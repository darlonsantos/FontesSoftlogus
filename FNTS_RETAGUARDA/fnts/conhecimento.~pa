{$I ACBr.inc }

unit conhecimento;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, DBCtrls, Collection, Buttons, ToolEdit, RXDBCtrl,
  ExtCtrls, ComCtrls, ACBrCTeDACTEClass, ACBrCTeDACTEFR, DB, ACBrCTe,
  ZAbstractRODataset, ZAbstractDataset, ZDataset, Menus, AdvGlowButton,
  RzEdit, RzDBEdit, RzDBBnEd, OleCtrls, SHDocVw, wwdbedit, Wwdotdot,
  Wwdbcomb, wwdblook, PageView, Mask, TFlatPanelUnit,
  IniFiles, jpeg, AdvPanel, AdvToolBar, AdvDropDown,
  AdvTimePickerDropDown, DBAdvTimePickerDropDown, pcnConversao, sGroupBox,
  RzCmboBx, RzDBCmbo, cxGraphics, cxControls, cxLookAndFeels,
  cxLookAndFeelPainters, cxContainer, cxEdit, dxSkinsCore, dxSkinBlack,
  dxSkinBlue, dxSkinBlueprint, dxSkinCaramel, dxSkinCoffee, dxSkinDarkRoom,
  dxSkinDarkSide, dxSkinDevExpressDarkStyle, dxSkinDevExpressStyle,
  dxSkinFoggy, dxSkinGlassOceans, dxSkinHighContrast, dxSkiniMaginary,
  dxSkinLilian, dxSkinLiquidSky, dxSkinLondonLiquidSky, dxSkinMcSkin,
  dxSkinMoneyTwins, dxSkinOffice2007Black, dxSkinOffice2007Blue,
  dxSkinOffice2007Green, dxSkinOffice2007Pink, dxSkinOffice2007Silver,
  dxSkinOffice2010Black, dxSkinOffice2010Blue, dxSkinOffice2010Silver,
  dxSkinPumpkin, dxSkinSeven, dxSkinSevenClassic, dxSkinSharp,
  dxSkinSharpPlus, dxSkinSilver, dxSkinSpringTime, dxSkinStardust,
  dxSkinSummer2008, dxSkinTheAsphaltWorld, dxSkinsDefaultPainters,
  dxSkinValentine, dxSkinVS2010, dxSkinWhiteprint, dxSkinXmas2008Blue,
  cxTextEdit, cxDBEdit, AdvDateTimePicker, AdvDBDateTimePicker, RzPanel,
  cxMaskEdit, cxDropDownEdit, cxCalendar, Grids, Wwdbigrd, Wwdbgrid;

type
  Tfrmconhecimento = class(TForm)
    dsconhecimento: TDataSource;
    Pop1: TPopupMenu;
    Incluir1: TMenuItem;
    Alterar1: TMenuItem;
    Excluir1: TMenuItem;
    CancelarNF1: TMenuItem;
    Localizar1: TMenuItem;
    Imprimir1: TMenuItem;
    Relatrios1: TMenuItem;
    Fechar1: TMenuItem;
    Pop2: TPopupMenu;
    Gravar1: TMenuItem;
    Cancelar1: TMenuItem;
    N1: TMenuItem;
    Incluiritem1: TMenuItem;
    Excluiritem1: TMenuItem;
    AlterarItem1: TMenuItem;
    Finalizar1: TMenuItem;
    qrmodelo: TZQuery;
    qrmodeloSINTEGRA: TStringField;
    qrmodeloMODELO: TStringField;
    qrmodeloCODIGO: TStringField;
    qrmodeloSIGLA: TStringField;
    qrmodeloTIPO_REGISTRO: TStringField;
    Bevel7: TBevel;
    Cte: TACBrCTe;
    ACBrCTe1: TACBrCTe;
    qrempresa: TZQuery;
    qrempresaCODIGO: TStringField;
    qrempresaFILIAL: TStringField;
    qrempresaNOTAFISCAL: TIntegerField;
    qrempresaENDERECO: TStringField;
    qrempresaCIDADE: TStringField;
    qrempresaUF: TStringField;
    qrempresaCEP: TStringField;
    qrempresaTELEFONE: TStringField;
    qrempresaCNPJ: TStringField;
    qrempresaIE: TStringField;
    qrempresaSEQNF: TIntegerField;
    qrempresaFAX: TStringField;
    qrempresaOBS1: TStringField;
    qrempresaOBS2: TStringField;
    qrempresaCONTRIBUINTE_IPI: TStringField;
    qrempresaSUBSTITUTO_TRIBUTARIO: TStringField;
    qrempresaEMPRESA_ESTADUAL: TStringField;
    qrempresaOPTANTE_SIMPLES: TStringField;
    qrempresaOPTANTE_SUPER_SIMPLES: TStringField;
    qrempresaECF: TStringField;
    qrempresaTIPO: TIntegerField;
    qrempresaIPI: TFloatField;
    qrempresaISS: TFloatField;
    qrempresaNUMERO: TStringField;
    qrempresaRESPONSAVEL: TStringField;
    qrempresaCOMPLEMENTO: TStringField;
    qrempresaBAIRRO: TStringField;
    qrcliente2: TZQuery;
    qrcliente2CODIGO: TStringField;
    qrcliente2NOME: TStringField;
    qrcliente2APELIDO: TStringField;
    qrcliente2ENDERECO: TStringField;
    qrcliente2BAIRRO: TStringField;
    qrcliente2CIDADE: TStringField;
    qrcliente2UF: TStringField;
    qrcliente2CEP: TStringField;
    qrcliente2COMPLEMENTO: TStringField;
    qrcliente2MORADIA: TIntegerField;
    qrcliente2TIPO: TIntegerField;
    qrcliente2SITUACAO: TIntegerField;
    qrcliente2TELEFONE1: TStringField;
    qrcliente2TELEFONE2: TStringField;
    qrcliente2TELEFONE3: TStringField;
    qrcliente2CELULAR: TStringField;
    qrcliente2EMAIL: TStringField;
    qrcliente2RG: TStringField;
    qrcliente2CPF: TStringField;
    qrcliente2FILIACAO: TStringField;
    qrcliente2ESTADOCIVIL: TStringField;
    qrcliente2CONJUGE: TStringField;
    qrcliente2PROFISSAO: TStringField;
    qrcliente2EMPRESA: TStringField;
    qrcliente2RENDA: TFloatField;
    qrcliente2LIMITE: TFloatField;
    qrcliente2REF1: TStringField;
    qrcliente2REF2: TStringField;
    qrcliente2CODVENDEDOR: TStringField;
    qrcliente2DATA_CADASTRO: TDateTimeField;
    qrcliente2DATA_ULTIMACOMPRA: TDateTimeField;
    qrcliente2OBS1: TStringField;
    qrcliente2OBS2: TStringField;
    qrcliente2OBS3: TStringField;
    qrcliente2OBS4: TStringField;
    qrcliente2OBS5: TStringField;
    qrcliente2OBS6: TStringField;
    qrcliente2NASCIMENTO: TStringField;
    qrcliente2CODREGIAO: TStringField;
    qrcliente2CODCONVENIO: TStringField;
    qrcliente2CODUSUARIO: TStringField;
    qrcliente2NUMERO: TStringField;
    qrcliente2RG_ORGAO: TStringField;
    qrcliente2RG_ESTADO: TStringField;
    qrcliente2RG_EMISSAO: TDateTimeField;
    qrcliente2SEXO: TStringField;
    qrcliente2HISTORICO: TBlobField;
    qrcliente2PREVISAO: TDateTimeField;
    qrcliente2CNAE: TStringField;
    qrcliente2COD_MUNICIPIO_IBGE: TStringField;
    qrcliente2IBGE: TStringField;
    qrcliente2TAMANHO_CALCA: TStringField;
    qrcliente2TAMANHO_BLUSA: TStringField;
    qrcliente2TAMANHO_SAPATO: TStringField;
    qrcliente2CORRESP_ENDERECO: TStringField;
    qrcliente2CORRESP_BAIRRO: TStringField;
    qrcliente2CORRESP_CIDADE: TStringField;
    qrcliente2CORRESP_UF: TStringField;
    qrcliente2CORRESP_CEP: TStringField;
    qrcliente2CORRESP_COMPLEMENTO: TStringField;
    qrcliente2RG_PRODUTOR: TStringField;
    qrcliente2RESP1_NOME: TStringField;
    qrcliente2RESP1_CPF: TStringField;
    qrcliente2RESP1_RG: TStringField;
    qrcliente2RESP1_PROFISSAO: TStringField;
    qrcliente2RESP1_ESTADO_CIVIL: TStringField;
    qrcliente2RESP1_ENDERECO: TStringField;
    qrcliente2RESP1_BAIRRO: TStringField;
    qrcliente2RESP1_CIDADE: TStringField;
    qrcliente2RESP1_UF: TStringField;
    qrcliente2RESP1_CEP: TStringField;
    qrcliente2RESP2_NOME: TStringField;
    qrcliente2RESP2_CPF: TStringField;
    qrcliente2RESP2_RG: TStringField;
    qrcliente2RESP2_PROFISSAO: TStringField;
    qrcliente2RESP2_ESTADO_CIVIL: TStringField;
    qrcliente2RESP2_ENDERECO: TStringField;
    qrcliente2RESP2_BAIRRO: TStringField;
    qrcliente2RESP2_CIDADE: TStringField;
    qrcliente2RESP2_UF: TStringField;
    qrcliente2RESP2_CEP: TStringField;
    qrcliente2FOTO: TStringField;
    qrcliente2CONDPGTO: TStringField;
    qrdest: TZQuery;
    qrdestCODIGO: TStringField;
    qrdestNOME: TStringField;
    qrdestAPELIDO: TStringField;
    qrdestENDERECO: TStringField;
    qrdestBAIRRO: TStringField;
    qrdestCIDADE: TStringField;
    qrdestUF: TStringField;
    qrdestCEP: TStringField;
    qrdestCOMPLEMENTO: TStringField;
    qrdestMORADIA: TIntegerField;
    qrdestTIPO: TIntegerField;
    qrdestSITUACAO: TIntegerField;
    qrdestTELEFONE1: TStringField;
    qrdestTELEFONE2: TStringField;
    qrdestTELEFONE3: TStringField;
    qrdestCELULAR: TStringField;
    qrdestEMAIL: TStringField;
    qrdestRG: TStringField;
    qrdestCPF: TStringField;
    qrdestFILIACAO: TStringField;
    qrdestESTADOCIVIL: TStringField;
    qrdestCONJUGE: TStringField;
    qrdestPROFISSAO: TStringField;
    qrdestEMPRESA: TStringField;
    qrdestRENDA: TFloatField;
    qrdestLIMITE: TFloatField;
    qrdestREF1: TStringField;
    qrdestREF2: TStringField;
    qrdestCODVENDEDOR: TStringField;
    qrdestDATA_CADASTRO: TDateTimeField;
    qrdestDATA_ULTIMACOMPRA: TDateTimeField;
    qrdestOBS1: TStringField;
    qrdestOBS2: TStringField;
    qrdestOBS3: TStringField;
    qrdestOBS4: TStringField;
    qrdestOBS5: TStringField;
    qrdestOBS6: TStringField;
    qrdestNASCIMENTO: TStringField;
    qrdestCODREGIAO: TStringField;
    qrdestCODCONVENIO: TStringField;
    qrdestCODUSUARIO: TStringField;
    qrdestNUMERO: TStringField;
    qrdestRG_ORGAO: TStringField;
    qrdestRG_ESTADO: TStringField;
    qrdestRG_EMISSAO: TDateTimeField;
    qrdestSEXO: TStringField;
    qrdestHISTORICO: TBlobField;
    qrdestPREVISAO: TDateTimeField;
    qrdestCNAE: TStringField;
    qrdestCOD_MUNICIPIO_IBGE: TStringField;
    qrdestIBGE: TStringField;
    qrdestTAMANHO_CALCA: TStringField;
    qrdestTAMANHO_BLUSA: TStringField;
    qrdestTAMANHO_SAPATO: TStringField;
    qrdestCORRESP_ENDERECO: TStringField;
    qrdestCORRESP_BAIRRO: TStringField;
    qrdestCORRESP_CIDADE: TStringField;
    qrdestCORRESP_UF: TStringField;
    qrdestCORRESP_CEP: TStringField;
    qrdestCORRESP_COMPLEMENTO: TStringField;
    qrdestRG_PRODUTOR: TStringField;
    qrdestRESP1_NOME: TStringField;
    qrdestRESP1_CPF: TStringField;
    qrdestRESP1_RG: TStringField;
    qrdestRESP1_PROFISSAO: TStringField;
    qrdestRESP1_ESTADO_CIVIL: TStringField;
    qrdestRESP1_ENDERECO: TStringField;
    qrdestRESP1_BAIRRO: TStringField;
    qrdestRESP1_CIDADE: TStringField;
    qrdestRESP1_UF: TStringField;
    qrdestRESP1_CEP: TStringField;
    qrdestRESP2_NOME: TStringField;
    qrdestRESP2_CPF: TStringField;
    qrdestRESP2_RG: TStringField;
    qrdestRESP2_PROFISSAO: TStringField;
    qrdestRESP2_ESTADO_CIVIL: TStringField;
    qrdestRESP2_ENDERECO: TStringField;
    qrdestRESP2_BAIRRO: TStringField;
    qrdestRESP2_CIDADE: TStringField;
    qrdestRESP2_UF: TStringField;
    qrdestRESP2_CEP: TStringField;
    qrdestFOTO: TStringField;
    qrdestCONDPGTO: TStringField;
    dacte1: TACBrCTeDACTEFR;
    OpenDialog1: TOpenDialog;
    qrNFE_Cliente: TZQuery;
    qrempresaFARMACIA_RESP_TECNICO: TStringField;
    qrempresaFARMACIA_CRF: TStringField;
    qrempresaFARMACIA_CPF: TStringField;
    qrempresaFARMCIA_DATA: TDateTimeField;
    qrempresaFARMACIA_UF: TStringField;
    qrempresaFARMACIA_SENHA: TStringField;
    qrempresaFARMACIA_EMAIL: TStringField;
    qrempresaFARMACIA_LOGIN: TStringField;
    qrempresaFARMACIA_ENVIO: TStringField;
    qrempresaCONHECIMENTO: TIntegerField;
    qrempresaINDUSTRIA: TStringField;
    qrempresaFARMACIA_NUMEROLICENCA: TStringField;
    qrempresaCOD_MUNICIPIO_IBGE: TStringField;
    qrempresaIBGE: TStringField;
    qrempresaPIS: TFloatField;
    qrempresaCOFINS: TFloatField;
    qrempresaEMAIL: TStringField;
    qrempresaATIVIDADE: TStringField;
    qrempresaCONTADOR_COD_MUNICIPIO_IBGE: TStringField;
    qrempresaCONTADOR_NOME: TStringField;
    qrempresaCONTADOR_CPF: TStringField;
    qrempresaCONTADOR_CRC: TStringField;
    qrempresaCONTADOR_CNPJ: TStringField;
    qrempresaCONTADOR_CEP: TStringField;
    qrempresaCONTADOR_ENDERECO: TStringField;
    qrempresaCONTADOR_NUMERO: TStringField;
    qrempresaCONTADOR_COMPLEMENTO: TStringField;
    qrempresaCONTADOR_BAIRRO: TStringField;
    qrempresaCONTADOR_FONE: TStringField;
    qrempresaCONTADOR_FAX: TStringField;
    qrempresaCONTADOR_EMAIL: TStringField;
    qrempresaINSC_MUNICIPAL: TStringField;
    qrempresaDATA_ABERTURA: TDateTimeField;
    qrempresaCNAE: TStringField;
    qrempresaCRT: TStringField;
    qrempresaCONTADOR_CIDADE: TStringField;
    qrempresaCONTADOR_COD_MUNICIPIO: TStringField;
    qrempresaCONTADOR_UF: TStringField;
    qrempresaPERMITE_CREDITO: TIntegerField;
    qrempresaFANTASIA: TStringField;
    qrempresaDFIXAS: TFloatField;
    qrempresaTIPOCALCULO: TIntegerField;
    qrconhecimento: TZQuery;
    dsconhecimento2: TDataSource;
    qrconhecimentoCODIGO: TStringField;
    qrconhecimentoNUMERO: TStringField;
    qrconhecimentoDATA: TDateTimeField;
    qrconhecimentoCFOP: TStringField;
    qrconhecimentoCODREMETENTE: TStringField;
    qrconhecimentoCODDESTINATARIO: TStringField;
    qrconhecimentoSITUACAO: TIntegerField;
    qrconhecimentoTIPO: TStringField;
    qrconhecimentoCONSIG_NOME: TStringField;
    qrconhecimentoCONSIG_ENDERECO: TStringField;
    qrconhecimentoCONSIG_CIDADE: TStringField;
    qrconhecimentoCONSIG_UF: TStringField;
    qrconhecimentoCONSIG_TIPO: TStringField;
    qrconhecimentoCONSIG_CALCULADO: TStringField;
    qrconhecimentoREDE_NOME: TStringField;
    qrconhecimentoREDE_ENDERECO: TStringField;
    qrconhecimentoREDE_CIDADE: TStringField;
    qrconhecimentoREDE_UF: TStringField;
    qrconhecimentoREDE_TIPO: TStringField;
    qrconhecimentoREDE_CNPJ: TStringField;
    qrconhecimentoCARGA_NATUREZA: TStringField;
    qrconhecimentoCARGA_NF: TStringField;
    qrconhecimentoCARGA_VALOR: TFloatField;
    qrconhecimentoCARGA_QTDE: TFloatField;
    qrconhecimentoCARGA_VOL_QTDE: TFloatField;
    qrconhecimentoCARGA_VOL_ESPECIE: TStringField;
    qrconhecimentoCARGA_MARCA1: TStringField;
    qrconhecimentoCARGA_MARCA2: TStringField;
    qrconhecimentoFRETE_PESO: TFloatField;
    qrconhecimentoFRETE_VALOR: TFloatField;
    qrconhecimentoFRETE_ADICIONAL: TFloatField;
    qrconhecimentoFRETE_SEGURO: TFloatField;
    qrconhecimentoFRETE_DESPACHO: TFloatField;
    qrconhecimentoFRETE_OUTROS: TFloatField;
    qrconhecimentoFRETE_TOTAL: TFloatField;
    qrconhecimentoFRETE_TARIFA: TFloatField;
    qrconhecimentoFRETE_BASE: TFloatField;
    qrconhecimentoFRETE_ALIQUOTA: TIntegerField;
    qrconhecimentoFRETE_ICMS: TFloatField;
    qrconhecimentoFRETE_PRONT: TStringField;
    qrconhecimentoFRETE_APOLICE: TStringField;
    qrconhecimentoFRETE_CIA: TStringField;
    qrconhecimentoFRETE_CARREGAR: TStringField;
    qrconhecimentoFRETE_DESCARREGAR: TStringField;
    qrconhecimentoCODVEICULO: TStringField;
    qrconhecimentoCODTRANSPORTADOR: TStringField;
    qrconhecimentoOBS: TBlobField;
    qrconhecimentoCODFILIAL: TStringField;
    qrconhecimentoLOCAL: TStringField;
    qrconhecimentoMOTIVO: TStringField;
    qrconhecimentoVEICULO_LOCAL: TStringField;
    qrconhecimentoVEICULO_UF: TStringField;
    qrconhecimentoMODELO: TStringField;
    qrconhecimentoESPECIE: TStringField;
    qrconhecimentoSERIE: TStringField;
    qrconhecimentoMODELO_NF: TStringField;
    qrconhecimentoESPECIE_NF: TStringField;
    qrconhecimentoSERIE_NF: TStringField;
    qrconhecimentoDATA_NF: TDateTimeField;
    qrconhecimentoVALOR_CONHECIMENTO: TFloatField;
    qrconhecimentoINF1: TStringField;
    qrconhecimentoINF2: TStringField;
    qrconhecimentoINF3: TStringField;
    qrconhecimentoINF4: TStringField;
    qrconhecimentoINF5: TStringField;
    qrconhecimentoCARGA_NATUREZA2: TStringField;
    qrconhecimentoCARGA_NF2: TStringField;
    qrconhecimentoCARGA_VALOR2: TFloatField;
    qrconhecimentoCARGA_QTDE2: TFloatField;
    qrconhecimentoCARGA_VOL_QTDE2: TFloatField;
    qrconhecimentoCARGA_VOL_ESPECIE2: TStringField;
    qrconhecimentoMODELO_NF2: TStringField;
    qrconhecimentoESPECIE_NF2: TStringField;
    qrconhecimentoSERIE_NF2: TStringField;
    qrconhecimentoDATA_NF2: TDateTimeField;
    qrconhecimentoVALOR_CONHECIMENTO2: TFloatField;
    qrconhecimentoCHAVE_ACESSO: TStringField;
    qrconhecimentoCHAVE_ACESSO2: TStringField;
    qrconhecimentoCTE_XML: TStringField;
    qrconhecimentoCTE_SITUACAO: TIntegerField;
    qrconhecimentoTESTE: TDateTimeField;
    qrconhecimentoORIGEM_CMUNINI: TStringField;
    qrconhecimentoORIGEM_XMUNINI: TStringField;
    qrconhecimentoORIGEM_UFINI: TStringField;
    qrconhecimentoCMUNFIM: TStringField;
    qrconhecimentoXMUNFIM: TStringField;
    qrconhecimentoUFFIM: TStringField;
    qrconhecimentoMODAL: TStringField;
    qrconhecimentoTIPO_SERVICO: TStringField;
    qrconhecimentoFINALIDADE_EMISSAO: TStringField;
    qrconhecimentoFORMA_EMISSAO: TStringField;
    qrconhecimentoFORMA_PAGAMENTO: TStringField;
    qrconhecimentoFORMA_IMPRESSAO_DACTE: TStringField;
    qrconhecimentoCHAVE_ACEESSO_REFERENCIADO: TStringField;
    qrconhecimentoCARAC_AD_TRANSP: TStringField;
    qrconhecimentoCARAC_AD_SERV: TStringField;
    qrconhecimentoFUNC_EMISSOR: TStringField;
    qrconhecimentoMUN_ORIGEM_CAL: TStringField;
    qrconhecimentoMUN_DEST_CAL: TStringField;
    qrconhecimentoCOD_ROTA_ENTREGA: TStringField;
    qrconhecimentoROTA_ENTREGA_SIGLA_ORIGEM: TStringField;
    qrconhecimentoROTA_ENTREGA_SIGLA_DEST: TStringField;
    qrconhecimentoPREV_ENTREGA_DATA_INI: TDateTimeField;
    qrconhecimentoPREV_ENTREGA_DATA_FIM: TDateTimeField;
    qrconhecimentoPREV_ENTREGA_DATA_TIPO: TStringField;
    qrconhecimentoPREV_ENTREGA_HORA_TIPO: TStringField;
    qrconhecimentoPREV_ENTREGA_HORA_INI: TDateTimeField;
    qrconhecimentoPREV_ENTREGA_HORA_FIM: TDateTimeField;
    qrconhecimentoRECEBEDOR_RET_AFPE: TStringField;
    qrconhecimentoDETALHES_RETIRADA: TStringField;
    qrconhecimentoCOD_EMITENTE: TStringField;
    qrconhecimentoCOD_TOMADOR: TStringField;
    qrconhecimentoCOD_REMETENTE: TStringField;
    qrconhecimentoREMETENTE_TIPO: TStringField;
    qrconhecimentoREMETENTE_INFORMACOES_NF: TStringField;
    qrconhecimentoCOD_EXPEDIDOR: TStringField;
    qrconhecimentoEXPEDIDOR_TIPO: TStringField;
    qrconhecimentoCOD_RECEBEDOR: TStringField;
    qrconhecimentoRECEBEDOR_TIPO: TStringField;
    qrconhecimentoCOD_DESTINATARIO: TStringField;
    qrconhecimentoDESTINATARIO_TIPO: TStringField;
    qrconhecimentoLOC_ENTREGA_DIF_END_DEST: TStringField;
    qrconhecimentoCOD_ENTREGA_DIFERENTE: TStringField;
    qrconhecimentoVTOTAL_SERVICO: TFloatField;
    qrconhecimentoVL_ARECEBER: TFloatField;
    qrconhecimentoVL_TOT_IMPOSTOS: TFloatField;
    qrconhecimentoCOD_SIT_TRIBUT: TStringField;
    qrconhecimentoINF_ADIC_INT_FISCO: TBlobField;
    qrconhecimentoVL_BC_ICMS: TFloatField;
    qrconhecimentoVL_ALIQ_ICMS: TFloatField;
    qrconhecimentoVL_ICMS: TFloatField;
    qrconhecimentoVL_CRED_OUT_PRESU: TFloatField;
    qrconhecimentoVL_PERC_REDUCAP_BC: TFloatField;
    qrconhecimentoVL_CARGA: TFloatField;
    qrconhecimentoPROD_PREDOMINANTE: TStringField;
    qrconhecimentoOUT_CARACT_PROD: TStringField;
    qrconhecimentoRESP_SEGURO: TStringField;
    qrconhecimentoNOME_SEGURADORA: TStringField;
    qrconhecimentoNUMERO_APOLICE: TStringField;
    qrconhecimentoNUMERO_AVERBACAO: TStringField;
    qrconhecimentoVL_MERC_AVERB: TFloatField;
    qrconhecimentoNUMERO_FAT: TStringField;
    qrconhecimentoVL_ORIGINAL: TFloatField;
    qrconhecimentoVL_DESCONTO: TFloatField;
    qrconhecimentoVL_LIQUIDO: TFloatField;
    qrconhecimentoRNTRC: TStringField;
    qrconhecimentoDATA_PREV_ENTREGA: TDateTimeField;
    qrconhecimentoIND_LOTACAO: TStringField;
    qrconhecimentoCIOT: TStringField;
    qrconhecimentoOBS_GERAIS: TBlobField;
    qrconhecimentoVERSAO_XML: TStringField;
    RzPanel1: TRzPanel;
    pficha: TPageView;
    PageSheet1: TPageSheet;
    PageView2: TPageView;
    PageSheet14: TPageSheet;
    sGroupBox1: TsGroupBox;
    Label14: TLabel;
    locemi: TAdvGlowButton;
    sGroupBox2: TsGroupBox;
    Label15: TLabel;
    Label16: TLabel;
    btiniprest: TAdvGlowButton;
    UFini: TDBEdit;
    xmunini: TDBEdit;
    cMunIni: TDBEdit;
    sGroupBox3: TsGroupBox;
    Label18: TLabel;
    Label17: TLabel;
    bttermprest: TAdvGlowButton;
    UFfim: TDBEdit;
    xmunfim: TDBEdit;
    cMunFim: TDBEdit;
    sGroupBox4: TsGroupBox;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label10: TLabel;
    Label9: TLabel;
    Label8: TLabel;
    Label7: TLabel;
    Label4: TLabel;
    Label3: TLabel;
    Label1: TLabel;
    Label2: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label33: TLabel;
    DBCOMBOBOX2: TRzDBComboBox;
    RzDBComboBox7: TRzDBComboBox;
    DBEdit3: TDBEdit;
    RzDBComboBox5: TRzDBComboBox;
    RzDBComboBox4: TRzDBComboBox;
    RzDBComboBox3: TRzDBComboBox;
    RzDBComboBox1: TRzDBComboBox;
    eserie: TDBEdit;
    DBEdit2: TDBEdit;
    ecfop: TRzDBButtonEdit;
    bt_nfe_validar: TBitBtn;
    bt_nfe_danfe: TBitBtn;
    btnGerarCTe: TButton;
    bt_nfe_assinar: TBitBtn;
    PageSheet15: TPageSheet;
    Label20: TLabel;
    Label21: TLabel;
    Label22: TLabel;
    Label23: TLabel;
    Label24: TLabel;
    sGroupBox5: TsGroupBox;
    PageView3: TPageView;
    PageSheet17: TPageSheet;
    Label19: TLabel;
    sGroupBox6: TsGroupBox;
    Label25: TLabel;
    Label26: TLabel;
    sGroupBox7: TsGroupBox;
    cxDBTextEdit7: TcxDBTextEdit;
    cxDBTextEdit8: TcxDBTextEdit;
    cxDBTextEdit1: TcxDBTextEdit;
    PageSheet18: TPageSheet;
    sGroupBox8: TsGroupBox;
    rgdataentrega: TDBComboBox;
    sGroupBox9: TsGroupBox;
    rghora: TDBComboBox;
    hrini: TAdvDBDateTimePicker;
    hrfim: TAdvDBDateTimePicker;
    xCaracAd: TcxDBTextEdit;
    xCaracSer: TcxDBTextEdit;
    cxDBTextEdit4: TcxDBTextEdit;
    cxDBTextEdit5: TcxDBTextEdit;
    cxDBTextEdit6: TcxDBTextEdit;
    PageSheet16: TPageSheet;
    DBComboBox3: TDBComboBox;
    xTexto: TDBMemo;
    PageSheet2: TPageSheet;
    PageSheet3: TPageSheet;
    sGroupBox12: TsGroupBox;
    Label41: TLabel;
    Label42: TLabel;
    Label43: TLabel;
    Label44: TLabel;
    Label45: TLabel;
    Label46: TLabel;
    Label47: TLabel;
    Label48: TLabel;
    Label49: TLabel;
    cxDBTextEdit22: TcxDBTextEdit;
    cxDBTextEdit23: TcxDBTextEdit;
    cxDBTextEdit24: TcxDBTextEdit;
    cxDBTextEdit25: TcxDBTextEdit;
    cxDBTextEdit26: TcxDBTextEdit;
    cxDBTextEdit27: TcxDBTextEdit;
    cxDBTextEdit28: TcxDBTextEdit;
    cxDBTextEdit29: TcxDBTextEdit;
    cxDBTextEdit30: TcxDBTextEdit;
    sGroupBox17: TsGroupBox;
    Label86: TLabel;
    Label87: TLabel;
    Label88: TLabel;
    Label89: TLabel;
    cxDBTextEdit67: TcxDBTextEdit;
    cxDBTextEdit68: TcxDBTextEdit;
    cxDBTextEdit69: TcxDBTextEdit;
    cxDBTextEdit70: TcxDBTextEdit;
    rgtomador: TDBComboBox;
    edtomador: TRzDBButtonEdit;
    PageSheet4: TPageSheet;
    DBComboBox5: TDBComboBox;
    rgmodelonf: TDBComboBox;
    PageView1: TPageView;
    PageSheet19: TPageSheet;
    sGroupBox18: TsGroupBox;
    Label90: TLabel;
    Label91: TLabel;
    Label92: TLabel;
    Label93: TLabel;
    cxDBTextEdit71: TcxDBTextEdit;
    cxDBTextEdit72: TcxDBTextEdit;
    cxDBTextEdit73: TcxDBTextEdit;
    cxDBTextEdit74: TcxDBTextEdit;
    sGroupBox13: TsGroupBox;
    Label50: TLabel;
    Label51: TLabel;
    Label52: TLabel;
    Label53: TLabel;
    Label54: TLabel;
    Label55: TLabel;
    Label56: TLabel;
    Label57: TLabel;
    Label58: TLabel;
    cxDBTextEdit31: TcxDBTextEdit;
    cxDBTextEdit32: TcxDBTextEdit;
    cxDBTextEdit33: TcxDBTextEdit;
    cxDBTextEdit34: TcxDBTextEdit;
    cxDBTextEdit35: TcxDBTextEdit;
    cxDBTextEdit36: TcxDBTextEdit;
    cxDBTextEdit37: TcxDBTextEdit;
    cxDBTextEdit38: TcxDBTextEdit;
    cxDBTextEdit39: TcxDBTextEdit;
    PageSheet20: TPageSheet;
    PageSheet21: TPageSheet;
    PageSheet22: TPageSheet;
    PageSheet5: TPageSheet;
    sGroupBox14: TsGroupBox;
    Label59: TLabel;
    Label60: TLabel;
    Label61: TLabel;
    Label62: TLabel;
    Label63: TLabel;
    Label64: TLabel;
    Label65: TLabel;
    Label66: TLabel;
    Label67: TLabel;
    cxDBTextEdit40: TcxDBTextEdit;
    cxDBTextEdit41: TcxDBTextEdit;
    cxDBTextEdit42: TcxDBTextEdit;
    cxDBTextEdit43: TcxDBTextEdit;
    cxDBTextEdit44: TcxDBTextEdit;
    cxDBTextEdit45: TcxDBTextEdit;
    cxDBTextEdit46: TcxDBTextEdit;
    cxDBTextEdit47: TcxDBTextEdit;
    cxDBTextEdit48: TcxDBTextEdit;
    DBComboBox7: TDBComboBox;
    sGroupBox19: TsGroupBox;
    Label94: TLabel;
    Label95: TLabel;
    Label96: TLabel;
    Label97: TLabel;
    cxDBTextEdit75: TcxDBTextEdit;
    cxDBTextEdit76: TcxDBTextEdit;
    cxDBTextEdit77: TcxDBTextEdit;
    cxDBTextEdit78: TcxDBTextEdit;
    PageSheet6: TPageSheet;
    sGroupBox15: TsGroupBox;
    Label68: TLabel;
    Label69: TLabel;
    Label70: TLabel;
    Label71: TLabel;
    Label72: TLabel;
    Label73: TLabel;
    Label74: TLabel;
    Label75: TLabel;
    Label76: TLabel;
    cxDBTextEdit49: TcxDBTextEdit;
    cxDBTextEdit50: TcxDBTextEdit;
    cxDBTextEdit51: TcxDBTextEdit;
    cxDBTextEdit52: TcxDBTextEdit;
    cxDBTextEdit53: TcxDBTextEdit;
    cxDBTextEdit54: TcxDBTextEdit;
    cxDBTextEdit55: TcxDBTextEdit;
    cxDBTextEdit56: TcxDBTextEdit;
    cxDBTextEdit57: TcxDBTextEdit;
    cbret: TDBComboBox;
    sGroupBox20: TsGroupBox;
    Label98: TLabel;
    Label99: TLabel;
    Label100: TLabel;
    Label101: TLabel;
    cxDBTextEdit79: TcxDBTextEdit;
    cxDBTextEdit80: TcxDBTextEdit;
    cxDBTextEdit81: TcxDBTextEdit;
    cxDBTextEdit82: TcxDBTextEdit;
    elocret: TRzDBButtonEdit;
    PageSheet7: TPageSheet;
    DBComboBox9: TDBComboBox;
    PageView4: TPageView;
    PageSheet23: TPageSheet;
    sGroupBox21: TsGroupBox;
    Label102: TLabel;
    Label103: TLabel;
    Label104: TLabel;
    Label105: TLabel;
    cxDBTextEdit83: TcxDBTextEdit;
    cxDBTextEdit84: TcxDBTextEdit;
    cxDBTextEdit85: TcxDBTextEdit;
    cxDBTextEdit86: TcxDBTextEdit;
    sGroupBox16: TsGroupBox;
    Label77: TLabel;
    Label78: TLabel;
    Label79: TLabel;
    Label80: TLabel;
    Label81: TLabel;
    Label82: TLabel;
    Label83: TLabel;
    Label84: TLabel;
    Label85: TLabel;
    cxDBTextEdit58: TcxDBTextEdit;
    cxDBTextEdit59: TcxDBTextEdit;
    cxDBTextEdit60: TcxDBTextEdit;
    cxDBTextEdit61: TcxDBTextEdit;
    cxDBTextEdit62: TcxDBTextEdit;
    cxDBTextEdit63: TcxDBTextEdit;
    cxDBTextEdit64: TcxDBTextEdit;
    cxDBTextEdit65: TcxDBTextEdit;
    cxDBTextEdit66: TcxDBTextEdit;
    PageSheet24: TPageSheet;
    cblocdest: TDBComboBox;
    sGroupBox22: TsGroupBox;
    Label114: TLabel;
    Label115: TLabel;
    sGroupBox23: TsGroupBox;
    Label106: TLabel;
    Label107: TLabel;
    Label108: TLabel;
    Label109: TLabel;
    Label110: TLabel;
    Label111: TLabel;
    Label112: TLabel;
    Label113: TLabel;
    cxDBTextEdit87: TcxDBTextEdit;
    cxDBTextEdit88: TcxDBTextEdit;
    cxDBTextEdit89: TcxDBTextEdit;
    cxDBTextEdit90: TcxDBTextEdit;
    cxDBTextEdit91: TcxDBTextEdit;
    cxDBTextEdit92: TcxDBTextEdit;
    cxDBTextEdit93: TcxDBTextEdit;
    cxDBTextEdit94: TcxDBTextEdit;
    cxDBTextEdit95: TcxDBTextEdit;
    cxDBTextEdit96: TcxDBTextEdit;
    elocdestdif: TRzDBButtonEdit;
    edestinatario: TRzDBButtonEdit;
    PageSheet8: TPageSheet;
    sGroupBox24: TsGroupBox;
    Label116: TLabel;
    Label117: TLabel;
    Label118: TLabel;
    cxDBTextEdit97: TcxDBTextEdit;
    cxDBTextEdit98: TcxDBTextEdit;
    cxDBTextEdit99: TcxDBTextEdit;
    sGroupBox25: TsGroupBox;
    Label119: TLabel;
    Label120: TLabel;
    Label121: TLabel;
    Label122: TLabel;
    Label123: TLabel;
    DBComboBox11: TDBComboBox;
    cxDBTextEdit100: TcxDBTextEdit;
    cxDBTextEdit101: TcxDBTextEdit;
    cxDBTextEdit102: TcxDBTextEdit;
    cxDBTextEdit103: TcxDBTextEdit;
    cxDBTextEdit104: TcxDBTextEdit;
    Memo2: TMemo;
    PageSheet9: TPageSheet;
    PageView5: TPageView;
    PageSheet25: TPageSheet;
    Label124: TLabel;
    Label125: TLabel;
    Label126: TLabel;
    cxDBTextEdit105: TcxDBTextEdit;
    cxDBTextEdit106: TcxDBTextEdit;
    cxDBTextEdit107: TcxDBTextEdit;
    PageSheet26: TPageSheet;
    PageSheet27: TPageSheet;
    PageSheet28: TPageSheet;
    PageSheet29: TPageSheet;
    PageSheet30: TPageSheet;
    PageSheet31: TPageSheet;
    PageSheet32: TPageSheet;
    sGroupBox26: TsGroupBox;
    Label127: TLabel;
    Label128: TLabel;
    Label129: TLabel;
    Label130: TLabel;
    cxDBTextEdit108: TcxDBTextEdit;
    cxDBTextEdit109: TcxDBTextEdit;
    cxDBTextEdit110: TcxDBTextEdit;
    cxDBTextEdit111: TcxDBTextEdit;
    sGroupBox27: TsGroupBox;
    PageSheet10: TPageSheet;
    PageSheet11: TPageSheet;
    PageView6: TPageView;
    PageSheet33: TPageSheet;
    Label131: TLabel;
    sGroupBox28: TsGroupBox;
    cxDBTextEdit112: TcxDBTextEdit;
    RzDBComboBox2: TRzDBComboBox;
    cxDBTextEdit113: TcxDBTextEdit;
    sGroupBox29: TsGroupBox;
    PageSheet34: TPageSheet;
    sGroupBox30: TsGroupBox;
    PageSheet35: TPageSheet;
    sGroupBox31: TsGroupBox;
    PageSheet36: TPageSheet;
    sGroupBox32: TsGroupBox;
    PageSheet12: TPageSheet;
    PageSheet13: TPageSheet;
    PageView7: TPageView;
    PageSheet37: TPageSheet;
    mix: TsGroupBox;
    xobs: TDBMemo;
    PageSheet38: TPageSheet;
    sGroupBox34: TsGroupBox;
    PageSheet39: TPageSheet;
    sGroupBox35: TsGroupBox;
    PageSheet40: TPageSheet;
    Panel1: TPanel;
    GroupBox1: TGroupBox;
    PageControl1: TPageControl;
    TabSheet1: TTabSheet;
    GroupBox3: TGroupBox;
    sbtnCaminhoCert: TSpeedButton;
    Label134: TLabel;
    sbtnGetCert: TSpeedButton;
    edtNumSerie: TEdit;
    TabSheet2: TTabSheet;
    GroupBox4: TGroupBox;
    Label135: TLabel;
    sbtnLogoMarca: TSpeedButton;
    sbtnPathSalvar: TSpeedButton;
    edtLogoMarca: TEdit;
    edtPathLogs: TEdit;
    ckSalvar: TCheckBox;
    rgTipoDACTe: TRadioGroup;
    rgFormaEmissao: TRadioGroup;
    TabSheet3: TTabSheet;
    GroupBox5: TGroupBox;
    Label136: TLabel;
    ckVisualizar: TCheckBox;
    cbUF: TComboBox;
    rgTipoAmb: TRadioGroup;
    gbProxy: TGroupBox;
    Label137: TLabel;
    Label138: TLabel;
    Label139: TLabel;
    Label140: TLabel;
    edtProxyHost: TEdit;
    edtProxyPorta: TEdit;
    edtProxyUser: TEdit;
    edtProxySenha: TEdit;
    TabSheet4: TTabSheet;
    Label141: TLabel;
    Label142: TLabel;
    Label143: TLabel;
    Label144: TLabel;
    Label145: TLabel;
    Label146: TLabel;
    Label147: TLabel;
    Label148: TLabel;
    Label149: TLabel;
    Label150: TLabel;
    Label151: TLabel;
    Label152: TLabel;
    Label153: TLabel;
    edtEmitCNPJ: TEdit;
    edtEmitIE: TEdit;
    edtEmitRazao: TEdit;
    edtEmitFantasia: TEdit;
    edtEmitFone: TEdit;
    edtEmitCEP: TEdit;
    edtEmitLogradouro: TEdit;
    edtEmitNumero: TEdit;
    edtEmitComp: TEdit;
    edtEmitBairro: TEdit;
    edtEmitCodCidade: TEdit;
    edtEmitCidade: TEdit;
    edtEmitUF: TEdit;
    TabSheet7: TTabSheet;
    GroupBox6: TGroupBox;
    Label154: TLabel;
    Label155: TLabel;
    Label156: TLabel;
    Label157: TLabel;
    Label158: TLabel;
    Label159: TLabel;
    edtSmtpHost: TEdit;
    edtSmtpPort: TEdit;
    edtSmtpUser: TEdit;
    edtSmtpPass: TEdit;
    edtEmailAssunto: TEdit;
    cbEmailSSL: TCheckBox;
    mmEmailMsg: TMemo;
    btnSalvarConfig: TBitBtn;
    Panel3: TPanel;
    Label160: TLabel;
    Button2: TButton;
    Button4: TButton;
    Button6: TButton;
    Button8: TButton;
    Button9: TButton;
    btnEnviarEmail: TButton;
    Button10: TButton;
    btnImportarXML: TButton;
    Button11: TButton;
    Button12: TButton;
    btnValidarXML: TButton;
    btnCriarEnviar: TButton;
    edtCTe: TEdit;
    PageControl2: TPageControl;
    TabSheet5: TTabSheet;
    MemoResp: TMemo;
    TabSheet6: TTabSheet;
    WBResposta: TWebBrowser;
    TabSheet8: TTabSheet;
    memoLog: TMemo;
    TabSheet9: TTabSheet;
    trvwCTe: TTreeView;
    TabSheet10: TTabSheet;
    memoRespWS: TMemo;
    Dados: TTabSheet;
    MemoDados: TMemo;
    RzPanel3: TRzPanel;
    AdvGlowButton4: TAdvGlowButton;
    AdvGlowButton5: TAdvGlowButton;
    AdvGlowButton6: TAdvGlowButton;
    AdvGlowButton7: TAdvGlowButton;
    AdvGlowButton8: TAdvGlowButton;
    AdvGlowButton9: TAdvGlowButton;
    AdvGlowButton10: TAdvGlowButton;
    btn74d: TAdvGlowButton;
    panel2: TRzPanel;
    bincluir: TAdvGlowButton;
    balterar: TAdvGlowButton;
    bexcluir: TAdvGlowButton;
    blocalizar: TAdvGlowButton;
    bitbtn5: TAdvGlowButton;
    btabela: TAdvGlowMenuButton;
    DBAdvGlowButton5: TDBAdvGlowButton;
    DBAdvGlowButton6: TDBAdvGlowButton;
    DBAdvGlowButton7: TDBAdvGlowButton;
    DBAdvGlowButton8: TDBAdvGlowButton;
    bfechar: TAdvGlowButton;
    pgravar: TRzPanel;
    bgravar: TAdvGlowButton;
    bcancelar: TAdvGlowButton;
    RzPanel4: TRzPanel;
    sGroupBox33: TsGroupBox;
    edata_cadastro: TcxDBDateEdit;
    DBEdit21: TDBEdit;
    dbtomador: TDBEdit;
    dtini: TcxDBDateEdit;
    dtfim: TcxDBDateEdit;
    DBEdit1: TDBEdit;
    Label161: TLabel;
    Label162: TLabel;
    DBEdit4: TDBEdit;
    DBEdit5: TDBEdit;
    ecodmodelo: TDBEdit;
    Label132: TLabel;
    edtCaminho: TEdit;
    Label133: TLabel;
    edtSenha: TEdit;
    edtserie: TEdit;
    edtsequencia: TEdit;
    Label163: TLabel;
    Label164: TLabel;
    edtchave: TcxDBTextEdit;
    ecliente: TRzDBButtonEdit;
    sGroupBox10: TsGroupBox;
    Label27: TLabel;
    Label28: TLabel;
    Label29: TLabel;
    Label30: TLabel;
    Label165: TLabel;
    cxDBTextEdit9: TcxDBTextEdit;
    cxDBTextEdit11: TcxDBTextEdit;
    cxDBTextEdit12: TcxDBTextEdit;
    cxDBTextEdit13: TcxDBTextEdit;
    cxDBTextEdit2: TcxDBTextEdit;
    sGroupBox11: TsGroupBox;
    Label31: TLabel;
    Label32: TLabel;
    Label34: TLabel;
    Label35: TLabel;
    Label36: TLabel;
    Label37: TLabel;
    Label38: TLabel;
    Label39: TLabel;
    Label40: TLabel;
    cxDBTextEdit10: TcxDBTextEdit;
    cxDBTextEdit14: TcxDBTextEdit;
    cxDBTextEdit15: TcxDBTextEdit;
    cxDBTextEdit16: TcxDBTextEdit;
    cxDBTextEdit17: TcxDBTextEdit;
    cxDBTextEdit18: TcxDBTextEdit;
    cxDBTextEdit19: TcxDBTextEdit;
    cxDBTextEdit20: TcxDBTextEdit;
    cxDBTextEdit21: TcxDBTextEdit;
    wwDBGrid1: TwwDBGrid;
    RzPanel2: TRzPanel;
    AdvGlowButton2: TAdvGlowButton;
    AdvGlowButton3: TAdvGlowButton;
    AdvGlowButton11: TAdvGlowButton;
    DBAdvGlowButton1: TDBAdvGlowButton;
    DBAdvGlowButton2: TDBAdvGlowButton;
    DBAdvGlowButton3: TDBAdvGlowButton;
    DBAdvGlowButton4: TDBAdvGlowButton;
    AdvGlowButton14: TAdvGlowButton;
    dspassagem: TDataSource;
    poptabelas: TPopupMenu;
    C1: TMenuItem;
    procedure bincluirClick(Sender: TObject);
    procedure balterarClick(Sender: TObject);
    procedure bexcluirClick(Sender: TObject);
    procedure bcancelarnfClick(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure BitBtn3Click(Sender: TObject);
    procedure BitBtn4Click(Sender: TObject);
    procedure BitBtn5Click(Sender: TObject);
    procedure BitBtn8Click(Sender: TObject);
    procedure BitBtn6Click(Sender: TObject);
    procedure bfecharClick(Sender: TObject);
    procedure bgravarClick(Sender: TObject);
    procedure bcancelarCTeClick(Sender: TObject);
    procedure ecfopKeyPress(Sender: TObject; var Key: Char);
    procedure ecfopExit(Sender: TObject);
    procedure ecfopEnter(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormShow(Sender: TObject);
    procedure eclienteExit(Sender: TObject);
    procedure eclienteKeyPress(Sender: TObject; var Key: Char);
    procedure eclienteEnter(Sender: TObject);
    procedure DBEdit2Enter(Sender: TObject);
    procedure DBEdit2Exit(Sender: TObject);
    procedure DBEdit2KeyPress(Sender: TObject; var Key: Char);
    procedure edata_cadastroEnter(Sender: TObject);
    procedure edata_cadastroExit(Sender: TObject);
    procedure edata_cadastroKeyPress(Sender: TObject; var Key: Char);
    procedure nrnfEnter(Sender: TObject);
    procedure nrnfExit(Sender: TObject);
    procedure nrnfKeyPress(Sender: TObject; var Key: Char);
    procedure DBComboBox2Exit(Sender: TObject);
    procedure EDESTINATARIOExit(Sender: TObject);
    procedure DBEdit9KeyPress(Sender: TObject; var Key: Char);
    procedure DBEdit11Exit(Sender: TObject);
    procedure DBEdit19Enter(Sender: TObject);
    procedure DBEdit20Exit(Sender: TObject);
    procedure DBEdit29KeyPress(Sender: TObject; var Key: Char);
    procedure blocveiculoClick(Sender: TObject);
    procedure eveiculoExit(Sender: TObject);
    procedure bloctransportadorClick(Sender: TObject);
    procedure etransportadorExit(Sender: TObject);
    procedure DBEdit40KeyPress(Sender: TObject; var Key: Char);
    procedure DBComboBox4KeyPress(Sender: TObject; var Key: Char);
    procedure DBEdit24Change(Sender: TObject);
    procedure blocalizarClick(Sender: TObject);
    procedure DBEdit5Exit(Sender: TObject);
    procedure DBEdit10Exit(Sender: TObject);
    procedure DBComboBox1Enter(Sender: TObject);
    procedure ecodmodeloButtonClick(Sender: TObject);
    procedure ecodmodeloKeyPress(Sender: TObject; var Key: Char);
    procedure edata_nfEnter(Sender: TObject);
    procedure evalor_nfExit(Sender: TObject);
    procedure emodelo_nfExit(Sender: TObject);
    procedure efilialButtonClick(Sender: TObject);
    procedure ecfopButtonClick(Sender: TObject);
    procedure eclienteButtonClick(Sender: TObject);
    procedure edestinatarioButtonClick(Sender: TObject);
    procedure DBCOMBOBOX2KeyPress(Sender: TObject; var Key: Char);
    procedure xCaracAdExit(Sender: TObject);
    procedure xCaracAdKeyPress(Sender: TObject; var Key: Char);
    procedure xtextofiscoKeyPress(Sender: TObject; var Key: Char);
    procedure DBEdit50Exit(Sender: TObject);
    procedure DBEdit52Exit(Sender: TObject);
    procedure btnGerarCTeClick(Sender: TObject);
    procedure btnSalvarConfigClick(Sender: TObject);
    procedure sbtnCaminhoCertClick(Sender: TObject);
    procedure sbtnGetCertClick(Sender: TObject);
    procedure sbtnLogoMarcaClick(Sender: TObject);
    procedure sbtnPathSalvarClick(Sender: TObject);
    procedure btnValidarXMLClick(Sender: TObject);
    procedure btnCriarEnviarClick(Sender: TObject);
    procedure btnImprimirClick(Sender: TObject);
    procedure btnStatusServClick(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button11Click(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure Button12Click(Sender: TObject);
    procedure Button6Click(Sender: TObject);
    procedure Button10Click(Sender: TObject);
    procedure Button8Click(Sender: TObject);
    procedure Button9Click(Sender: TObject);
    procedure btnEnvDPECClick(Sender: TObject);
    procedure btnConsultarDPECClick(Sender: TObject);
    procedure btnImportarXMLClick(Sender: TObject);
    procedure btnEnviarEmailClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure bt_nfe_statusClick(Sender: TObject);
    procedure bt_nfe_danfeClick(Sender: TObject);
    procedure bt_nfe_validarClick(Sender: TObject);
    procedure bt_nfe_exportarClick(Sender: TObject);
    procedure bt_logClick(Sender: TObject);
    procedure Localizar1Click(Sender: TObject);
    procedure rgtomadorClick(Sender: TObject);
    procedure bt_nfe_assinarClick(Sender: TObject);
    procedure locemiClick(Sender: TObject);
    procedure btiniprestClick(Sender: TObject);
    procedure bttermprestClick(Sender: TObject);
    procedure edtomadorButtonClick(Sender: TObject);
    procedure rgtomadorChange(Sender: TObject);
    procedure C1Click(Sender: TObject);
    procedure AdvGlowButton8Click(Sender: TObject);
    procedure AdvGlowButton10Click(Sender: TObject);
    procedure AdvGlowButton2Click(Sender: TObject);
    procedure PageView2Change(Sender: TObject);
    procedure PageView3Change(Sender: TObject);
  private
    function Gerar_XML(): string;
    { Private declarations }
  public
    { Public declarations }
    procedure GravarConfiguracao;
    procedure LerConfiguracao;
    procedure GerarCTe(NumCTe: string);
    procedure LoadXML(MyMemo: TMemo; MyWebBrowser: TWebBrowser);
  end;

var
  frmconhecimento: Tfrmconhecimento;

implementation

uses modulo, principal, loc_cfop, loc_filial, loc_cliente, loc_veiculo,
  loc_transportador, relnf, loc_conhecimento, conhecimento_impressao,
  xloc_modelo, compra, lista_conhecimento, FileCtrl, DateUtils, ACBrDFeUtil, ACBrCTeUtil,
  ACBrCTeConhecimentos, msg_Operador, email, pcteCTe, xloc_cidade,
  xloc_cliente, passagem_cte, cliente;

{$R *.dfm}

procedure Tfrmconhecimento.bincluirClick(Sender: TObject);
begin
  frmmodulo.qrconhecimento.insert;
  frmmodulo.qrconhecimento.fieldbyname('codigo').asstring := frmprincipal.codifica('000068');
  frmmodulo.qrconhecimento.fieldbyname('codfilial').asstring := '000001';
  frmmodulo.qrconhecimento.FieldByName('SERIE').AsString :=  frmPrincipal.zerarcodigo(frmmodulo.qrFilial.FieldByName('SERIE_CTE').AsString, 6);
  frmmodulo.qrconhecimento.FieldByName('numero').AsString := frmPrincipal.zerarcodigo(Frmmodulo.qrFilial.FieldByName('SEQ_CTE').AsString, 6);
  frmmodulo.qrconhecimento.FieldByName('data').AsDateTime :=Date;
  frmmodulo.qrconhecimento.FieldByName('modelo').AsString :='57';
  pficha.Enabled := true;
  pgravar.Visible := true;
  PopupMenu := pop2;
end;

procedure Tfrmconhecimento.balterarClick(Sender: TObject);
begin
  if ecfop.Text <> '' then
  begin
    frmmodulo.qrcfop.Locate('cfop', frmmodulo.qrconhecimento.fieldbyname('cfop').asstring, [loCaseInsensitive]);
    frmmodulo.qrconhecimento.Edit;
    frmmodulo.qrconhecimento.fieldbyname('codfilial').asstring := '000001';
    pficha.Enabled := true;
   // ecfop.setfocus;
    pgravar.Visible := true;
    ecodmodelo.Text := '57';
    PopupMenu := pop2;
  end
  else
  begin
    Showmessage('Nenhum registro foi selecionado!');
  end;
end;

procedure Tfrmconhecimento.bexcluirClick(Sender: TObject);
begin
  if frmprincipal.autentica('Excluir NF', 4) then
  begin
    frmmodulo.qrconhecimento.Delete;
    frmmodulo.Conexao.commit;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;

procedure Tfrmconhecimento.bcancelarnfClick(Sender: TObject);
begin
  if frmprincipal.autentica('Cancelar/Ativar', 4) then
  begin
    if frmmodulo.qrconhecimento.fieldbyname('situacao').AsInteger = 1 then
    begin
      if application.messagebox('Confirma o cancelamento deste conhecimento?', 'Atenção', mb_yesno + MB_ICONWARNING) = idyes then
      begin
        frmmodulo.qrconhecimento.edit;
        frmmodulo.qrconhecimento.FieldByName('motivo').asstring := inputbox('Cancelar', 'Informe o motivo do Cancelamento:', '');
        frmmodulo.qrconhecimento.fieldbyname('situacao').AsInteger := 2;
        frmmodulo.qrconhecimento.post;
        frmmodulo.Conexao.Commit;
      end;
    end
    else
    begin
      if application.messagebox('Este conhecimento está CANCELADO! Deseja ativá-lo?', 'Atenção', mb_yesno + mb_iconquestion) = idyes then
      begin
        frmmodulo.qrconhecimento.edit;
        frmmodulo.qrconhecimento.FieldByName('motivo').asstring := '';
        frmmodulo.qrconhecimento.fieldbyname('situacao').AsInteger := 1;
        frmmodulo.qrconhecimento.post;
        frmmodulo.Conexao.Commit;
      end;
    end;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;

procedure Tfrmconhecimento.BitBtn2Click(Sender: TObject);
begin
  frmmodulo.qrconhecimento.first;
end;

procedure Tfrmconhecimento.BitBtn3Click(Sender: TObject);
begin
  frmmodulo.qrconhecimento.prior;
end;

procedure Tfrmconhecimento.BitBtn4Click(Sender: TObject);
begin
  frmmodulo.qrconhecimento.next;
end;

procedure Tfrmconhecimento.BitBtn5Click(Sender: TObject);
begin
  frmmodulo.qrconhecimento.last;
end;

procedure Tfrmconhecimento.BitBtn8Click(Sender: TObject);
begin
  frmconhecimento_impressao := tfrmconhecimento_impressao.create(self);
  frmconhecimento_impressao.showmodal;


end;

procedure Tfrmconhecimento.BitBtn6Click(Sender: TObject);
begin
  frmlista_conhecimento := tfrmlista_conhecimento.create(self);
  frmlista_conhecimento.showmodal;
end;

procedure Tfrmconhecimento.bfecharClick(Sender: TObject);
begin
  CLOSE;
end;

procedure Tfrmconhecimento.bgravarClick(Sender: TObject);
var situacao, tipo, xseq: integer;
  DATA: string;
begin
  if ecfop.text = '' then
  begin
    application.messagebox('Favor informar o CFOP!', 'Erro', mb_ok + mb_iconerror);
    ecfop.setfocus;
    exit;
  end;

  if (dbedit2.text = '') or (dbedit2.text = '000000') then
  begin
    application.messagebox('Favor informar o Número!', 'Erro', mb_ok + mb_iconerror);
    dbedit2.setfocus;
    exit;
  end;

  if edata_cadastro.Date = StrToDate('30/12/1899') then
  begin
    application.messagebox('Favor informar a data!', 'Erro', mb_ok + mb_iconerror);
    edata_cadastro.setfocus;
    exit;
  end;


  if ecodmodelo.text = '' then
  begin
    application.messagebox('Favor informar o modelo!', 'Erro', mb_ok + mb_iconerror);
    ecodmodelo.setfocus;
    exit;
  end;
  ecodmodelo.Text := '57';

 { if (ecliente.text = '') or (ecliente.text = '000000') then
  begin
    application.messagebox('Favor informar o remetente!', 'Erro', mb_ok + mb_iconerror);
    ecliente.setfocus;
    exit;
  end; }

 { if (edestinatario.text = '') or (edestinatario.text = '000000') then
  begin
    application.messagebox('Favor informar o destinatário!', 'Erro', mb_ok + mb_iconerror);
    edestinatario.setfocus;
    exit;
  end;  }


  if (frmmodulo.qrconhecimento.State = dsinsert) or (frmmodulo.qrconhecimento.State = dsedit) then
  begin
    if frmmodulo.qrconhecimento.State = dsinsert then
    begin
      frmmodulo.qrconhecimento.FieldByName('situacao').asinteger := 1;
      frmmodulo.qrfilial.edit;
      xseq:= StrToInt(frmmodulo.qrfilial.fieldbyname('SEQ_CTE').AsString)+1;
      frmmodulo.qrfilial.fieldbyname('SEQ_CTE').AsString := IntToStr(xseq);
      frmmodulo.qrfilial.post;
    end;

      //SHOWMESSAGE(FRMMODULO.qrconhecimentoREDE_TIPO.AsString);

    frmmodulo.qrconhecimento.post;
  end;
  frmmodulo.Conexao.Commit;
  pficha.Enabled := false;
  pgravar.Visible := false;
  PopupMenu := pop1;
  bincluir.setfocus;

//     panel2.Enabled := false;
//     panel1.Enabled := false;
//     panel_item.visible := true;



  PageView1.ActivePageIndex := 0;


  BitBtn8Click(frmconhecimento);


end;

procedure Tfrmconhecimento.bcancelarCTeClick(Sender: TObject);
begin
  if (frmmodulo.qrconhecimento.State = dsinsert) or (frmmodulo.qrconhecimento.State = dsedit) then
    frmmodulo.qrconhecimento.cancel;


  frmmodulo.Conexao.Rollback;

  FRMMODULO.qrconhecimento.Refresh;


  pficha.Enabled := false;
  pgravar.Visible := false;
  PopupMenu := pop1;
  bincluir.setfocus;


//     panel2.Enabled := false;
//     panel1.Enabled := false;
//     panel_item.visible := true;

  PageView1.ActivePageIndex := 0;


end;


procedure Tfrmconhecimento.ecfopKeyPress(Sender: TObject; var Key: Char);
begin
  if key = #13 then perform(wm_nextdlgctl, 0, 0);
end;

procedure Tfrmconhecimento.ecfopExit(Sender: TObject);
begin
  tedit(sender).Color := clwindow;
  if (frmmodulo.qrconhecimento.state = dsinsert) or (frmmodulo.qrconhecimento.State = dsedit) then
  begin
    if ecfop.text <> '' then
    begin
      if not FrmPrincipal.Locregistro(frmmodulo.qrcfop, ecfop.text, 'cfop') then ecfopbuttonclick(frmconhecimento)
      else
      begin

        FRMMODULO.qrconhecimento.FieldByName('INF1').ASSTRING := FRMMODULO.qrCFOP.FIELDBYNAME('OBS1').ASSTRING;
        FRMMODULO.qrconhecimento.FieldByName('INF2').ASSTRING := FRMMODULO.qrCFOP.FIELDBYNAME('OBS2').ASSTRING;
        FRMMODULO.qrconhecimento.FieldByName('INF3').ASSTRING := FRMMODULO.qrCFOP.FIELDBYNAME('OBS3').ASSTRING;
        FRMMODULO.qrconhecimento.FieldByName('INF4').ASSTRING := FRMMODULO.qrCFOP.FIELDBYNAME('OBS4').ASSTRING;

        //ECLIENTE.setfocus;
      end;
    end
    else
      ecfopButtonClick(frmconhecimento);

  end;
end;

procedure Tfrmconhecimento.ecfopEnter(Sender: TObject);
begin
  tedit(sender).Color := $00A8FFFF;
end;

procedure Tfrmconhecimento.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  action := cafree;
end;

procedure Tfrmconhecimento.FormShow(Sender: TObject);
begin
//  panel_item.top := 194;
//  panel_item.left := 4;


  //Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  pgravar.visible := false;
  pgravar.Align := alClient;

  frmmodulo.qrtransportador.close;
  frmmodulo.qrtransportador.sql.clear;
  frmmodulo.qrtransportador.SQL.add('select * from c000010 order by nome');
  frmmodulo.qrtransportador.open;
  frmmodulo.qrtransportador.IndexFieldNames := 'nome';

  frmmodulo.qrcliente.close;
  frmmodulo.qrcliente.sql.clear;
  frmmodulo.qrcliente.SQL.add('select * from c000007 order by nome');
  frmmodulo.qrcliente.open;
  frmmodulo.qrcliente.IndexFieldNames := 'nome';

  frmmodulo.qrfilial.close;
  frmmodulo.qrfilial.sql.clear;
  frmmodulo.qrfilial.SQL.add('select * from c000004 order by filial');
  frmmodulo.qrfilial.open;

  frmmodulo.qrcfop.close;
  frmmodulo.qrcfop.sql.clear;
  frmmodulo.qrcfop.SQL.add('select * from c000030 where tipo = 2 order by NATUREZA');
  frmmodulo.qrcfop.open;
  frmmodulo.qrcfop.IndexFieldNames := 'NATUREZA';

  frmmodulo.qrconhecimento.close;
  frmmodulo.qrconhecimento.SQL.clear;
  frmmodulo.qrconhecimento.SQL.add('select * from c000068 order by numero');
  frmmodulo.qrconhecimento.open;
  frmmodulo.qrconhecimento.last;

  pficha.ActivePageIndex := 0;
  pficha.Enabled := false;
  bincluir.SetFocus;
  LerConfiguracao;

end;

procedure Tfrmconhecimento.eclienteExit(Sender: TObject);
begin
  {tedit(sender).Color := clwindow;
  if (frmmodulo.qrconhecimento.state = dsinsert) or (frmmodulo.qrconhecimento.State = dsedit) then
  begin
    frmmodulo.qrconhecimento.fieldbyname('CODREMETENTE').asstring := frmprincipal.zerarcodigo(ecliente.text, 6);
    if ecliente.text <> '000000' then
    begin
      if not FrmPrincipal.Locregistro(frmmodulo.qrcliente, ecliente.text, 'codigo') then
      begin
        eclientebuttonclick(frmconhecimento)
      end
      else
      begin
        eDESTINATARIO.SetFocus;
      end;
    end
    else
      eclientebuttonclick(frmconhecimento);
  end;  }
end;

procedure Tfrmconhecimento.eclienteKeyPress(Sender: TObject;
  var Key: Char);
begin
  if key = #13 then perform(wm_nextdlgctl, 0, 0);
end;

procedure Tfrmconhecimento.eclienteEnter(Sender: TObject);
begin
  tedit(sender).color := $00A8FFFF;
end;

procedure Tfrmconhecimento.DBEdit2Enter(Sender: TObject);
begin
  tedit(sender).color := $00A8FFFF;
end;

procedure Tfrmconhecimento.DBEdit2Exit(Sender: TObject);
begin
  tedit(sender).color := clwindow;
end;

procedure Tfrmconhecimento.DBEdit2KeyPress(Sender: TObject; var Key: Char);
begin
  if key = #13 then perform(wm_nextdlgctl, 0, 0);
end;

procedure Tfrmconhecimento.edata_cadastroEnter(Sender: TObject);
begin
  tedit(SENDER).Color := $00A8FFFF;
  if edata_cadastro.text = '  /  /    ' then edata_cadastro.date := date;
end;

procedure Tfrmconhecimento.edata_cadastroExit(Sender: TObject);
begin
  tedit(sender).color := clwindow;
end;

procedure Tfrmconhecimento.edata_cadastroKeyPress(Sender: TObject;
  var Key: Char);
begin
  if key = #13 then perform(wm_nextdlgctl, 0, 0);
end;

procedure Tfrmconhecimento.nrnfEnter(Sender: TObject);
begin
  tedit(sender).color := $00A8FFFF;
end;

procedure Tfrmconhecimento.nrnfExit(Sender: TObject);
begin
  tedit(sender).color := clwindow;
end;

procedure Tfrmconhecimento.nrnfKeyPress(Sender: TObject; var Key: Char);
begin
  if key = #13 then perform(wm_nextdlgctl, 0, 0);
end;

procedure Tfrmconhecimento.DBComboBox2Exit(Sender: TObject);
begin
  tedit(sender).color := clwindow;
  if TEDIT(SENDER).Text <> '' then
    if tedit(sender).Text <> 'PAGO' then
      if tedit(sender).Text <> 'A PAGAR' then
      begin
        Showmessage('Favor informar PAGO ou A PAGAR!');
      end;
end;

procedure Tfrmconhecimento.EDESTINATARIOExit(Sender: TObject);
begin
 { tedit(sender).Color := clwindow;
  if (frmmodulo.qrconhecimento.state = dsinsert) or (frmmodulo.qrconhecimento.State = dsedit) then
  begin
    frmmodulo.qrconhecimento.fieldbyname('CODDESTINATARIO').asstring := frmprincipal.zerarcodigo(EDESTINATARIO.text, 6);
    if EDESTINATARIO.text <> '000000' then
    begin
      if not FrmPrincipal.Locregistro(frmmodulo.qrcliente, EDESTINATARIO.text, 'codigo') then
      begin
        edestinatariobuttonclick(frmconhecimento)
      end
      else
      begin
        PAGEVIEW1.ActivePageIndex := 0;
        COMBOCARGA.SETFOCUS;
      end;
    end
    else
      edestinatariobuttonclick(frmconhecimento);
  end; }
end;

procedure Tfrmconhecimento.DBEdit9KeyPress(Sender: TObject; var Key: Char);
begin
  if KEY = #13 then
  begin
    PageView1.ActivePageIndex := 1;
//    DBEDIT10.SETFOCUS;
  end;
end;

procedure Tfrmconhecimento.DBEdit11Exit(Sender: TObject);
begin
  TEDIT(SENDER).COLOR := CLWINDOW;
  frmmodulo.qrconhecimento.fieldbyname('frete_total').asfloat :=
    frmmodulo.qrconhecimento.fieldbyname('frete_valor').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_adicional').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_seguro').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_despacho').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_outros').asfloat;



end;

procedure Tfrmconhecimento.DBEdit19Enter(Sender: TObject);
begin
  tedit(sender).color := $00A8FFFF;
  if frmmodulo.qrconhecimento.FieldByName('frete_base').asfloat = 0 then
  begin
    frmmodulo.qrconhecimento.FieldByName('frete_base').asfloat :=
      frmmodulo.qrconhecimento.FieldByName('frete_valor').asfloat;

  end;
  TEDIT(SENDER).SELECTALL;
end;

procedure Tfrmconhecimento.DBEdit20Exit(Sender: TObject);
begin
  tedit(sender).Color := clwindow;
  if frmmodulo.qrconhecimento.FieldByName('frete_aliquota').asinteger <> 0 then
  begin
    frmmodulo.qrconhecimento.FieldByName('frete_icms').asfloat :=
      frmmodulo.qrconhecimento.FieldByName('frete_base').asfloat *
      (frmmodulo.qrconhecimento.FieldByName('frete_aliquota').asfloat / 100);

  end;


end;

procedure Tfrmconhecimento.DBEdit29KeyPress(Sender: TObject;
  var Key: Char);
begin
  if key = #13 then
  begin
    PageView1.ActivePageindex := 2;
   // eveiculo.setfocus;
  end;
end;

procedure Tfrmconhecimento.blocveiculoClick(Sender: TObject);
begin
  frmloc_veiculo := tfrmloc_veiculo.create(self);
  frmloc_veiculo.showmodal;
  frmmodulo.qrconhecimento.fieldbyname('CODveiCulo').asstring := frmmodulo.qrveiculo.fieldbyname('CODIGO').asstring;
  frmmodulo.qrconhecimento.fieldbyname('VEICULO_UF').asstring := frmmodulo.qrveiculo.fieldbyname('UFPLACA').asstring;
  frmmodulo.qrconhecimento.fieldbyname('VEICULO_LOCAL').asstring := frmmodulo.qrveiculo.fieldbyname('CIDADE').asstring;

 // dbedit32.setfocus;
end;

procedure Tfrmconhecimento.eveiculoExit(Sender: TObject);
begin
{  tedit(sender).Color := clwindow;
  if (frmmodulo.qrconhecimento.state = dsinsert) or (frmmodulo.qrconhecimento.State = dsedit) then
  begin
    frmmodulo.qrconhecimento.fieldbyname('CODveiculo').asstring := frmprincipal.zerarcodigo(eveiculo.text, 6);
    if eveiculo.text <> '000000' then
    begin
      if not FrmPrincipal.Locregistro(frmmodulo.qrveiculo, eveiculo.text, 'codigo') then
      begin
        blocveiculoclick(frmconhecimento)
      end
      else
      begin
        frmmodulo.qrconhecimento.fieldbyname('VEICULO_UF').asstring := frmmodulo.qrveiculo.fieldbyname('UFPLACA').asstring;
        frmmodulo.qrconhecimento.fieldbyname('VEICULO_LOCAL').asstring := frmmodulo.qrveiculo.fieldbyname('CIDADE').asstring;
        dbedit32.SetFocus;
      end;
    end
    else
      blocveiculo.SetFocus;
  end;  }
end;

procedure Tfrmconhecimento.bloctransportadorClick(Sender: TObject);
begin
  frmloc_transportador := tfrmloc_transportador.create(self);
  frmloc_transportador.showmodal;
  frmmodulo.qrconhecimento.fieldbyname('CODTRANSPORTADOR').asstring := frmmodulo.qrtransportador.fieldbyname('CODIGO').asstring;

  pageview1.ActivePageIndex := 3;
 // dbedit36.setfocus;
end;

procedure Tfrmconhecimento.etransportadorExit(Sender: TObject);
begin
  {tedit(sender).Color := clwindow;
  if (frmmodulo.qrconhecimento.state = dsinsert) or (frmmodulo.qrconhecimento.State = dsedit) then
  begin
    frmmodulo.qrconhecimento.fieldbyname('CODtransportador').asstring := frmprincipal.zerarcodigo(etransportador.text, 6);
    if etransportador.text <> '000000' then
    begin
      if not FrmPrincipal.Locregistro(frmmodulo.qrtransportador, etransportador.text, 'codigo') then
      begin
        bloctransportadorclick(frmconhecimento)
      end
      else
      begin
        pageview1.ActivePageIndex := 3;
        dbedit36.setfocus;
      end;
    end
    else
      bloctransportador.SetFocus;
  end; }

end;

procedure Tfrmconhecimento.DBEdit40KeyPress(Sender: TObject;
  var Key: Char);
begin
  if key = #13 then
  begin
    PageView1.ActivePageIndex := 4;
  //  dbedit41.SetFocus;
  end;
end;

procedure Tfrmconhecimento.DBComboBox4KeyPress(Sender: TObject;
  var Key: Char);
begin
  if key = #13 then
  begin
    pageview1.ActivePageIndex := 5;
//    dbmemo1.SetFocus;
  end;
end;

procedure Tfrmconhecimento.DBEdit24Change(Sender: TObject);
begin
  try

    if frmmodulo.qrconhecimento.fieldbyname('situacao').asinteger = 2 then
    else
  except
  end;
end;

procedure Tfrmconhecimento.blocalizarClick(Sender: TObject);
begin
  frmloc_conhecimento := tfrmloc_conhecimento.create(self);
  frmloc_conhecimento.showmodal;
end;

procedure Tfrmconhecimento.DBEdit5Exit(Sender: TObject);
begin
  tedit(sender).color := clwindow;

  frmmodulo.qrconhecimento.FieldByName('FRETE_VALOR').asfloat :=
    frmmodulo.qrconhecimento.FieldByName('CARGA_QTDE').asfloat *
    frmmodulo.qrconhecimento.FieldByName('FRETE_PESO').asfloat;

  frmmodulo.qrconhecimento.fieldbyname('frete_total').asfloat :=
    frmmodulo.qrconhecimento.fieldbyname('frete_valor').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_adicional').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_seguro').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_despacho').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_outros').asfloat;
end;

procedure Tfrmconhecimento.DBEdit10Exit(Sender: TObject);
begin
  tedit(sender).color := clwindow;

  frmmodulo.qrconhecimento.FieldByName('FRETE_VALOR').asfloat :=
    frmmodulo.qrconhecimento.FieldByName('CARGA_QTDE').asfloat *
    frmmodulo.qrconhecimento.FieldByName('FRETE_PESO').asfloat;

  frmmodulo.qrconhecimento.fieldbyname('frete_total').asfloat :=
    frmmodulo.qrconhecimento.fieldbyname('frete_valor').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_adicional').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_seguro').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_despacho').asfloat +
    frmmodulo.qrconhecimento.fieldbyname('frete_outros').asfloat;

end;

procedure Tfrmconhecimento.DBComboBox1Enter(Sender: TObject);
begin
//  IF DBCOMBOBOX1.TEXT = '' THEN
 //   FRMMODULO.qrconhecimento.FieldBYNAME('LOCAL').AsString :=  emitente_cidade;
end;

procedure Tfrmconhecimento.ecodmodeloButtonClick(Sender: TObject);
begin
  resultado_pesquisa1 := '';
  parametro_pesquisa := '';
  frmxloc_modelo := tfrmxloc_modelo.create(self);
  frmxloc_modelo.showmodal;
  if resultado_pesquisa1 <> '' then
  begin

    qrmodelo.close;
    qrmodelo.sql.clear;
    qrmodelo.sql.add('select * from c000082 where sintegra = ''' + resultado_pesquisa1 + '''');
    qrmodelo.open;
    frmmodulo.qrconhecimento.fieldbyname('modelo').asstring := resultado_pesquisa1;
    frmmodulo.qrconhecimento.fieldbyname('especie').asstring := qrmodelo.fieldbyname('sigla').asstring;
   // eSERIE.setfocus;
  end;
end;

procedure Tfrmconhecimento.ecodmodeloKeyPress(Sender: TObject;
  var Key: Char);
begin
 { if key = #13 then
  begin
    if frmmodulo.qrconhecimento.State <> dsedit then if frmmodulo.qrconhecimento.State <> dsinsert then exit;

    frmmodulo.qrconhecimento.fieldbyname('modelo').asstring := frmprincipal.zerarcodigo(tedit(sender).Text, 2);
    if tedit(sender).Text <> '00' then
    begin
      qrmodelo.close;
      qrmodelo.sql.clear;
      qrmodelo.sql.add('select * from c000082 where sintegra = ''' + ecodmodelo.text + '''');
      qrmodelo.open;

      qrmodelo.close;
      qrmodelo.sql.clear;
      qrmodelo.sql.add('select * from c000082 where sintegra = ''' + ecodmodelo.text + '''');
      qrmodelo.open;

      if qrmodelo.recordcount > 0 then
      begin
        frmmodulo.qrconhecimento.fieldbyname('especie').asstring := qrmodelo.fieldbyname('sigla').asstring;
        Perform(wm_nextdlgctl, 0, 0);
        eserie.SetFocus;
      end
      else
      begin
        application.messagebox('Modelo não cadastrado!', 'Aviso', mb_ok + mb_iconwarning);
        ecodmodelo.setfocus;
      end;

    end
    else
    begin
      ecodmodeloButtonClick(frmcompra);
    end;
  end; }

end;

procedure Tfrmconhecimento.edata_nfEnter(Sender: TObject);
begin
  tedit(SENDER).Color := $00A8FFFF;
  //if edata_nf.text = '  /  /    ' then edata_nf.date := date;

end;

procedure Tfrmconhecimento.evalor_nfExit(Sender: TObject);
begin
  tedit(sender).color := clwindow;
  if frmmodulo.qrconhecimento.FieldByName('valor_conhecimento').AsFloat = 0 then
  begin
    Application.messagebox('Não Informado o Valor da Nota Fiscal, Verifique!', 'Conecimento!', mb_ok + MB_ICONWARNING);
   // evalor_nf.SetFocus;
    exit;
  end;
end;

procedure Tfrmconhecimento.emodelo_nfExit(Sender: TObject);
begin
  tedit(sender).color := clwindow;

  if frmmodulo.qrconhecimento.FieldByName('modelo_nf').AsString = '55' then
  begin
    if OpenDialog1.Execute then
    begin
     // chave1.Text := OpenDialog1.FileName;
    end;
  end;


end;

procedure Tfrmconhecimento.efilialButtonClick(Sender: TObject);
begin
  frmloc_filial := tfrmloc_filial.create(self);
  frmloc_filial.showmodal;
  frmmodulo.qrconhecimento.fieldbyname('codfilial').asstring := resultado_pesquisa1;

  FRMMODULO.QRCONHECIMENTO.FIELDBYNAME('LOCAL').ASSTRING := FRMMODULO.QRFILIAL.FIELDBYNAME('CIDADE').ASSTRING + '/' +
    FRMMODULO.QRFILIAL.FIELDBYNAME('UF').ASSTRING;

  if frmmodulo.qrconhecimento.State = dsinsert then
  begin
    frmmodulo.qrconhecimento.FieldByName('numero').asstring :=
      frmprincipal.zerarcodigo(frmmodulo.qrFilial.fieldbyname('CONHECIMENTO').asstring, 6);

  end;

end;

procedure Tfrmconhecimento.ecfopButtonClick(Sender: TObject);
begin
  frmloc_cfop := tfrmloc_cfop.create(self);
  frmloc_cfop.showmodal;
  frmmodulo.qrconhecimento.fieldbyname('cfop').asstring := frmmodulo.qrcfop.fieldbyname('cfop').asstring;
 // ECLIENTE.setfocus;
end;

procedure Tfrmconhecimento.eclienteButtonClick(Sender: TObject);
begin
  frmloc_cliente := tfrmloc_cliente.create(self);
  frmloc_cliente.showmodal;
  frmmodulo.qrconhecimento.fieldbyname('CODREMETENTE').asstring := frmmodulo.qrcliente.fieldbyname('CODIGO').asstring;
//  eDESTINATARIO.setfocus;
end;

procedure Tfrmconhecimento.edestinatarioButtonClick(Sender: TObject);
begin
  frmloc_cliente := tfrmloc_cliente.create(self);
  frmloc_cliente.showmodal;
  frmmodulo.qrconhecimento.fieldbyname('CODDESTINATARIO').asstring := frmmodulo.qrcliente.fieldbyname('CODIGO').asstring;

end;

procedure Tfrmconhecimento.DBCOMBOBOX2KeyPress(Sender: TObject;
  var Key: Char);
begin
  if KEY = #13 then
  begin
    PAGEVIEW1.ActivePageIndex := 0;
    //COMBOCARGA.SETFOCUS;
  end;
end;

procedure Tfrmconhecimento.xCaracAdExit(Sender: TObject);
begin
  TEDIT(SENDER).COLOR := CLWINDOW;
end;

procedure Tfrmconhecimento.xCaracAdKeyPress(Sender: TObject; var Key: Char);
begin
  if KEY = #13 then PERFORM(WM_NEXTDLGCTL, 0, 0);
end;

procedure Tfrmconhecimento.xtextofiscoKeyPress(Sender: TObject;
  var Key: Char);
begin
  if KEY = #13 then BGRAVAR.SETFOCUS;
end;

procedure Tfrmconhecimento.DBEdit50Exit(Sender: TObject);
begin
  tedit(sender).color := clwindow;


end;

procedure Tfrmconhecimento.DBEdit52Exit(Sender: TObject);
begin
  tedit(sender).color := clwindow;
end;

procedure Tfrmconhecimento.btnGerarCTeClick(Sender: TObject);
var
  vAux: string;
begin
  //Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  if not (InputQuery('WebServices Enviar', 'Numero do Conhecimento', vAux))
    then exit;

    //gerar o xml
  GerarCTe(vAux);

  Cte.Conhecimentos.Items[0].SaveToFile;
  //edtchave.text := copy(cte.Conhecimentos.Items[0].CTe.infCTe.ID, 4, 44);
  ShowMessage('Arquivo gerado em: ' + Cte.Conhecimentos.Items[0].NomeArq);
 // PageControl2.ActivePageIndex := 1;
  MemoDados.Lines.Add('Arquivo gerado em: ' + Cte.Conhecimentos.Items[0].NomeArq);
  MemoResp.Lines.LoadFromFile(Cte.Conhecimentos.Items[0].NomeArq);
  LoadXML(MemoResp, WBResposta);
end;

procedure Tfrmconhecimento.GerarCTe(NumCTe: string);
var
  i, j, CodigoMunicipio, Tomador: Integer;
begin

  try


 // O código abaixo faz parte da minha aplicação devendo ser feitas as alterações
 // necessárias para ser utilizado na sua.
    qrempresa.close;
    qrempresa.sql.clear;
    qrempresa.sql.add('select * from c000004');
    //mizael
   // qrempresa.sql.add('where codigo = ''' + efilial.Text + '''');
    qrempresa.open;

    qrcliente2.close;
    qrcliente2.sql.clear;
    qrcliente2.sql.add('select * from c000007');
    qrcliente2.sql.add('where codigo = ''' + ecliente.Text + '''');
    qrcliente2.open;

    qrdest.close;
    qrdest.sql.clear;
    qrdest.sql.add('select * from c000007');
    qrdest.sql.add('where codigo = ''' + edestinatario.Text + '''');
    qrdest.open;


    with CTe.Conhecimentos.Add.CTe do
    begin
   //
   // Dados de Identificação do CT-e
   //

      if qrempresaUF.Text = 'SC' then Ide.cUF := 42
      else
        if qrempresaUF.Text = 'SP' then Ide.cUF := 35;


      Ide.cCT := StrToInt(DBEdit2.text); // Código Aleatório
      Ide.CFOP := StrToInt(ecfop.text);
      Ide.natOp := DBEdit21.Text;

      if DBCOMBOBOX2.ItemIndex = 1 then Ide.forPag := fpPago
      else Ide.forPag := fpAPagar;


      Ide.modelo := ecodmodelo.Text;
      Ide.serie := StrToInt(eserie.Text);
      Ide.nCT := StrToInt(DBEdit2.Text);
      Ide.dhEmi := Now;
      Ide.tpImp := tiRetrato;

   // TpcnTipoEmissao = (teNormal, teContingencia, teSCAN, teDPEC, teFSDA);
      case rgFormaEmissao.ItemIndex of
        0: Ide.tpEmis := teNormal;
        1: Ide.tpEmis := teContingencia;
        2: Ide.tpEmis := teSCAN;
        3: Ide.tpEmis := teDPEC;
        4: Ide.tpEmis := teFSDA;
      end;


   // TpcnTipoAmbiente = (taProducao, taHomologacao);
      case rgTipoAmb.ItemIndex of
        0: Ide.tpAmb := taProducao;
        1: Ide.tpAmb := taHomologacao;
      end;


   // TpcteTipoCTe = (tcNormal, tcComplemento, tcAnulacao, tcSubstituto);
   { case  of
      0: Ide.tpCTe := tcNormal;
      1: Ide.tpCTe := tcComplemento;
      2: Ide.tpCTe := tcAnulacao;
      3: Ide.tpCTe := tcSubstituto;
    end;}

      Ide.tpCTe := tcNormal;
   // TpcnProcessoEmissao = (peAplicativoContribuinte, peAvulsaFisco, peAvulsaContribuinte, peContribuinteAplicativoFisco);
      Ide.procEmi := peAplicativoContribuinte;
      Ide.verProc := '4.0';
   // Ide.refCTE:=''; // Chave de Acesso do CT-e Referenciado
      Ide.cMunEnv := StrToInt(qrempresaCOD_MUNICIPIO_IBGE.Text);
      Ide.xMunEnv := qrempresaCIDADE.Text;
      Ide.UFEnv := qrempresaUF.Text;

   // TpcteModal = (mdRodoviario, mdAereo, mdAquaviario, mdFerroviario, mdDutoviario);
      Ide.modal := mdRodoviario;
   // TpcteTipoServico = (tsNormal, tsSubcontratacao, tsRedespacho, tsIntermediario);
    {case DM_CNT.Conhec2TipoServico.AsInteger of
      0: Ide.tpServ := tsNormal;
      1: Ide.tpServ := tsSubcontratacao;
      2: Ide.tpServ := tsRedespacho;
      3: Ide.tpServ := tsIntermediario;
    end;  }
      Ide.tpServ := tsNormal;
      showmessage('27');
   // Origem da Prestação
      Ide.cMunIni := StrToInt(cMunIni.Text);
      Ide.xMunIni := xMunIni.Text;
      Ide.UFIni := UFini.Text;

      showmessage('28');
   // Destino da Prestação
      Ide.cMunFim := StrToInt(cMunFim.Text);
      Ide.xMunFim := xMunFim.Text;
      Ide.UFFim := UFFim.Text;

   // TpcteRetira = (rtSim, rtNao);
      Ide.retira := rtSim;
      Ide.xdetretira := qrcliente2UF.Text;
      showmessage('29');

    //contratante = tomador

      case rgtomador.ItemIndex of
        0: Ide.Toma03.Toma := tmRemetente;
        1: Ide.Toma03.Toma := tmExpedidor;
        2: Ide.Toma03.Toma := tmRecebedor;
        3: Ide.Toma03.Toma := tmDestinatario;
        4: Ide.Toma03.Toma := tmOutros;
      end;
      showmessage('30');

   // Totamdor do Serviço no CTe 4 = Outros
      if rgtomador.ItemIndex = 4 then
      begin
        qrcliente2.close;
        qrcliente2.sql.clear;
        qrcliente2.sql.add('select * from c000007');
        qrcliente2.sql.add('where codigo = ''' + edtomador.Text + '''');
        qrcliente2.open;


        Ide.Toma4.Toma := tmOutros;

        if qrcliente2TIPO.AsInteger = 2
          then begin
          Ide.Toma4.CNPJCPF := qrcliente2CPF.AsString;
          Ide.toma4.IE := qrcliente2RG.asstring;
        end
        else begin
          Ide.Toma4.CNPJCPF := qrcliente2CPF.AsString;
          Ide.toma4.IE := 'ISENTO';
        end;

        Ide.Toma4.xNome := dbtomador.Text;
        Ide.Toma4.xFant := dbtomador.Text;
        Ide.Toma4.fone := qrcliente2TELEFONE1.AsString;
        Ide.Toma4.EnderToma.xLgr := qrcliente2ENDERECO.AsString;
        Ide.Toma4.EnderToma.nro := qrcliente2NUMERO.AsString;
        Ide.Toma4.EnderToma.xCpl := qrcliente2COMPLEMENTO.AsString;
        Ide.Toma4.EnderToma.xBairro := qrcliente2BAIRRO.AsString;
        Ide.Toma4.EnderToma.cMun := StrToInt(qrcliente2COD_MUNICIPIO_IBGE.Text);
        Ide.Toma4.EnderToma.xMun := qrcliente2CIDADE.AsString;
        Ide.Toma4.EnderToma.CEP := StrToInt(frmPrincipal.somenteNumero(qrcliente2CEP.AsString));
        Ide.Toma4.EnderToma.UF := qrcliente2UF.Text;
        Ide.Toma4.EnderToma.cPais := 1058;
        Ide.Toma4.EnderToma.xPais := 'Brasil';
      end;



   //
   //  Informações Complementares do CTe
   //
      compl.xCaracAd := xCaracAd.Text;
      compl.xCaracSer := xCaracSer.Text;
      compl.xEmi := frmmodulo.qrusuario.fieldbyname('usuario').asstring;

      compl.fluxo.xOrig := qrempresaCODIGO.Text;

      compl.fluxo.xDest := '';
      compl.fluxo.xRota := '';
    //TpcteTipoDataPeriodo = (tdSemData, tdNaData, tdAteData, tdApartirData, tdNoPeriodo);

      //final
      showmessage('3');
      case rgdataentrega.itemindex of
        0: begin
            compl.Entrega.semData.tpPer := tdSemData;
            compl.Entrega.TipoData := tdSemData;
          end;
        1: begin
            compl.Entrega.comData.tpPer := tdNaData;
            compl.Entrega.comData.dProg := StrToDate(FormatDateTime('yyyy/mm/dd', dtini.Date));
            compl.Entrega.TipoData := tdNaData;
          end;
        2: begin
            compl.Entrega.comData.tpPer := tdAteData;
            compl.Entrega.comData.dProg := StrToDate(FormatDateTime('dd/mm/yyyy', dtini.Date));
            compl.Entrega.TipoData := tdAteData;
          end;
        3: begin
            compl.Entrega.comData.tpPer := tdApartirData;
            compl.Entrega.comData.dProg := StrToDate(FormatDateTime('dd/mm/yyyy', dtini.Date));
            compl.Entrega.TipoData := tdApartirData;
          end;
        4: begin
            compl.Entrega.noPeriodo.tpPer := tdNoPeriodo;
            compl.Entrega.noPeriodo.dIni := StrToDate(FormatDateTime('dd/mm/yyyy', dtini.Date));
            compl.Entrega.noPeriodo.dFim := StrToDate(FormatDateTime('dd/mm/yyyy', dtfim.Date));
          end;
      end;

      showmessage('4');
      case rghora.itemindex of
        0: compl.Entrega.semHora.tpHor := thSemHorario;
        1: begin
            compl.Entrega.comHora.tpHor := thNoHorario;
            compl.Entrega.comHora.hProg := hrini.time;
          end;
        2: begin
            compl.Entrega.comHora.tpHor := thAteHorario;
            compl.Entrega.comHora.hProg := hrini.time;
          end;
        3: begin
            compl.Entrega.comHora.tpHor := thApartirHorario;
            compl.Entrega.comHora.hProg := hrini.time;
          end;
        4: begin
            compl.Entrega.noInter.tpHor := thNoIntervalo;
            compl.Entrega.noInter.hIni := hrini.time;
            compl.Entrega.noInter.hFim := hrfim.time;
          end;
      end;

      compl.origCalc := xmunini.text;
      compl.destCalc := xmunfim.text;
      compl.xObs := xObs.lines.Text;

    {DM_CNT.Tabelas.Close;
    DM_CNT.Tabelas.SQL.Clear;
    DM_CNT.Tabelas.SQL.Add('Select * From Cnt_Tabelas');
    DM_CNT.Tabelas.SQL.Add('Where Codigo = :xTabela');
    DM_CNT.Tabelas.Params[0].AsString := DM_CNT.ParametrosTabela.AsString;
    DM_CNT.Tabelas.Active := True;
    DM_CNT.Tabelas.Open;}

      if qrempresaOPTANTE_SIMPLES.Text = 'S' then
        compl.xObs := compl.xObs +
          'Documento emitido por ME ou EPP optante pelo Simples Nacional' +
          'Nao gera direito a credito fiscal de ICMS';

      with Compl.ObsCont.Add do
      begin
        xCampo := 'Contato de Entrega';
        //mizael
        //xTexto := Self.xTexto.lines.Text;
      end;


      with compl.ObsFisco.Add do
      begin
        xCampo := 'Contato de Entrega';
        //mizael
       // xTexto := Self.xtextofisco.Text;
      end;

      showmessage('5');
   //
   // Dados do Emitente
   //

      Emit.CNPJ := qrempresaCNPJ.AsString;

      if (qrempresaIE.Text = '') or
        (qrempresaIE.Text = 'ISENTO') then Emit.IE := '999999999'
      else Emit.IE := qrempresaIE.Text;

      Emit.xNome := qrempresaFILIAL.AsString;
      Emit.xFant := qrempresaFILIAL.AsString;
      Emit.EnderEmit.xLgr := qrempresaENDERECO.AsString;
      Emit.EnderEmit.nro := qrempresaNUMERO.AsString;
      Emit.EnderEmit.xCpl := qrempresaCOMPLEMENTO.AsString;
      Emit.EnderEmit.xBairro := qrempresaBAIRRO.AsString;

      CodigoMunicipio := 42 * 100000 +
        4218707;
      Emit.EnderEmit.cMun := StrToInt(qrempresaCOD_MUNICIPIO_IBGE.Text);
      Emit.EnderEmit.xMun := qrempresaCIDADE.Text;
      Emit.EnderEmit.CEP := StrToInt(frmprincipal.somenteNumero(qrempresaCEP.AsString));
      Emit.EnderEmit.UF := qrempresaUF.AsString;
      Emit.EnderEmit.fone := qrempresaTELEFONE.AsString;

   //
   //  Dados do Remetente
   //
      qrcliente2.close;
      qrcliente2.sql.clear;
      qrcliente2.sql.add('select * from c000007');
      qrcliente2.sql.add('where codigo = ''' + ecliente.Text + '''');
      qrcliente2.open;

      if qrcliente2.RecordCount <> 0 then
      begin
        Rem.xNome := qrcliente2NOME.AsString;
        Rem.xFant := qrcliente2APELIDO.AsString;
        Rem.EnderReme.xLgr := qrcliente2ENDERECO.AsString;
        Rem.EnderReme.nro := qrcliente2NUMERO.AsString;
        Rem.EnderReme.xCpl := qrcliente2COMPLEMENTO.AsString;
        Rem.EnderReme.xBairro := qrcliente2BAIRRO.AsString;
        Rem.EnderReme.cMun := StrToInt(qrcliente2COD_MUNICIPIO_IBGE.Text);
        Rem.EnderReme.xMun := qrcliente2CIDADE.AsString;
        Rem.EnderReme.CEP := StrToInt(frmPrincipal.somenteNumero(qrcliente2CEP.AsString));
        Rem.EnderReme.UF := qrcliente2UF.AsString;
        Rem.EnderReme.cPais := 1058;
        Rem.EnderReme.xPais := 'Brasil';

        if qrcliente2TIPO.AsInteger = 2 then
        begin
          Rem.CNPJCPF := qrcliente2CPF.AsString;
          Rem.IE := qrcliente2RG.asstring;
        end
        else
        begin
          Rem.CNPJCPF := qrcliente2CPF.AsString;
          Rem.IE := 'ISENTO';
        end;

        Rem.fone := qrcliente2TELEFONE1.AsString;
        Rem.email := qrcliente2EMAIL.Text;
        showmessage('6');
     //              showmessage('1');
     // Relação das Notas Fiscais
     //


        case rgmodelonf.itemindex of
          0: begin
              // Nota Fiscal
              with Rem.InfNF.Add do
              begin
              //nRoma := DM_CNT.NotasRomaneioNF.AsString;
              //nPed := DM_CNT.NotasPedidoNF.AsString;
               //criar tabela
                {serie := dbedit4.Text;
                nDoc := nrnf.Text;
                dEmi := StrToDate(edata_nf.Text);
                vBC := strtoFloat(dbedit1.text);
                vICMS := strtoFloat(dbedit25.text);
                vBCST := strtoFloat(dbedit26.text);
                vST := strtoFloat(dbedit30.text);
                vProd := strtoFloat(dbedit3.text);
                vNF := strtoFloat(evalor_nf.text);
                nCFOP := 5353;
                nPeso := strtoFloat(dbedit46.text);   }
             // PIN := DM_CNT.NotasPinSuframa.AsString;

                // Local de Retirada

                if cbret.itemindex = 0 then
                begin
                  qrcliente2.close;
                  qrcliente2.sql.clear;
                  qrcliente2.sql.add('select * from c000007');
                  qrcliente2.sql.add('where codigo = ''' + elocret.Text + '''');
                  qrcliente2.open;

                  if qrcliente2TIPO.AsInteger = 2 then
                    locRet.CNPJCPF := qrcliente2CPF.AsString
                  else
                    locRet.CNPJCPF := qrcliente2CPF.AsString;

                  locRet.xNome := qrcliente2NOME.AsString;
                  locRet.xLgr := qrcliente2ENDERECO.AsString;
                  locRet.nro := qrcliente2NUMERO.AsString;
                  locRet.xCpl := qrcliente2COMPLEMENTO.AsString;
                  locRet.xBairro := qrcliente2BAIRRO.AsString;
                  locRet.cMun := StrToInt(qrcliente2COD_MUNICIPIO_IBGE.Text);
                  locRet.xMun := qrcliente2CIDADE.AsString;
                  locRet.UF := qrcliente2UF.AsString;
                end;
              end;
            end;
          1: begin
              // Nota Fiscal Eletrônica
              with Rem.InfNFe.Add do
              begin
                //criar tabela
               // chave := self.chave1.Text;
                //PIN := self.pin.Text;
              end;
            end;
          2: begin

            end;
        end;


      end;



   //
   //  Dados do Destinatario
   //

      qrdest.close;
      qrdest.sql.clear;
      qrdest.sql.add('select * from c000007');
      qrdest.sql.add('where codigo = ''' + edestinatario.Text + '''');
      qrdest.open;

      if qrdest.RecordCount <> 0 then
      begin


        Dest.xNome := qrdestNOME.AsString;
        Dest.EnderDest.xLgr := qrdestENDERECO.AsString;
        Dest.EnderDest.nro := qrdestNUMERO.AsString;
        Dest.EnderDest.xCpl := qrdestCOMPLEMENTO.AsString;
        Dest.EnderDest.xBairro := qrdestBAIRRO.AsString;
        Dest.EnderDest.cMun := StrToInt(qrdestCOD_MUNICIPIO_IBGE.Text);
        Dest.EnderDest.xMun := qrdestCIDADE.AsString;
        Dest.EnderDest.CEP := StrToInt(frmPrincipal.somenteNumero(qrdestCEP.AsString));
        Dest.EnderDest.UF := qrdestUF.AsString;
        Dest.EnderDest.cPais := 1058;
        Dest.EnderDest.xPais := 'Brasil';

        if qrdestTIPO.AsInteger = 2
          then begin
          Dest.CNPJCPF := qrdestCPF.AsString;
          Dest.IE := qrdestRG.asstring;
        end
        else begin
          Dest.CNPJCPF := qrdestCPF.AsString;
          Dest.IE := 'ISENTO';
        end;


        Dest.fone := qrdestTELEFONE1.AsString;
     //Dest.ISUF := '0';


     // Local de Entrega   so preencher se local de entrega for diferente
        if cblocdest.itemindex = 0 then
        begin
          qrdest.close;
          qrdest.sql.clear;
          qrdest.sql.add('select * from c000007');
          qrdest.sql.add('where codigo = ''' + elocdestdif.Text + '''');
          qrdest.open;

          Dest.locEnt.CNPJCPF := qrdestCPF.AsString;
          Dest.locEnt.xNome := qrdestNOME.AsString;
          Dest.locEnt.xLgr := qrdestENDERECO.AsString;
          Dest.locEnt.nro := qrdestNUMERO.AsString;
          Dest.locEnt.xCpl := qrdestCOMPLEMENTO.AsString;
          Dest.locEnt.xBairro := qrdestBAIRRO.AsString;
          Dest.locEnt.cMun := 4218707;
          Dest.locEnt.xMun := qrdestCIDADE.AsString;
          Dest.locEnt.UF := qrdestUF.AsString;
        end;

      end;
    {
   //
   //  Dados do Expedidor
   //
    if trim(DM_CNT.Conhec2Expedidor.AsString) <> ''
      then begin
      DM_CTA.PessoaFJ.Close;
      DM_CTA.PessoaFJ.SQL.Clear;
      DM_CTA.PessoaFJ.SQL.Add('Select * From Sis_PessoaFJ');
      DM_CTA.PessoaFJ.SQL.Add('Where CGC = :xCGC');
      DM_CTA.PessoaFJ.Params[0].AsString := DM_CNT.Conhec2Expedidor.AsString;
      DM_CTA.PessoaFJ.Active := True;
      DM_CTA.PessoaFJ.Open;

      Exped.xNome := DM_CTA.PessoaFJRSocial.AsString;
      Exped.EnderExped.xLgr := DM_CTA.PessoaFJEndereco.AsString;
      Exped.EnderExped.nro := DM_CTA.PessoaFJNumero.AsString;
      Exped.EnderExped.xCpl := DM_CTA.PessoaFJComplemento.AsString;
      Exped.EnderExped.xBairro := DM_CTA.PessoaFJBairro.AsString;

      CodigoMunicipio := DM_CTA.PessoaFJCodigoEstado.AsInteger * 100000 +
        DM_CTA.PessoaFJCodigoMunicipio.AsInteger;
      Exped.EnderExped.cMun := CodigoMunicipio;
      Exped.EnderExped.xMun := DM_CTA.PessoaFJCidade.AsString;
      Exped.EnderExped.CEP := StrToIntDef(DM_CTA.PessoaFJCEP.AsString, 0);
      Exped.EnderExped.UF := DM_CTA.PessoaFJEstado.AsString;
      Exped.EnderExped.cPais := DM_CTA.PessoaFJCodigoPais.AsInteger;
      Exped.EnderExped.xPais := DM_CTA.PessoaFJPais.AsString;

      if copy(DM_CTA.PessoaFJCGC.AsString, 10, 4) <> '0000'
        then begin
        Exped.CNPJCPF := Copy(DM_CTA.PessoaFJCGC.AsString, 2, 14);
        IE := DM_CTA.PessoaFJIEstadual.AsString;
      end
      else begin
        Exped.CNPJCPF := Copy(DM_CTA.PessoaFJCGC.AsString, 1, 9) +
          Copy(DM_CTA.PessoaFJCGC.AsString, 14, 2);
        IE := 'ISENTO';
      end;

      Exped.IE := IE;
      Exped.fone := DM_CTA.PessoaFJTelefone.AsString;
    end;
       }


   //
   //  Dados do Recebedor
   //
    //if trim(DM_CNT.Conhec2Expedidor.AsString) <> '' then
      begin


        Receb.xNome := qrdestNOME.AsString;
        Receb.EnderReceb.xLgr := qrdestENDERECO.AsString;
        Receb.EnderReceb.nro := qrdestNUMERO.AsString;
        Receb.EnderReceb.xCpl := qrdestCOMPLEMENTO.AsString;
        Receb.EnderReceb.xBairro := qrdestBAIRRO.AsString;
        Receb.EnderReceb.cMun := StrToInt(qrdestCOD_MUNICIPIO_IBGE.Text);
        Receb.EnderReceb.xMun := qrdestCIDADE.AsString;
        Receb.EnderReceb.CEP := StrToInt(frmPrincipal.somenteNumero(qrdestCEP.AsString));
        Receb.EnderReceb.UF := qrdestUF.AsString;
        Receb.EnderReceb.cPais := 1058;
        Receb.EnderReceb.xPais := 'Brasil';


        if qrdestTIPO.AsInteger = 2 then
        begin
          Receb.CNPJCPF := qrdestCPF.AsString;
          Receb.IE := qrdestRG.asstring;
        end
        else
        begin
          Receb.CNPJCPF := qrdestCPF.AsString;
          Receb.IE := 'ISENTO';
        end;

      //Receb.IE := IE;
        Receb.fone := qrdestTELEFONE1.AsString;
      end;

   //
   //  Valores da Prestação de Serviço
   //
      vPrest.vTPrest := 100.00;
      vPrest.vRec := 100.00;
    {
   //
   // Relação dos Componentes da Prestação de Serviço
   //
    DM_CNT.Componentes.Close;
    DM_CNT.Componentes.SQL.Clear;
    DM_CNT.Componentes.SQL.Add('Select * From Cnt_Componentes');
    DM_CNT.Componentes.SQL.Add('Where Codigo = :xCodigo');
    DM_CNT.Componentes.SQL.Add('and Numero = :xNumero');
    DM_CNT.Componentes.SQL.Add('Order By Item');
    DM_CNT.Componentes.Params[0].AsInteger := DM_CNT.Conhec2Codigo.AsInteger;
    DM_CNT.Componentes.Params[1].AsInteger := DM_CNT.Conhec2Numero.AsInteger;
    DM_CNT.Componentes.Active := True;
    DM_CNT.Componentes.Open;
    j := DM_CNT.Componentes.RecordCount;
    if j > 0
      then begin
      DM_CNT.Componentes.First;
      for i := 1 to j do
      begin
        if DM_CNT.ComponentesValor.AsFloat > 0.0
          then begin
          with vPrest.comp.Add do
          begin
            xNome := DM_CNT.ComponentesDescricao.AsString; ;
            vComp := RoundTo(DM_CNT.ComponentesValor.AsFloat, -2);
          end;
        end;
        DM_CNT.Componentes.Next;
      end;
    end;
           }

           {
   //
   //  Valores dos Impostos
   //
   // TpcnCSTIcms = (cst00, cst10, cst20, cst30, cst40, cst41, cst45, cst50, cst51, cst60, cst70, cst80, cst81, cst90);
   // 80 e 81 apenas para CTe

    case DM_CNT.Conhec2CSTICMS.AsInteger of
      00: begin
          Imp.ICMS.SituTrib := cst00;
          Imp.ICMS.CST00.CST := cst00; // Tributação Normal ICMS
          Imp.ICMS.CST00.vBC := RoundTo(DM_CNT.Conhec2BaseCalc.AsFloat, -2);
          Imp.ICMS.CST00.pICMS := RoundTo(DM_CNT.Conhec2AliqICMS.AsFloat, -2);
          Imp.ICMS.CST00.vICMS := RoundTo(DM_CNT.Conhec2ValorICMS.AsFloat, -2);
        end;
      20: begin
          Imp.ICMS.SituTrib := cst20;
          Imp.ICMS.CST20.CST := cst20; // Tributação com BC reduzida do ICMS
          Imp.ICMS.CST20.pRedBC := RoundTo(DM_CNT.Conhec2ReducaoICMS.AsFloat, -2);
          Imp.ICMS.CST20.vBC := RoundTo(DM_CNT.Conhec2BaseCalc.AsFloat, -2);
          Imp.ICMS.CST20.pICMS := RoundTo(DM_CNT.Conhec2AliqICMS.AsFloat, -2);
          Imp.ICMS.CST20.vICMS := RoundTo(DM_CNT.Conhec2ValorICMS.AsFloat, -2);
        end;
      40: begin
          Imp.ICMS.SituTrib := cst40;
          Imp.ICMS.CST45.CST := cst40; // ICMS Isento
        end;
      41: begin
          Imp.ICMS.SituTrib := cst41;
          Imp.ICMS.CST45.CST := cst41; // ICMS não Tributada
        end;
      51: begin
          Imp.ICMS.SituTrib := cst51;
          Imp.ICMS.CST45.CST := cst51; // ICMS diferido
        end;
      80: begin
          Imp.ICMS.SituTrib := cst80;
          Imp.ICMS.CST80.CST := cst90; // Tributação atribuida ao tomador ou 3. por ST
          Imp.ICMS.CST80.vBC := RoundTo(DM_CNT.Conhec2BaseCalc.AsFloat, -2);
          Imp.ICMS.CST80.pICMS := RoundTo(DM_CNT.Conhec2AliqICMS.AsFloat, -2);
          Imp.ICMS.CST80.vICMS := RoundTo(DM_CNT.Conhec2ValorICMS.AsFloat, -2);
          Imp.ICMS.CST80.vCred := RoundTo(DM_CNT.Conhec2CreditoICMS.AsFloat, -2);
        end;
      81: begin
          Imp.ICMS.SituTrib := cst81;
          Imp.ICMS.CST81.CST := cst90; // Tributação devido a outra UF
          Imp.ICMS.CST81.pRedBC := RoundTo(DM_CNT.Conhec2ReducaoICMS.AsFloat, -2);
          Imp.ICMS.CST81.vBC := RoundTo(DM_CNT.Conhec2BaseCalc.AsFloat, -2);
          Imp.ICMS.CST81.pICMS := RoundTo(DM_CNT.Conhec2AliqICMS.AsFloat, -2);
          Imp.ICMS.CST81.vICMS := RoundTo(DM_CNT.Conhec2ValorICMS.AsFloat, -2);
        end;
      90: begin
          Imp.ICMS.SituTrib := cst90;
          Imp.ICMS.CST90.CST := cst90; // ICMS Outros
          Imp.ICMS.CST90.pRedBC := RoundTo(DM_CNT.Conhec2ReducaoICMS.AsFloat, -2);
          Imp.ICMS.CST90.vBC := RoundTo(DM_CNT.Conhec2BaseCalc.AsFloat, -2);
          Imp.ICMS.CST90.pICMS := RoundTo(DM_CNT.Conhec2AliqICMS.AsFloat, -2);
          Imp.ICMS.CST90.vICMS := RoundTo(DM_CNT.Conhec2ValorICMS.AsFloat, -2);
          Imp.ICMS.CST90.vCred := RoundTo(DM_CNT.Conhec2CreditoICMS.AsFloat, -2);
        end;
    end;
        }
   //
   //  Informações da Carga
   //
      infCarga.vCarga := 100.00;
      infCarga.proPred := 'Caixa';
      infCarga.xOutCat := 'Teste';

   // UnidMed = (uM3,uKG, uTON, uUNIDADE, uLITROS);
      with infCarga.InfQ.Add do
      begin
        cUnid := uKg;
        tpMed := 'Kg';
        qCarga := 30.00;
      end;
      with infCarga.InfQ.Add do
      begin
        cUnid := uUnidade;
        tpMed := 'Caixa';
        qCarga := 30.00;
      end;

   //
   //  Informações da Seguradora
   //
    //if trim(DM_CNT.ParametrosSeguradora.AsString) <> '' then
      begin
        with infseg.Add do
        begin
       { case DM_CNT.Conhec2RespSeguro.AsInteger of
          0: respSeg := rsRemetente;
          1: respSeg := rsExpedidor;
          2: respSeg := rsRecebedor;
          3: respSeg := rsDestinatario;
          4: respSeg := rsEmitenteCTe;
          5: respSeg := rsTomadorServico;
        end; }
          respSeg := rsRemetente;
          xSeg := '999999999999999999999999999999'; //Copy(trim(DM_CTA.PessoaFJRSocial.AsString), 1, 30);

          nApol := '12345678912345678912';
          nAver := '99999999999999999999'; //DM_CNT.ParametrosNumAverbacao.AsString;
        end;
      end;

   //
   //  Dados do Modal Rodoviário
   //
      Rodo.RNTRC := '12345678';
      Rodo.dPrev := StrToDate('27/04/2013');

   // TpcteLocacao = (ltNao, ltsim);
      Rodo.Lota := ltNao;

   //
   //  Informações do Detalhamento do CTe do tipo Anulação de Valores
   //

   // infCTeAnuEnt.dEmi:=DM_CNT.Conhec2Data.AsDateTime;
   // infCTeAnuEnt.chCTe:='';
    end;
  except
    on E: exception do
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmMsg_Operador.Timer1.Enabled := False;
      frmMsg_Operador.lb_msg.Width := 70;
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Erro ao Criar XML do CT-e.:Funções Envolvidas:' + #13 +
        '***GerarCTe***' + #13 +
        'Mensagem: ' + E.message;
      frmMsg_Operador.showmodal;
      Exit;
    end;

  end

end;


procedure Tfrmconhecimento.LoadXML(MyMemo: TMemo;
  MyWebBrowser: TWebBrowser);
begin
  MyMemo.Lines.SaveToFile(ExtractFileDir(application.ExeName) + 'temp.xml');
  MyWebBrowser.Navigate(ExtractFileDir(application.ExeName) + 'temp.xml');
end;

procedure Tfrmconhecimento.GravarConfiguracao;
var
  IniFile: string;
  Ini: TIniFile;
  StreamMemo: TMemoryStream;
begin
  IniFile := ChangeFileExt(Application.ExeName, '.ini');

  Ini := TIniFile.Create(IniFile);
  try
    Ini.WriteString('Certificado', 'Caminho', edtCaminho.Text);
    Ini.WriteString('Certificado', 'Senha', edtSenha.Text);
    Ini.WriteString('Certificado', 'NumSerie', edtNumSerie.Text);

    Ini.WriteInteger('Geral', 'DACTE', rgTipoDACTe.ItemIndex);
    Ini.WriteInteger('Geral', 'FormaEmissao', rgFormaEmissao.ItemIndex);
    Ini.WriteString('Geral', 'LogoMarca', edtLogoMarca.Text);
    Ini.WriteBool('Geral', 'Salvar', ckSalvar.Checked);
    Ini.WriteString('Geral', 'PathSalvar', edtPathLogs.Text);

    Ini.WriteString('WebService', 'UF', cbUF.Text);
    Ini.WriteInteger('WebService', 'Ambiente', rgTipoAmb.ItemIndex);
    Ini.WriteBool('WebService', 'Visualizar', ckVisualizar.Checked);

    Ini.WriteString('Proxy', 'Host', edtProxyHost.Text);
    Ini.WriteString('Proxy', 'Porta', edtProxyPorta.Text);
    Ini.WriteString('Proxy', 'User', edtProxyUser.Text);
    Ini.WriteString('Proxy', 'Pass', edtProxySenha.Text);

    Ini.WriteString('Emitente', 'CNPJ', edtEmitCNPJ.Text);
    Ini.WriteString('Emitente', 'IE', edtEmitIE.Text);
    Ini.WriteString('Emitente', 'RazaoSocial', edtEmitRazao.Text);
    Ini.WriteString('Emitente', 'Fantasia', edtEmitFantasia.Text);
    Ini.WriteString('Emitente', 'Fone', edtEmitFone.Text);
    Ini.WriteString('Emitente', 'CEP', edtEmitCEP.Text);
    Ini.WriteString('Emitente', 'Logradouro', edtEmitLogradouro.Text);
    Ini.WriteString('Emitente', 'Numero', edtEmitNumero.Text);
    Ini.WriteString('Emitente', 'Complemento', edtEmitComp.Text);
    Ini.WriteString('Emitente', 'Bairro', edtEmitBairro.Text);
    Ini.WriteString('Emitente', 'CodCidade', edtEmitCodCidade.Text);
    Ini.WriteString('Emitente', 'Cidade', edtEmitCidade.Text);
    Ini.WriteString('Emitente', 'UF', edtEmitUF.Text);
    Ini.WriteString('Emitente', 'serie', edtserie.Text);
    Ini.WriteString('Emitente', 'sequencia', edtsequencia.Text);

    Ini.WriteString('Email', 'Host', edtSmtpHost.Text);
    Ini.WriteString('Email', 'Port', edtSmtpPort.Text);
    Ini.WriteString('Email', 'User', edtSmtpUser.Text);
    Ini.WriteString('Email', 'Pass', edtSmtpPass.Text);
    Ini.WriteString('Email', 'Assunto', edtEmailAssunto.Text);
    Ini.WriteBool('Email', 'SSL', cbEmailSSL.Checked);

    StreamMemo := TMemoryStream.Create;
    mmEmailMsg.Lines.SaveToStream(StreamMemo);
    StreamMemo.Seek(0, soFromBeginning);
    Ini.WriteBinaryStream('Email', 'Mensagem', StreamMemo);

    StreamMemo.Free;
  finally
    Ini.Free;
  end;
end;

procedure Tfrmconhecimento.LerConfiguracao;
var
  IniFile: string;
  Ini: TIniFile;
  Ok: Boolean;
  StreamMemo: TMemoryStream;
begin
  IniFile := ChangeFileExt(Application.ExeName, '.ini');

  Ini := TIniFile.Create(IniFile);
  try
{$IFDEF ACBrCTeOpenSSL}
    edtCaminho.Text := Ini.ReadString('Certificado', 'Caminho', '');
    edtSenha.Text := Ini.ReadString('Certificado', 'Senha', '');
    ACBrCTe1.Configuracoes.Certificados.Certificado := edtCaminho.Text;
    ACBrCTe1.Configuracoes.Certificados.Senha := edtSenha.Text;
    edtNumSerie.Visible := False;
    Label25.Visible := False;
    sbtnGetCert.Visible := False;
{$ELSE}
    edtNumSerie.Text := Ini.ReadString('Certificado', 'NumSerie', '');
    ACBrCTe1.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
   //edtNumSerie.Text := ACBrCTe1.Configuracoes.Certificados.NumeroSerie;
    Label1.Caption := 'Informe o número de série do certificado'#13 +
      'Disponível no Internet Explorer no menu'#13 +
      'Ferramentas - Opções da Internet - Conteúdo '#13 +
      'Certificados - Exibir - Detalhes - '#13 +
      'Número do certificado';
    Label2.Visible := False;
    edtCaminho.Visible := False;
    edtSenha.Visible := False;
    sbtnCaminhoCert.Visible := False;
{$ENDIF}

    rgFormaEmissao.ItemIndex := Ini.ReadInteger('Geral', 'FormaEmissao', 0);
    ckSalvar.Checked := Ini.ReadBool('Geral', 'Salvar', True);
    edtPathLogs.Text := Ini.ReadString('Geral', 'PathSalvar', '');
    ACBrCTe1.Configuracoes.Geral.FormaEmissao := StrToTpEmis(OK, IntToStr(rgFormaEmissao.ItemIndex + 1));
    ACBrCTe1.Configuracoes.Geral.Salvar := ckSalvar.Checked;
    ACBrCTe1.Configuracoes.Geral.PathSalvar := edtPathLogs.Text;

    cbUF.ItemIndex := cbUF.Items.IndexOf(Ini.ReadString('WebService', 'UF', 'SP'));
    rgTipoAmb.ItemIndex := Ini.ReadInteger('WebService', 'Ambiente', 0);
    ckVisualizar.Checked := Ini.ReadBool('WebService', 'Visualizar', False);
    ACBrCTe1.Configuracoes.WebServices.UF := cbUF.Text;
    ACBrCTe1.Configuracoes.WebServices.Ambiente := StrToTpAmb(Ok, IntToStr(rgTipoAmb.ItemIndex + 1));
    ACBrCTe1.Configuracoes.WebServices.Visualizar := ckVisualizar.Checked;

    edtProxyHost.Text := Ini.ReadString('Proxy', 'Host', '');
    edtProxyPorta.Text := Ini.ReadString('Proxy', 'Porta', '');
    edtProxyUser.Text := Ini.ReadString('Proxy', 'User', '');
    edtProxySenha.Text := Ini.ReadString('Proxy', 'Pass', '');
    ACBrCTe1.Configuracoes.WebServices.ProxyHost := edtProxyHost.Text;
    ACBrCTe1.Configuracoes.WebServices.ProxyPort := edtProxyPorta.Text;
    ACBrCTe1.Configuracoes.WebServices.ProxyUser := edtProxyUser.Text;
    ACBrCTe1.Configuracoes.WebServices.ProxyPass := edtProxySenha.Text;

    rgTipoDACTe.ItemIndex := Ini.ReadInteger('Geral', 'DACTE', 0);
    edtLogoMarca.Text := Ini.ReadString('Geral', 'LogoMarca', '');
    if ACBrCTe1.DACTe <> nil then
    begin
      ACBrCTe1.DACTe.TipoDACTe := StrToTpImp(OK, IntToStr(rgTipoDaCTe.ItemIndex + 1));
      ACBrCTe1.DACTe.Logo := edtLogoMarca.Text;
      ACBrCTe1.DACTe.PathPDF := edtPathLogs.Text;
    end;

    edtEmitCNPJ.Text := Ini.ReadString('Emitente', 'CNPJ', '');
    edtEmitIE.Text := Ini.ReadString('Emitente', 'IE', '');
    edtEmitRazao.Text := Ini.ReadString('Emitente', 'RazaoSocial', '');
    edtEmitFantasia.Text := Ini.ReadString('Emitente', 'Fantasia', '');
    edtEmitFone.Text := Ini.ReadString('Emitente', 'Fone', '');
    edtEmitCEP.Text := Ini.ReadString('Emitente', 'CEP', '');
    edtEmitLogradouro.Text := Ini.ReadString('Emitente', 'Logradouro', '');
    edtEmitNumero.Text := Ini.ReadString('Emitente', 'Numero', '');
    edtEmitComp.Text := Ini.ReadString('Emitente', 'Complemento', '');
    edtEmitBairro.Text := Ini.ReadString('Emitente', 'Bairro', '');
    edtEmitCodCidade.Text := Ini.ReadString('Emitente', 'CodCidade', '');
    edtEmitCidade.Text := Ini.ReadString('Emitente', 'Cidade', '');
    edtEmitUF.Text := Ini.ReadString('Emitente', 'UF', '');
    edtEmitUF.Text := Ini.ReadString('Emitente', 'serie', '');
    edtEmitUF.Text := Ini.ReadString('Emitente', 'sequencia', '');

    edtSmtpHost.Text := Ini.ReadString('Email', 'Host', '');
    edtSmtpPort.Text := Ini.ReadString('Email', 'Port', '');
    edtSmtpUser.Text := Ini.ReadString('Email', 'User', '');
    edtSmtpPass.Text := Ini.ReadString('Email', 'Pass', '');
    edtEmailAssunto.Text := Ini.ReadString('Email', 'Assunto', '');
    cbEmailSSL.Checked := Ini.ReadBool('Email', 'SSL', False);

    StreamMemo := TMemoryStream.Create;
    Ini.ReadBinaryStream('Email', 'Mensagem', StreamMemo);
    mmEmailMsg.Lines.LoadFromStream(StreamMemo);
    StreamMemo.Free;
  finally
    Ini.Free;
  end;
end;

procedure Tfrmconhecimento.btnSalvarConfigClick(Sender: TObject);
begin
  GravarConfiguracao;
  LerConfiguracao;
end;

procedure Tfrmconhecimento.sbtnCaminhoCertClick(Sender: TObject);
begin
  OpenDialog1.Title := 'Selecione o Certificado';
  OpenDialog1.DefaultExt := '*.pfx';
  OpenDialog1.Filter := 'Arquivos PFX (*.pfx)|*.pfx|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := ExtractFileDir(application.ExeName);

  if OpenDialog1.Execute then
  begin
    edtCaminho.Text := OpenDialog1.FileName;
  end;
end;

procedure Tfrmconhecimento.sbtnGetCertClick(Sender: TObject);
begin
{$IFNDEF ACBrCTeOpenSSL}
  edtNumSerie.Text := ACBrCTe1.Configuracoes.Certificados.SelecionarCertificado;
{$ENDIF}
end;

procedure Tfrmconhecimento.sbtnLogoMarcaClick(Sender: TObject);
begin
  OpenDialog1.Title := 'Selecione o Logo';
  OpenDialog1.DefaultExt := '*.bmp';
  OpenDialog1.Filter := 'Arquivos BMP (*.bmp)|*.bmp|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := ExtractFileDir(application.ExeName);

  if OpenDialog1.Execute then
  begin
    edtLogoMarca.Text := OpenDialog1.FileName;
  end;
end;

procedure Tfrmconhecimento.sbtnPathSalvarClick(Sender: TObject);
var
  Dir: string;
begin
  if Length(edtPathLogs.Text) <= 0
    then Dir := ExtractFileDir(application.ExeName)
  else Dir := edtPathLogs.Text;

  if SelectDirectory(Dir, [sdAllowCreate, sdPerformCreate, sdPrompt], HelpContext)
    then edtPathLogs.Text := Dir;
end;

procedure Tfrmconhecimento.btnValidarXMLClick(Sender: TObject);
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  OpenDialog1.Title := 'Selecione o CTe';
  OpenDialog1.DefaultExt := '*-cte.xml';
  OpenDialog1.Filter := 'Arquivos CTe (*-cte.xml)|*-cte.xml|Arquivos XML (*.xml)|*.xml|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := Cte.Configuracoes.Geral.PathSalvar;

  if OpenDialog1.Execute then
  begin
    Cte.Conhecimentos.Clear;
    Cte.Conhecimentos.LoadFromFile(OpenDialog1.FileName);
    Cte.Conhecimentos.Valida;
    showmessage('Conhecimento de Transporte Eletrônico Valido');
  end;

 // Cte.Conhecimentos.Clear;
 // Cte.Conhecimentos.LoadFromFile('C:\iCloud\Server\Cte\XML\'+ edtchave.Text +'-cte.xml');
 // Cte.Conhecimentos.Valida;

end;

procedure Tfrmconhecimento.btnCriarEnviarClick(Sender: TObject);
var
  vAux, vNumLote: string;
begin
  if not (InputQuery('WebServices Enviar', 'Numero do Conhecimento', vAux))
    then exit;

  if not (InputQuery('WebServices Enviar', 'Numero do Lote', vNumLote))
    then exit;

  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  CTe.Conhecimentos.Clear;
  GerarCTe(vAux);
  CTe.Enviar(StrToInt(vNumLote));
  Cte.Conhecimentos.ImprimirPDF;

  MemoResp.Lines.Text := UTF8Encode(CTe.WebServices.Retorno.RetWS);
  memoRespWS.Lines.Text := UTF8Encode(CTe.WebServices.Retorno.RetWS);
  LoadXML(MemoResp, WBResposta);

  PageControl2.ActivePageIndex := 5;
  MemoDados.Lines.Add('');
  MemoDados.Lines.Add('Envio CTe');
  MemoDados.Lines.Add('tpAmb: ' + TpAmbToStr(CTe.WebServices.Retorno.TpAmb));
  MemoDados.Lines.Add('verAplic: ' + CTe.WebServices.Retorno.verAplic);
  MemoDados.Lines.Add('cStat: ' + IntToStr(CTe.WebServices.Retorno.cStat));
  MemoDados.Lines.Add('cUF: ' + IntToStr(CTe.WebServices.Retorno.cUF));
  MemoDados.Lines.Add('xMotivo: ' + CTe.WebServices.Retorno.xMotivo);
  MemoDados.Lines.Add('xMsg: ' + CTe.WebServices.Retorno.Msg);
  MemoDados.Lines.Add('Recibo: ' + CTe.WebServices.Retorno.Recibo);
  MemoDados.Lines.Add('Protocolo: ' + CTe.WebServices.Retorno.Protocolo);

  CTe.Conhecimentos.Clear;
end;


procedure Tfrmconhecimento.btnImprimirClick(Sender: TObject);
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  OpenDialog1.Title := 'Selecione o CTe';
  OpenDialog1.DefaultExt := '*-cte.xml';
  OpenDialog1.Filter := 'Arquivos CTe (*-cte.xml)|*-cte.xml|Arquivos XML (*.xml)|*.xml|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := Cte.Configuracoes.Geral.PathSalvar;
  dacte1.FastFile := 'C:\iCloud\Server\Cte\Report\DACTE_1_04.fr3';

  if OpenDialog1.Execute then
  begin
    Cte.Conhecimentos.Clear;
    Cte.Conhecimentos.LoadFromFile(OpenDialog1.FileName);
    if Cte.Conhecimentos.Items[0].CTe.Ide.tpEmis = teDPEC then
    begin
     {
     ACBrCTe1.WebServices.ConsultaDPEC.CTeChave := ACBrCTe1.Conhecimentos.Items[0].CTe.infCTe.ID;
     ACBrCTe1.WebServices.ConsultaDPEC.Executar;
     ACBrCTe1.DACTe.ProtocoloCTe := ACBrCTe1.WebServices.ConsultaDPEC.nRegDPEC +
       ' '+ DateTimeToStr(ACBrCTe1.WebServices.ConsultaDPEC.retDPEC.dhRegDPEC);
     }
    end;
    Cte.Conhecimentos.Imprimir;
  end;
end;

procedure Tfrmconhecimento.btnStatusServClick(Sender: TObject);
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  Cte.WebServices.StatusServico.Executar;
  MemoResp.Lines.Text := UTF8Encode(Cte.WebServices.StatusServico.RetWS);
  memoRespWS.Lines.Text := UTF8Encode(Cte.WebServices.StatusServico.RetWS);
  LoadXML(MemoResp, WBResposta);

  PageControl2.ActivePageIndex := 5;
  MemoDados.Lines.Add('');
  MemoDados.Lines.Add('Status Serviço');
  MemoDados.Lines.Add('tpAmb: ' + TpAmbToStr(Cte.WebServices.StatusServico.tpAmb));
  MemoDados.Lines.Add('verAplic: ' + Cte.WebServices.StatusServico.verAplic);
  MemoDados.Lines.Add('cStat: ' + IntToStr(Cte.WebServices.StatusServico.cStat));
  MemoDados.Lines.Add('xMotivo: ' + Cte.WebServices.StatusServico.xMotivo);
  MemoDados.Lines.Add('cUF: ' + IntToStr(Cte.WebServices.StatusServico.cUF));
  MemoDados.Lines.Add('dhRecbto: ' + DateTimeToStr(Cte.WebServices.StatusServico.dhRecbto));
  MemoDados.Lines.Add('tMed: ' + IntToStr(Cte.WebServices.StatusServico.TMed));
  MemoDados.Lines.Add('dhRetorno: ' + DateTimeToStr(Cte.WebServices.StatusServico.dhRetorno));
  MemoDados.Lines.Add('xObs: ' + Cte.WebServices.StatusServico.xObs);
end;

procedure Tfrmconhecimento.Button2Click(Sender: TObject);
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  OpenDialog1.Title := 'Selecione o CTe';
  OpenDialog1.DefaultExt := '*-cte.xml';
  OpenDialog1.Filter := 'Arquivos CTe (*-cte.xml)|*-cte.xml|Arquivos XML (*.xml)|*.xml|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := ACBrCTe1.Configuracoes.Geral.PathSalvar;

  if OpenDialog1.Execute then
  begin
    Cte.Conhecimentos.Clear;
    Cte.Conhecimentos.LoadFromFile(OpenDialog1.FileName);
    Cte.Consultar;

    ShowMessage(Cte.WebServices.Consulta.Protocolo);
    MemoResp.Lines.Text := UTF8Encode(Cte.WebServices.Consulta.RetWS);
    memoRespWS.Lines.Text := UTF8Encode(Cte.WebServices.Consulta.RetWS);
    LoadXML(MemoResp, WBResposta);
  end;
end;

procedure Tfrmconhecimento.Button11Click(Sender: TObject);
var
  vChave: string;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  if not (InputQuery('WebServices Consultar', 'Chave do CT-e:', vChave)) then
    exit;

  Cte.WebServices.Consulta.CTeChave := vChave;
  Cte.WebServices.Consulta.Executar;

  MemoResp.Lines.Text := UTF8Encode(Cte.WebServices.Consulta.RetWS);
  memoRespWS.Lines.Text := UTF8Encode(Cte.WebServices.Consulta.RetornoWS);
  LoadXML(MemoResp, WBResposta);
end;

procedure Tfrmconhecimento.Button4Click(Sender: TObject);
var
  vAux: string;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  OpenDialog1.Title := 'Selecione o CTe';
  OpenDialog1.DefaultExt := '*-cte.xml';
  OpenDialog1.Filter := 'Arquivos CTe (*-cte.xml)|*-cte.xml|Arquivos XML (*.xml)|*.xml|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := ACBrCTe1.Configuracoes.Geral.PathSalvar;

  if OpenDialog1.Execute then
  begin
    Cte.Conhecimentos.Clear;
    Cte.Conhecimentos.LoadFromFile(OpenDialog1.FileName);
    if not (InputQuery('WebServices Cancelamento', 'Justificativa', vAux))
      then exit;

    Cte.Cancelamento(vAux);
    MemoResp.Lines.Text := UTF8Encode(Cte.WebServices.Cancelamento.RetWS);
    memoRespWS.Lines.Text := UTF8Encode(Cte.WebServices.Cancelamento.RetWS);
    LoadXML(MemoResp, WBResposta);
    ShowMessage(IntToStr(Cte.WebServices.Cancelamento.cStat));
    ShowMessage(Cte.WebServices.Cancelamento.Protocolo);
  end;
end;

procedure Tfrmconhecimento.Button12Click(Sender: TObject);
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  ShowMessage('Opção não Implementada!');
end;

procedure Tfrmconhecimento.Button6Click(Sender: TObject);
var
  Modelo, Serie, Ano, NumeroInicial, NumeroFinal, Justificativa: string;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  if not (InputQuery('WebServices Inutilização ', 'Ano', Ano))
    then exit;
  if not (InputQuery('WebServices Inutilização ', 'Modelo', Modelo))
    then exit;
  if not (InputQuery('WebServices Inutilização ', 'Serie', Serie))
    then exit;
  if not (InputQuery('WebServices Inutilização ', 'Número Inicial', NumeroInicial))
    then exit;
  if not (InputQuery('WebServices Inutilização ', 'Número Inicial', NumeroFinal))
    then exit;
  if not (InputQuery('WebServices Inutilização ', 'Justificativa', Justificativa))
    then exit;
  Cte.WebServices.Inutiliza(edtEmitCNPJ.Text, Justificativa, StrToInt(Ano),
    StrToInt(Modelo), StrToInt(Serie),
    StrToInt(NumeroInicial), StrToInt(NumeroFinal));
  MemoResp.Lines.Text := UTF8Encode(Cte.WebServices.Inutilizacao.RetWS);
  memoRespWS.Lines.Text := UTF8Encode(Cte.WebServices.Inutilizacao.RetWS);
  LoadXML(MemoResp, WBResposta);
end;

procedure Tfrmconhecimento.Button10Click(Sender: TObject);
var
  aux: string;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  if not (InputQuery('Consultar Recibo Lote', 'Número do Recibo', aux))
    then exit;

  Cte.WebServices.Recibo.Recibo := aux;
  Cte.WebServices.Recibo.Executar;

  MemoResp.Lines.Text := UTF8Encode(Cte.WebServices.Recibo.RetWS);
  memoRespWS.Lines.Text := UTF8Encode(Cte.WebServices.Recibo.RetWS);
  LoadXML(MemoResp, WBResposta);
end;

procedure Tfrmconhecimento.Button8Click(Sender: TObject);
var
  UF, Documento: string;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  if not (InputQuery('WebServices Consulta Cadastro ', 'UF do Documento a ser Consultado:', UF))
    then exit;
  if not (InputQuery('WebServices Consulta Cadastro ', 'Documento(CPF/CNPJ)', Documento))
    then exit;

  Documento := Trim(DFeUtil.LimpaNumero(Documento));

  cte.WebServices.ConsultaCadastro.UF := UF;
  if Length(Documento) > 11
    then ACBrCTe1.WebServices.ConsultaCadastro.CNPJ := Documento
  else ACBrCTe1.WebServices.ConsultaCadastro.CPF := Documento;
  cte.WebServices.ConsultaCadastro.Executar;

  MemoResp.Lines.Text := UTF8Encode(cte.WebServices.ConsultaCadastro.RetWS);
  memoRespWS.Lines.Text := UTF8Encode(cte.WebServices.ConsultaCadastro.RetWS);
  LoadXML(MemoResp, WBResposta);

  ShowMessage(cte.WebServices.ConsultaCadastro.xMotivo);
  ShowMessage(cte.WebServices.ConsultaCadastro.RetConsCad.InfCad.Items[0].xNome);
end;

procedure Tfrmconhecimento.Button9Click(Sender: TObject);
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  OpenDialog1.Title := 'Selecione o CTe';
  OpenDialog1.DefaultExt := '*-cte.xml';
  OpenDialog1.Filter := 'Arquivos CTe (*-cte.xml)|*-cte.xml|Arquivos XML (*.xml)|*.xml|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := Cte.Configuracoes.Geral.PathSalvar;

  if OpenDialog1.Execute
    then begin
    Cte.Conhecimentos.Clear;
    Cte.Conhecimentos.LoadFromFile(OpenDialog1.FileName);
    Cte.Conhecimentos.ImprimirPDF;
  end;
end;

procedure Tfrmconhecimento.btnEnvDPECClick(Sender: TObject);
var
  vAux: string;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  ShowMessage('Opção não Implementada!');
 {
 if not(InputQuery('WebServices DPEC', 'Numero do Conhecimento', vAux))
  then exit;

 ACBrCTe1.Conhecimentos.Clear;
 GerarCTe(vAux);
 ACBrCTe1.Conhecimentos.SaveToFile();
 ACBrCTe1.WebServices.EnviarDPEC.Executar;

 //protocolo de envio ao DPEC e impressão do DACTe
 ACBrCTe1.DACTe.ProtocoloCTe:=ACBrCTe1.WebServices.EnviarDPEC.nRegDPEC+' '+
                       DateTimeToStr(ACBrCTe1.WebServices.EnviarDPEC.DhRegDPEC);
 ACBrCTe1.Conhecimentos.Imprimir;

 ShowMessage(DateTimeToStr(ACBrCTe1.WebServices.EnviarDPEC.DhRegDPEC));
 ShowMessage(ACBrCTe1.WebServices.EnviarDPEC.nRegDPEC);

 MemoResp.Lines.Text   := UTF8Encode(ACBrCTe1.WebServices.EnviarDPEC.RetWS);
 memoRespWS.Lines.Text := UTF8Encode(ACBrCTe1.WebServices.EnviarDPEC.RetWS);
 LoadXML(MemoResp, WBResposta);

 ACBrCTe1.Conhecimentos.Clear;
 }
end;

procedure Tfrmconhecimento.btnConsultarDPECClick(Sender: TObject);
var
  vAux: string;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  ShowMessage('Opção não Implementada!');
{
 if not(InputQuery('WebServices DPEC', 'Informe o Numero do Registro do DPEC ou a Chave do CTe', vAux))
  then exit;

 if Length(Trim(vAux)) < 44
  then ACBrCTe1.WebServices.ConsultaDPEC.nRegDPEC := vAux
  else ACBrCTe1.WebServices.ConsultaDPEC.CTeChave := vAux;

 ACBrCTe1.WebServices.ConsultaDPEC.Executar;

 MemoResp.Lines.Text   := UTF8Encode(ACBrCTe1.WebServices.ConsultaDPEC.RetWS);
 memoRespWS.Lines.Text := UTF8Encode(ACBrCTe1.WebServices.ConsultaDPEC.RetWS);
 LoadXML(MemoResp, WBResposta);
 }
end;

procedure Tfrmconhecimento.btnImportarXMLClick(Sender: TObject);
var
  i, j, k, n: integer;
  Nota, Node, NodePai, NodeItem: TTreeNode;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  OpenDialog1.FileName := '';
  OpenDialog1.Title := 'Selecione o CTe';
  OpenDialog1.DefaultExt := '*-cte.xml';
  OpenDialog1.Filter := 'Arquivos CTe (*-cte.xml)|*-cte.xml|Arquivos XML (*.xml)|*.xml|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := Cte.Configuracoes.Geral.PathSalvar;

  if OpenDialog1.Execute then
  begin
    Cte.Conhecimentos.Clear;
    Cte.Conhecimentos.LoadFromFile(OpenDialog1.FileName);
    trvwCTe.Items.Clear;

    for n := 0 to ACBrCTe1.Conhecimentos.Count - 1 do
    begin
      with ACBrCTe1.Conhecimentos.Items[n].CTe do
      begin
       (*
       Nota := trvwCTe.Items.Add(nil,infCTe.ID);
       trvwCTe.Items.AddChild(Nota,'ID= ' +infCTe.ID);
       Node := trvwCTe.Items.AddChild(Nota,'procCTe');
       trvwCTe.Items.AddChild(Node,'tpAmb= '     +TpAmbToStr(procCTe.tpAmb));
       trvwCTe.Items.AddChild(Node,'verAplic= '  +procCTe.verAplic);
       trvwCTe.Items.AddChild(Node,'chCTe= '     +procCTe.chCTe);
       trvwCTe.Items.AddChild(Node,'dhRecbto= '  +DateTimeToStr(procCTe.dhRecbto));
       trvwCTe.Items.AddChild(Node,'nProt= '     +procCTe.nProt);
       trvwCTe.Items.AddChild(Node,'digVal= '    +procCTe.digVal);
       trvwCTe.Items.AddChild(Node,'cStat= '     +IntToStr(procCTe.cStat));
       trvwCTe.Items.AddChild(Node,'xMotivo= '   +procCTe.xMotivo);

       Node := trvwCTe.Items.AddChild(Nota,'Ide');
       trvwCTe.Items.AddChild(Node,'cNF= '     +IntToStr(Ide.cNF));
       trvwCTe.Items.AddChild(Node,'natOp= '   +Ide.natOp );
       trvwCTe.Items.AddChild(Node,'indPag= '  +IndpagToStr(Ide.indPag));
       trvwCTe.Items.AddChild(Node,'modelo= '  +IntToStr(Ide.modelo));
       trvwCTe.Items.AddChild(Node,'serie= '   +IntToStr(Ide.serie));
       trvwCTe.Items.AddChild(Node,'nNF= '     +IntToStr(Ide.nNF));
       trvwCTe.Items.AddChild(Node,'dEmi= '    +DateToStr(Ide.dEmi));
       trvwCTe.Items.AddChild(Node,'dSaiEnt= ' +DateToStr(Ide.dSaiEnt));
       trvwCTe.Items.AddChild(Node,'tpNF= '    +tpNFToStr(Ide.tpNF));
       trvwCTe.Items.AddChild(Node,'finCTe= '  +FinCTeToStr(Ide.finCTe));
       trvwCTe.Items.AddChild(Node,'verProc= ' +Ide.verProc);
       trvwCTe.Items.AddChild(Node,'cUF= '     +IntToStr(Ide.cUF));
       trvwCTe.Items.AddChild(Node,'cMunFG= '  +IntToStr(Ide.cMunFG));
       trvwCTe.Items.AddChild(Node,'tpImp= '   +TpImpToStr(Ide.tpImp));
       trvwCTe.Items.AddChild(Node,'tpEmis= '  +TpEmisToStr(Ide.tpEmis));
       trvwCTe.Items.AddChild(Node,'cDV= '     +IntToStr(Ide.cDV));
       trvwCTe.Items.AddChild(Node,'tpAmb= '   +TpAmbToStr(Ide.tpAmb));
       trvwCTe.Items.AddChild(Node,'finCTe= '  +FinCTeToStr(Ide.finCTe));
       trvwCTe.Items.AddChild(Node,'procEmi= ' +procEmiToStr(Ide.procEmi));
       trvwCTe.Items.AddChild(Node,'verProc= ' +Ide.verProc);

       for i:=0 to Ide.NFref.Count-1 do
        begin
          Node := trvwCTe.Items.AddChild(Node,'NFRef'+IntToStrZero(i+1,3));
          trvwCTe.Items.AddChild(Node,'refCTe= ' +Ide.NFref.Items[i].refCTe);
          trvwCTe.Items.AddChild(Node,'cUF= '    +IntToStr(Ide.NFref.Items[i].RefNF.cUF));
          trvwCTe.Items.AddChild(Node,'AAMM= '   +Ide.NFref.Items[i].RefNF.AAMM);
          trvwCTe.Items.AddChild(Node,'CNPJ= '   +Ide.NFref.Items[i].RefNF.CNPJ);
          trvwCTe.Items.AddChild(Node,'modelo= ' +IntToStr(Ide.NFref.Items[i].RefNF.modelo));
          trvwCTe.Items.AddChild(Node,'serie= '  +IntToStr(Ide.NFref.Items[i].RefNF.serie));
          trvwCTe.Items.AddChild(Node,'nNF= '    +IntToStr(Ide.NFref.Items[i].RefNF.nNF));
        end;

       Node := trvwCTe.Items.AddChild(Nota,'Emit');
       trvwCTe.Items.AddChild(Node,'CNPJCPF= ' +Emit.CNPJCPF);
       trvwCTe.Items.AddChild(Node,'IE='       +Emit.IE);
       trvwCTe.Items.AddChild(Node,'xNome='    +Emit.xNome);
       trvwCTe.Items.AddChild(Node,'xFant='    +Emit.xFant );
       trvwCTe.Items.AddChild(Node,'IEST='     +Emit.IEST);
       trvwCTe.Items.AddChild(Node,'IM='       +Emit.IM);
       trvwCTe.Items.AddChild(Node,'CNAE='     +Emit.CNAE);

       Node := trvwCTe.Items.AddChild(Node,'EnderEmit');
       trvwCTe.Items.AddChild(Node,'Fone='    +Emit.EnderEmit.fone);
       trvwCTe.Items.AddChild(Node,'CEP='     +IntToStr(Emit.EnderEmit.CEP));
       trvwCTe.Items.AddChild(Node,'xLgr='    +Emit.EnderEmit.xLgr);
       trvwCTe.Items.AddChild(Node,'nro='     +Emit.EnderEmit.nro);
       trvwCTe.Items.AddChild(Node,'xCpl='    +Emit.EnderEmit.xCpl);
       trvwCTe.Items.AddChild(Node,'xBairro=' +Emit.EnderEmit.xBairro);
       trvwCTe.Items.AddChild(Node,'cMun='    +IntToStr(Emit.EnderEmit.cMun));
       trvwCTe.Items.AddChild(Node,'xMun='    +Emit.EnderEmit.xMun);
       trvwCTe.Items.AddChild(Node,'UF'       +Emit.EnderEmit.UF);
       trvwCTe.Items.AddChild(Node,'cPais='   +IntToStr(Emit.EnderEmit.cPais));
       trvwCTe.Items.AddChild(Node,'xPais='   +Emit.EnderEmit.xPais);

       if Avulsa.CNPJ  <> '' then
        begin
          Node := trvwCTe.Items.AddChild(Nota,'Avulsa');
          trvwCTe.Items.AddChild(Node,'CNPJ='    +Avulsa.CNPJ);
          trvwCTe.Items.AddChild(Node,'xOrgao='  +Avulsa.xOrgao);
          trvwCTe.Items.AddChild(Node,'matr='    +Avulsa.matr );
          trvwCTe.Items.AddChild(Node,'xAgente=' +Avulsa.xAgente);
          trvwCTe.Items.AddChild(Node,'fone='    +Avulsa.fone);
          trvwCTe.Items.AddChild(Node,'UF='      +Avulsa.UF);
          trvwCTe.Items.AddChild(Node,'nDAR='    +Avulsa.nDAR);
          trvwCTe.Items.AddChild(Node,'dEmi='    +DateToStr(Avulsa.dEmi));
          trvwCTe.Items.AddChild(Node,'vDAR='    +FloatToStr(Avulsa.vDAR));
          trvwCTe.Items.AddChild(Node,'repEmi='  +Avulsa.repEmi);
          trvwCTe.Items.AddChild(Node,'dPag='    +DateToStr(Avulsa.dPag));
        end;
       Node := trvwCTe.Items.AddChild(Nota,'Dest');
       trvwCTe.Items.AddChild(Node,'CNPJCPF= ' +Dest.CNPJCPF);
       trvwCTe.Items.AddChild(Node,'IE='       +Dest.IE);
       trvwCTe.Items.AddChild(Node,'ISUF='     +Dest.ISUF);
       trvwCTe.Items.AddChild(Node,'xNome='    +Dest.xNome);

       Node := trvwCTe.Items.AddChild(Node,'EnderDest');
       trvwCTe.Items.AddChild(Node,'Fone='    +Dest.EnderDest.Fone);
       trvwCTe.Items.AddChild(Node,'CEP='     +IntToStr(Dest.EnderDest.CEP));
       trvwCTe.Items.AddChild(Node,'xLgr='    +Dest.EnderDest.xLgr);
       trvwCTe.Items.AddChild(Node,'nro='     +Dest.EnderDest.nro);
       trvwCTe.Items.AddChild(Node,'xCpl='    +Dest.EnderDest.xCpl);
       trvwCTe.Items.AddChild(Node,'xBairro=' +Dest.EnderDest.xBairro);
       trvwCTe.Items.AddChild(Node,'cMun='    +IntToStr(Dest.EnderDest.cMun));
       trvwCTe.Items.AddChild(Node,'xMun='    +Dest.EnderDest.xMun);
       trvwCTe.Items.AddChild(Node,'UF='      +Dest.EnderDest.UF );
       trvwCTe.Items.AddChild(Node,'cPais='   +IntToStr(Dest.EnderDest.cPais));
       trvwCTe.Items.AddChild(Node,'xPais='   +Dest.EnderDest.xPais);

       {if Retirada.CNPJ <> '' then
        begin
          Node := trvwCTe.Items.AddChild(Nota,'Retirada');
          trvwCTe.Items.AddChild(Node,'CNPJ='    +Retirada.CNPJ);
          trvwCTe.Items.AddChild(Node,'xLgr='    +Retirada.xLgr);
          trvwCTe.Items.AddChild(Node,'nro='     +Retirada.nro);
          trvwCTe.Items.AddChild(Node,'xCpl='    +Retirada.xCpl);
          trvwCTe.Items.AddChild(Node,'xBairro=' +Retirada.xBairro);
          trvwCTe.Items.AddChild(Node,'cMun='    +IntToStr(Retirada.cMun));
          trvwCTe.Items.AddChild(Node,'xMun='    +Retirada.xMun);
          trvwCTe.Items.AddChild(Node,'UF='      +Retirada.UF);
        end;

       if Entrega.CNPJ <> '' then
        begin
          Node := trvwCTe.Items.AddChild(Nota,'Entrega');
          trvwCTe.Items.AddChild(Node,'CNPJ='    +Entrega.CNPJ);
          trvwCTe.Items.AddChild(Node,'xLgr='    +Entrega.xLgr);
          trvwCTe.Items.AddChild(Node,'nro='     +Entrega.nro);
          trvwCTe.Items.AddChild(Node,'xCpl='    +Entrega.xCpl);
          trvwCTe.Items.AddChild(Node,'xBairro=' +Entrega.xBairro);
          trvwCTe.Items.AddChild(Node,'cMun='    +IntToStr(Entrega.cMun));
          trvwCTe.Items.AddChild(Node,'xMun='    +Entrega.xMun);
          trvwCTe.Items.AddChild(Node,'UF='      +Entrega.UF);
        end;}

       for I := 0 to Det.Count-1 do
        begin
          with Det.Items[I] do
           begin
               NodeItem := trvwCTe.Items.AddChild(Nota,'Produto'+IntToStrZero(I+1,3));
               trvwCTe.Items.AddChild(NodeItem,'nItem='  +IntToStr(Prod.nItem) );
               trvwCTe.Items.AddChild(NodeItem,'cProd='  +Prod.cProd );
               trvwCTe.Items.AddChild(NodeItem,'cEAN='   +Prod.cEAN);
               trvwCTe.Items.AddChild(NodeItem,'xProd='  +Prod.xProd);
               trvwCTe.Items.AddChild(NodeItem,'NCM='    +Prod.NCM);
               trvwCTe.Items.AddChild(NodeItem,'EXTIPI=' +Prod.EXTIPI);
               //trvwCTe.Items.AddChild(NodeItem,'genero=' +IntToStr(Prod.genero));
               trvwCTe.Items.AddChild(NodeItem,'CFOP='   +Prod.CFOP);
               trvwCTe.Items.AddChild(NodeItem,'uCom='   +Prod.uCom);
               trvwCTe.Items.AddChild(NodeItem,'qCom='   +FloatToStr(Prod.qCom));
               trvwCTe.Items.AddChild(NodeItem,'vUnCom=' +FloatToStr(Prod.vUnCom));
               trvwCTe.Items.AddChild(NodeItem,'vProd='  +FloatToStr(Prod.vProd));

               trvwCTe.Items.AddChild(NodeItem,'cEANTrib=' +Prod.cEANTrib);
               trvwCTe.Items.AddChild(NodeItem,'uTrib='    +Prod.uTrib);
               trvwCTe.Items.AddChild(NodeItem,'qTrib='    +FloatToStr(Prod.qTrib));
               trvwCTe.Items.AddChild(NodeItem,'vUnTrib='  +FloatToStr(Prod.vUnTrib));

               trvwCTe.Items.AddChild(NodeItem,'vFrete=' +FloatToStr(Prod.vFrete));
               trvwCTe.Items.AddChild(NodeItem,'vSeg='   +FloatToStr(Prod.vSeg));
               trvwCTe.Items.AddChild(NodeItem,'vDesc='  +FloatToStr(Prod.vDesc));

               trvwCTe.Items.AddChild(NodeItem,'infAdProd=' +infAdProd);

               for J:=0 to Prod.DI.Count-1 do
                begin
                  if Prod.DI.Items[j].nDi <> '' then
                   begin
                     with Prod.DI.Items[j] do
                      begin
                        NodePai := trvwCTe.Items.AddChild(NodeItem,'DI'+IntToStrZero(J+1,3));
                        trvwCTe.Items.AddChild(NodePai,'nDi='         +nDi);
                        trvwCTe.Items.AddChild(NodePai,'dDi='         +DateToStr(dDi));
                        trvwCTe.Items.AddChild(NodePai,'xLocDesemb='  +xLocDesemb);
                        trvwCTe.Items.AddChild(NodePai,'UFDesemb='    +UFDesemb);
                        trvwCTe.Items.AddChild(NodePai,'dDesemb='     +DateToStr(dDesemb));
                        trvwCTe.Items.AddChild(NodePai,'cExportador=' +cExportador);;

                        for K:=0 to adi.Count-1 do
                         begin
                           with adi.Items[K] do
                            begin
                              Node := trvwCTe.Items.AddChild(NodePai,'LADI'+IntToStrZero(K+1,3));
                              trvwCTe.Items.AddChild(Node,'nAdicao='     +IntToStr(nAdicao));
                              trvwCTe.Items.AddChild(Node,'nSeqAdi='     +IntToStr(nSeqAdi));
                              trvwCTe.Items.AddChild(Node,'cFabricante=' +cFabricante);
                              trvwCTe.Items.AddChild(Node,'vDescDI='     +FloatToStr(vDescDI));
                            end;
                         end;
                      end;
                   end
                  else
                    Break;
                end;

              if Prod.veicProd.chassi <> '' then
               begin
                 Node := trvwCTe.Items.AddChild(NodeItem,'Veiculo');
                 with Prod.veicProd do
                  begin
                    trvwCTe.Items.AddChild(Node,'tpOP='     +tpOPToStr(tpOP));
                    trvwCTe.Items.AddChild(Node,'chassi='   +chassi);
                    trvwCTe.Items.AddChild(Node,'cCor='     +cCor);
                    trvwCTe.Items.AddChild(Node,'xCor='     +xCor);
                    trvwCTe.Items.AddChild(Node,'pot='      +pot);
                    trvwCTe.Items.AddChild(Node,'Cilin='      +Cilin);
                    trvwCTe.Items.AddChild(Node,'pesoL='    +pesoL);
                    trvwCTe.Items.AddChild(Node,'pesoB='    +pesoB);
                    trvwCTe.Items.AddChild(Node,'nSerie='   +nSerie);
                    trvwCTe.Items.AddChild(Node,'tpComb='   +tpComb);
                    trvwCTe.Items.AddChild(Node,'nMotor='   +nMotor);
                    trvwCTe.Items.AddChild(Node,'CMT='     +CMT);
                    trvwCTe.Items.AddChild(Node,'dist='     +dist);
                    trvwCTe.Items.AddChild(Node,'RENAVAM='  +RENAVAM);
                    trvwCTe.Items.AddChild(Node,'anoMod='   +IntToStr(anoMod));
                    trvwCTe.Items.AddChild(Node,'anoFab='   +IntToStr(anoFab));
                    trvwCTe.Items.AddChild(Node,'tpPint='   +tpPint);
                    trvwCTe.Items.AddChild(Node,'tpVeic='   +IntToStr(tpVeic));
                    trvwCTe.Items.AddChild(Node,'espVeic='  +IntToStr(espVeic));
                    trvwCTe.Items.AddChild(Node,'VIN='      +VIN);
                    trvwCTe.Items.AddChild(Node,'condVeic=' +condVeicToStr(condVeic));
                    trvwCTe.Items.AddChild(Node,'cMod='     +cMod);
                  end;
               end;

               for J:=0 to Prod.med.Count-1 do
                begin
                  Node := trvwCTe.Items.AddChild(NodeItem,'Medicamento'+IntToStrZero(J+1,3) );
                  with Prod.med.Items[J] do
                   begin
                     trvwCTe.Items.AddChild(Node,'nLote=' +nLote);
                     trvwCTe.Items.AddChild(Node,'qLote=' +FloatToStr(qLote));
                     trvwCTe.Items.AddChild(Node,'dFab='  +DateToStr(dFab));
                     trvwCTe.Items.AddChild(Node,'dVal='  +DateToStr(dVal));
                     trvwCTe.Items.AddChild(Node,'vPMC='  +FloatToStr(vPMC));
                    end;
                end;

               for J:=0 to Prod.arma.Count-1 do
                begin
                  Node := trvwCTe.Items.AddChild(NodeItem,'Arma'+IntToStrZero(J+1,3));
                  with Prod.arma.Items[J] do
                   begin
                     trvwCTe.Items.AddChild(Node,'nSerie=' +IntToStr(nSerie));
                     trvwCTe.Items.AddChild(Node,'tpArma=' +tpArmaToStr(tpArma));
                     trvwCTe.Items.AddChild(Node,'nCano='  +IntToStr(nCano));
                     trvwCTe.Items.AddChild(Node,'descr='  +descr);
                    end;
                end;

               if (Prod.comb.cProdANP > 0) then
                begin
                 NodePai := trvwCTe.Items.AddChild(NodeItem,'Combustivel');
                 with Prod.comb do
                  begin
                    trvwCTe.Items.AddChild(NodePai,'cProdANP=' +IntToStr(cProdANP));
                    trvwCTe.Items.AddChild(NodePai,'CODIF='    +CODIF);
                    trvwCTe.Items.AddChild(NodePai,'qTemp='    +FloatToStr(qTemp));

                    Node := trvwCTe.Items.AddChild(NodePai,'CIDE'+IntToStrZero(I+1,3));
                    trvwCTe.Items.AddChild(Node,'qBCprod='   +FloatToStr(CIDE.qBCprod));
                    trvwCTe.Items.AddChild(Node,'vAliqProd=' +FloatToStr(CIDE.vAliqProd));
                    trvwCTe.Items.AddChild(Node,'vCIDE='     +FloatToStr(CIDE.vCIDE));

                    Node := trvwCTe.Items.AddChild(NodePai,'ICMSComb'+IntToStrZero(I+1,3));
                    trvwCTe.Items.AddChild(Node,'vBCICMS='   +FloatToStr(ICMS.vBCICMS));
                    trvwCTe.Items.AddChild(Node,'vICMS='     +FloatToStr(ICMS.vICMS));
                    trvwCTe.Items.AddChild(Node,'vBCICMSST=' +FloatToStr(ICMS.vBCICMSST));
                    trvwCTe.Items.AddChild(Node,'vICMSST='   +FloatToStr(ICMS.vICMSST));

                    if (ICMSInter.vBCICMSSTDest>0) then
                     begin
                       Node := trvwCTe.Items.AddChild(NodePai,'ICMSInter'+IntToStrZero(I+1,3));
                       trvwCTe.Items.AddChild(Node,'vBCICMSSTDest=' +FloatToStr(ICMSInter.vBCICMSSTDest));
                       trvwCTe.Items.AddChild(Node,'vICMSSTDest='   +FloatToStr(ICMSInter.vICMSSTDest));
                     end;

                    if (ICMSCons.vBCICMSSTCons>0) then
                     begin
                       Node := trvwCTe.Items.AddChild(NodePai,'ICMSCons'+IntToStrZero(I+1,3));
                       trvwCTe.Items.AddChild(Node,'vBCICMSSTCons=' +FloatToStr(ICMSCons.vBCICMSSTCons));
                       trvwCTe.Items.AddChild(Node,'vICMSSTCons='   +FloatToStr(ICMSCons.vICMSSTCons));
                       trvwCTe.Items.AddChild(Node,'UFCons='        +ICMSCons.UFcons);
                     end;
                  end;
               end;

               with Imposto do
                begin
                   NodePai := trvwCTe.Items.AddChild(NodeItem,'Imposto');
                   Node := trvwCTe.Items.AddChild(NodePai,'ICMS');
                   with ICMS do
                    begin
                      trvwCTe.Items.AddChild(Node,'CST=' +CSTICMSToStr(CST));

                      if CST = cst00 then
                       begin
                         trvwCTe.Items.AddChild(Node,'orig='  +OrigToStr(ICMS.orig));
                         trvwCTe.Items.AddChild(Node,'modBC=' +modBCToStr(ICMS.modBC));
                         trvwCTe.Items.AddChild(Node,'vBC='   +FloatToStr(ICMS.vBC));
                         trvwCTe.Items.AddChild(Node,'pICMS=' +FloatToStr(ICMS.pICMS));
                         trvwCTe.Items.AddChild(Node,'vICMS=' +FloatToStr(ICMS.vICMS));
                       end
                      else if CST = cst10 then
                       begin
                         trvwCTe.Items.AddChild(Node,'orig='     +OrigToStr(ICMS.orig));
                         trvwCTe.Items.AddChild(Node,'modBC='    +modBCToStr(ICMS.modBC));
                         trvwCTe.Items.AddChild(Node,'vBC='      +FloatToStr(ICMS.vBC));
                         trvwCTe.Items.AddChild(Node,'pICMS='    +FloatToStr(ICMS.pICMS));
                         trvwCTe.Items.AddChild(Node,'vICMS='    +FloatToStr(ICMS.vICMS));
                         trvwCTe.Items.AddChild(Node,'modBCST='  +modBCSTToStr(ICMS.modBCST));
                         trvwCTe.Items.AddChild(Node,'pMVAST='   +FloatToStr(ICMS.pMVAST));
                         trvwCTe.Items.AddChild(Node,'pRedBCST=' +FloatToStr(ICMS.pRedBCST));
                         trvwCTe.Items.AddChild(Node,'vBCST='    +FloatToStr(ICMS.vBCST));
                         trvwCTe.Items.AddChild(Node,'pICMSST='  +FloatToStr(ICMS.pICMSST));
                         trvwCTe.Items.AddChild(Node,'vICMSST='  +FloatToStr(ICMS.vICMSST));
                       end
                      else if CST = cst20 then
                       begin
                         trvwCTe.Items.AddChild(Node,'orig='   +OrigToStr(ICMS.orig));
                         trvwCTe.Items.AddChild(Node,'modBC='  +modBCToStr(ICMS.modBC));
                         trvwCTe.Items.AddChild(Node,'pRedBC=' +FloatToStr(ICMS.pRedBC));
                         trvwCTe.Items.AddChild(Node,'vBC='    +FloatToStr(ICMS.vBC));
                         trvwCTe.Items.AddChild(Node,'pICMS='  +FloatToStr(ICMS.pICMS));
                         trvwCTe.Items.AddChild(Node,'vICMS='  +FloatToStr(ICMS.vICMS));
                       end
                      else if CST = cst30 then
                       begin
                         trvwCTe.Items.AddChild(Node,'orig='     +OrigToStr(ICMS.orig));
                         trvwCTe.Items.AddChild(Node,'modBCST='  +modBCSTToStr(ICMS.modBCST));
                         trvwCTe.Items.AddChild(Node,'pMVAST='   +FloatToStr(ICMS.pMVAST));
                         trvwCTe.Items.AddChild(Node,'pRedBCST=' +FloatToStr(ICMS.pRedBCST));
                         trvwCTe.Items.AddChild(Node,'vBCST='    +FloatToStr(ICMS.vBCST));
                         trvwCTe.Items.AddChild(Node,'pICMSST='  +FloatToStr(ICMS.pICMSST));
                         trvwCTe.Items.AddChild(Node,'vICMSST='  +FloatToStr(ICMS.vICMSST));
                       end
                      else if (CST = cst40) or (CST = cst41) or (CST = cst50) then
                       begin
                         trvwCTe.Items.AddChild(Node,'orig='    +OrigToStr(ICMS.orig));
                       end
                      else if CST = cst51 then
                         begin
                         trvwCTe.Items.AddChild(Node,'orig='    +OrigToStr(ICMS.orig));
                         trvwCTe.Items.AddChild(Node,'modBC='   +modBCToStr(ICMS.modBC));
                         trvwCTe.Items.AddChild(Node,'pRedBC='  +FloatToStr(ICMS.pRedBC));
                         trvwCTe.Items.AddChild(Node,'vBC='     +FloatToStr(ICMS.vBC));
                         trvwCTe.Items.AddChild(Node,'pICMS='   +FloatToStr(ICMS.pICMS));
                         trvwCTe.Items.AddChild(Node,'vICMS='   +FloatToStr(ICMS.vICMS));
                       end
                      else if CST = cst60 then
                       begin
                         trvwCTe.Items.AddChild(Node,'orig='    +OrigToStr(ICMS.orig));
                         trvwCTe.Items.AddChild(Node,'vBCST='   +FloatToStr(ICMS.vBCST));
                         trvwCTe.Items.AddChild(Node,'vICMSST=' +FloatToStr(ICMS.vICMSST));
                       end
                      else if CST = cst70 then
                       begin
                         trvwCTe.Items.AddChild(Node,'orig='       +OrigToStr(ICMS.orig));
                         trvwCTe.Items.AddChild(Node,'modBC='      +modBCToStr(ICMS.modBC));
                         trvwCTe.Items.AddChild(Node,'pRedBC='     +FloatToStr(ICMS.pRedBC));
                         trvwCTe.Items.AddChild(Node,'vBC='        +FloatToStr(ICMS.vBC));
                         trvwCTe.Items.AddChild(Node,'pICMS='      +FloatToStr(ICMS.pICMS));
                         trvwCTe.Items.AddChild(Node,'vICMS='      +FloatToStr(ICMS.vICMS));
                         trvwCTe.Items.AddChild(Node,'modBCST='    +modBCSTToStr(ICMS.modBCST));
                         trvwCTe.Items.AddChild(Node,'pMVAST='     +FloatToStr(ICMS.pMVAST));
                         trvwCTe.Items.AddChild(Node,'pRedBCST='   +FloatToStr(ICMS.pRedBCST));
                         trvwCTe.Items.AddChild(Node,'vBCST='      +FloatToStr(ICMS.vBCST));
                         trvwCTe.Items.AddChild(Node,'pICMSST='    +FloatToStr(ICMS.pICMSST));
                         trvwCTe.Items.AddChild(Node,'vICMSST='    +FloatToStr(ICMS.vICMSST));
                       end
                      else if CST = cst90 then
                       begin
                         trvwCTe.Items.AddChild(Node,'orig='       +OrigToStr(ICMS.orig));
                         trvwCTe.Items.AddChild(Node,'modBC='      +modBCToStr(ICMS.modBC));
                         trvwCTe.Items.AddChild(Node,'pRedBC='     +FloatToStr(ICMS.pRedBC));
                         trvwCTe.Items.AddChild(Node,'vBC='        +FloatToStr(ICMS.vBC));
                         trvwCTe.Items.AddChild(Node,'pICMS='      +FloatToStr(ICMS.pICMS));
                         trvwCTe.Items.AddChild(Node,'vICMS='      +FloatToStr(ICMS.vICMS));
                         trvwCTe.Items.AddChild(Node,'modBCST='    +modBCSTToStr(ICMS.modBCST));
                         trvwCTe.Items.AddChild(Node,'pMVAST='     +FloatToStr(ICMS.pMVAST));
                         trvwCTe.Items.AddChild(Node,'pRedBCST='   +FloatToStr(ICMS.pRedBCST));
                         trvwCTe.Items.AddChild(Node,'vBCST='      +FloatToStr(ICMS.vBCST));
                         trvwCTe.Items.AddChild(Node,'pICMSST='    +FloatToStr(ICMS.pICMSST));
                         trvwCTe.Items.AddChild(Node,'vICMSST='    +FloatToStr(ICMS.vICMSST));
                       end;
                    end;

                   if (IPI.vBC > 0) then
                    begin
                      Node := trvwCTe.Items.AddChild(NodePai,'IPI');
                      with IPI do
                       begin
                         trvwCTe.Items.AddChild(Node,'CST='       +CSTIPIToStr(CST));
                         trvwCTe.Items.AddChild(Node,'clEnq='    +clEnq);
                         trvwCTe.Items.AddChild(Node,'CNPJProd=' +CNPJProd);
                         trvwCTe.Items.AddChild(Node,'cSelo='    +cSelo);
                         trvwCTe.Items.AddChild(Node,'qSelo='    +IntToStr(qSelo));
                         trvwCTe.Items.AddChild(Node,'cEnq='     +cEnq);

                         trvwCTe.Items.AddChild(Node,'vBC='    +FloatToStr(vBC));
                         trvwCTe.Items.AddChild(Node,'qUnid='  +FloatToStr(qUnid));
                         trvwCTe.Items.AddChild(Node,'vUnid='  +FloatToStr(vUnid));
                         trvwCTe.Items.AddChild(Node,'pIPI='   +FloatToStr(pIPI));
                         trvwCTe.Items.AddChild(Node,'vIPI='   +FloatToStr(vIPI));
                       end;
                    end;

                   if (II.vBc > 0) then
                    begin
                      Node := trvwCTe.Items.AddChild(NodePai,'II');
                      with II do
                       begin
                         trvwCTe.Items.AddChild(Node,'vBc='      +FloatToStr(vBc));
                         trvwCTe.Items.AddChild(Node,'vDespAdu=' +FloatToStr(vDespAdu));
                         trvwCTe.Items.AddChild(Node,'vII='      +FloatToStr(vII));
                         trvwCTe.Items.AddChild(Node,'vIOF='     +FloatToStr(vIOF));
                       end;
                    end;

                   Node := trvwCTe.Items.AddChild(NodePai,'PIS');
                   with PIS do
                    begin
                      trvwCTe.Items.AddChild(Node,'CST=' +CSTPISToStr(CST));

                      if (CST = pis01) or (CST = pis02) then
                       begin
                         trvwCTe.Items.AddChild(Node,'vBC='  +FloatToStr(PIS.vBC));
                         trvwCTe.Items.AddChild(Node,'pPIS=' +FloatToStr(PIS.pPIS));
                         trvwCTe.Items.AddChild(Node,'vPIS=' +FloatToStr(PIS.vPIS));
                       end
                      else if CST = pis03 then
                       begin
                         trvwCTe.Items.AddChild(Node,'qBCProd='   +FloatToStr(PIS.qBCProd));
                         trvwCTe.Items.AddChild(Node,'vAliqProd=' +FloatToStr(PIS.vAliqProd));
                         trvwCTe.Items.AddChild(Node,'vPIS='      +FloatToStr(PIS.vPIS));
                       end
                      else if CST = pis99 then
                       begin
                         trvwCTe.Items.AddChild(Node,'vBC='       +FloatToStr(PIS.vBC));
                         trvwCTe.Items.AddChild(Node,'pPIS='      +FloatToStr(PIS.pPIS));
                         trvwCTe.Items.AddChild(Node,'qBCProd='   +FloatToStr(PIS.qBCProd));
                         trvwCTe.Items.AddChild(Node,'vAliqProd=' +FloatToStr(PIS.vAliqProd));
                         trvwCTe.Items.AddChild(Node,'vPIS='      +FloatToStr(PIS.vPIS));
                       end;
                    end;

                   if (PISST.vBc>0) then
                    begin
                      Node := trvwCTe.Items.AddChild(NodePai,'PISST');
                      with PISST do
                       begin
                         trvwCTe.Items.AddChild(Node,'vBc='       +FloatToStr(vBc));
                         trvwCTe.Items.AddChild(Node,'pPis='      +FloatToStr(pPis));
                         trvwCTe.Items.AddChild(Node,'qBCProd='   +FloatToStr(qBCProd));
                         trvwCTe.Items.AddChild(Node,'vAliqProd=' +FloatToStr(vAliqProd));
                         trvwCTe.Items.AddChild(Node,'vPIS='      +FloatToStr(vPIS));
                       end;
                      end;

                   Node := trvwCTe.Items.AddChild(NodePai,'COFINS');
                   with COFINS do
                    begin
                      trvwCTe.Items.AddChild(Node,'CST=' +CSTCOFINSToStr(CST));

                      if (CST = cof01) or (CST = cof02)   then
                       begin
                         trvwCTe.Items.AddChild(Node,'vBC='     +FloatToStr(COFINS.vBC));
                         trvwCTe.Items.AddChild(Node,'pCOFINS=' +FloatToStr(COFINS.pCOFINS));
                         trvwCTe.Items.AddChild(Node,'vCOFINS=' +FloatToStr(COFINS.vCOFINS));
                       end
                      else if CST = cof03 then
                       begin
                         trvwCTe.Items.AddChild(Node,'qBCProd='   +FloatToStr(COFINS.qBCProd));
                         trvwCTe.Items.AddChild(Node,'vAliqProd=' +FloatToStr(COFINS.vAliqProd));
                         trvwCTe.Items.AddChild(Node,'vCOFINS='   +FloatToStr(COFINS.vCOFINS));
                       end
                      else if CST = cof99 then
                       begin
                         trvwCTe.Items.AddChild(Node,'vBC='       +FloatToStr(COFINS.vBC));
                         trvwCTe.Items.AddChild(Node,'pCOFINS='   +FloatToStr(COFINS.pCOFINS));
                         trvwCTe.Items.AddChild(Node,'qBCProd='   +FloatToStr(COFINS.qBCProd));
                         trvwCTe.Items.AddChild(Node,'vAliqProd=' +FloatToStr(COFINS.vAliqProd));
                         trvwCTe.Items.AddChild(Node,'vCOFINS='   +FloatToStr(COFINS.vCOFINS));
                       end;
                    end;

                   if (COFINSST.vBC > 0) then
                    begin
                      Node := trvwCTe.Items.AddChild(NodePai,'COFINSST');
                      with COFINSST do
                       begin
                         trvwCTe.Items.AddChild(Node,'vBC='       +FloatToStr(vBC));
                         trvwCTe.Items.AddChild(Node,'pCOFINS='   +FloatToStr(pCOFINS));
                         trvwCTe.Items.AddChild(Node,'qBCProd='   +FloatToStr(qBCProd));
                         trvwCTe.Items.AddChild(Node,'vAliqProd=' +FloatToStr(vAliqProd));
                         trvwCTe.Items.AddChild(Node,'vCOFINS='   +FloatToStr(vCOFINS));
                       end;
                    end;

                   if (ISSQN.vBC > 0) then
                    begin
                     Node := trvwCTe.Items.AddChild(NodePai,'ISSQN');
                     with ISSQN do
                      begin
                        trvwCTe.Items.AddChild(Node,'vBC='       +FloatToStr(vBC));
                        trvwCTe.Items.AddChild(Node,'vAliq='     +FloatToStr(vAliq));
                        trvwCTe.Items.AddChild(Node,'vISSQN='    +FloatToStr(vISSQN));
                        trvwCTe.Items.AddChild(Node,'cMunFG='    +IntToStr(cMunFG));
                        trvwCTe.Items.AddChild(Node,'cListServ=' +IntToStr(cListServ));
                      end;
                    end;
                end;
             end;
          end;

       NodePai := trvwCTe.Items.AddChild(Nota,'Total');
       Node := trvwCTe.Items.AddChild(NodePai,'ICMSTot');
       trvwCTe.Items.AddChild(Node,'vBC='     +FloatToStr(Total.ICMSTot.vBC));
       trvwCTe.Items.AddChild(Node,'vICMS='   +FloatToStr(Total.ICMSTot.vICMS));
       trvwCTe.Items.AddChild(Node,'vBCST='   +FloatToStr(Total.ICMSTot.vBCST));
       trvwCTe.Items.AddChild(Node,'vST='     +FloatToStr(Total.ICMSTot.vST));
       trvwCTe.Items.AddChild(Node,'vProd='   +FloatToStr(Total.ICMSTot.vProd));
       trvwCTe.Items.AddChild(Node,'vFrete='  +FloatToStr(Total.ICMSTot.vFrete));
       trvwCTe.Items.AddChild(Node,'vSeg='    +FloatToStr(Total.ICMSTot.vSeg));
       trvwCTe.Items.AddChild(Node,'vDesc='   +FloatToStr(Total.ICMSTot.vDesc));
       trvwCTe.Items.AddChild(Node,'vII='     +FloatToStr(Total.ICMSTot.vII));
       trvwCTe.Items.AddChild(Node,'vIPI='    +FloatToStr(Total.ICMSTot.vIPI));
       trvwCTe.Items.AddChild(Node,'vPIS='    +FloatToStr(Total.ICMSTot.vPIS));
       trvwCTe.Items.AddChild(Node,'vCOFINS=' +FloatToStr(Total.ICMSTot.vCOFINS));
       trvwCTe.Items.AddChild(Node,'vOutro='  +FloatToStr(Total.ICMSTot.vOutro));
       trvwCTe.Items.AddChild(Node,'vNF='     +FloatToStr(Total.ICMSTot.vNF));

       if Total.ISSQNtot.vServ > 0 then
        begin
          Node := trvwCTe.Items.AddChild(NodePai,'ISSQNtot');
          trvwCTe.Items.AddChild(Node,'vServ='   +FloatToStr(Total.ISSQNtot.vServ));
          trvwCTe.Items.AddChild(Node,'vBC='     +FloatToStr(Total.ISSQNTot.vBC));
          trvwCTe.Items.AddChild(Node,'vISS='    +FloatToStr(Total.ISSQNTot.vISS));
          trvwCTe.Items.AddChild(Node,'vPIS='    +FloatToStr(Total.ISSQNTot.vPIS));
          trvwCTe.Items.AddChild(Node,'vCOFINS=' +FloatToStr(Total.ISSQNTot.vCOFINS));
        end;

       Node := trvwCTe.Items.AddChild(NodePai,'retTrib');
       trvwCTe.Items.AddChild(Node,'vRetPIS='   +FloatToStr(Total.retTrib.vRetPIS));
       trvwCTe.Items.AddChild(Node,'vRetCOFINS='+FloatToStr(Total.retTrib.vRetCOFINS));
       trvwCTe.Items.AddChild(Node,'vRetCSLL='  +FloatToStr(Total.retTrib.vRetCSLL));
       trvwCTe.Items.AddChild(Node,'vBCIRRF='   +FloatToStr(Total.retTrib.vBCIRRF));
       trvwCTe.Items.AddChild(Node,'vIRRF='     +FloatToStr(Total.retTrib.vIRRF));
       trvwCTe.Items.AddChild(Node,'vBCRetPrev='+FloatToStr(Total.retTrib.vBCRetPrev));
       trvwCTe.Items.AddChild(Node,'vRetPrev='  +FloatToStr(Total.retTrib.vRetPrev));

       NodePai := trvwCTe.Items.AddChild(Nota,'Transp');
       Node := trvwCTe.Items.AddChild(NodePai,'Transporta');
       trvwCTe.Items.AddChild(Node,'modFrete=' +modFreteToStr(Transp.modFrete));
       trvwCTe.Items.AddChild(Node,'CNPJCPF='  +Transp.Transporta.CNPJCPF);
       trvwCTe.Items.AddChild(Node,'xNome='    +Transp.Transporta.xNome);
       trvwCTe.Items.AddChild(Node,'IE='       +Transp.Transporta.IE);
       trvwCTe.Items.AddChild(Node,'xEnder='   +Transp.Transporta.xEnder);
       trvwCTe.Items.AddChild(Node,'xMun='     +Transp.Transporta.xMun);
       trvwCTe.Items.AddChild(Node,'UF='       +Transp.Transporta.UF);

       Node := trvwCTe.Items.AddChild(NodePai,'retTransp');
       trvwCTe.Items.AddChild(Node,'vServ='    +FloatToStr(Transp.retTransp.vServ));
       trvwCTe.Items.AddChild(Node,'vBCRet='   +FloatToStr(Transp.retTransp.vBCRet));
       trvwCTe.Items.AddChild(Node,'pICMSRet=' +FloatToStr(Transp.retTransp.pICMSRet));
       trvwCTe.Items.AddChild(Node,'vICMSRet=' +FloatToStr(Transp.retTransp.vICMSRet));
       trvwCTe.Items.AddChild(Node,'CFOP='     +Transp.retTransp.CFOP);
       trvwCTe.Items.AddChild(Node,'cMunFG='   +FloatToStr(Transp.retTransp.cMunFG));

       Node := trvwCTe.Items.AddChild(NodePai,'veicTransp');
       trvwCTe.Items.AddChild(Node,'placa='  +Transp.veicTransp.placa);
       trvwCTe.Items.AddChild(Node,'UF='     +Transp.veicTransp.UF);
       trvwCTe.Items.AddChild(Node,'RNTC='   +Transp.veicTransp.RNTC);

       for I:=0 to Transp.Reboque.Count-1 do
        begin
          Node := trvwCTe.Items.AddChild(NodePai,'Reboque'+IntToStrZero(I+1,3));
          with Transp.Reboque.Items[I] do
           begin
             trvwCTe.Items.AddChild(Node,'placa=' +placa);
             trvwCTe.Items.AddChild(Node,'UF='    +UF);
             trvwCTe.Items.AddChild(Node,'RNTC='  +RNTC);
           end;
        end;

       for I:=0 to Transp.Vol.Count-1 do
        begin
          Node := trvwCTe.Items.AddChild(NodePai,'Volume'+IntToStrZero(I+1,3));
          with Transp.Vol.Items[I] do
           begin
             trvwCTe.Items.AddChild(Node,'qVol='  +IntToStr(qVol));
             trvwCTe.Items.AddChild(Node,'esp='   +esp);
             trvwCTe.Items.AddChild(Node,'marca=' +marca);
             trvwCTe.Items.AddChild(Node,'nVol='  +nVol);
             trvwCTe.Items.AddChild(Node,'pesoL=' +FloatToStr(pesoL));
             trvwCTe.Items.AddChild(Node,'pesoB'  +FloatToStr(pesoB));

             for J:=0 to Lacres.Count-1 do
              begin
                Node := trvwCTe.Items.AddChild(Node,'Lacre'+IntToStrZero(I+1,3)+IntToStrZero(J+1,3) );
                trvwCTe.Items.AddChild(Node,'nLacre='+Lacres.Items[J].nLacre);
              end;
           end;
        end;

       NodePai := trvwCTe.Items.AddChild(Nota,'Cobr');
       Node    := trvwCTe.Items.AddChild(NodePai,'Fat');
       trvwCTe.Items.AddChild(Node,'nFat='  +Cobr.Fat.nFat);
       trvwCTe.Items.AddChild(Node,'vOrig=' +FloatToStr(Cobr.Fat.vOrig));
       trvwCTe.Items.AddChild(Node,'vDesc=' +FloatToStr(Cobr.Fat.vDesc));
       trvwCTe.Items.AddChild(Node,'vLiq='  +FloatToStr(Cobr.Fat.vLiq));

       for I:=0 to Cobr.Dup.Count-1 do
        begin
          Node    := trvwCTe.Items.AddChild(NodePai,'Duplicata'+IntToStrZero(I+1,3));
          with Cobr.Dup.Items[I] do
           begin
             trvwCTe.Items.AddChild(Node,'nDup='  +nDup);
             trvwCTe.Items.AddChild(Node,'dVenc=' +DateToStr(dVenc));
             trvwCTe.Items.AddChild(Node,'vDup='  +FloatToStr(vDup));
           end;
        end;

       NodePai := trvwCTe.Items.AddChild(Nota,'InfAdic');
       trvwCTe.Items.AddChild(NodePai,'infCpl='     +InfAdic.infCpl);
       trvwCTe.Items.AddChild(NodePai,'infAdFisco=' +InfAdic.infAdFisco);

       for I:=0 to InfAdic.obsCont.Count-1 do
        begin
          Node := trvwCTe.Items.AddChild(NodePai,'obsCont'+IntToStrZero(I+1,3));
          with InfAdic.obsCont.Items[I] do
           begin
             trvwCTe.Items.AddChild(Node,'xCampo=' +xCampo);
             trvwCTe.Items.AddChild(Node,'xTexto=' +xTexto);
           end;
        end;

         for I:=0 to InfAdic.obsFisco.Count-1 do
          begin
            Node := trvwCTe.Items.AddChild(NodePai,'obsFisco'+IntToStrZero(I+1,3));
            with InfAdic.obsFisco.Items[I] do
             begin
                trvwCTe.Items.AddChild(Node,'xCampo=' +xCampo);
                trvwCTe.Items.AddChild(Node,'xTexto=' +xTexto);
             end;
          end;

         for I:=0 to InfAdic.procRef.Count-1 do
          begin
            Node := trvwCTe.Items.AddChild(NodePai,'procRef'+IntToStrZero(I+1,3));
            with InfAdic.procRef.Items[I] do
             begin
               trvwCTe.Items.AddChild(Node,'nProc='   +nProc);
               trvwCTe.Items.AddChild(Node,'indProc=' +indProcToStr(indProc));
             end;
          end;

         if (exporta.UFembarq <> '') then
          begin
            Node := trvwCTe.Items.AddChild(Nota,'exporta');
            trvwCTe.Items.AddChild(Node,'UFembarq='   +exporta.UFembarq);
            trvwCTe.Items.AddChild(Node,'xLocEmbarq=' +exporta.xLocEmbarq);
          end;

         if (compra.xNEmp <> '') then
          begin
            Node := trvwCTe.Items.AddChild(Nota,'compra');
            trvwCTe.Items.AddChild(Node,'xNEmp=' +compra.xNEmp);
            trvwCTe.Items.AddChild(Node,'xPed='  +compra.xPed);
            trvwCTe.Items.AddChild(Node,'xCont=' +compra.xCont);
          end;
      *)
      end;
      PageControl2.ActivePageIndex := 3;
    end;
  end;
end;

procedure Tfrmconhecimento.btnEnviarEmailClick(Sender: TObject);
var
  Para: string;
  CC: Tstrings;
begin
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;

  {if not (InputQuery('Enviar Email', 'Email de destino', Para))
    then exit;}

  OpenDialog1.Title := 'Selecione o CTe';
  OpenDialog1.DefaultExt := '*-cte.xml';
  OpenDialog1.Filter := 'Arquivos CTe (*-cte.xml)|*-cte.xml|Arquivos XML (*.xml)|*.xml|Todos os Arquivos (*.*)|*.*';
  OpenDialog1.InitialDir := Cte.Configuracoes.Geral.PathSalvar;

  if OpenDialog1.Execute then
  begin
    Cte.Conhecimentos.Clear;
    Cte.Conhecimentos.LoadFromFile(OpenDialog1.FileName);
    CC := TstringList.Create;
    CC.Add('email_1@provedor.com'); //especifique um email válido
    CC.Add('email_2@provedor.com.br'); //especifique um email válido
    Cte.Conhecimentos.Items[0].EnviarEmail(edtSmtpHost.Text
      , edtSmtpPort.Text
      , edtSmtpUser.Text
      , edtSmtpPass.Text
      , edtSmtpUser.Text
      , Para
      , edtEmailAssunto.Text
      , mmEmailMsg.Lines
      , cbEmailSSL.Checked
      , False //Enviar PDF junto
      , nil //Lista com emails que serão enviado cópias - TStrings
      , nil // Lista de anexos - TStrings
      , False); //Pede confirmação de leitura do email
    CC.Free;
  end;
end;

procedure Tfrmconhecimento.FormCreate(Sender: TObject);
begin
  dacte1.FastFile := 'C:\iCloud\Server\Cte\Report\DACTE_1_04.fr3';
  Cte.Configuracoes.Certificados.NumeroSerie := edtNumSerie.Text;
  PageSheet10.Enabled := False;
end;

procedure Tfrmconhecimento.bt_nfe_statusClick(Sender: TObject);
begin
  PageView1.ActivePageIndex := 6;
  PageControl2.ActivePageIndex := 1;

  Cte.WebServices.StatusServico.Executar;
  MemoResp.Lines.Text := UTF8Encode(Cte.WebServices.StatusServico.RetWS);
  memoRespWS.Lines.Text := UTF8Encode(Cte.WebServices.StatusServico.RetWS);
  LoadXML(MemoResp, WBResposta);

  MemoDados.Lines.Add('');
  MemoDados.Lines.Add('Status Serviço');
  MemoDados.Lines.Add('tpAmb: ' + TpAmbToStr(Cte.WebServices.StatusServico.tpAmb));
  MemoDados.Lines.Add('verAplic: ' + Cte.WebServices.StatusServico.verAplic);
  MemoDados.Lines.Add('cStat: ' + IntToStr(Cte.WebServices.StatusServico.cStat));
  MemoDados.Lines.Add('xMotivo: ' + Cte.WebServices.StatusServico.xMotivo);
  MemoDados.Lines.Add('cUF: ' + IntToStr(Cte.WebServices.StatusServico.cUF));
  MemoDados.Lines.Add('dhRecbto: ' + DateTimeToStr(Cte.WebServices.StatusServico.dhRecbto));
  MemoDados.Lines.Add('tMed: ' + IntToStr(Cte.WebServices.StatusServico.TMed));
  MemoDados.Lines.Add('dhRetorno: ' + DateTimeToStr(Cte.WebServices.StatusServico.dhRetorno));
  MemoDados.Lines.Add('xObs: ' + Cte.WebServices.StatusServico.xObs);

  frmMsg_Operador := TfrmMsg_Operador.create(self);
  frmmodulo.tipo_msg := 1;
  frmMsg_Operador.lb_msg.Font.Style := [fsBold];
  frmMsg_Operador.lb_msg.Caption := Cte.WebServices.StatusServico.xMotivo;
  frmMsg_Operador.showmodal;
end;

procedure Tfrmconhecimento.bt_nfe_danfeClick(Sender: TObject);
var sXML: string;
begin
  //if edtchave.Text := '' then Exit;

  sXML := ExtractFilePath(Application.ExeName) + 'Cte\' +
    FormatDateTime('yyyy', edata_cadastro.Date) +
    FormatDateTime('mm', edata_cadastro.Date) +
    '\CTe\' + edtchave.text + '-cte.xml';


  try


    if FileExists(sxml) then
    begin
      Cte.Conhecimentos.Clear;
      Cte.Conhecimentos.LoadFromFile(sxml);
      if Cte.Conhecimentos.Items[0].CTe.Ide.tpEmis = teDPEC then
      begin
     {
     ACBrCTe1.WebServices.ConsultaDPEC.CTeChave := ACBrCTe1.Conhecimentos.Items[0].CTe.infCTe.ID;
     ACBrCTe1.WebServices.ConsultaDPEC.Executar;
     ACBrCTe1.DACTe.ProtocoloCTe := ACBrCTe1.WebServices.ConsultaDPEC.nRegDPEC +
       ' '+ DateTimeToStr(ACBrCTe1.WebServices.ConsultaDPEC.retDPEC.dhRegDPEC);
     }
      end;
      Cte.Conhecimentos.Imprimir;
    end
    else
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Arquivo XML não Encontrado!!!';
      frmMsg_Operador.showmodal;
    end;

  except
    on E: exception do
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Erro ao criar/imprimir CT-e!!!' + #13 +
        'Mensagem: ' + E.message;
      frmMsg_Operador.showmodal;
      Exit;
    end;
  end;
end;

procedure Tfrmconhecimento.bt_nfe_validarClick(Sender: TObject);
var sXML, caminho: string;
begin

  case frmmodulo.qrconhecimento.fieldbyname('CTE_SITUACAO').AsInteger of
// 3 - nao validada


    4: begin // validada
        if Application.messagebox('Este CT-e já foi validado! Deseja prosseguir?',
          'Atenção', mb_yesno + MB_ICONWARNING + MB_DEFBUTTON2) = idno then
          exit;
      end;
    5: begin // transmitida
        if Application.messagebox('Este CT-e já foi validado e transmitido! Deseja prosseguir?',
          'Atenção', mb_yesno + MB_ICONWARNING + MB_DEFBUTTON2) = idno then
          exit;
      end;

    6: begin // Aceita
        if Application.messagebox('Este CT-e já foi validado/aceito pela receita! Deseja prosseguir?',
          'Atenção', mb_yesno + MB_ICONWARNING + MB_DEFBUTTON2) = idno then
          exit;
      end;

    7: begin // rejeitada
        if Application.messagebox('Este CT-e já foi validado e rejeitado! Deseja prosseguir?',
          'Atenção', mb_yesno + MB_ICONWARNING + MB_DEFBUTTON2) = idno then
          exit;
      end;
    8: begin // cancelada
        Application.messagebox('Este CT-e já foi cancelado!',
          'Erro', mb_ok + MB_ICONerror);
        exit;
      end;
  end;

  try

    sXML := Gerar_XML;

    Application.ProcessMessages;

    if FileExists(sXML) then
    begin
      Cte.Conhecimentos.Clear;
      Cte.Conhecimentos.LoadFromFile(sXML);
      Cte.Conhecimentos.Valida;

      frmmodulo.qrconhecimento.edit;
      frmmodulo.qrconhecimento.FieldByName('cte_xml').asstring := sXML;
      frmmodulo.qrconhecimento.FieldByName('cte_situacao').asinteger := 4;
      frmmodulo.qrconhecimento.post;


      bt_nfe_assinar.Click;

    end
    else
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmMsg_Operador.Timer1.Enabled := False;
      frmMsg_Operador.lb_msg.Width := 70;
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Arquivo XML não Encontrado!!!';
      frmMsg_Operador.showmodal;

      exit;
    end;
  finally

  end;

end;

function Tfrmconhecimento.Gerar_XML: string;
var
  vAux, caminho: string;
  Vaux1: Integer;
begin

  vAux1 := strtoInt(DBEdit2.Text);
  vAux := IntToStr(Vaux1);

  try
    Cte.Conhecimentos.Clear;
    //gerar xml alimenta compo. dados
    GerarCTe(vAux);
    //salvar arquivo e gerar o xml
    Cte.Conhecimentos.Items[0].SaveToFile;


    //edtchave.text := copy(cte.Conhecimentos.Items[0].CTe.infCTe.ID, 4, 44);



  except
    on E: exception do
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmMsg_Operador.Timer1.Enabled := False;
      frmMsg_Operador.lb_msg.Width := 70;
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Erro ao Criar CT-e.:Funções Envolvidas:' + #13 +
        'GerarCTe / SaveToFile' + #13 +
        'Mensagem: ' + E.message;
      frmMsg_Operador.showmodal;
      Exit;
    end;

  end;

  //ShowMessage('Arquivo gerado em: ' + Cte.Conhecimentos.Items[0].NomeArq);
  PageControl2.ActivePageIndex := 1;
  MemoDados.Lines.Add('Arquivo gerado em: ' + Cte.Conhecimentos.Items[0].NomeArq);
  MemoResp.Lines.LoadFromFile(Cte.Conhecimentos.Items[0].NomeArq);
  LoadXML(MemoResp, WBResposta);
end;

procedure Tfrmconhecimento.bt_nfe_exportarClick(Sender: TObject);
var
  Para: string;
  sXML: string;
  bserv: boolean;
  StreamMemo: TMemoryStream;
  Email: TEmail;
begin
  try
    sXML := ExtractFilePath(Application.ExeName) + 'Cte\' +
      FormatDateTime('yyyy', edata_cadastro.Date) +
      FormatDateTime('mm', edata_cadastro.Date) +
      '\CTe\' + edtchave.text + '-cte.xml';

    Application.ProcessMessages; ;

    if FileExists(sXML) then
    begin
      frmmodulo.qrconfig.open;
      if edtSmtpHost.text = '' then
      begin
        frmMsg_Operador := TfrmMsg_Operador.create(self);
        frmMsg_Operador.lb_msg.Font.Style := [fsBold];
        frmmodulo.tipo_msg := 4;
        frmMsg_Operador.lb_msg.Caption := 'Favor configurar a conta de email!';
        frmMsg_Operador.showmodal;
        exit;
      end;

      qrnfe_cliente.close;
      qrnfe_cliente.sql.clear;
      qrnfe_cliente.sql.add('select email from c000007');
      qrnfe_cliente.sql.add('where codigo = ''' + ecliente.Text + '''');
      qrnfe_cliente.open;

      para := qrNFE_Cliente.fieldbyname('email').asstring;

      if para = '' then
      begin
        frmMsg_Operador := TfrmMsg_Operador.create(self);
        frmMsg_Operador.lb_msg.Font.Style := [fsBold];
        frmmodulo.tipo_msg := 4;
        frmMsg_Operador.lb_msg.Caption := 'Favor cadastrar email do cliente!!!';
        frmMsg_Operador.showmodal;
        exit;
      end;

      if cbEmailSSL.Checked then
        bserv := true
      else
        bserv := false;

      Email := TEmail.Create;
      //'' opção de e-mail configurar essa opção
      if Email.EnviarEmail(edtCTe.Text,
        para,
        edtEmailAssunto.text,
        mmEmailMsg.Text,
        sxml,
        edtSmtpUser.text,
        edtSmtpPass.text,
        edtSmtpHost.text,
        strtoint(edtSmtpPort.Text)
        ) then
      begin
        frmMsg_Operador := TfrmMsg_Operador.create(self);
        frmMsg_Operador.lb_msg.Font.Style := [fsBold];
        frmmodulo.tipo_msg := 1;
        frmMsg_Operador.lb_msg.Caption := 'Email enviado com sucesso!!!';
        frmMsg_Operador.showmodal;
      end
      else
      begin
        frmMsg_Operador := TfrmMsg_Operador.create(self);
        frmMsg_Operador.lb_msg.Font.Style := [fsBold];
        frmmodulo.tipo_msg := 2;
        frmMsg_Operador.lb_msg.Caption := 'Erro ao enviar xml do CT-e!!!' + #13 +
          'Mensagem: ' + 'Reveja suas configurações de email';
        frmMsg_Operador.showmodal;
        Exit;
      end;

      Email.Free;

    end
    else
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Arquivo XML não encontrado!!!';
      frmMsg_Operador.showmodal;
      exit;
    end;
  except
    on E: exception do
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Erro ao enviar email do CT-e!!!' + #13 +
        'Mensagem: ' + E.message;
      frmMsg_Operador.showmodal;
      Exit;
    end;
  end;
end;

procedure Tfrmconhecimento.bt_logClick(Sender: TObject);
begin
  PageView1.ActivePageIndex := 6;
end;

procedure Tfrmconhecimento.Localizar1Click(Sender: TObject);
begin
  frmloc_conhecimento := tfrmloc_conhecimento.create(self);
  frmloc_conhecimento.showmodal;
end;

procedure Tfrmconhecimento.rgtomadorClick(Sender: TObject);
begin
  if rgtomador.ItemIndex = 4 then
  begin
    //lbtomador.Visible := True;
    //edtomador.Visible := True;
   // dbtomador.Visible := True;
  end;
end;

procedure Tfrmconhecimento.bt_nfe_assinarClick(Sender: TObject);
var sXML: string;
begin

  sXML := frmmodulo.qrconhecimento.fieldbyname('cte_xml').asstring;

  if sxml = '' then exit;

  if FileExists(sxml) then
  begin
    Cte.Conhecimentos.Clear;
    Cte.Conhecimentos.LoadFromFile(sxml);
    Cte.Enviar(0);
    MemoResp.Lines.Text := UTF8Encode(cte.WebServices.Retorno.RetWS);
    LoadXML(MemoResp, WBResposta);
   // Cte.Conhecimento.Clear;

    frmmodulo.qrconhecimento.edit;
    frmmodulo.qrconhecimento.FieldByName('cte_xml').asstring := sXML;
    frmmodulo.qrconhecimento.FieldByName('cte_situacao').asinteger := 6;
    frmmodulo.qrconhecimento.post;


  //  acbrnfedanferave1.ProtocoloNFe := ''; //Linha inserida para corrigir problema de impressao do numero do protocolo na nfe.

    bt_nfe_danfe.Click;

  end
  else
  begin
    application.messagebox('Arquivo XML não econtraddo!', 'Erro', mb_ok + mb_iconerror);
  end;
end;

procedure Tfrmconhecimento.locemiClick(Sender: TObject);
begin
  parametro_pesquisa := '';
  frmxloc_cidade := tfrmxloc_cidade.create(self);
  frmxloc_cidade.showmodal;

  frmmodulo.qrconhecimento.FieldByName('EMISSAO_CMUNINI').AsString := resultado_pesquisa6;
  frmmodulo.qrconhecimento.FieldByName('XMUN_EMISSAO').AsString := resultado_pesquisa2;
  frmmodulo.qrconhecimento.FieldByName('UF_EMISSAO').AsString := resultado_pesquisa3;
  locemi.SetFocus;
end;

procedure Tfrmconhecimento.btiniprestClick(Sender: TObject);
begin
  parametro_pesquisa := '';
  frmxloc_cidade := tfrmxloc_cidade.create(self);
  frmxloc_cidade.showmodal;

  frmmodulo.qrconhecimento.FieldByName('ORIGEM_CMUNINI').AsString := resultado_pesquisa6;
  frmmodulo.qrconhecimento.FieldByName('ORIGEM_XMUNINI').AsString := resultado_pesquisa2;
  frmmodulo.qrconhecimento.FieldByName('ORIGEM_UFINI').AsString := resultado_pesquisa3;
  bttermprest.SetFocus;
  Self.Repaint;
end;

procedure Tfrmconhecimento.bttermprestClick(Sender: TObject);
begin
  parametro_pesquisa := '';
  frmxloc_cidade := tfrmxloc_cidade.create(self);
  frmxloc_cidade.showmodal;

  frmmodulo.qrconhecimento.FieldByName('CMUNFIM').AsString := resultado_pesquisa6;
  frmmodulo.qrconhecimento.FieldByName('XMUNFIM').AsString := resultado_pesquisa2;
  frmmodulo.qrconhecimento.FieldByName('UFFIM').AsString := resultado_pesquisa3;
end;

procedure Tfrmconhecimento.edtomadorButtonClick(Sender: TObject);
begin
  frmXloc_cliente := tfrmXloc_cliente.create(self);
  frmXloc_cliente.showmodal;

  frmmodulo.qrconhecimento.fieldbyname('COD_TOMADOR').asstring := RESULTADO_PESQUISA1;

end;

procedure Tfrmconhecimento.rgtomadorChange(Sender: TObject);
begin
  if rgtomador.itemindex = 4 then
  begin
    edtomador.Visible := True;
    dbtomador.Visible := True;
  end
  else
  begin
    edtomador.Visible := False;
    dbtomador.Visible := False;
  end;
end;

procedure Tfrmconhecimento.C1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente := tfrmcliente.create(self);
  frmcliente.showmodal;
end;

procedure Tfrmconhecimento.AdvGlowButton8Click(Sender: TObject);
var
  Para: string;
  sXML: string;
  bserv: boolean;
  StreamMemo: TMemoryStream;
  Email: TEmail;
begin
  try
    sXML := ExtractFilePath(Application.ExeName) + 'Cte\' +
      FormatDateTime('yyyy', edata_cadastro.Date) +
      FormatDateTime('mm', edata_cadastro.Date) +
      '\CTe\' + edtchave.text + '-cte.xml';

    Application.ProcessMessages; ;

    if FileExists(sXML) then
    begin
      frmmodulo.qrconfig.open;
      if edtSmtpHost.text = '' then
      begin
        frmMsg_Operador := TfrmMsg_Operador.create(self);
        frmMsg_Operador.lb_msg.Font.Style := [fsBold];
        frmmodulo.tipo_msg := 4;
        frmMsg_Operador.lb_msg.Caption := 'Favor configurar a conta de email!';
        frmMsg_Operador.showmodal;
        exit;
      end;

      qrnfe_cliente.close;
      qrnfe_cliente.sql.clear;
      qrnfe_cliente.sql.add('select email from c000007');
      qrnfe_cliente.sql.add('where codigo = ''' + ecliente.Text + '''');
      qrnfe_cliente.open;

      para := qrNFE_Cliente.fieldbyname('email').asstring;

      if para = '' then
      begin
        frmMsg_Operador := TfrmMsg_Operador.create(self);
        frmMsg_Operador.lb_msg.Font.Style := [fsBold];
        frmmodulo.tipo_msg := 4;
        frmMsg_Operador.lb_msg.Caption := 'Favor cadastrar email do cliente!!!';
        frmMsg_Operador.showmodal;
        exit;
      end;

      if cbEmailSSL.Checked then
        bserv := true
      else
        bserv := false;

      Email := TEmail.Create;
      //'' opção de e-mail configurar essa opção
      if Email.EnviarEmail(edtCTe.Text,
        para,
        edtEmailAssunto.text,
        mmEmailMsg.Text,
        sxml,
        edtSmtpUser.text,
        edtSmtpPass.text,
        edtSmtpHost.text,
        strtoint(edtSmtpPort.Text)
        ) then
      begin
        frmMsg_Operador := TfrmMsg_Operador.create(self);
        frmMsg_Operador.lb_msg.Font.Style := [fsBold];
        frmmodulo.tipo_msg := 1;
        frmMsg_Operador.lb_msg.Caption := 'Email enviado com sucesso!!!';
        frmMsg_Operador.showmodal;
      end
      else
      begin
        frmMsg_Operador := TfrmMsg_Operador.create(self);
        frmMsg_Operador.lb_msg.Font.Style := [fsBold];
        frmmodulo.tipo_msg := 2;
        frmMsg_Operador.lb_msg.Caption := 'Erro ao enviar xml do CT-e!!!' + #13 +
          'Mensagem: ' + 'Reveja suas configurações de email';
        frmMsg_Operador.showmodal;
        Exit;
      end;

      Email.Free;

    end
    else
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Arquivo XML não encontrado!!!';
      frmMsg_Operador.showmodal;
      exit;
    end;
  except
    on E: exception do
    begin
      frmMsg_Operador := TfrmMsg_Operador.create(self);
      frmMsg_Operador.lb_msg.Font.Style := [fsBold];
      frmmodulo.tipo_msg := 2;
      frmMsg_Operador.lb_msg.Caption := 'Erro ao enviar email do CT-e!!!' + #13 +
        'Mensagem: ' + E.message;
      frmMsg_Operador.showmodal;
      Exit;
    end;
  end;
end;

procedure Tfrmconhecimento.AdvGlowButton10Click(Sender: TObject);
begin
 pficha.ActivePageIndex := 13;
end;

procedure Tfrmconhecimento.AdvGlowButton2Click(Sender: TObject);
begin
  frmPassagem_cte := TfrmPassagem_cte.Create(self);
  frmPassagem_cte.ShowModal;
end;

procedure Tfrmconhecimento.PageView2Change(Sender: TObject);
begin
  if PageView2.ActivePageIndex = 1 then
  begin
    frmmodulo.qrpassagem.Close;
    frmmodulo.qrpassagem.SQL.Clear;
    frmmodulo.qrpassagem.SQL.Add('select * from passagem_cte where codcte = :codcte');
    frmmodulo.qrpassagem.ParamByName('codcte').AsString := frmmodulo.qrconhecimento.fieldbyname('numero').AsString;
    frmmodulo.qrpassagem.Open;
  end;
end;

procedure Tfrmconhecimento.PageView3Change(Sender: TObject);
begin
  if PageView3.ActivePageIndex = 0 then
  begin
    frmmodulo.qrpassagem.Close;
    frmmodulo.qrpassagem.SQL.Clear;
    frmmodulo.qrpassagem.SQL.Add('select * from passagem_cte where codcte = :codcte');
    frmmodulo.qrpassagem.ParamByName('codcte').AsString := frmmodulo.qrconhecimento.fieldbyname('numero').AsString;
    frmmodulo.qrpassagem.Open;
  end;
end;

end.

