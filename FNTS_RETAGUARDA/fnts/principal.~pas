unit principal;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, VrControls, VrButtons, ExtCtrls, TFlatPanelUnit, jpeg,
  Collection, StdCtrls, XPMan, Menus, DB, Grids, DBGrids, Registry, Winsock,
  ToolWin, ComCtrls, dxCore, Buttons, CheckCPF,
  RXCtrls, RXDBCtrl, vrLineMeter, ZAbstractRODataset, ZAbstractDataset,
  ZDataset, shellapi, ExeInfo, AdvGlowButton, AdvToolBar, AdvToolBarStylers,
  AdvMenus, AdvMenuStylers, AdvShapeButton, AdvOfficeStatusBar,
  AdvOfficeStatusBarStylers, AdvOfficeHint, ImgList, RzTray, AdvNavBar,
  AdvOfficePager, AdvOfficePagerStylers, AdvPanel, Wwdbigrd, Wwdbgrid,
  MemDS, StrUtils, Mask, RzEdit, RzPanel, IBServices, DBAccess, IBC,
  AdvReflectionLabel, LMDControl, LMDBaseControl, LMDBaseGraphicControl,
  LMDGraphicControl, LMDScrollText, pngimage, AdvPicture,
  AdvReflectionImage, dxGDIPlusClasses, acAlphaImageList, ZConnection,
  sSkinProvider, sSkinManager, acPNG, frxpngimage, cxGraphics, cxControls,
  cxLookAndFeels, cxLookAndFeelPainters, dxSkinsCore,
  dxSkinsDefaultPainters, dxSkinsdxNavBarPainter, dxNavBar, cxClasses,
  dxNavBarBase, dxNavBarCollns, dxNavBarGroupItems, dxSkinBlack,
  dxSkinBlue, dxSkinCaramel, dxSkinCoffee, dxSkinDarkRoom, dxSkinDarkSide,
  dxSkinFoggy, dxSkinGlassOceans, dxSkiniMaginary, dxSkinLilian,
  dxSkinLiquidSky, dxSkinLondonLiquidSky, dxSkinMcSkin, dxSkinMoneyTwins,
  dxSkinOffice2007Black, dxSkinOffice2007Blue, dxSkinOffice2007Green,
  dxSkinOffice2007Pink, dxSkinOffice2007Silver, dxSkinOffice2010Black,
  dxSkinOffice2010Blue, dxSkinOffice2010Silver, dxSkinPumpkin, dxSkinSeven,
  dxSkinSharp, dxSkinSilver, dxSkinSpringTime, dxSkinStardust,
  dxSkinSummer2008, dxSkinValentine, dxSkinXmas2008Blue, cxContainer,
  cxEdit, cxImage, EAppProt, sToolBar, sButton, sBitBtn, sPanel,
  sSpeedButton, dxSkinBlueprint, dxSkinDevExpressDarkStyle,
  dxSkinDevExpressStyle, dxSkinHighContrast, dxSkinSevenClassic,
  dxSkinSharpPlus, dxSkinTheAsphaltWorld, dxSkinVS2010, dxSkinWhiteprint,
  dxSkinsForm, dxCustomTileControl, dxTileControl, Protect;

type

  TfrmPrincipal = class(TForm)
    XPManifest1: TXPManifest;
    CheckCPF1: TCheckCPF;
    ExeInfo1: TExeInfo;
    qrproduto: TZQuery;
    AdvToolBarOfficeStyler1: TAdvToolBarOfficeStyler;
    pop_tabela_fiscal: TAdvPopupMenu;
    AdvMenuOfficeStyler1: TAdvMenuOfficeStyler;
    bcfop2: TMenuItem;
    CSTCdigodaSituaoTributria1: TMenuItem;
    ModelosdeDocumentosFiscais1: TMenuItem;
    ECFCadastrodeEquipamentos1: TMenuItem;
    pop_outros_cadastros: TAdvPopupMenu;
    Setor2: TMenuItem;
    Veculos1: TMenuItem;
    bveiculoc: TMenuItem;
    pop_nf_saida: TAdvPopupMenu;
    MenuItem1: TMenuItem;
    Bconhecimento: TMenuItem;
    AdvOfficeStatusBarOfficeStyler1: TAdvOfficeStatusBarOfficeStyler;
    AdvOfficeHint1: TAdvOfficeHint;
    ImageList1: TImageList;
    ptopo: TAdvOfficeStatusBar;
    pop_principal: TAdvPopupMenu;
    Venda1: TMenuItem;
    ConsultadePreos1: TMenuItem;
    Oramento1: TMenuItem;
    Caixa1: TMenuItem;
    Produtos1: TMenuItem;
    Clientes1: TMenuItem;
    ContasaReceber1: TMenuItem;
    ContasaPagar1: TMenuItem;
    NotaFiscal1: TMenuItem;
    OrdemdeServio1: TMenuItem;
    SairdoSistema1: TMenuItem;
    AnularSaida1: TMenuItem;
    pop_usuario: TAdvPopupMenu;
    rocardeUsurio1: TMenuItem;
    GerencimentodeUsurios1: TMenuItem;
    pop_mov_produto: TAdvPopupMenu;
    Pedido1: TMenuItem;
    Entrada1: TMenuItem;
    Baixa1: TMenuItem;
    ConsultaServio1: TMenuItem;
    query: TZQuery;
    MemorandodeExportao1: TMenuItem;
    ImageList2: TImageList;
    pfundo: TFlatPanel;
    AdvOfficePagerOfficeStyler1: TAdvOfficePagerOfficeStyler;
    FormasdePagamento1: TMenuItem;
    CondiesdePagamento1: TMenuItem;
    AdvToolBarOfficeStyler2: TAdvToolBarOfficeStyler;
    AdvPanelStyler1: TAdvPanelStyler;
    qrniver: TZQuery;
    pnormal: TAdvPanel;
    AdvPanel4: TAdvPanel;
    dsniver: TDataSource;
    qrcx: TZQuery;
    qrpagar: TZQuery;
    dspagar: TDataSource;
    qrpagarCODIGO: TStringField;
    qrpagarDATA_EMISSAO: TDateTimeField;
    qrpagarDATA_VENCIMENTO: TDateTimeField;
    qrpagarDATA_PAGAMENTO: TDateTimeField;
    qrpagarCODCONTA: TStringField;
    qrpagarCODFORNECEDOR: TStringField;
    qrpagarVALOR: TFloatField;
    qrpagarVALORPAGO: TFloatField;
    qrpagarLIQUIDO: TFloatField;
    qrpagarDESCONTO: TFloatField;
    qrpagarACRESCIMO: TFloatField;
    qrpagarDOCUMENTO: TStringField;
    qrpagarNOTAFISCAL: TStringField;
    qrpagarHISTORICO: TStringField;
    qrpagarC: TStringField;
    qrpagarE: TStringField;
    qrpagarFILTRO: TIntegerField;
    qrpagarESPECIE: TStringField;
    qrpagarSITUACAO: TIntegerField;
    qrpagarCODNOTA: TStringField;
    qrpagarMOVIMENTO: TIntegerField;
    qrpagarCODCAIXA: TStringField;
    qrpagarNOME: TStringField;
    ArquivoLOG1: TMenuItem;
    Cidades1: TMenuItem;
    Memo1: TMemo;
    CNAE1: TMenuItem;
    N1: TMenuItem;
    N2: TMenuItem;
    N3: TMenuItem;
    N4: TMenuItem;
    Cores1: TMenuItem;
    amanho1: TMenuItem;
    Timer1: TTimer;
    qrinventario: TZQuery;
    qrinventarioCODPRODUTO: TStringField;
    qrinventarioTIPO: TStringField;
    qrinventarioPRODUTO: TStringField;
    qrinventarioUNIDADE: TStringField;
    qrinventarioCST: TStringField;
    qrinventarioALIQUOTA: TFloatField;
    qrinventarioESTOQUE: TFloatField;
    qrinventarioCUSTO: TFloatField;
    qrinventarioTOTAL: TFloatField;
    qrinventarionome_aliquota: TStringField;
    qrinventarioDATA: TDateTimeField;
    qrinventarioVENDA: TFloatField;
    qrinventarioANO: TIntegerField;
    qrinventarioMES: TIntegerField;
    qrinventarioDATA_POSTERIOR: TDateTimeField;
    BitBtn1: TBitBtn;
    rnumero: TRzNumericEdit;
    qrmestre: TZQuery;
    eConexao: TIBCConnection;
    NCMNomenclaturaMercosul1: TMenuItem;
    CSOSNCdigodaOperaodeSituaodoSimplesNacional1: TMenuItem;
    img1: TImage;
    Image1: TImage;
    popmenuarq: TAdvPopupMenu;
    EmpresasFiliais1: TMenuItem;
    Clientes2: TMenuItem;
    Fornecedores1: TMenuItem;
    ransportadores1: TMenuItem;
    bancosFinanceiras1: TMenuItem;
    popmenu1: TAdvPopupMenu;
    Clientes3: TMenuItem;
    Fornecedores2: TMenuItem;
    ransportadores2: TMenuItem;
    Funcionarios1: TMenuItem;
    Image2: TImage;
    Image3: TImage;
    Image5: TImage;
    Image7: TImage;
    Funcionrios1: TMenuItem;
    planodeContas1: TMenuItem;
    Usurios1: TMenuItem;
    OperadoresdeCaixa1: TMenuItem;
    OutrosCadastros1: TMenuItem;
    abelasFiscais1: TMenuItem;
    Convnios1: TMenuItem;
    Servios1: TMenuItem;
    rocardeUsurio2: TMenuItem;
    GerenciamentodeUsurio1: TMenuItem;
    ArquivodeLOG1: TMenuItem;
    Setor1: TMenuItem;
    N5: TMenuItem;
    Veculos2: TMenuItem;
    VeculosdeTerceiros1: TMenuItem;
    N6: TMenuItem;
    FormasdePagamento2: TMenuItem;
    CondiesdePagamento2: TMenuItem;
    N7: TMenuItem;
    Cidades2: TMenuItem;
    CNAE2: TMenuItem;
    N8: TMenuItem;
    Cores2: TMenuItem;
    amanho2: TMenuItem;
    CFOPNaturezadeOperao1: TMenuItem;
    CSTCdigodaSituaoTributria2: TMenuItem;
    ModelosdeDocumentosFiscais2: TMenuItem;
    ECFCadastrodeEquipamentos2: TMenuItem;
    NCMNomeclaturaComumaoMercosul1: TMenuItem;
    CSOSNCdigodeSituaodaOperaonoSimplesNacional1: TMenuItem;
    lblarquivo: TLabel;
    lblestoque: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    popestoque: TAdvPopupMenu;
    popmovimento: TAdvPopupMenu;
    popfinanceiro: TAdvPopupMenu;
    popnfe: TAdvPopupMenu;
    poprelatorios: TAdvPopupMenu;
    poputilitarios: TAdvPopupMenu;
    Produtos2: TMenuItem;
    GruposeSubgrupos1: TMenuItem;
    Marcasfabricantes1: TMenuItem;
    notaFiscaldeEntrada1: TMenuItem;
    ConsultadePreo1: TMenuItem;
    ConsultaSerial1: TMenuItem;
    ProdutosVendasFaltas1: TMenuItem;
    PedidodeCompra1: TMenuItem;
    BalanaExportao1: TMenuItem;
    Venda2: TMenuItem;
    AtendimentodePrVenda1: TMenuItem;
    NotasdeVendas1: TMenuItem;
    NotaFiscal2: TMenuItem;
    Oramento2: TMenuItem;
    ECFmovimentoDirio1: TMenuItem;
    SINTEGRARegistroFiscal1: TMenuItem;
    EFDSpedFiscal1: TMenuItem;
    ControledeEntrega1: TMenuItem;
    OrdemdesERVIO2: TMenuItem;
    Industrializao1: TMenuItem;
    NotaFiscalEmisso1: TMenuItem;
    ConhecimentodeTransporte1: TMenuItem;
    MemorandodeExportao2: TMenuItem;
    Caixa2: TMenuItem;
    ContasaPagar2: TMenuItem;
    ContasaReceber2: TMenuItem;
    Financeira1: TMenuItem;
    Cheques1: TMenuItem;
    ContaCorrente1: TMenuItem;
    Clientes4: TMenuItem;
    BoletoBancrio1: TMenuItem;
    CartodeCrdito1: TMenuItem;
    Convnio1: TMenuItem;
    Clientes5: TMenuItem;
    Fornecedores3: TMenuItem;
    Produtos3: TMenuItem;
    Vendas1: TMenuItem;
    ContasaReceber3: TMenuItem;
    ContasaPagar3: TMenuItem;
    Caixa3: TMenuItem;
    EtiquetasdeProdutos1: TMenuItem;
    OrdemdeServio3: TMenuItem;
    ServiosPeridicos1: TMenuItem;
    PercentualVendasGrupoMarca1: TMenuItem;
    Fretes1: TMenuItem;
    FluxodeCaixa1: TMenuItem;
    DRE1: TMenuItem;
    CpiadeSegurna1: TMenuItem;
    RestaurarCpiadeSegurana1: TMenuItem;
    AgendaTelefnica1: TMenuItem;
    Calculadora1: TMenuItem;
    Calendrio1: TMenuItem;
    Configuraes1: TMenuItem;
    ExportaodeDados1: TMenuItem;
    ControledeRotas1: TMenuItem;
    ChavesdeLiberao1: TMenuItem;
    MduloNFe1: TMenuItem;
    MduloOrdemdeServio1: TMenuItem;
    MduloPCP1: TMenuItem;
    MduloEncaixe1: TMenuItem;
    MduloBI1: TMenuItem;
    MduloCRM1: TMenuItem;
    MduloVI1: TMenuItem;
    ConsultaLote1: TMenuItem;
    ConsultaLote2: TMenuItem;
    NFSadasEmisso1: TMenuItem;
    NotasdeVendas2: TMenuItem;
    psuper: TAdvOfficePager;
    AdvOfficePage1: TAdvOfficePage;
    Label1: TLabel;
    Bevel2: TBevel;
    Label2: TLabel;
    Bevel3: TBevel;
    Label3: TLabel;
    Bevel4: TBevel;
    Label4: TLabel;
    Bevel5: TBevel;
    Bevel6: TBevel;
    Bevel7: TBevel;
    Label5: TLabel;
    lcaixa: TLabel;
    Label7: TLabel;
    Bevel8: TBevel;
    lsit_caixa: TLabel;
    Bevel9: TBevel;
    Label9: TLabel;
    Bevel10: TBevel;
    Label10: TLabel;
    Bevel11: TBevel;
    Bevel13: TBevel;
    ltcaixa: TLabel;
    ltpagar: TLabel;
    ltreceber: TLabel;
    ltfinal: TLabel;
    ltvenda: TLabel;
    ltos: TLabel;
    Bevel12: TBevel;
    batual: TAdvGlowButton;
    AdvOfficePage2: TAdvOfficePage;
    AdvPanel2: TAdvPanel;
    wwDBGrid2: TwwDBGrid;
    AdvOfficePage3: TAdvOfficePage;
    wwDBGrid1: TwwDBGrid;
    AdvPanel3: TAdvPanel;
    AtualizarSistema1: TMenuItem;
    img2: TImage;
    ImportarNfe1: TMenuItem;
    sSkinProvider1: TsSkinProvider;
    AdvPanel1: TAdvPanel;
    Image8: TImage;
    Label35: TLabel;
    AdvMenuFantasyStyler1: TAdvMenuFantasyStyler;
    sSkinManager2: TsSkinManager;
    sToolBar1: TsToolBar;
    sPanel1: TsPanel;
    dxTile: TdxTileControl;
    dxTiledxTileControlGroup1: TdxTileControlGroup;
    tlPhotos: TdxTileControlItem;
    tlUserManagement: TdxTileControlItem;
    tlSystemInformation: TdxTileControlItem;
    tlAgents: TdxTileControlItem;
    tlResearch: TdxTileControlItem;
    tlStatistics: TdxTileControlItem;
    tlZillow: TdxTileControlItem;
    tlLoanCalculator: TdxTileControlItem;
    tlMortgageRates: TdxTileControlItem;
    dxSkinController1: TdxSkinController;
    menu_cadastros: TAdvPopupMenu;
    Empresa2: TMenuItem;
    Clientes9: TMenuItem;
    Fornecedores6: TMenuItem;
    ransportadoras2: TMenuItem;
    Funcionrios3: TMenuItem;
    BancosFinanceira2: TMenuItem;
    PlanodeContas3: TMenuItem;
    AdvMenuOfficeStyler2: TAdvMenuOfficeStyler;
    Convnios3: TMenuItem;
    Servios3: TMenuItem;
    btmenu001: TAdvGlowButton;
    btmenu002: TAdvGlowButton;
    btmenu003: TAdvGlowButton;
    btmenu004: TAdvGlowButton;
    btmenu005: TAdvGlowButton;
    btmenu006: TAdvGlowButton;
    btmenu007: TAdvGlowButton;
    btmenu008: TAdvGlowButton;
    btmenu009: TAdvGlowButton;
    menu_produtos: TAdvPopupMenu;
    Produtos6: TMenuItem;
    GruposeSubgrupos3: TMenuItem;
    NotaFiscaldeEntrada3: TMenuItem;
    ConsultadePreo3: TMenuItem;
    ConsultaSerial3: TMenuItem;
    ProdutosVendasFaltas3: TMenuItem;
    BaixadeEstoque2: TMenuItem;
    PedidodeCompra3: TMenuItem;
    menu_faturamento: TAdvPopupMenu;
    ControledeEntrega3: TMenuItem;
    Industrializao3: TMenuItem;
    NotasdeVendas4: TMenuItem;
    NotaFiscal4: TMenuItem;
    MemorandodeExportao4: TMenuItem;
    menu_dep_financeiro: TAdvPopupMenu;
    SintegraregistroFiscal3: TMenuItem;
    ECFSpedFiscal2: TMenuItem;
    ECFMovimentoDirio3: TMenuItem;
    menu_vendas: TAdvPopupMenu;
    Venda4: TMenuItem;
    Oramento4: TMenuItem;
    OrdemdeServio4: TMenuItem;
    menu_financeiro: TAdvPopupMenu;
    Caixa6: TMenuItem;
    N17: TMenuItem;
    ContasaPagar6: TMenuItem;
    ContsasaReceber2: TMenuItem;
    N18: TMenuItem;
    Financeira3: TMenuItem;
    Cheques3: TMenuItem;
    ContaCorrente3: TMenuItem;
    Clientes10: TMenuItem;
    BoletoBancrio3: TMenuItem;
    CartodeCrdito3: TMenuItem;
    Convnio3: TMenuItem;
    menu_relatorios: TAdvPopupMenu;
    Clientes11: TMenuItem;
    Fornecedores7: TMenuItem;
    Produtos7: TMenuItem;
    EtiquetasdeProdutos3: TMenuItem;
    Vendas4: TMenuItem;
    PercentualVendasGrupoMarca3: TMenuItem;
    N19: TMenuItem;
    ContasaPagar7: TMenuItem;
    ContasaReceber5: TMenuItem;
    N20: TMenuItem;
    Caixa7: TMenuItem;
    FluxodeCaixa3: TMenuItem;
    N21: TMenuItem;
    OrdensdeServio2: TMenuItem;
    ServiosPeridicos3: TMenuItem;
    Fretes3: TMenuItem;
    N22: TMenuItem;
    DRE3: TMenuItem;
    menu_usuarios: TAdvPopupMenu;
    rocardeUsurio4: TMenuItem;
    N23: TMenuItem;
    GerenciamentodeUsurio3: TMenuItem;
    N24: TMenuItem;
    OperadoresdeCaixa3: TMenuItem;
    menu_gerenciador: TAdvPopupMenu;
    Configuraes3: TMenuItem;
    N25: TMenuItem;
    ArquivodeLog3: TMenuItem;
    N26: TMenuItem;
    SobreoSistemaiCloud1: TMenuItem;
    N27: TMenuItem;
    OutrosCadastros3: TMenuItem;
    Setor4: TMenuItem;
    VeculosdeTerceiros3: TMenuItem;
    CondiesdePagamento4: TMenuItem;
    Cidades4: TMenuItem;
    CNAE4: TMenuItem;
    Cores4: TMenuItem;
    amanhos2: TMenuItem;
    N28: TMenuItem;
    abelasFiscais3: TMenuItem;
    CFOPNaturezadeOperao3: TMenuItem;
    CSTCdigodaSituaoTributria4: TMenuItem;
    ModelosdeDocumentosFiscais4: TMenuItem;
    ECFCadastrodeEquipamentos4: TMenuItem;
    NCMNomeclaturaComumaoMercosul3: TMenuItem;
    CSOSNCdigodeSituaodaOperaonoSimplesNacional2: TMenuItem;
    A1: TMenuItem;
    N29: TMenuItem;
    lbl158: TLabel;
    AdvReflectionImage1: TAdvReflectionImage;
    spnl147: TsPanel;
    spnl47: TsPanel;
    spnl2569: TsPanel;
    AdvReflectionImage2: TAdvReflectionImage;
    img4785: TAdvReflectionImage;
    Label17: TLabel;
    Label18: TLabel;
    dxTileItem1: TdxTileControlItem;
    dxTileItem2: TdxTileControlItem;
    spnlUsu: TsPanel;
    img: TAdvReflectionImage;
    lbl25: TLabel;
    AdvPanel5: TAdvPanel;
    AdvPanelStyler2: TAdvPanelStyler;
    AdvPanel6: TAdvPanel;
    dxtlcntrltmTileItem3: TdxTileControlItem;
    dxtlcntrltmTileItem4: TdxTileControlItem;
    dxtlcntrltmTileItem5: TdxTileControlItem;
    dxtlcntrltmTileItem7: TdxTileControlItem;
    dxtlcntrltmfrmPhotosdxTileControlItemFrame1: TdxTileControlItemFrame;
    dxtlcntrltmfrmPhotosdxTileControlItemFrame2: TdxTileControlItemFrame;
    dxtlcntrltmfrmResearchdxTileControlItemFrame1: TdxTileControlItemFrame;
    dxtlcntrltmfrmResearchdxTileControlItemFrame2: TdxTileControlItemFrame;
    dxtlcntrltmfrmUserManagementdxTileControlItemFrame1: TdxTileControlItemFrame;
    dxtlcntrltmfrmUserManagementdxTileControlItemFrame2: TdxTileControlItemFrame;
    prtct1: TProtect;
    N9: TMenuItem;
    E1: TMenuItem;
    N10: TMenuItem;
    A2: TMenuItem;
    tlAgentsdxTileControlItemFrame1: TdxTileControlItemFrame;
    tlAgentsdxTileControlItemFrame2: TdxTileControlItemFrame;
    dxTileItem1dxTileControlItemFrame1: TdxTileControlItemFrame;
    dxTileItem1dxTileControlItemFrame2: TdxTileControlItemFrame;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure VrDemoButton49Click(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure LinkView3Click(Sender: TObject);
    procedure LinkView1Click(Sender: TObject);
    procedure Filiais1Click(Sender: TObject);
    procedure VrDemoButton2Click(Sender: TObject);
    procedure VrDemoButton3Click(Sender: TObject);
    procedure VrDemoButton4Click(Sender: TObject);
    procedure VrDemoButton5Click(Sender: TObject);
    procedure MenuItem1Click(Sender: TObject);
    procedure CSTCdigodaSituaoTributria1Click(Sender: TObject);
    procedure ModelosdeDocumentosFiscais1Click(Sender: TObject);
    procedure ECFCadastrodeEquipamentos1Click(Sender: TObject);
    procedure Setor2Click(Sender: TObject);
    procedure Veculos1Click(Sender: TObject);
    procedure Clientes1Click(Sender: TObject);
    procedure Produtos1Click(Sender: TObject);
    procedure ConsultadePreos1Click(Sender: TObject);
    procedure ContasaPagar1Click(Sender: TObject);
    procedure ContasaReceber1Click(Sender: TObject);
    procedure Oramento1Click(Sender: TObject);
    procedure Caixa1Click(Sender: TObject);
    procedure OrdemdeServio1Click(Sender: TObject);
    procedure NotaFiscal1Click(Sender: TObject);
    procedure SairdoSistema1Click(Sender: TObject);
    procedure AnularSaida1Click(Sender: TObject);
    procedure rocardeUsurio1Click(Sender: TObject);
    procedure GerencimentodeUsurios1Click(Sender: TObject);
    procedure Baixa1Click(Sender: TObject);
    procedure Pedido1Click(Sender: TObject);
    procedure Entrada1Click(Sender: TObject);
    procedure ConsultaServio1Click(Sender: TObject);
    procedure Ad55vGlowButton1Click(Sender: TObject);
    procedure MemorandodeExportao1Click(Sender: TObject);
    procedure bformaClick(Sender: TObject);
    procedure Venda1Click(Sender: TObject);
    procedure AdvGlowButton2Click(Sender: TObject);
    procedure FormasdePagamento1Click(Sender: TObject);
    procedure CondiesdePagamento1Click(Sender: TObject);
    procedure batualClick(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure AdvGlowButton3Click(Sender: TObject);
    procedure AdvGlowButton3KeyPress(Sender: TObject; var Key: Char);
    procedure AdvGlowButton4Click(Sender: TObject);
    procedure ArquivoLOG1Click(Sender: TObject);
    procedure Cidades1Click(Sender: TObject);
    procedure AdvGlowButton6Click(Sender: TObject);
    procedure AdvGlowButton7Click(Sender: TObject);
    procedure AdvGlowButton10Click(Sender: TObject);
    procedure CNAE1Click(Sender: TObject);
    procedure Cores1Click(Sender: TObject);
    procedure amanho1Click(Sender: TObject);
    procedure AdvGlowButton8Click(Sender: TObject);
    procedure AdvGlowButton9Click(Sender: TObject);
    procedure AdvGlowButton11Click(Sender: TObject);
    procedure DREClick(Sender: TObject);
    procedure Label12Click(Sender: TObject);
    procedure NCMNomenclaturaMercosul1Click(Sender: TObject);
    procedure CSOSNCdigodaOperaodeSituaodoSimplesNacional1Click(
      Sender: TObject);
    procedure Image1Click(Sender: TObject);
    procedure Image8Click(Sender: TObject);
    procedure imgClientesClick(Sender: TObject);
    procedure Image9Click(Sender: TObject);
    procedure Clientes3Click(Sender: TObject);
    procedure imgFornecedoresClick(Sender: TObject);
    procedure imgtransportadoresClick(Sender: TObject);
    procedure imgFuncionariosClick(Sender: TObject);
    procedure imgBancosClick(Sender: TObject);
    procedure vbosContasClick(Sender: TObject);
    procedure imgOperadoresCaixaClick(Sender: TObject);
    procedure imgConveniosClick(Sender: TObject);
    procedure imgServicosClick(Sender: TObject);
    procedure EmpresasFiliais1Click(Sender: TObject);
    procedure Clientes2Click(Sender: TObject);
    procedure Fornecedores1Click(Sender: TObject);
    procedure ransportadores1Click(Sender: TObject);
    procedure bancosFinanceiras1Click(Sender: TObject);
    procedure rocardeUsurio2Click(Sender: TObject);
    procedure GerenciamentodeUsurio1Click(Sender: TObject);
    procedure ArquivodeLOG1Click(Sender: TObject);
    procedure OperadoresdeCaixa1Click(Sender: TObject);
    procedure Setor1Click(Sender: TObject);
    procedure Veculos2Click(Sender: TObject);
    procedure VeculosdeTerceiros1Click(Sender: TObject);
    procedure CondiesdePagamento2Click(Sender: TObject);
    procedure Cidades2Click(Sender: TObject);
    procedure CNAE2Click(Sender: TObject);
    procedure Cores2Click(Sender: TObject);
    procedure amanho2Click(Sender: TObject);
    procedure CFOPNaturezadeOperao1Click(Sender: TObject);
    procedure CSTCdigodaSituaoTributria2Click(Sender: TObject);
    procedure ModelosdeDocumentosFiscais2Click(Sender: TObject);
    procedure ECFCadastrodeEquipamentos2Click(Sender: TObject);
    procedure NCMNomeclaturaComumaoMercosul1Click(Sender: TObject);
    procedure CSOSNCdigodeSituaodaOperaonoSimplesNacional1Click(
      Sender: TObject);
    procedure Servios1Click(Sender: TObject);
    procedure Convnios1Click(Sender: TObject);
    procedure planodeContas1Click(Sender: TObject);
    procedure Produtos2Click(Sender: TObject);
    procedure GruposeSubgrupos1Click(Sender: TObject);
    procedure Marcasfabricantes1Click(Sender: TObject);
    procedure notaFiscaldeEntrada1Click(Sender: TObject);
    procedure ConsultadePreo1Click(Sender: TObject);
    procedure ConsultaSerial1Click(Sender: TObject);
    procedure ProdutosVendasFaltas1Click(Sender: TObject);
    procedure PedidodeCompra1Click(Sender: TObject);
    procedure BalanaExportao1Click(Sender: TObject);
    procedure img2Click(Sender: TObject);
    procedure Venda2Click(Sender: TObject);
    procedure AtendimentodePrVenda1Click(Sender: TObject);
    procedure NotasdeVendas1Click(Sender: TObject);
    procedure Oramento2Click(Sender: TObject);
    procedure ECFmovimentoDirio1Click(Sender: TObject);
    procedure SINTEGRARegistroFiscal1Click(Sender: TObject);
    procedure EFDSpedFiscal1Click(Sender: TObject);
    procedure ControledeEntrega1Click(Sender: TObject);
    procedure OrdemdesERVIO2Click(Sender: TObject);
    procedure Industrializao1Click(Sender: TObject);
    procedure NotaFiscalEmisso1Click(Sender: TObject);
    procedure ConhecimentodeTransporte1Click(Sender: TObject);
    procedure MemorandodeExportao2Click(Sender: TObject);
    procedure Image2Click(Sender: TObject);
    procedure Caixa2Click(Sender: TObject);
    procedure ContasaPagar2Click(Sender: TObject);
    procedure ContasaReceber2Click(Sender: TObject);
    procedure Financeira1Click(Sender: TObject);
    procedure Cheques1Click(Sender: TObject);
    procedure ContaCorrente1Click(Sender: TObject);
    procedure Clientes4Click(Sender: TObject);
    procedure BoletoBancrio1Click(Sender: TObject);
    procedure CartodeCrdito1Click(Sender: TObject);
    procedure Convnio1Click(Sender: TObject);
    procedure Image3Click(Sender: TObject);
    procedure Image5Click(Sender: TObject);
    procedure Clientes5Click(Sender: TObject);
    procedure Fornecedores3Click(Sender: TObject);
    procedure Produtos3Click(Sender: TObject);
    procedure Vendas1Click(Sender: TObject);
    procedure ContasaReceber3Click(Sender: TObject);
    procedure ContasaPagar3Click(Sender: TObject);
    procedure Caixa3Click(Sender: TObject);
    procedure EtiquetasdeProdutos1Click(Sender: TObject);
    procedure OrdemdeServio3Click(Sender: TObject);
    procedure ServiosPeridicos1Click(Sender: TObject);
    procedure PercentualVendasGrupoMarca1Click(Sender: TObject);
    procedure Fretes1Click(Sender: TObject);
    procedure FluxodeCaixa1Click(Sender: TObject);
    procedure DRE1Click(Sender: TObject);
    procedure CpiadeSegurna1Click(Sender: TObject);
    procedure RestaurarCpiadeSegurana1Click(Sender: TObject);
    procedure AgendaTelefnica1Click(Sender: TObject);
    procedure Calculadora1Click(Sender: TObject);
    procedure Calendrio1Click(Sender: TObject);
    procedure Configuraes1Click(Sender: TObject);
    procedure ExportaodeDados1Click(Sender: TObject);
    procedure ControledeRotas1Click(Sender: TObject);
    procedure Image7Click(Sender: TObject);
    procedure Funcionrios1Click(Sender: TObject);
    procedure ConsultaLote1Click(Sender: TObject);
    procedure ConsultaLote2Click(Sender: TObject);
    procedure AtualizarSistema1Click(Sender: TObject);
    procedure ImportarNfe1Click(Sender: TObject);
    procedure bveiculocClick(Sender: TObject);
    procedure Sair1Click(Sender: TObject);
    procedure tlPhotosClick(Sender: TdxTileControlItem);
    procedure tlUserManagementClick(Sender: TdxTileControlItem);
    procedure Empresa2Click(Sender: TObject);
    procedure Clientes9Click(Sender: TObject);
    procedure Fornecedores6Click(Sender: TObject);
    procedure ransportadoras2Click(Sender: TObject);
    procedure Funcionrios3Click(Sender: TObject);
    procedure BancosFinanceira2Click(Sender: TObject);
    procedure PlanodeContas3Click(Sender: TObject);
    procedure Convnios3Click(Sender: TObject);
    procedure Servios3Click(Sender: TObject);
    procedure Setor4Click(Sender: TObject);
    procedure VeculosdeTerceiros3Click(Sender: TObject);
    procedure CondiesdePagamento4Click(Sender: TObject);
    procedure Cidades4Click(Sender: TObject);
    procedure CNAE4Click(Sender: TObject);
    procedure Cores4Click(Sender: TObject);
    procedure amanhos2Click(Sender: TObject);
    procedure CFOPNaturezadeOperao3Click(Sender: TObject);
    procedure CSTCdigodaSituaoTributria4Click(Sender: TObject);
    procedure ModelosdeDocumentosFiscais4Click(Sender: TObject);
    procedure ECFCadastrodeEquipamentos4Click(Sender: TObject);
    procedure NCMNomeclaturaComumaoMercosul3Click(Sender: TObject);
    procedure CSOSNCdigodeSituaodaOperaonoSimplesNacional2Click(
      Sender: TObject);
    procedure Produtos6Click(Sender: TObject);
    procedure GruposeSubgrupos3Click(Sender: TObject);
    procedure NotaFiscaldeEntrada3Click(Sender: TObject);
    procedure ConsultadePreo3Click(Sender: TObject);
    procedure ConsultaSerial3Click(Sender: TObject);
    procedure ProdutosVendasFaltas3Click(Sender: TObject);
    procedure BaixadeEstoque2Click(Sender: TObject);
    procedure PedidodeCompra3Click(Sender: TObject);
    procedure ControledeEntrega3Click(Sender: TObject);
    procedure Industrializao3Click(Sender: TObject);
    procedure NotasdeVendas4Click(Sender: TObject);
    procedure NotaFiscal4Click(Sender: TObject);
    procedure MemorandodeExportao4Click(Sender: TObject);
    procedure SintegraregistroFiscal3Click(Sender: TObject);
    procedure ECFSpedFiscal2Click(Sender: TObject);
    procedure ECFMovimentoDirio3Click(Sender: TObject);
    procedure Venda4Click(Sender: TObject);
    procedure Oramento4Click(Sender: TObject);
    procedure OrdemdeServio4Click(Sender: TObject);
    procedure rocardeUsurio4Click(Sender: TObject);
    procedure GerenciamentodeUsurio3Click(Sender: TObject);
    procedure OperadoresdeCaixa3Click(Sender: TObject);
    procedure ArquivodeLog3Click(Sender: TObject);
    procedure DRE3Click(Sender: TObject);
    procedure Fretes3Click(Sender: TObject);
    procedure ServiosPeridicos3Click(Sender: TObject);
    procedure OrdensdeServio2Click(Sender: TObject);
    procedure FluxodeCaixa3Click(Sender: TObject);
    procedure Caixa7Click(Sender: TObject);
    procedure ContasaReceber5Click(Sender: TObject);
    procedure ContasaPagar7Click(Sender: TObject);
    procedure PercentualVendasGrupoMarca3Click(Sender: TObject);
    procedure Vendas4Click(Sender: TObject);
    procedure EtiquetasdeProdutos3Click(Sender: TObject);
    procedure Produtos7Click(Sender: TObject);
    procedure Fornecedores7Click(Sender: TObject);
    procedure Clientes11Click(Sender: TObject);
    procedure Configuraes3Click(Sender: TObject);
    procedure A1Click(Sender: TObject);
    procedure Caixa6Click(Sender: TObject);
    procedure ContasaPagar6Click(Sender: TObject);
    procedure ContsasaReceber2Click(Sender: TObject);
    procedure Financeira3Click(Sender: TObject);
    procedure Cheques3Click(Sender: TObject);
    procedure ContaCorrente3Click(Sender: TObject);
    procedure Clientes10Click(Sender: TObject);
    procedure BoletoBancrio3Click(Sender: TObject);
    procedure CartodeCrdito3Click(Sender: TObject);
    procedure Convnio3Click(Sender: TObject);
    procedure tlSystemInformationClick(Sender: TdxTileControlItem);
    procedure tlAgentsClick(Sender: TdxTileControlItem);
    procedure tlResearchClick(Sender: TdxTileControlItem);
    procedure tlStatisticsClick(Sender: TdxTileControlItem);
    procedure tlZillowClick(Sender: TdxTileControlItem);
    procedure dxTileItem2Click(Sender: TdxTileControlItem);
    procedure dxTileItem1Click(Sender: TdxTileControlItem);
    procedure tlMortgageRatesClick(Sender: TdxTileControlItem);
    procedure tlLoanCalculatorClick(Sender: TdxTileControlItem);
    procedure SobreoSistemaiCloud1Click(Sender: TObject);
    procedure dxtlcntrltmTileItem5Click(Sender: TdxTileControlItem);
    procedure dxtlcntrltmTileItem7Click(Sender: TdxTileControlItem);
    procedure dxtlcntrltmTileItem3Click(Sender: TdxTileControlItem);
    procedure dxtlcntrltmTileItem4Click(Sender: TdxTileControlItem);
    procedure dxtlcntrltmTileItem6Click(Sender: TdxTileControlItem);
    procedure E1Click(Sender: TObject);
    procedure A2Click(Sender: TObject);

  private
    { Private declarations }
    FUltimaExecucao: TDateTime;
//   FHoje: TDateTime;
    FValidate: Integer;
    FNomeProduto: string;
    FVersaoProduto: string;
    FBuilt: string;
    FHistorico: TStrings;
    STime: TDateTime;



  public

    FHoje: TDateTime;

    vfil_codigo, vfil_nome, vfil_cnpj, vfil_ie, vfil_cst, vfil_cipi, vfil_simples, vfil_ssimples, vfil_estadual: string;
    vcontador: integer;
    { Public declarations }
    function StrZeros(Texto: string; Qtde: Integer): string;
    function Verifica_Conexao: Boolean;
    procedure log(CODUSUARIO, TABELA, CODREGISTRO, FUNCAO, hISTORICO: string);
    procedure agenda(vsituacao, vtipo, vnome, vtelefone1, vtelefone2, vtelefone3, vcelular, vemail, vfax, vhomepage, vtipoi: string);

    function VersaoExe(const Filename: string): string;

    function formata_valor(valor: string): string;

    function Exec_File(File_Path: string): integer;
    function UltimoDiaMes(Mdt: TDateTime): TDateTime;
    function Space(const Len: integer): string;
    function tbReplChar(const Ch: Char; const Len: integer): string;
    function somenteNumero(sNum: string): string;
    function tira_ponto(texto: string): string;
    function TiraCaracterEspecial(texto: string): string;
    function FormataValorProsoft(fValor: Real; fQtde: Integer): string;
    procedure ExecutePrograma(Nome, Parametros: string);
    procedure FechePrograma(Programa: Pchar);
    function acesso(usuario: string; funcao: string): string;
    procedure AcertaPadraoData2;
    procedure GravaReducaoZ;
    function DataDeCriacao(Arq: string): TDateTime;
    function RemoveAcentos(Str: string): string;
    function Arredondar(Value: Extended; Decimals: integer): Extended;


    procedure limpaedit(Form: Tform);
    function AnoBiSexto(Ayear: Integer): Boolean;
    function DiasPorMes(Ayear, AMonth: Integer): Integer;
    function texto_justifica(texto: string; qtde_caracteres: integer; caracter: string; tipo: string): string;
    function tiraacento(str: string): string;
    function lancaproduto(codproduto: string; data: tdatetime; movimento: string; codcliente: string; codsaida: string; codentrada: string; codvendedor: string; qtde: real; valor: real; total: real; notafiscal: string): string;
    function CalculaDigEAN13(Cod: string): string;
    function CalculaDigitoEAN(CodigoEAN: string): Integer;
    function TestaCnpj(xCNPJ: string): Boolean;
    function Locregistro(tabela: TDataSet; valor: string; campo: string): boolean;
    function GetIP: string;

    function ChecaEstado(Dado: string): boolean;
    function adic_codifica(Tabela: string): string;
    function codifica(Tabela: string): string;
    function zerarcodigo(codigo: string; qtde: integer): string;
    function Cript(Action, Src: string): string;
    function autentica(funcao: string; nivel: integer): boolean;
    function autentica_caixa(funcao: string; nivel: integer): boolean;
    function NomeComputador: string; //External
    function tira_aspa(texto: string): string;
    function nao_arredonda(valor: real): real;
    function FormataCEP(const CEP: string): string;

    function efetua_Backup: boolean;

       (*T E F*)

    procedure Daruma_Analisa_Retorno();
    procedure Daruma_Retorno_Impressora();

    function AnalisaRetornoECF: integer;
    function AnalisaRetornoComando(retorno: integer): integer;
    function AnalisaRetorno(retorno: integer): integer;

    function msgcard(): boolean;
    function msgcheck(): boolean;




       (*----------------------------------------*)






  end;

    // funcoes externas da dll ebo7

procedure AcertaPadraoData; External '\iCloud\server\dll\ebo7.dll';

function NumeroSerieHD: string; External '\iCloud\server\dll\ebo7.dll';
function frm(ebo: string): string; External '\iCloud\server\dll\ebo7.dll';
var
  frmPrincipal: TfrmPrincipal;
  autenticado: boolean;
  ativa_sistema: boolean;
  qtde_dias_ativacao: integer;
  DATA_TERMINO: TDATETIME;

  nc_caixa: integer;

  res_expirado, res_instalacao, res_data, res_termino, res_empresa, res_rsocial, res_cnpj: string;
  cont_inventario: boolean;
  novaversao: boolean;
  conexao_sistema: string;
  ExeAtualiza, ExeAtual: string;

  usuario_temp: string;


  // TEF_DIAL
  USA_TEF, usa_tecban: BOOLEAN;
  retmsg, TEFFINAL, jafinalizado, foiconectado: BOOLEAN;
  ret_cheque: integer;
  elcheque: boolean; // variavel q controla o se a venda eh cheque ou cartao para impressao do CV
  daruma_retorno: integer;
  continua: boolean;
  iRet: Integer;
  venda_TEF: boolean;
  //



implementation

uses backup, restore, modulo, senha, filial, papelparede, cliente,
  fornecedor, transportador, funcionario, servico, banco, formapgto,
  condpgto, grupo, marca, aliquota, agenda, produto, produto_entrada,
  produto_consultapreco, Calculad, calendario, plano, produto_saida,
  produto_pedido, cheque, contacorrente, caixa, caixa_operador,
  senha_caixa, contaspagar, venda, venda_inicio,
  contasreceber, notas_venda, os, setor, os_menu, veiculo, config,
  orcamento, balanca, produto_ligth,
  notafiscal, cliente_financeiro, produto_auto, cliente_veiculo,
  etiquetador, boleto, sintegra_gerar, Math, usuario_menu, conhecimento,
  cfop, loc_produto_auto, acesso, xloc_cliente, lista_venda2,
  lista_cliente2, lista_fornecedor2, lista_produto2, lista_os,
  lista_receber2, lista_pagar2, notafiscalE, lista_caixa2, ativacao,
  aviso_expirado, ativacao2, venda_farma, convenio, produto_farma, log, ecfserver,
  produto_falta, convenio_receber, empresa, cst, modelo_fiscal, ecfs,
  sintegra_menu, ecf,
  ECF_REDUCAO, prevenda, compra, compra_menu, exporta_dados,
  ecf_reducao_menu, notafiscal_menu, progresso, usuario, cheque_menu,
  baixa_estoque, xloc_servico, Produto_consultaserial, memorando_menu,
  lista_servicos_periodicos, produto_pdv2, entrega, notafiscal_item2,
  copia_arquivo, financeira, usuario_log, cidade, msgcartao, msgcheque,
  Tef, unFuncoesTEF, cartao, cnae, cor, tamanho, Lista_ABC_Marca_Grupo,
  lista_frete, fluxo_caixa, DRE, mensagem_inventario, industrializacao, Ncm,
  xloc_csosn, consulta_lote, importa_nfe, FMapa, Unit1, sobre,
  form_ativacaoicloud;


{$R *.dfm}

procedure AlinharPanel(AForm: TForm; APanel: TPanel; ACentro: Boolean);
begin
  if ACentro then
  begin
    APanel.Left := (AForm.ClientWidth div 2) - (APanel.Width div 2);
    APanel.Top := (AForm.ClientHeight div 2) - (APanel.Height div 2);
  end
  else
  begin
    APanel.Left := (AForm.ClientWidth + 100);
    APanel.Top := (AForm.ClientHeight + 100);
  end;
  APanel.Update;
  AForm.Update;
end;


function TFrmPrincipal.Efetua_Backup: boolean;
begin

 // RzPanel4.Visible := True;

//  try
  //  try
    //  eConexao.Connected := false;
      //Backup.DatabaseName := frmmodulo.Conexao.Database;
//      BAckup.ServerName := frmmodulo.Conexao.HostName;
      //Backup.DatabaseName := eConexao.Database;
      //BAckup.ServerName := eConexao.Server;
//      application.ProcessMessages;

 //     Backup.BackupFile.Clear;
   //   Backup.BackupFile.Add(ChangeFileExt('\iCloud\server\bkp\' + FormatDateTime('yyyymmddnnhh', now), '.fbk'));
     // Backup.Active := true;

//      listbox1.Clear;
  //    listbox1.Items.Add(Format('Backup Iniciado às %s horas', [FormatDateTime('hh:nn:ss', now)]));
    //  listbox1.Items.add('Local: \iCloud\server\bkp\');

//      AlinharPanel(frmPrincipal, pBackup, true);
  //    pBackup.visible := true;
    //  application.ProcessMessages;

//      Backup.ServiceStart;
  //    while not BackUp.Eof do
    //  begin
      //  listbox1.Items.add(BackUp.GetNextLine);
        //ListBox1.Update;
//        ListBox1.ItemIndex := ListBox1.Items.Count - 1;

  //      Application.ProcessMessages;
    //  end;
//      Backup.Active := false;
  //    listbox1.items.add(Format('Backup Finalizado às %s horas', [FormatDateTime('hh:nn:ss', now)]));
    //  showmessage('Processamento finalizado!');
      //RzPanel4.Visible := False;
//      econexao.Connected := true;
  //    pBackup.visible := false;
    //  application.processmessages;
      //result := true;

//      frmmodulo.Conexao.Connected := TRUE;
  //    FRMMODULO.ConexaoLOCAL.Connected := TRUE;

    //  frmmodulo.qrconfig.Open;
      //frmmodulo.qrconfig.edit;
//      frmmodulo.qrconfig.FieldByName('ultimo_backup').asdatetime := date;
  //    frmmodulo.qrconfig.post;
    //  frmmodulo.qrconfig.close;
      //frmmodulo.ConexaoLocal.Commit;
//      frmmodulo.Conexao.commit;

  //  except
    //  on E: Exception do
      //  ShowMessage(E.ClassName
        //  + 'erro gerado, com mensagem : '
          //+ E.Message);
//    end;
  //except
    //result := false;
//  end;
end;

function TfrmPrincipal.StrZeros(Texto: string; Qtde: Integer): string;
var i, Tam: integer;
  Aux: string;
begin
  Aux := '';
  Tam := Length(Texto);
  for i := Tam to (Qtde - 1) do
    Aux := Aux + '0';
  StrZeros := Aux + Texto;
end;

function TfrmPrincipal.Verifica_Conexao: Boolean;
begin
end;

(*FUNCOES ACRESCENTADAS PARA O TEF*)


function Tfrmprincipal.tira_aspa(texto: string): string;
var s1, s2: string;
  i: Integer;
begin
  s1 := texto;
  s2 := '';
  for i := 1 to Length(s1) do
    if s1[i] <> '''' then
      s2 := s2 + s1[i];
  result := s2;
end;

function tfrmprincipal.msgcard(): boolean;
begin
  frmmsgcartao := tfrmmsgcartao.create(self);
  frmmsgcartao.showmodal;
  result := retmsg;
end;

function tfrmprincipal.msgcheck(): boolean;
begin
  frmmsgcheque := tfrmmsgcheque.create(self);
  frmmsgcheque.showmodal;
  result := retmsg;
end;

procedure Tfrmprincipal.Daruma_Analisa_Retorno();
begin

  if Daruma_Retorno = -27 then
    Daruma_Retorno_Impressora();

  if Daruma_Retorno = 0 then
  begin
    continua := false;
    application.messagebox('Erro de comunicação, a Função nao conseguiu enviar o comando', 'Erro', mb_ok + MB_ICONERROR);
  end;

  if Daruma_Retorno = -1 then
  begin
    continua := false;
    application.messagebox('Erro de Execução da Função', 'Erro', mb_ok + MB_ICONERROR);
  end;

  if Daruma_Retorno = -2 then
  begin
    continua := false;
    application.messagebox('Parâmetro inválido passado na função.!', 'Erro', mb_ok + MB_ICONERROR);
  end;

  if Daruma_Retorno = -3 then
  begin
    continua := false;
    application.messagebox('Alíquota não programada no ECF. !', 'Erro', mb_ok + MB_ICONERROR);
  end;

  if Daruma_Retorno = -4 then
  begin
    continua := false;
    application.messagebox('A Chave ou Valor no Registry não Foi Encontado.!', 'Erro', mb_ok + MB_ICONERROR);
  end;

  if Daruma_Retorno = -5 then
  begin
    continua := false;
    application.messagebox('Erro ao Abrir a Porta de Comunicação', 'Erro', mb_ok + MB_ICONERROR);
  end;

  if Daruma_Retorno = -6 then
  begin
    continua := false;
    application.messagebox('Impressora desligada ou cabo de comunicação desconectado.', 'Erro', mb_ok + MB_ICONERROR);
  end;

  if Daruma_Retorno = -7 then
  begin
    continua := false;
    application.messagebox('Banco não encontrado ou não cadastrado no Registry', 'Erro', mb_ok + MB_ICONERROR);
  end;

  if Daruma_Retorno = -8 then
  begin
    continua := false;
    application.messagebox(' Erro ao criar ou gravar no arquivo STATUS.TXT ou RETORNO.TXT.', 'Erro', mb_ok + MB_ICONERROR);
  end;

end;

{A Rotina Abaixo Analisa o Retorno da Impressora, do ECF}

procedure Tfrmprincipal.Daruma_Retorno_Impressora();
var Daruma_iACK, Daruma_iST1, Daruma_iST2: Integer;
  Daruma_MSG: string;

begin
  Daruma_iACK := 0; //Variaveis devem ser inicializadas para Alocar Espaco
  Daruma_iST1 := 0;
  Daruma_iST2 := 0;
  Daruma_MSG := '';
  Daruma_Retorno := Daruma_FI_RetornoImpressora(Daruma_iACK, Daruma_iST1, Daruma_iST2);
  if Daruma_iACK = 6 then
  begin


          // Verifica ST1

    if Daruma_iST1 >= 128 then begin Daruma_iST1 := Daruma_iST1 - 128; Daruma_MSG := 'Papel Acabou!!' + #13 + #10; end;
    if Daruma_iST1 >= 64 then begin Daruma_iST1 := Daruma_iST1 - 64; Daruma_MSG := Daruma_MSG + 'Papel Acabando!!' + #13 + #10; continua := true; end;
    if Daruma_iST1 >= 32 then begin Daruma_iST1 := Daruma_iST1 - 32; Daruma_MSG := Daruma_MSG + 'Erro no Relogio!!' + #13 + #10; end;
    if Daruma_iST1 >= 16 then begin Daruma_iST1 := Daruma_iST1 - 16; Daruma_MSG := Daruma_MSG + 'Impressora em Erro!!' + #13 + #10; end;
    if Daruma_iST1 >= 8 then begin Daruma_iST1 := Daruma_iST1 - 8; Daruma_MSG := Daruma_MSG + 'Falta o ESC no comando!!' + #13 + #10; end;
    if Daruma_iST1 >= 4 then begin Daruma_iST1 := Daruma_iST1 - 4; Daruma_MSG := Daruma_MSG + 'Nao existe o Comando!!' + #13 + #10; end;
    if Daruma_iST1 >= 2 then begin Daruma_iST1 := Daruma_iST1 - 2; Daruma_MSG := Daruma_MSG + 'Cupom Aberto!!' + #13 + #10; end;
    if Daruma_iST1 >= 1 then begin Daruma_iST1 := Daruma_iST1 - 1; Daruma_MSG := Daruma_MSG + 'Parametro Errado!!' + #13 + #10; end;

          // Verifica ST2

    if Daruma_iST2 >= 128 then begin Daruma_iST2 := Daruma_iST2 - 128; Daruma_MSG := Daruma_MSG + 'Parametro Invalido!!' + #13 + #10; end;
    if Daruma_iST2 >= 64 then begin Daruma_iST2 := Daruma_iST2 - 64; Daruma_MSG := Daruma_MSG + 'MF Lotada!!' + #13 + #10; end;
    if Daruma_iST2 >= 32 then begin Daruma_iST2 := Daruma_iST2 - 32; Daruma_MSG := Daruma_MSG + 'Erro na Ram!!' + #13 + #10; end;
    if Daruma_iST2 >= 16 then begin Daruma_iST2 := Daruma_iST2 - 16; Daruma_MSG := Daruma_MSG + 'Aliquota Nao Programada!!' + #13 + #10; end;
    if Daruma_iST2 >= 8 then begin Daruma_iST2 := Daruma_iST2 - 8; Daruma_MSG := Daruma_MSG + 'Nao cabe mais Aliquota!!' + #13 + #10; end;
    if Daruma_iST2 >= 4 then begin Daruma_iST2 := Daruma_iST2 - 4; Daruma_MSG := Daruma_MSG + 'Canc. Nao Permitido!!' + #13 + #10; end;
    if Daruma_iST2 >= 2 then begin Daruma_iST2 := Daruma_iST2 - 2; Daruma_MSG := Daruma_MSG + 'CNPJ nao Programado!!' + #13 + #10; end;
    if Daruma_iST2 >= 1 then begin Daruma_iST2 := Daruma_iST2 - 1; Daruma_MSG := Daruma_MSG + 'Comando Nao Executado!!' + #13 + #10; end;

    if Length(Daruma_MSG) > 1 then
      APPLICATION.MESSAGEBOX(pansichar(daruma_msg), 'Atenção', mb_ok + mb_iconwarning);
  end;

  if Daruma_iACK = 21 then begin
    APPLICATION.MESSAGEBOX('Erro Fatal na Impressora! A aplicação será finalizada!', 'Erro', mb_ok + mb_iconerror);
    Application.Terminate;
    Exit;
  end;
end;


function Tfrmprincipal.AnalisaRetornoECF: integer;
var iACK, iST1, iST2: Integer;
begin
  iACK := 0; iST1 := 0; iST2 := 0;
  iRet := Bematech_FI_RetornoImpressora(iACK, iST1, iST2);
  if iACK = 6 then
  begin
    if iST1 = 64 then
    begin
      iST1 := iST1 - 64;
      application.messagebox('Papel está terminando', 'Atenção', mb_ok + mb_iconwarning);
      IRET := 1;
      CONTINUA := TRUE;
    end
    else
    begin
      if iST1 = 128 then
      begin
        iST1 := iST1 - 128;
        application.messagebox('Fim do Papel', 'Erro', mb_ok + MB_ICONERROR);
        iret := 0;
      end;
      if iST1 = 192 then
      begin
        iST1 := iST1 - 128;
        application.messagebox('Fim do Papel', 'Erro', mb_ok + MB_ICONERROR);
        iret := 0;
      end;
      if iST1 = 32 then
      begin
        iST1 := iST1 - 32;
        application.messagebox('Erro no relógio interno do ECF', 'Erro', mb_ok + MB_ICONERROR);
      end;
      if iST1 = 16 then
      begin
        iST1 := iST1 - 16;
        application.messagebox('Impressora em erro - Desligue e ligue o ECF', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST1 = 8 then
      begin
        iST1 := iST1 - 8;
        application.messagebox('Erro no envio do comando', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST1 = 4 then
      begin
        iST1 := iST1 - 4;
        application.messagebox('Comando inexistente', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST1 = 2 then
      begin
        iST1 := iST1 - 2;
        application.messagebox('Cupom Fiscal aberto', 'Erro', mb_ok + MB_ICONERROR);
        venda_TEF := true;
      end;
      if iST1 = 1 then
      begin
        iST1 := iST1 - 1;
        application.messagebox('Parâmetro inválido', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      // Verifica ST2
      if iST2 = 128 then
      begin
        iST2 := iST2 - 128;
        application.messagebox('Tipo de comando inválido', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST2 = 64 then
      begin
        iST2 := iST2 - 64;
        application.messagebox('Memória Fiscal cheia', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST2 = 32 then
      begin
        iST2 := iST2 - 32;
        application.messagebox('Erro na CMOS do ECF', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST2 = 16 then
      begin
        iST2 := iST2 - 16;
        application.messagebox('Alíquota não programada', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST2 = 8 then
      begin
        iST2 := iST2 - 8;
        application.messagebox('Capacidade de alíquotas esgotada', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST2 = 5 then
      begin
        iST2 := iST2 - 4;
        application.messagebox('Cancelamento não permitido! Verifique se o mesmo já foi cancelado!', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;



      if iST2 = 4 then
      begin
        iST2 := iST2 - 4;
        application.messagebox('Cancelamento não permitido pelo ECF', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST2 = 2 then
      begin
        iST2 := iST2 - 2;
        application.messagebox('CNPJ/IE não programados', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
      if iST2 = 1 then
      begin
        iST2 := iST2 - 1;
        application.messagebox('Comando não executado', 'Erro', mb_ok + MB_ICONERROR);
        continua := false;
      end;
    end; // ACABANDO O PAPEL....
  end;

  if iACK = 21 then
  begin
    application.messagebox(pansichar('Atenção!!!' + #13 + #10 + 'A Impressora retornou NAK. O programa será abortado.'), 'Erro', mb_ok + mb_iconerror);
    continua := false;
    Application.Terminate;
    Exit;
  end;



  result := iRet;
end;


function Tfrmprincipal.AnalisaRetornoComando(retorno: integer): integer;
begin

  if retorno < 1 then continua := false;

  if retorno = 0 then
    application.messagebox('Erro de Comunicação !', 'Erro', mb_ok + MB_ICONERROR);
  if retorno = -1 then
    application.messagebox('Erro de Execução na Função. Verifique!', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -2 then
    application.messagebox('Parâmetro Inválido!', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -3 then
    application.messagebox('Alíquota não programada!', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -4 then
    application.messagebox('Arquivo BemaFI32.INI não encontrado. Verifique!', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -5 then
    application.messagebox('Erro ao Abrir a Porta de Comunicação', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -6 then
    application.messagebox('Impressora Desligada ou Desconectada', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -7 then
    application.messagebox('Banco Não Cadastrado no Arquivo BemaFI32.ini', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -8 then
    application.messagebox('Erro ao Criar ou Gravar no Arquivo Retorno.txt ou Status.txt', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -18 then
    application.messagebox('Não foi possível abrir arquivo INTPOS.001 !', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -19 then
    application.messagebox('Parâmetro diferentes !', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -20 then
    application.messagebox('Transação cancelada pelo Operador !', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -21 then
    application.messagebox('A Transação não foi aprovada !', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -22 then
    application.messagebox('Não foi possível terminal a Impressão !', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -23 then
    application.messagebox('Não foi possível terminal a Operação !', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -24 then
    application.messagebox('Forma de pagamento não programada.', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -25 then
    application.messagebox('Totalizador não fiscal não programado.', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -26 then
    application.messagebox('Transação já Efetuada !', 'Erro', mb_ok + MB_ICONERROR);

  if retorno = -28 then
    application.messagebox('Não há Informações para serem Impressas !', 'Erro', mb_ok + MB_ICONERROR);
  result := retorno;
end;

function Tfrmprincipal.AnalisaRetorno(retorno: integer): integer;
begin
  iRet := AnalisaRetornoComando(retorno);
  iRet := AnalisaRetornoECF();
  result := iRet;
end;




procedure tfrmprincipal.log(CODUSUARIO, TABELA, CODREGISTRO, FUNCAO, hISTORICO: string);
begin
  frmmodulo.querylog.close;
  frmmodulo.querylog.SQL.clear;
  frmmodulo.querylog.sql.add('insert into c000101');
  frmmodulo.querylog.sql.add('(data,hora,codusuario,tabela,codregistro,funcao,historico)');
  frmmodulo.querylog.SQL.add('values');
  frmmodulo.querylog.sql.add('(:data,:hora,:codusuario,:tabela,:codregistro,:funcao,:historico)');
  frmmodulo.querylog.params.parambyname('data').asdatetime := date;
  frmmodulo.querylog.params.parambyname('hora').asstring := timetostr(time);
  frmmodulo.querylog.params.parambyname('codusuario').asstring := usuario_temp;
  frmmodulo.querylog.params.parambyname('tabela').asstring := TABELA;
  frmmodulo.querylog.params.parambyname('codregistro').asstring := copy(codregistro, 1, 10);
  frmmodulo.querylog.params.parambyname('funcao').asstring := copy(funcao, 1, 10);
  frmmodulo.querylog.params.parambyname('historico').asstring := copy(historico, 1, 80);
  frmmodulo.querylog.execsql;

  usuario_temp := codigo_usuario;

end;

procedure tfrmprincipal.agenda(vsituacao, vtipo, vnome, vtelefone1, vtelefone2, vtelefone3, vcelular, vemail, vfax, vhomepage, vtipoi: string);
begin

  // tipoi
  {
   1. 'CLIENTE'
   2. 'CONTATO'
   3. 'FORNECEDOR'
   4. 'FUNCIONÁRIO'
   5. 'OUTROS'
   6. 'TRANSPORTADOR'
  }

  if vsituacao = '1' then
  begin
    frmmodulo.queryagenda.close;
    frmmodulo.queryagenda.SQL.clear;
    frmmodulo.queryagenda.sql.add('insert into c000034');
    frmmodulo.queryagenda.sql.add('(codigo,tipo,nome,telefone1,telefone2,telefone3,celular,email,fax,homepage,tipoi)');
    frmmodulo.queryagenda.SQL.add('values');
    frmmodulo.queryagenda.sql.add('(:codigo,:tipo,:nome,:telefone1,:telefone2,:telefone3,:celular,:email,:fax,:homepage,:tipoi)');
    frmmodulo.queryagenda.params.parambyname('codigo').AsString := frmprincipal.codifica('000034');
    frmmodulo.queryagenda.params.parambyname('tipo').AsString := vtipo;
    frmmodulo.queryagenda.params.parambyname('nome').asstring := vnome;
    frmmodulo.queryagenda.params.parambyname('telefone1').asstring := vtelefone1;
    frmmodulo.queryagenda.params.parambyname('telefone2').asstring := vtelefone2;
    frmmodulo.queryagenda.params.parambyname('telefone3').asstring := vtelefone3;
    frmmodulo.queryagenda.params.parambyname('celular').asstring := vcelular;
    frmmodulo.queryagenda.params.parambyname('email').asstring := vemail;
    frmmodulo.queryagenda.params.parambyname('fax').asstring := vfax;
    frmmodulo.queryagenda.params.parambyname('homepage').asstring := vhomepage;
    frmmodulo.queryagenda.params.parambyname('tipoi').AsInteger := strtoint(vtipoi);
    frmmodulo.queryagenda.execsql;
  end
  else if vsituacao = '2' then
  begin
    {
      frmmodulo.queryagenda.close;
      frmmodulo.queryagenda.SQL.clear;
      frmmodulo.queryagenda.sql.add('update c000034 set ');
      frmmodulo.queryagenda.sql.add('(tipo,nome,telefone1,telefone2,telefone3,celular,email,fax,homepage,tipoi)');
      frmmodulo.queryagenda.SQL.add('values');
      frmmodulo.queryagenda.sql.add('(:tipo,:nome,:telefone1,:telefone2,:telefone3,:celular,:email,:homepage,:tipoi)');
      frmmodulo.queryagenda.params.parambyname('tipo').AsString := vtipo;
      frmmodulo.queryagenda.params.parambyname('nome').asstring := vnome;
      frmmodulo.queryagenda.params.parambyname('telefone1').asstring := vtelefone1;
      frmmodulo.queryagenda.params.parambyname('telefone2').asstring := vtelefone2;
      frmmodulo.queryagenda.params.parambyname('telefone3').asstring := vtelefone2;
      frmmodulo.queryagenda.params.parambyname('celular').asstring := vcelular;
      frmmodulo.queryagenda.params.parambyname('email').asstring := vemail;
      frmmodulo.queryagenda.params.parambyname('fax').asstring := vfax;
      frmmodulo.queryagenda.params.parambyname('homepage').asstring := vhomepage;
      frmmodulo.queryagenda.params.parambyname('tipoi').AsInteger := strtoint(vtipoi);
      frmmodulo.queryagenda.execsql;
      }
  end;

end;

function TfrmPrincipal.VersaoExe(const Filename: string): string;
type
  TVersionInfo = packed record
    Dummy: array[0..7] of Byte;
    V2, V1, V4, V3: Word;
  end;
var
  Zero, Size: Cardinal;
  Data: Pointer;
  VersionInfo: ^TVersionInfo;
begin
  Size := GetFileVersionInfoSize(Pointer(Filename), Zero);
  if Size = 0 then
    Result := ''
  else
  begin
    GetMem(Data, Size);
    try
      GetFileVersionInfo(Pointer(Filename), 0, Size, Data);
      VerQueryValue(Data, '\', Pointer(VersionInfo), Size);
      Result := Format('%d.%d.%d.%d', [VersionInfo.V1, VersionInfo.V2, VersionInfo.V3, VersionInfo.V4]);
    finally
      FreeMem(Data);
    end;
  end;
end;

function tfrmprincipal.Exec_File(File_Path: string): integer;
var
  retorno: integer;
  MyOpenDialog: TOpenDialog;
  Error_Msg: string;
begin
  retorno := ERROR_FILE_NOT_FOUND;

  try
    if FileExists(File_Path) then
      retorno := ShellExecute(0, nil, PChar(File_Path), nil, nil, SW_NORMAL)
    else if application.messagebox(PChar('Não foi possível encontrar o arquivo - ' +
      #13 + File_Path + #13#13 +
      'Deseja Localizar o Arquivo?'),
      'Atenção', MB_IconInformation + MB_YESNO) = idYes then
    begin
      MyOpenDialog := TOpenDialog.Create(MyOpenDialog);
      MyOpenDialog.Title := 'Localizando Arquivo...';
      MyOpenDialog.InitialDir := Extractfiledir(application.exename);
      if MyOpenDialog.Execute then
        retorno := ShellExecute(0, nil, PChar(MyOpenDialog.filename), nil, nil, SW_NORMAL);
    end;
  except
    application.MessageBox('Erro no processo de execução do arquivo de Ajuda',
      'Atenção', mb_ok + mb_iconerror);
  end;

  MyOpenDialog.Free;

  Error_Msg := '';
  case retorno of
    0: Error_Msg := 'Erro: Não há memória sufiente para executar o arquivo - ' + File_Path;
    ERROR_FILE_NOT_FOUND: Error_Msg := 'Erro: Arquivo não encontrado em - ' + File_Path;
    ERROR_PATH_NOT_FOUND: Error_Msg := 'Erro: Arquivo não encontrado em - ' + File_Path;
    ERROR_BAD_FORMAT: Error_Msg := 'Erro: Arquivo .EXE inválido (non-Win32 .EXE or error in .EXE image).';
    SE_ERR_ACCESSDENIED: Error_Msg := 'Erro: O Sistema Operacional negou o acesso ao arquivo - ' + File_Path;
    SE_ERR_ASSOCINCOMPLETE: Error_Msg := 'Erro: Associação de tipo de arquivo incompatível ou inválida.';
    SE_ERR_DDEBUSY: Error_Msg := 'Erro: Transação DDE não pode ser completada devido a execução de outras transações.';
    SE_ERR_DDEFAIL: Error_Msg := 'Erro: A Transação DDE falhou.';
    SE_ERR_DDETIMEOUT: Error_Msg := 'Erro: Time de execução da transação DDE';
    SE_ERR_DLLNOTFOUND: Error_Msg := 'Erro: Dll especificada não foi encontrada.';
    SE_ERR_NOASSOC: Error_Msg := 'Erro: Não há aplicativo associado ao tipo de arquivo especificado.';
    SE_ERR_OOM: Error_Msg := 'Erro: Não há memória sufiente para completar a operação.';
    SE_ERR_SHARE: Error_Msg := 'Erro: Violação de Compartilhamento.';
  //else
  //showmessage('instance handle of the application that was run, or the handle of a dynamic data exchange (DDE) server application is: ' + inttostr(retorno));
  end;

  if trim(Error_Msg) <> '' then
    showmessage(Error_Msg);



end;

function tfrmprincipal.UltimoDiaMes(Mdt: TDateTime): TDateTime;
{ retorna o ultimo dia o mes, de uma data fornecida}
var
  ano, mes, dia: word;
  mDtTemp: TDateTime;
begin
  Decodedate(mDt, ano, mes, dia);
  mDtTemp := (mDt - dia) + 33;
  Decodedate(mDtTemp, ano, mes, dia);
  Result := mDtTemp - dia;
end;


function tfrmprincipal.Space(const Len: integer): string;
begin
  Result := tbReplChar(#32, Len);
end;

function tfrmprincipal.tbReplChar(const Ch: Char; const Len: integer): string;
var
  I: integer;
begin
  SetLength(Result, Len);
  for I := 1 to Len do
    Result[I] := Ch;
end;

function Tfrmprincipal.somenteNumero(sNum: string): string;
var s1, s2: string;
  i: Integer;
begin
  s1 := snum;
  s2 := '';
  for i := 1 to Length(s1) do
    if s1[i] in ['0'..'9'] then
      s2 := s2 + s1[i];
  result := s2;
end;

function tfrmprincipal.tira_ponto(texto: string): string;
var i: integer;
begin
  i := pos('.', texto) + pos(',', texto);
  while i <> 0 do
  begin
    if pos('.', texto) > 0 then delete(texto, i, 1);
    if pos(',', texto) > 0 then delete(texto, i, 1);
    i := pos('.', texto) + pos(',', texto);
  end;
  result := texto;
end;

function tfrmprincipal.TiraCaracterEspecial(texto: string): string;
var i: integer;
begin
  i := pos('-', texto) + pos('_', texto);
  while i <> 0 do
  begin
    if pos('-', texto) > 0 then delete(texto, i, 1);
    if pos('_', texto) > 0 then delete(texto, i, 1);
    i := pos('-', texto) + pos('_', texto);
  end;
  result := texto;
end;

procedure tfrmprincipal.ExecutePrograma(Nome, Parametros: string);
var
  Comando: array[0..1024] of Char;
  Parms: array[0..1024] of Char;
begin
  StrPCopy(Comando, Nome);
  StrPCopy(Parms, Parametros);
  ShellExecute(0, nil, Comando, Parms, nil, SW_ShowNormal);
end;


procedure tfrmprincipal.FechePrograma(Programa: Pchar);
var
  hHandle: THandle;
begin
  hHandle := FindWindow(nil, Programa);

  if hHandle <> 0 then
    PostMessage(hHandle, WM_QUIT, 0, 0);

end;

function TFRMPRINCIPAL.NomeComputador: string;
var
  lpBuffer: PChar;
  nSize: DWord;
const Buff_Size = MAX_COMPUTERNAME_LENGTH + 1;
begin
  nSize := Buff_Size;
  lpBuffer := StrAlloc(Buff_Size);
  GetComputerName(lpBuffer, nSize);
  Result := string(lpBuffer);
  StrDispose(lpBuffer);
end;

function tfrmprincipal.acesso(usuario: string; funcao: string): string;
begin
  try
    frmmodulo.qrUsuario_funcao.Close;
    frmmodulo.qrusuario_funcao.SQL.clear;
    frmmodulo.qrusuario_funcao.sql.add('select * from c000067 where codusuario =''' + usuario + ''' and funcao like ''' + funcao + '%''');
    frmmodulo.qrusuario_funcao.open;
    if frmmodulo.qrusuario_funcao.RecNo = 1 then
    begin
      result := FRMMODULO.QRUSUARIO_FUNCAO.FIELDBYNAME('ACESSO').ASSTRING;
    end
    else
    begin
      result := 'NAO';
    end;
  except
    result := 'NAO';
  end;

end;

procedure Tfrmprincipal.AcertaPadraoData2;
const arrShortDayNames: array[1..7] of string[3] = ('Dom', 'Seg', 'Ter', 'Qua',
    'Qui', 'Sex', 'Sab');
  arrLongDayNames: array[1..7] of string[15] = ('Domingo', 'Segunda', 'Terça',
    'Quarta', 'Quinta', 'Sexta', 'Sábado');
  arrShortMonthNames: array[1..12] of string[3] = ('Jan', 'Fev', 'Mar', 'Abr',
    'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez');
  arrLongMonthNames: array[1..12] of string[15] = ('Janeiro', 'Fevereiro',
    'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro',
    'Novembro', 'Dezembro');
var ii: integer;
begin
  ShortDateFormat := 'dd/mm/yyyy';
  DecimalSeparator := ',';
  ThousandSeparator := '.';
  for ii := 1 to 7 do
  begin
    ShortDayNames[ii] := arrShortDayNames[ii];
    LongDayNames[ii] := arrLongDayNames[ii];
  end;
  for ii := 1 to 12 do
  begin
    ShortMonthNames[ii] := arrShortMonthNames[ii];
    LongMonthNames[ii] := arrLongMonthNames[ii];
  end;
end;



procedure tfrmprincipal.LimpaEdit(Form: TForm);
var
  i: Integer;
begin
  for i := 0 to Form.ComponentCount - 1 do
    if Form.Components[i] is TCustomEdit then (Form.Components[i] as TCustomEdit).Clear;
end;

function tfrmprincipal.texto_justifica(texto: string; qtde_caracteres: integer; caracter: string; tipo: string): string;
begin
  texto := tiraacento(texto);
  if tipo = 'E' then
  begin
    while length(texto) < qtde_caracteres do texto := caracter + texto;
    while length(texto) > qtde_caracteres do delete(texto, (qtde_caracteres + 1), 1);
  end;
  if tipo = 'D' then
  begin
    while length(texto) < qtde_caracteres do texto := texto + caracter;
    while length(texto) > qtde_caracteres do delete(texto, (qtde_caracteres + 1), 1);
  end;
  if tipo = 'C' then
  begin
    if (qtde_caracteres mod 2) <> 0 then qtde_caracteres := qtde_caracteres - 1;
    while length(texto) < qtde_caracteres do texto := caracter + texto + caracter;
    while length(texto) > qtde_caracteres do delete(texto, (qtde_caracteres + 1), 1);
  end;
  result := texto;
end;


function TFrmprincipal.AnoBiSexto(Ayear: Integer): Boolean;
begin
// Verifica se o ano é Bi-Sexto
  Result := (AYear mod 4 = 0) and ((AYear mod 100 <> 0) or
    (AYear mod 400 = 0));
end;

function TFrmprincipal.DiasPorMes(Ayear, AMonth: Integer): Integer;
const DaysInMonth: array[1..12] of Integer = (31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);
begin
  Result := DaysInMonth[AMonth];
  if (AMonth = 2) and AnoBiSexto(AYear) then
    Inc(Result);
end;




function tfrmprincipal.tiraacento(str: string): string;
var
  i: Integer;
begin
  for i := 1 to Length(str) do
    case str[i] of
      'è': str[i] := 'e';
      'ì': str[i] := 'i';
      'ù': str[i] := 'u';
      'î': str[i] := 'i';
      'û': str[i] := 'u';
      'á': str[i] := ' '; //
      'é': str[i] := ''; //
      'í': str[i] := '¡'; //
      'ó': str[i] := '¢'; //
      'ú': str[i] := '£'; //
      'à': str[i] := ''; //
      'ò': str[i] := ''; //
      'â': str[i] := ''; //
      'ê': str[i] := ''; //
      'ô': str[i] := ''; //
      'ä': str[i] := ''; //
      'ë': str[i] := ''; //
      'ï': str[i] := ''; //
      'ö': str[i] := ''; //
      'ü': str[i] := ''; //
      'ã': str[i] := ''; //
      'õ': str[i] := 'o';
      'ñ': str[i] := '¤'; //
      'ç': str[i] := ''; //
      'Á': str[i] := 'A';
      'É': str[i] := ''; //
      'Í': str[i] := 'I';
      'Ó': str[i] := 'O';
      'Ú': str[i] := 'U';
      'À': str[i] := 'A';
      'È': str[i] := 'E';
      'Ì': str[i] := 'I';
      'Ò': str[i] := 'O';
      'Ù': str[i] := 'U';
      'Â': str[i] := '';
      'Ê': str[i] := 'E';
      'Î': str[i] := 'I';
      'Ô': str[i] := 'O';
      'Û': str[i] := 'U';
      'Ä': str[i] := 'A';
      'Ë': str[i] := 'E';
      'Ï': str[i] := 'I';
      'Ö': str[i] := 'O';
      'Ü': str[i] := ''; //
      'Ã': str[i] := 'A';
      'Õ': str[i] := 'O';
      'Ñ': str[i] := '¥'; //
      'Ç': str[i] := ''; //
      'ª': str[i] := '¦'; //
      'º': str[i] := '§'; //
    end;
  Result := str;
end;


function tfrmprincipal.lancaproduto(codproduto: string; data: tdatetime; movimento: string; codcliente: string; codsaida: string; codentrada: string; codvendedor: string; qtde: real; valor: real; total: real; notafiscal: string): string;
begin
  result := '';

end;


function tfrmprincipal.CalculaDigEAN13(Cod: string): string;
  function Par(Cod: Integer): Boolean;
  begin
    Result := Cod mod 2 = 0;
  end;
var
  i,
    SomaPar,
    SomaImpar: Integer;
begin
  SomaPar := 0;
  SomaImpar := 0;
  for i := 1 to 12 do
    if Par(i) then
      SomaPar := SomaPar + StrToInt(Cod[i])
    else
      SomaImpar := SomaImpar + StrToInt(Cod[i]);

  SomaPar := SomaPar * 3;
  i := 0;
  while i < (SomaPar + SomaImpar) do Inc(i, 10);
  Result := IntToStr(i - (SomaPar + SomaImpar));
end;





function tfrmprincipal.TestaCnpj(xCNPJ: string): Boolean;
var
  d1, d4, xx, nCount, fator, resto, digito1, digito2: Integer;
  Check: string;
begin
  d1 := 0;
  d4 := 0;
  xx := 1;
  for nCount := 1 to Length(xCNPJ) - 2 do
  begin
    if Pos(Copy(xCNPJ, nCount, 1), '/-.') = 0 then
    begin
      if xx < 5 then
      begin
        fator := 6 - xx;
      end
      else
      begin
        fator := 14 - xx;
      end;
      d1 := d1 + StrToInt(Copy(xCNPJ, nCount, 1)) * fator;
      if xx < 6 then
      begin
        fator := 7 - xx;
      end
      else
      begin
        fator := 15 - xx; end;
      d4 := d4 + StrToInt(Copy(xCNPJ, nCount, 1)) * fator;
      xx := xx + 1;
    end;
  end;
  resto := (d1 mod 11);
  if resto < 2 then
  begin
    digito1 := 0;
  end
  else
  begin
    digito1 := 11 - resto;
  end;
  d4 := d4 + 2 * digito1;
  resto := (d4 mod 11);
  if resto < 2 then
  begin
    digito2 := 0;
  end
  else
  begin
    digito2 := 11 - resto;
  end;
  Check := IntToStr(Digito1) + IntToStr(Digito2);
  if Check <> copy(xCNPJ, succ(length(xCNPJ) - 2), 2) then
  begin
    Result := False;
  end
  else
  begin
    Result := True;
  end;
end;


function tfrmprincipal.Locregistro(tabela: TDataSet; valor: string; campo: string): boolean;
begin
  if tabela.Locate(campo, valor, [loCaseInsensitive]) then
  begin
    result := true;
  end
  else
  begin
    Application.MessageBox('Registro não encontrado!!', 'Erro', mb_ok + mb_iconwarning);
    result := false;
  end;


end;


function tfrmprincipal.zerarcodigo(codigo: string; qtde: integer): string;
begin
  while length(codigo) < qtde do codigo := '0' + codigo;
  result := codigo;
end;

function TfrmPrincipal.FormataValorProsoft(fValor: Real; fQtde: Integer): string;
var
  troca: string;
begin
  troca := frmPrincipal.zerarcodigo(FRMPRINCIPAL.somenteNumero(formatcurr('0.00', fValor)), fQtde - 1);
  result := Copy(troca, 1, (fQtde - 3)) + '.' + Copy(troca, (fQtde - 2), 2);
end;

function TFRMPRINCIPAL.GetIP: string;
//--> Declare a Winsock na clausula uses da unit
var
  WSAData: TWSAData;
  HostEnt: PHostEnt;
  Name: string;
begin
  WSAStartup(2, WSAData);
  SetLength(Name, 255);
  Gethostname(PChar(Name), 255);
  SetLength(Name, StrLen(PChar(Name)));
  HostEnt := gethostbyname(PChar(Name));
  with HostEnt^ do
  begin
    Result := Format('%d.%d.%d.%d',
      [Byte(h_addr^[0]), Byte(h_addr^[1]),
      Byte(h_addr^[2]), Byte(h_addr^[3])]);
  end;
  WSACleanup;
end;
//complus

function tfrmprincipal.adic_codifica(tabela: string): string;
begin

  frmmodulo.qradic_mestre.open;
  frmmodulo.qradic_mestre.CommitUpdates;
  frmmodulo.qradic_mestre.Refresh;
  if frmmodulo.qradic_mestre.Locate('codigo', tabela, [loCaseInsensitive]) then
  begin

    if frmmodulo.qradic_mestre.FieldByName('sequencia').asinteger < 1 then
    begin
      result := '000001';
      frmmodulo.qradic_mestre.Edit;
      frmmodulo.qradic_mestre.fieldbyname('sequencia').asinteger := 2;
      frmmodulo.qradic_mestre.Post;
    end
    else
    begin
      result := frmprincipal.zerarcodigo(inttostr(frmmodulo.qradic_mestre.fieldbyname('sequencia').asinteger), 6);
      frmmodulo.qradic_mestre.Edit;
      frmmodulo.qradic_mestre.fieldbyname('sequencia').asinteger := frmmodulo.qradic_mestre.fieldbyname('sequencia').asinteger + 1;
      frmmodulo.qradic_mestre.Post;
    end;
  end
  else
  begin
    Showmessage('Não foi possível concluir com a operação!' + #13 + 'Erro: Código de sequência não encontrado na tabela de códigos.');
    frmmodulo.conexao_adic.Rollback;
  end;



end;

function tfrmprincipal.codifica(tabela: string): string;
var xcod: integer;
begin
//  transMestre.active := true;
  qrmestre.close;
  qrmestre.sql.clear;
  qrmestre.sql.add('select * from c000000 where codigo = ''' + tabela + '''');
  qrmestre.open;
  if qrmestre.recordcount > 0 then
  begin
    xcod := qrmestre.fieldbyname('sequencia').asinteger;
    if xcod < 1 then xcod := 1;
    qrmestre.close;
    qrmestre.sql.clear;
    qrmestre.sql.add('update c000000 set sequencia = sequencia + 1 where codigo = ''' + tabela + '''');
    qrmestre.execsql;
  //  transMestre.commit;
    result := frmprincipal.zerarcodigo(inttostr(xcod), 6);
  end
  else
  begin
    Showmessage('Não foi possível concluir com a operação!' + #13 + 'Erro: Código de sequência não encontrado na tabela de códigos.');
  end;
  Application.ProcessMessages;
end;

function tfrmprincipal.Cript(Action, Src: string): string;
label Fim;
var KeyLen: Integer;
  KeyPos: Integer;
  OffSet: Integer;
  Dest, Key: string;
  SrcPos: Integer;
  SrcAsc: Integer;
  TmpSrcAsc: Integer;
  Range: Integer;
begin
  if (Src = '') then
  begin
    Result := '';
    goto Fim;
  end;
  Key := 'YUQL23KL23DF90WI5E1JAS467NMCXXL6JAOAUWWMCL0AOMM4A4VZYW9KHJUI2347EJHJKDF3424SKL K3LAKDJSL9RTIKJ';
//  Key := 'YUQL%%$#%3DF#0WI5E$JA$46#NM@XXL6JAOAUW%$#@0AOMM4$4VZYW&&HJUI23@7E%#@!DF34#4SKL K3LA@DJSL9RTIKJ';
  Dest := '';
  KeyLen := Length(Key);
  KeyPos := 0;
  SrcPos := 0;
  SrcAsc := 0;
  Range := 256;
  if (Action = UpperCase('C')) then
  begin
    Randomize;
    OffSet := Random(Range);
    Dest := Format('%1.2x', [OffSet]);
    for SrcPos := 1 to Length(Src) do
    begin
      Application.ProcessMessages;
      SrcAsc := (Ord(Src[SrcPos]) + OffSet) mod 255;
      if KeyPos < KeyLen then KeyPos := KeyPos + 1 else KeyPos := 1;
      SrcAsc := SrcAsc xor Ord(Key[KeyPos]);
      Dest := Dest + Format('%1.2x', [SrcAsc]);
      OffSet := SrcAsc;
    end;
  end
  else
    if (Action = UpperCase('D')) then
    begin
      OffSet := StrToInt('$' + copy(Src, 1, 2));
      SrcPos := 3;
      repeat
        SrcAsc := StrToInt('$' + copy(Src, SrcPos, 2));
        if (KeyPos < KeyLen) then KeyPos := KeyPos + 1 else KeyPos := 1;
        TmpSrcAsc := SrcAsc xor Ord(Key[KeyPos]);
        if TmpSrcAsc <= OffSet then TmpSrcAsc := 255 + TmpSrcAsc - OffSet
        else TmpSrcAsc := TmpSrcAsc - OffSet;
        Dest := Dest + Chr(TmpSrcAsc);
        OffSet := SrcAsc;
        SrcPos := SrcPos + 2;
      until (SrcPos >= Length(Src));
    end;
  Result := Dest;
  Fim:
end;

function tfrmprincipal.autentica(funcao: string; nivel: integer): boolean;
begin
  frmsenha := tfrmsenha.create(self);
  frmsenha.lfuncao.caption := inttostr(nivel) + ' - ' + funcao;
  frmsenha.showmodal;
  result := autenticado;
end;

function tfrmprincipal.autentica_caixa(funcao: string; nivel: integer): boolean;
begin
  frmsenha_caixa := tfrmsenha_caixa.create(self);
  frmsenha_caixa.lfuncao.caption := inttostr(nivel) + ' - ' + funcao;
  frmsenha_caixa.showmodal;

  result := autenticado;
end;

procedure TfrmPrincipal.FormShow(Sender: TObject);
var
  d: integer;
  pt: tpoint;
  serial: string;
  x, data_fim, data_inicio: string;
  Registro: TRegistry;
  lSucesso: Boolean;
  a: real;
  texto: string;

// variaveis da dll de registro
  reg_expirado, reg_instalacao, reg_data, reg_termino: string;

  slinha: string;
  f: textfile;


  Dt_Final, Dt_inventario: TDateTime;
  AnoF, MesF, DiaF: Word;
  Ano, Mes, Dia: Word;


  vData_Inventario, Data: TDateTime;
  vInventario_ano: integer;
//  ano, mes, dia : word;

begin
  //novo menu
//  ptopo2.panels[3].Text := '---';

  if (frmmodulo.Conexao.HostName <> '') and
    (ansiuppercase(frmmodulo.Conexao.HostName) <> 'LOCALHOST') and
    (ansiuppercase(frmmodulo.Conexao.HostName) <> ansiuppercase(NomeComputador)) and
    (frmmodulo.conexao.HostName <> GetIP)
    then


  begin
       //showmessage('sistema eh uma estacao');
    FHoje := Trunc(Date);


  end
  else
  begin

  end;
  // se o sistema eh uma estacao



  if USA_TEF then
  begin
    if FileExists(sTEFKoneKPath + 'gp.tmp') then
    begin
      begin
        assignfile(f, sTEFKoneKPath + 'gp.tmp');
        reset(f);
        readln(f, slinha);
        closefile(f);
      end;
    end;

    if slinha = 'TECBAN' then
    begin
      itefTecban := 1;
      sTEFPath := 'C:\TEF_DISC\'
    end
    else
    begin
      sTEFPath := 'C:\TEF_DIAL\';
      itefTecban := 0;
    end;

    TEFVerificaGerenciadorAtivo;
    TEFVerificaArquivosPendentes;
    TEFVerificaOperacaoPendente;
  end;

  try
    Registro := TRegistry.Create;
    Registro.RootKey := HKEY_CURRENT_USER;
    if not Registro.OpenKey('iCloud', false) then
    begin
      Registro.CreateKey('iCloud');
      Registro.OpenKey('iCloud', true);
      registro.writestring('Terminal', inputbox('Config. Terminal.', 'Nº Terminal (3 Digitos)', '000'));
    end
    else
    begin
      if Registro.ReadString('Terminal') = '' then
      begin
        registro.writestring('Terminal', inputbox('Config. Terminal', 'Nº Terminal (3 Digitos)', '000'));
      end;
    end;


  finally
    registro_terminal := Registro.ReadString('Terminal');
    Registro.free;
  end;


  FRMMODULO.QRCONFIG.OPEN;
  case FRMMODULO.QRCONFIG.FIELDBYNAME('RAMO_ATIVIDADE').ASINTEGER of
    1: begin // FULL
//        PSTATUS.Panels[0].Text := 'FULL';
      end;
    2: begin // SUPERMERCADO
  //      PSTATUS.Panels[0].Text := 'SUPER';
      end;
    3: begin // PECAS
    //    PSTATUS.Panels[0].Text := 'PEÇAS';
      end;
    4: begin // FARMACIA
      //  PSTATUS.Panels[0].Text := 'FARMACIA';
      end;
  end;

  if not autentica('Entrada no sistema', 1) then
  begin
    application.Terminate;
  end
  else
  begin

    frmmodulo.qrconfig.open;
    nivel_usuario := frmmodulo.qrusuario.fieldbyname('nivel').asinteger;
    codigo_usuario := frmmodulo.qrusuario.fieldbyname('codigo').asstring;

   //   frmmodulo.qrconfig.open;

//    frmprincipal.pstatus.Panels[2].text := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
  //  frmprincipal.pstatus.Panels[3].text := frmmodulo.qrusuario.fieldbyname('usuario').asstring;

   // frmprincipal.pstatus.Panels[5].text := NomeComputador;

    frmprincipal.PopupMenu := Pop_principal;
    //frmprincipal.Menu := nil;
  //  frmprincipal.pstatus.Panels[7].text := GETIP;

//    ptopo2.Panels[1].text := emitente_nome;

    Data := DataDeCriacao('C:\iCloud\server\iCloud.exe');
  //  ptopo2.Panels[5].Text := ExeInfo1.fileVersion;
   // ptopo2.Panels[6].Text := 'Atualizado Em: ' + DATETIMETOSTR(DATA);

    frmmodulo.qremitente.Open;
    x := cript('D', frmmodulo.qremitente.fieldbyname('comentarios').asstring);

    if res_termino <> copy(x, 2, 10) then
//      ptopo2.panels[3].Text := res_termino
    else
  //    ptopo2.panels[3].Text := copy(x, 2, 10);

      frmmodulo.qrcaixa_operador.Open;
  //  pstatus.Panels[12].Text := 'Data do Sistema : ' + frmmodulo.qrcaixa_operador.FIELDBYNAME('DATA').AsString;


    if frmmodulo.Conexao.hostname = '' then
      spnl47.Caption := 'LOCALHOST'
    else
      spnl47.Caption := frmmodulo.Conexao.hostname;

    spnl2569.Caption := frmmodulo.Conexao.Database;
    spnlUsu.Caption := frmmodulo.qrusuario.fieldbyname('usuario').asstring;


    if frmmodulo.qrconfig.fieldbyname('VISUALIZA_MENSAGEM').AsInteger = 1 then
    begin
    end;

    frmmodulo.qrfilial.close;
    frmmodulo.qrfilial.sql.clear;
    frmmodulo.qrfilial.sql.add('select * from c000004 order by filial');
    frmmodulo.qrfilial.open;
    //variavel para nome no statusbar by Mizael
    spnl147.Caption := frmmodulo.qrFilialFILIAL.AsString;

    vfil_codigo := frmmodulo.qrFilialCODIGO.AsString;
    vfil_nome := frmmodulo.qrFilialFILIAL.AsString;
    vfil_cnpj := frmmodulo.qrFilialCNPJ.AsString;
    vfil_ie := frmmodulo.qrFilialIE.AsString;
    vfil_cipi := frmmodulo.qrFilialCONTRIBUINTE_IPI.AsString;
    vfil_cst := frmmodulo.qrFilialSUBSTITUTO_TRIBUTARIO.AsString;
    vfil_simples := frmmodulo.qrFilialOPTANTE_SIMPLES.AsString;
    vfil_ssimples := frmmodulo.qrFilialOPTANTE_SUPER_SIMPLES.AsString;
    vfil_estadual := frmmodulo.qrFilialEMPRESA_ESTADUAL.AsString;

    if nivel_usuario = 4 then
    begin

      if mostra_principal = '1' then
      begin

        pnormal.visible := false;
        psuper.visible := false; //true;

        qrcx.close;
        qrcx.sql.clear;
        qrcx.sql.add('select * from c000045 where codigo = ''000099''');
        qrcx.open;
        if qrcx.RecordCount > 0 then
        begin
          lcaixa.Caption := qrcx.fieldbyname('data').asstring;
          if qrcx.fieldbyname('situacao').asinteger = 1 then
            lsit_caixa.caption := 'ABERTO' else
            lsit_caixa.caption := 'FECHADO';
        end
        else
        begin
          Lcaixa.caption := '---';
          lsit_caixa.Caption := '---'
        end;

        if (qrcx.fieldbyname('data').AsDateTime <> Date) and (qrcx.fieldbyname('situacao').asinteger = 1) then
        begin

          if application.messagebox(PChar('A Data do Caixa está diferente da atual!' +
            #13 + 'Deseja fechar o caixa do dia ' + qrcx.fieldbyname('data').asstring + '?'),
            'Atenção', MB_IconInformation + MB_YESNO) = idYes then
          begin
            Caixa2.Click
          end;
        end;

//        pstatus.Panels[11].Text := frmmodulo.qrconfig.fieldbyname('ultimo_backup').AsString;
        d := TRUNC((date - frmmodulo.qrconfig.fieldbyname('ultimo_backup').asdatetime));
        FRMMODULO.QRCONFIG.CLOSE;
      //  if pstatus.Panels[13].Text = 'Servidor : LOCALHOST' then
        begin
 //         if d > 2 then
   //       begin
     //       label8.caption := 'Há ' + inttostr(d) + ' dias não é feito';
       //     alerta_copia.Popup;
         // end;
        end;

        qrniver.close;
        qrniver.sql.clear;
        qrniver.sql.add('select codigo, nome, nascimento, telefone1, telefone2, celular from c000007 where situacao < 3 and  nascimento like ''' + copy(datetostr(date), 1, 5) + '/%'' order by nome');
        qrniver.open;

        qrpagar.close;
        qrpagar.sql.clear;
        qrpagar.sql.add('select pg.*, forn.nome from c000046 pg, c000009 forn');
        qrpagar.sql.add('where pg.codfornecedor = forn.codigo and situacao = 1 and');
        qrpagar.sql.add('data_vencimento = :datax order by data_vencimento ');
        qrpagar.params.ParamByName('datax').asdatetime := date;
        qrpagar.open;

        query.close;
        query.sql.clear;
        query.sql.add('select sum(entrada) total_entrada, sum(saida) total_saida,');
        query.sql.add('(select sum(valor) valor from c000046 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(valor_atual) valor_1 from c000049 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(total) valor_2 from c000048 where data = :datax),');
        query.sql.add('(select sum(total) valor_3 from c000051 where conclusao_data = :datax and situacao = ''FECHADA'')');
        query.sql.add('from c000044 where data = :datax');
        query.params.ParamByName('datax').asdatetime := qrcx.fieldbyname('data').asdatetime;
        query.params.ParamByName('datav').asdatetime := date;
        query.open;

        ltcaixa.caption := formatfloat('###,###,##0.00', query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat);
        ltpagar.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor').asfloat);
        ltreceber.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_1').asfloat);
        ltvenda.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_2').asfloat);
        ltos.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_3').asfloat);
        ltfinal.caption := formatfloat('###,###,##0.00', (query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat) + query.fieldbyname('valor_1').asfloat - query.fieldbyname('valor').asfloat);
      end
      else
      begin
        pnormal.visible := false; //true;
        psuper.visible := false;
      end;
    end
    else
    begin
      pnormal.visible := false; //true;
      psuper.visible := false;
    end;

    frmmodulo.qrconfig.open;
    if frmmodulo.qrconfigINVENTARIO_AUTOMATICO.AsInteger = 1 then
    begin

      /// INVENTARIO INICIO

      vData_Inventario := strtodate('31/12/' + zerarcodigo(inttostr(strtoint(copy(datetostr(date), 7, 4)) - 1), 4));

      decodedate(vData_Inventario, ano, mes, dia);

      vInventario_ano := strtoint(zerarcodigo(inttostr(strtoint(copy(datetostr(date), 7, 4)) - 1), 4));

      frmmodulo.qrinventario.close;
      frmmodulo.qrinventario.SQL.clear;
      frmmodulo.qrinventario.SQL.add('select * from INVENTARIO where ano = :vinventario_ano');
      frmmodulo.qrinventario.Params.ParamByName('vInventario_ano').asinteger := vInventario_ano;
      frmmodulo.qrinventario.Open;
      if frmmodulo.qrinventario.RecordCount = 0 then
      begin
        if Application.messagebox(pchar('O Inventário de ' + inttostr(vInventario_ano) + ' Ainda Não foi Gerado.' + #13 +
          '        Deseja Criar o Inventário Agora?'), 'INVENTÁRIO', mb_yesno + mb_iconquestion) = idYes then
        begin
          qrproduto.close;
          qrproduto.sql.clear;
          qrproduto.sql.add('select prod.*, est.*');
          qrproduto.sql.add('from c000025 prod, c000100 est');
          qrproduto.sql.add('where prod.codigo = est.codproduto');
          qrproduto.sql.add('and situacao = 0');
          qrproduto.sql.add('order by prod.produto');
          qrproduto.open;
          qrproduto.first;
          if qrproduto.RecordCount > 0 then
          begin
            frmmensagem_inventario := tfrmmensagem_inventario.create(self);
            frmmensagem_inventario.bar.TotalParts := qrproduto.recordcount;
            frmmensagem_inventario.bar.PartsComplete := 0;
            while not qrproduto.eof do begin
              frmmensagem_inventario.rzpanel1.caption := '         ' + qrproduto.fieldbyname('codigo').asstring + ' ' + copy(qrproduto.fieldbyname('produto').asstring, 1, 30);
              frmmensagem_inventario.show;

              application.processmessages;
              qrinventario.Close;
              qrinventario.sql.clear;
              qrinventario.sql.add('insert into inventario');
              qrinventario.sql.add('(data,data_posterior,ano,mes,tipo,codproduto,produto,unidade,cst,aliquota,estoque,custo,venda,total)');
              qrinventario.sql.add('values');
              qrinventario.sql.add('(:datax,:data_posteriorx,:anox,:mesx,:tipox,:codprodutox,:produtox,:unidadex,:cstx,:aliquotax,:estoquex,:custox,:vendax,:totalx)');
              qrinventario.params.ParamByName('datax').asdatetime := vData_Inventario;
              qrinventario.params.ParamByName('data_posteriorx').asdatetime := vData_Inventario + 1;
              qrinventario.params.ParamByName('anox').asinteger := vInventario_ano;
              qrinventario.params.ParamByName('mesx').asinteger := trunc(mes);
              qrinventario.params.ParamByName('tipox').asstring := qrproduto.fieldbyname('tipo').asstring;
              qrinventario.params.ParamByName('codprodutox').asstring := qrproduto.fieldbyname('codigo').asstring;
              qrinventario.params.ParamByName('produtox').asstring := qrproduto.fieldbyname('produto').asstring;
              qrinventario.params.ParamByName('unidadex').asstring := qrproduto.fieldbyname('unidade').asstring;
              qrinventario.params.ParamByName('cstx').asstring := qrproduto.fieldbyname('cst').asstring;
              qrinventario.params.ParamByName('aliquotax').asfloat := qrproduto.fieldbyname('aliquota').asfloat;
              qrinventario.params.ParamByName('custox').asfloat := qrproduto.fieldbyname('precocusto').asfloat;
              qrinventario.params.ParamByName('estoquex').asfloat := qrproduto.fieldbyname('estoque_atual').asfloat;
              qrinventario.params.ParamByName('vendax').asfloat := qrproduto.fieldbyname('precovenda').asfloat;
              qrinventario.params.ParamByName('totalx').asfloat := qrproduto.fieldbyname('precocusto').asfloat *
                qrproduto.fieldbyname('estoque_atual').asfloat;
              qrinventario.execsql;

              frmmensagem_inventario.bar.PartsComplete := frmmensagem_inventario.bar.PartsComplete + 1;
              application.ProcessMessages;
              qrproduto.next;
            end;
            frmmodulo.Conexao.Commit;
            frmmensagem_inventario.destroy;

            Application.messagebox('Inventário Gerado Com sucesso!', 'Inventário!', mb_ok + MB_ICONQUESTION);
          end;
        end;
      end;

        /////////////////////////// FINAL INVENTARIO
    end;

    caption := caption + '    Terminal: ' + registro_terminal;
  end
end;

procedure TfrmPrincipal.FormCreate(Sender: TObject);
var txt: textfile;
  entrada: string;
  Hand: THandle;
begin
  prtct1.executar;
  //Mizael este comeco esta num bloco de notas para testes
  try
  (*  VERIFICAR SE O COMPUTADOR EH UMA ATUALIZACAO*)
    if not DirectoryExists('c:\iCloud\server\atualizacao') then
      if application.messagebox('Caminho do arquivo para Atualização não encontrado, Deseja Cria-lo?', 'Aviso', mb_yesno + MB_ICONWARNING) = idyes then
      begin
        ForceDirectories('c:\iCloud\server\atualizacao');
        Application.messagebox('Caminho Criado com Sucesso!', 'Aviso!', mb_ok + MB_ICONQUESTION);
      end;

    assignfile(txt, '\iCloud\server\ini\com.ini');
    reset(txt);
    while not eof(txt) do

    begin
      readln(txt, entrada);
      if copy(entrada, 1, 7) = '999-002' then conexao_sistema := trim(copy(entrada, 9, 50));
    end;

    CloseFile(txt);

    NovaVersao := False;

    if (conexao_sistema <> '') and
      (ansiuppercase(conexao_sistema) <> 'LOCALHOST') and
      (ansiuppercase(conexao_sistema) <> ansiuppercase(NomeComputador)) and
      (conexao_sistema <> GetIP) then
    begin
      frmcopia_arquivo := tfrmcopia_arquivo.create(self);
      frmcopia_arquivo.show;
    end;

    ExeAtualiza := ExtractFilePath(ParamStr(0)) + 'atualizacao\iCloud.exe';
    ExeAtual := ExtractFilePath(ParamStr(0)) + 'iCloud.exe';

    if (conexao_sistema <> '') and
      (ansiuppercase(conexao_sistema) <> 'LOCALHOST') and
      (ansiuppercase(conexao_sistema) <> ansiuppercase(NomeComputador)) and
      (conexao_sistema <> GetIP) then
      frmcopia_arquivo.Destroy;

    if FileExists(ExeAtualiza) then
    begin
      if VersaoExe(ExeAtual) < VersaoExe(ExeAtualiza) then
      begin
        if Application.messagebox(pchar('Foi Encontrada uma nova versão do Sistema iCLoud.' + #13 +
          'Deseja Atualizar Agora?                  '), 'ATUALIZAÇÃO', mb_yesno + mb_iconquestion) = idYes then
        begin
          NovaVersao := True;
              //Apago se existir versão antiga
          DeleteFile(ExeAtual + '.OLD');
              //Renomeio o arquivo atual
          RenameFile(ExeAtual, ExeAtual + '.OLD');
              //Renomeio o arquivo novo para poder usa-lo
              //RenameFile(ExeAtualiza,ExeAtualiza ARQUIVO.EXE');
              //Informo que a aplicação foi atualizado com sucesso
              //copia da pasta atualizacao para a pasta iCloud
          CopyFile(PChar(ExeAtualiza), pchar('c:\iCloud\server\iCloud.exe'), False);
          ShowMessage('Aplicação atualizada com sucesso!');
              //Mando abrir a nova versão do teclado
          Hand := FindWindow('TApplication', 'iCloud');
          if Hand = 0 then
            frmprincipal.ExecutePrograma('\iCloud\server\iCloud.exe', '');
              //Fecho a aberta
              //Close;
          Application.Terminate;
        end
        else
          NovaVersao := false;
      end;
    end;

  except

  end;

end;

procedure TfrmPrincipal.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin

  if application.messagebox('Confirma o encerramento do Sistema?', 'Aviso', mb_yesno + MB_ICONWARNING) = idyes then
  begin
    frmmodulo.Conexao.Connected := false;
    Application.Terminate;
    action := cafree;
  end
  else
    abort;

end;

procedure TfrmPrincipal.VrDemoButton49Click(Sender: TObject);
begin
  frmcalendario := tfrmcalendario.create(self);
  frmcalendario.showmodal;
  TAdvGlowButton(sender).setfocus;
end;


procedure TfrmPrincipal.SpeedButton1Click(Sender: TObject);
begin
  if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
  begin
    if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
    begin
      frmVENDA_INICIO := tfrmVENDA_INICIO.create(self);
      frmVENDA_INICIO.showmodal;
    end
    else
    begin
      APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
    end;
  end
  else
  begin
    APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
  end;
end;

procedure TfrmPrincipal.LinkView3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '05.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmbackup := tfrmbackup.create(self);
  frmbackup.showmodal;
end;

procedure TfrmPrincipal.LinkView1Click(Sender: TObject);
begin
  frmcalc := tfrmcalc.create(self);
  frmcalc.show;
end;

procedure TfrmPrincipal.Filiais1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmfilial := tfrmfilial.create(self);
  frmfilial.showmodal;
end;

procedure TfrmPrincipal.VrDemoButton2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMPRODUTO_FALTA := TFRMPRODUTO_FALTA.CREATE(SELF);
  FRMPRODUTO_FALTA.SHOWMODAL;
  TAdvGlowButton(sender).setfocus;
end;

procedure TfrmPrincipal.VrDemoButton3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONVENIO_receber := TFRMCONVENIO_receber.CREATE(SELF);
  FRMCONVENIO_receber.SHOWMODAL;
  TAdvGlowButton(sender).setfocus;
end;

procedure TfrmPrincipal.VrDemoButton4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMECF_REDUCAO_menu := TFRMECF_REDUCAO_menu.CREATE(SELF);
  FRMECF_REDUCAO_menu.SHOWMODAL;
  TAdvGlowButton(sender).setfocus;
end;

procedure TfrmPrincipal.VrDemoButton5Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
  begin
    if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
    begin
      frmprevenda := tfrmprevenda.create(self);
      frmprevenda.lcodcaixa.caption := frmmodulo.qrcaixa_operador.fieldByname('codigo').asstring;
      frmprevenda.lcaixa.caption := frmmodulo.qrcaixa_operador.fieldByname('nome').asstring;
      frmprevenda.showmodal;
      TAdvGlowButton(sender).setfocus;

    end
    else
    begin
      APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
    end;
  end
  else
  begin
    APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
  end;



end;

function TfrmPrincipal.ChecaEstado(Dado: string): boolean;
const
  Estados = 'SPMGRJRSSCPRESDFMTMSGOTOBASEALPBPEMARNCEPIPAAMAPFNACRRROEX';
var
  Posicao: integer;
begin
  Result := true;
  if Dado <> '' then
  begin
    Posicao := Pos(UpperCase(Dado), Estados);
    if (Posicao = 0) or ((Posicao mod 2) = 0) then
    begin
      Result := false;
    end;
  end;
end;


procedure TfrmPrincipal.GravaReducaoZ;
var TXT: TEXTFILE;
  TEXTO, cnpj_cpf, ie_rg: string;
  i: integer;

begin
  //if application.messagebox('Deseja Gravar a REDUÇÃO Z?','Atenção - Redução Z',mb_yesno+MB_ICONWARNING+MB_DEFBUTTON2) = idyes then
  //begin

  //****************************************************************
  // Inicio da criação do registro 60M - REDUÇÃO Z
  //****************************************************************

  frmprogresso := tfrmprogresso.create(self);
  frmprogresso.barra.Position := 0;
  frmprogresso.show;
  Application.ProcessMessages;

      (***************** CRIAR ARQUIVO TIPO 60 M *****************)
  cnpj_cpf := emitente_cnpj;
  i := pos('.', cnpj_cpf);
  while i > 0 do
  begin
    delete(cnpj_cpf, i, 1);
    i := pos('.', cnpj_cpf);
  end;
  i := pos('/', cnpj_cpf);
  while i > 0 do
  begin
    delete(cnpj_cpf, i, 1);
    i := pos('/', cnpj_cpf);
  end;
  i := pos('-', cnpj_cpf);
  while i > 0 do
  begin
    delete(cnpj_cpf, i, 1);
    i := pos('-', cnpj_cpf);
  end;


  ie_rg := emitente_ie;
  i := pos('.', ie_rg);
  while i > 0 do
  begin
    delete(ie_rg, i, 1);
    i := pos('.', ie_rg);
  end;
  i := pos('-', ie_rg);
  while i > 0 do
  begin
    delete(ie_rg, i, 1);
    i := pos('-', ie_rg);
  end;

  //TRY

  frmmodulo.qrsintegra_r60.close;
  frmmodulo.qrsintegra_r60.sql.clear;
  frmmodulo.qrsintegra_r60.SQL.Add('select * from sintegra_reg60 where ID IS NOT NULL');
  frmmodulo.qrsintegra_r60.Open;

  frmmodulo.qrsintegra_r60.insert;
  frmmodulo.qrsintegra_r60.FieldByName('ID').asstring := '1';
  frmmodulo.qrsintegra_r60.FieldByName('movimento').asstring := '1';
  frmmodulo.qrsintegra_r60.FieldByName('CODIGO_EMPRESA').asinteger := 1;
  frmmodulo.qrsintegra_r60.FieldByName('cnpj').asstring := cnpj_cpf;
  frmmodulo.qrsintegra_r60.FieldByName('ie').asstring := ie_rg;
  frmmodulo.qrsintegra_r60.FieldByName('uf').asstring := emitente_uf;

  frmprogresso.ltexto.caption := 'Gerando REGISTRO 60 ANALÍTICO para o SINTEGRA...';
  frmprogresso.barra.Position := 5;
  Application.ProcessMessages;

  I := 1;

  ecf_registro_60A(ecf_modelo);

       {
       if ecf_modelo = 'DARUMA' then frmecf_daruma.ecf_registro_60A(ecf_modelo);
       if ecf_modelo = 'BEMATECH' then frmecf_BEMATECH.ecf_registro_60A(ecf_modelo);
       if ecf_modelo = 'SWEDA' then frmecf_SWEDA.ecf_registro_60A(ecf_modelo);
       if ecf_modelo = 'URANO' then frmecf_URANO.ecf_registro_60A(ecf_modelo);
       if ecf_modelo = 'YANCO' then frmecf_YANCO.ecf_registro_60A(ecf_modelo);
       }

  if FileExists('\retorno.txt') then
  begin
    ASSIGNFILE(TXT, '\retorno.txt');
    reset(txt);
    while not eof(txt) do
    begin

      readln(txt, texto);

      if (I > 9) and (copy(texto, CAMPO_INI, CAMPO_QTDE) <> 'ISS.......................:') then

      begin

        if copy(texto, 1, 4) = '0700' then
        begin
          frmmodulo.qrsintegra_r60.FieldByName('aliquota01').asfloat := strtofloat(copy(texto, 1, 4)) / 100;
          texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
          frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL01').asstring := formata_valor(texto);
          frmmodulo.qrsintegra_r60.FieldByName('BASE01').asstring := formata_valor(texto);
        end;
        if copy(texto, 1, 4) = '1200' then
        begin
          frmmodulo.qrsintegra_r60.FieldByName('aliquota02').asfloat := strtofloat(copy(texto, 1, 4)) / 100;
          texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
          frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL02').asstring := formata_valor(texto);
          frmmodulo.qrsintegra_r60.FieldByName('BASE02').asstring := formata_valor(texto);
        end;

        if copy(texto, 1, 4) = '1700' then
        begin
          frmmodulo.qrsintegra_r60.FieldByName('aliquota03').asfloat := strtofloat(copy(texto, 1, 4)) / 100;
          texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
          frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL03').asstring := formata_valor(texto);
          frmmodulo.qrsintegra_r60.FieldByName('BASE03').asstring := formata_valor(texto);
        end;
        if copy(texto, 1, 4) = '2500' then
        begin
          frmmodulo.qrsintegra_r60.FieldByName('aliquota04').asfloat := strtofloat(copy(texto, 1, 4)) / 100;
          texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
          frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL04').asstring := formata_valor(texto);
          frmmodulo.qrsintegra_r60.FieldByName('BASE04').asstring := formata_valor(texto);
        end;
        if copy(texto, 1, 4) = '2700' then
        begin
          frmmodulo.qrsintegra_r60.FieldByName('aliquota05').asfloat := strtofloat(copy(texto, 1, 4)) / 100;
          texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
          frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL05').asstring := formata_valor(texto);
          frmmodulo.qrsintegra_r60.FieldByName('BASE05').asstring := formata_valor(texto);
        end;

           {
              IF frmmodulo.qrsintegra_r60.FieldByName('aliquota01').asfloat = 0 then
              begin
                frmmodulo.qrsintegra_r60.FieldByName('aliquota01').asfloat := strtofloat(copy(texto,1,4))/100;
                texto := (TrimLeft(copy(texto,RESULTADO_INI,RESULTADO_QTDE)));
                frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL01').asstring :=  formata_valor(texto);
                frmmodulo.qrsintegra_r60.FieldByName('BASE01').asstring :=  formata_valor(texto);

              end
              else
              begin
                IF frmmodulo.qrsintegra_r60.FieldByName('aliquota02').asfloat = 0 then
                begin
                  frmmodulo.qrsintegra_r60.FieldByName('aliquota02').asfloat := strtofloat(copy(texto,1,4))/100;
                  texto := (TrimLeft(copy(texto,RESULTADO_INI,RESULTADO_QTDE)));
                  frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL02').asstring :=  formata_valor(texto);
                  frmmodulo.qrsintegra_r60.FieldByName('BASE02').asstring :=  formata_valor(texto);

                end
                else
                begin
                  IF frmmodulo.qrsintegra_r60.FieldByName('aliquota03').asfloat = 0 then
                  begin
                    frmmodulo.qrsintegra_r60.FieldByName('aliquota03').asfloat := strtofloat(copy(texto,1,4))/100;
                    texto := (TrimLeft(copy(texto,RESULTADO_INI,RESULTADO_QTDE)));
                    frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL03').asstring :=  formata_valor(texto);
                    frmmodulo.qrsintegra_r60.FieldByName('BASE03').asstring :=  formata_valor(texto);
                  end
                  else
                  begin
                    IF frmmodulo.qrsintegra_r60.FieldByName('aliquota04').asfloat = 0 then
                    begin
                      frmmodulo.qrsintegra_r60.FieldByName('aliquota04').asfloat := strtofloat(copy(texto,1,4))/100;
                      texto := (TrimLeft(copy(texto,RESULTADO_INI,RESULTADO_QTDE)));
                      frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL04').asstring :=  formata_valor(texto);
                      frmmodulo.qrsintegra_r60.FieldByName('BASE04').asstring :=  formata_valor(texto);
                    end
                    else
                    begin
                      frmmodulo.qrsintegra_r60.FieldByName('aliquota05').asfloat := strtofloat(copy(texto,1,4))/100;
                      texto := (TrimLeft(copy(texto,RESULTADO_INI,RESULTADO_QTDE)));
                      frmmodulo.qrsintegra_r60.FieldByName('VALOR_TPARCIAL05').asstring :=  formata_valor(texto);
                      frmmodulo.qrsintegra_r60.FieldByName('BASE05').asstring :=  formata_valor(texto);

                    end;
                  end;
                end;
              end;

              }

      end;




      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Data de emissão...........:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
             //showmessage(texto);
        Insert(copy(datetostr(date), 7, 2), texto, 7);
        frmmodulo.qrsintegra_r60.FieldByName('DATA_EMISSAO').asstring := texto;
      end;


      frmmodulo.qrconfig.open;
      if frmmodulo.qrconfig.fieldbyname('ECF_SERIAL').asstring <> '' then
      begin
        frmmodulo.qrsintegra_r60.FieldByName('NRO_SERIE_EQP').asstring := frmmodulo.qrconfig.fieldbyname('ECF_SERIAL').asstring;
      end
      else
      begin
        if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Número de série...........:' then
        begin
          texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
          frmmodulo.qrsintegra_r60.FieldByName('NRO_SERIE_EQP').asstring := texto;
        end;
      end;

      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Cancelamentos.............:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('CANCELAMENTO').asstring := formata_valor(texto);
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Descontos.................:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('DESCONTO').asstring := formata_valor(texto);
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'ISS.......................:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('ISSQN').asstring := formata_valor(texto);
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'F.........................:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('SUBSTITUICAO_TRIBUTARIA').asstring := formata_valor(texto);
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'I.........................:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('ISENTO').asstring := formata_valor(texto);
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'N.........................:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('NAO_INCIDENCIA').asstring := formata_valor(texto);
      end;

      frmmodulo.qrsintegra_r60.FieldByName('NRO_CONTADOR_CANCELAMENTO').asinteger := 0;

      I := I + 1;
      frmprogresso.barra.Position := frmprogresso.barra.Position + 5;
      Application.ProcessMessages;
    end;
    closefile(txt);
    deletefile('\retorno.txt');
  end;

  Application.ProcessMessages;
  if FileExists('\retorno.txt') then DELETEFILE('\RETORNO.TXT');
  frmprogresso.ltexto.caption := 'Gerando REGISTRO 60 MESTRE para o SINTEGRA...';
  Application.ProcessMessages;

  ecf_registro_60M(ecf_modelo);

       {
       if ecf_modelo = 'DARUMA' then frmecf_daruma.ecf_registro_60M(ecf_modelo);
       if ecf_modelo = 'BEMATECH' then frmecf_BEMATECH.ecf_registro_60M(ecf_modelo);
       if ecf_modelo = 'SWEDA' then frmecf_SWEDA.ecf_registro_60M(ecf_modelo);
       if ecf_modelo = 'URANO' then frmecf_URANO.ecf_registro_60M(ecf_modelo);
       if ecf_modelo = 'YANCO' then frmecf_YANCO.ecf_registro_60M(ecf_modelo);
       }

  if FileExists('\retorno.txt') then
  begin
    ASSIGNFILE(TXT, '\retorno.txt');
    reset(txt);
    while not eof(txt) do
    begin
      readln(txt, texto);
      frmmodulo.qrconfig.open;
      if frmmodulo.qrconfig.fieldbyname('ECF_CAIXA').asstring <> '' then
      begin
        frmmodulo.qrsintegra_r60.FieldByName('NRO_ORDEM_EQP').asstring := frmmodulo.qrconfig.fieldbyname('ECF_CAIXA').asstring;
      end
      else
      begin
        if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Número do equipamento.....:' then
        begin
          texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
          frmmodulo.qrsintegra_r60.FieldByName('NRO_ORDEM_EQP').asstring := texto;
        end;
      end;

      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Modelo do documento fiscal:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('MODELO_DOC').asstring := texto;
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'COO inicial...............:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('NRO_CONTADOR_INICIO').asstring := texto;
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'COO final.................:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('NRO_CONTADOR_FIM').asstring := texto;
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Contador de reduções......:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('NRO_CONTADOR_Z').asstring := texto;
      end;
      if (copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Reinicio de Operação......:') or (copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Reinicio de Operacao......:') then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('CONTADOR_REINICIO').asstring := texto;
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Venda Bruta...............:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('VALOR_VENDA_BRUTA').asstring := formata_valor(texto);
      end;
      if copy(texto, CAMPO_INI, CAMPO_QTDE) = 'Totalizador geral.........:' then
      begin
        texto := (TrimLeft(copy(texto, RESULTADO_INI, RESULTADO_QTDE)));
        frmmodulo.qrsintegra_r60.FieldByName('VALOR_TOTAL_GERAL').asstring := formata_valor(texto);
      end;
      frmprogresso.barra.Position := frmprogresso.barra.Position + 5;
      Application.ProcessMessages;
    end;
    closefile(txt);
    deletefile('\retorno.txt');
  end;
  frmprogresso.barra.Position := 100;
  Application.ProcessMessages;

  frmmodulo.qrsintegra_r60.FieldByName('valor_venda_liquida').AsFloat :=
    frmmodulo.qrsintegra_r60.FieldByName('valor_venda_bruta').AsFloat -
    frmmodulo.qrsintegra_r60.FieldByName('cancelamento').AsFloat -
    frmmodulo.qrsintegra_r60.FieldByName('desconto').AsFloat +
    frmmodulo.qrsintegra_r60.FieldByName('issqn').AsFloat;

  frmprogresso.Close;
  frmmodulo.qrsintegra_r60.post;
  frmmodulo.Conexao.Commit;

  //EXCEPT
  //  APPLICATION.MESSAGEBOX('Houve falha no processamento do Registro 60M e 60A para geração do sintegra! Favor verificar!','Atenção',mb_ok+mb_iconerror);
  //  frmmodulo.Conexao.rollback;

  //END;

  //****************************************************************
  // Final da criação do registro 60M - REDUÇÃO Z
  //****************************************************************

  //end;
end;


function TfrmPrincipal.formata_valor(valor: string): string;
var i: integer;
begin
  i := pos('.', valor);
  while i <> 0 do
  begin
    delete(valor, i, 1);
    i := pos('.', valor);
  end;
  result := valor;
end;

function TfrmPrincipal.DataDeCriacao(Arq: string): TDateTime;
var
  ffd: TWin32FindData;
  dft: DWORD;
  lft: TFileTime;
  h: THandle;
begin
  h := Windows.FindFirstFile(PChar(Arq), ffd);
  try
    if (INVALID_HANDLE_VALUE <> h) then begin
      //FileTimeToLocalFileTime(ffd.ftCreationTime, lft);  // criação do arquivo
      //FileTimeToLocalFileTime(ffd.ftLastAccessTime, lft );  // ultima acesso
      FileTimeToLocalFileTime(ffd.ftLastWriteTime, lft); // ultima alteração

      FileTimeToDosDateTime(lft, LongRec(dft).Hi, LongRec(dft).Lo);
      Result := FileDateToDateTime(dft);
    end;
  finally
    Windows.FindClose(h);
  end;
end;

procedure TfrmPrincipal.MenuItem1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmnotafiscal_menu := tfrmnotafiscal_menu.create(self);
  frmnotafiscal_menu.showmodal;
end;

procedure TfrmPrincipal.CSTCdigodaSituaoTributria1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  frmcst := tfrmcst.create(self);
  frmcst.showmodal;
end;

procedure TfrmPrincipal.ModelosdeDocumentosFiscais1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMmodelo_fiscal := TFRMmodelo_fiscal.CREATE(SELF);
  FRMmodelo_fiscal.SHOWMODAL;
end;

procedure TfrmPrincipal.ECFCadastrodeEquipamentos1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMECF := TFRMECF.CREATE(SELF);
  FRMECF.SHOWMODAL;
end;

procedure TfrmPrincipal.Setor2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.10') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmsetor := tfrmsetor.create(self);
  frmsetor.showmodal;
end;

procedure TfrmPrincipal.Veculos1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.11') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMVEICULO := TFRMVEICULO.CREATE(SELF);
  FRMVEICULO.SHOWMODAL;
end;


procedure TfrmPrincipal.Clientes1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente := tfrmcliente.create(self);
  frmcliente.Top := frmmodulo.top_forms;
  frmcliente.showmodal;
end;

procedure TfrmPrincipal.Produtos1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMMODULO.QRCONFIG.OPEN;
  if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'NORMAL' then
  begin
    frmproduto := tfrmproduto.create(self);
    frmproduto.showmodal;
  end
  else
  begin
    if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'LIGHT' then
    begin
      frmproduto_LIGTH := tfrmproduto_LIGTH.create(self);
      frmproduto_LIGTH.showmodal;
    end
    else
    begin
      if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'FARMA' then
      begin
        frmproduto_FARMA := tfrmproduto_FARMA.create(self);
        frmproduto_FARMA.showmodal;
      end
      else
      begin
        if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'PECAS' then
        begin
          frmproduto_AUTO := tfrmproduto_AUTO.create(self);
          frmproduto_AUTO.showmodal;
        end;
      end;
    end;
  end;
end;

procedure TfrmPrincipal.ConsultadePreos1Click(Sender: TObject);
begin

  if frmprincipal.acesso(codigo_usuario, '02.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMMODULO.QRCONFIG.OPEN;
  if (FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'NORMAL') or (FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'FARMA') then
  begin
    frmproduto_consultapreco := tfrmproduto_consultapreco.create(self);
    frmproduto_consultapreco.showmodal;
  end
  else
  begin
    if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'LIGHT' then
    begin
      frmproduto_consultapreco := tfrmproduto_consultapreco.create(self);
      frmproduto_consultapreco.showmodal;
    end
    else
    begin
      if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'PECAS' then
      begin
        frmloc_produto_AUTO := tfrmloc_produto_AUTO.create(self);
        frmloc_produto_AUTO.showmodal;
      end
    end;
  end;
end;

procedure TfrmPrincipal.ContasaPagar1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONTASPAGAR := TFRMCONTASPAGAR.CREATE(SELF);
  FRMCONTASPAGAR.SHOWMODAL;
end;

procedure TfrmPrincipal.ContasaReceber1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmcontasreceber := tfrmcontasreceber.create(self);
  frmcontasreceber.showmodal;


end;

procedure TfrmPrincipal.Oramento1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmorcamento := tfrmorcamento.create(self);
  frmorcamento.showmodal;
end;

procedure TfrmPrincipal.Caixa1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;



  if frmPrincipal.autentica_caixa('Acesso ao Caixa', 0) then
  begin
    frmcaixa := tfrmcaixa.create(self);
    frmcaixa.showmodal;
  end
  else
  begin
    APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
  end;
end;

procedure TfrmPrincipal.OrdemdeServio1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmos_menu := tfrmos_menu.create(self);
  frmos_menu.showmodal;
end;

procedure TfrmPrincipal.NotaFiscal1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  //frmnotafiscal := tfrmnotafiscal.create(self);
  //frmnotafiscal.showmodal;

  frmnotafiscal_menu := tfrmnotafiscal_menu.create(self);
  frmnotafiscal_menu.showmodal;
end;

procedure TfrmPrincipal.SairdoSistema1Click(Sender: TObject);
begin
  close;
end;

procedure TfrmPrincipal.AnularSaida1Click(Sender: TObject);
begin
//
end;


procedure TfrmPrincipal.rocardeUsurio1Click(Sender: TObject);
begin
  with FRMPRINCIPAL do
  begin

    if autentica('Trocar de Usuário', 1) then
    begin
      nivel_usuario := frmmodulo.qrusuario.fieldbyname('nivel').asinteger;
      codigo_usuario := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
//      frmprincipal.pstatus.Panels[2].text := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
  //    frmprincipal.pstatus.Panels[3].text := frmmodulo.qrusuario.fieldbyname('usuario').asstring;
      if nivel_usuario = 4 then
      begin
        pnormal.visible := false; //false;
        psuper.visible := false; //true;

        qrcx.close;
        qrcx.sql.clear;
        qrcx.sql.add('select * from c000045 where codigo = ''000099''');
        qrcx.open;
        if qrcx.RecordCount > 0 then
        begin
          lcaixa.Caption := qrcx.fieldbyname('data').asstring;
          if qrcx.fieldbyname('situacao').asinteger = 1 then
            lsit_caixa.caption := 'ABERTO' else
            lsit_caixa.caption := 'FECHADO';
        end
        else
        begin
          Lcaixa.caption := '---';
          lsit_caixa.Caption := '---'
        end;

        qrniver.close;
        qrniver.sql.clear;
        qrniver.sql.add('select codigo, nome, nascimento, telefone1, telefone2, celular from c000007 where situacao < 3 and  nascimento like ''' + copy(datetostr(date), 1, 5) + '/%'' order by nome');
        qrniver.open;

        qrpagar.close;
        qrpagar.sql.clear;
        qrpagar.sql.add('select pg.*, forn.nome from c000046 pg, c000009 forn');
        qrpagar.sql.add('where pg.codfornecedor = forn.codigo and situacao = 1 and');
        qrpagar.sql.add('data_vencimento = :datax order by data_vencimento ');
        qrpagar.params.ParamByName('datax').asdatetime := date;
        qrpagar.open;

        query.close;
        query.sql.clear;
        query.sql.add('select sum(entrada) total_entrada, sum(saida) total_saida,');
        query.sql.add('(select sum(valor)       valor   from c000046 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(valor_atual) valor_1 from c000049 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(total)       valor_2 from c000048 where data = :datax),');
        query.sql.add('(select sum(total)       valor_3 from c000051 where conclusao_data = :datax and situacao = ''FECHADA'')');
        query.sql.add('from c000044 where data = :datax');
        query.params.ParamByName('datax').asdatetime := qrcx.fieldbyname('data').asdatetime;
        query.params.ParamByName('datav').asdatetime := date;
        query.open;

        ltcaixa.caption := formatfloat('###,###,##0.00', query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat);
        ltpagar.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor').asfloat);
        ltreceber.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_1').asfloat);
        ltvenda.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_2').asfloat);
        ltos.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_3').asfloat);
        ltfinal.caption := formatfloat('###,###,##0.00', (query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat) + query.fieldbyname('valor_1').asfloat - query.fieldbyname('valor').asfloat);

      end
      else
      begin
        pnormal.visible := false; //true;
        psuper.visible := false;
      end;
    end;
  end;
end;

procedure TfrmPrincipal.GerencimentodeUsurios1Click(Sender: TObject);
begin
  if frmprincipal.autentica('Config. Usuários', nivel_exclusao) then
  begin
    frmusuario := tfrmusuario.create(self);
    frmusuario.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;

end;

procedure TfrmPrincipal.Baixa1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmbaixa_estoque := tfrmbaixa_estoque.create(self);
  frmbaixa_estoque.showmodal;
end;

procedure TfrmPrincipal.Pedido1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.06') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmproduto_pedido := tfrmproduto_pedido.create(self);
  frmproduto_pedido.showmodal;


end;

procedure TfrmPrincipal.Entrada1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmbaixa_estoque := tfrmbaixa_estoque.create(self);
  frmbaixa_estoque.showmodal;
end;

procedure TfrmPrincipal.ConsultaServio1Click(Sender: TObject);
begin
  frmxloc_servico := tfrmxloc_servico.create(self);
  frmxloc_servico.showmodal;
end;

procedure TfrmPrincipal.Ad55vGlowButton1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmproduto_consultaserial := tfrmproduto_consultaserial.create(self);
  frmproduto_consultaserial.showmodal;
end;

procedure TfrmPrincipal.MemorandodeExportao1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmmemorando_menu := Tfrmmemorando_menu.CREATE(SELF);
  frmmemorando_menu.SHOWMODAL;
end;

procedure TfrmPrincipal.bformaClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMFORMAPGTO := TFRMFORMAPGTO.CREATE(SELF);
  FRMFORMAPGTO.SHOWMODAL;
  TAdvGlowButton(sender).setfocus;
end;

procedure TfrmPrincipal.Venda1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

{
    if frmPrincipal.autentica_caixa('Pedido de Venda',0) then
    begin
      if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
      begin
        frmvenda_inicio := tfrmvenda_inicio.create(self);
        frmvenda_inicio.showmodal;
      END
      ELSE
      BEGIN
        APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...','Atenção',mb_ok+MB_ICONWARNING);
      END;
    end
    else
    begin
      APPLICATION.MESSAGEBOX('Não autorizado!','Aviso',mb_ok+MB_ICONERROR);
    end;
 }


  FRMMODULO.qrconfig.OPEN;
  if frmmodulo.qrconfig.FieldByName('ramo_atividade').asinteger = 4 then
  begin
    if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
    begin
      if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
      begin
        FRMVENDA_FARMA := TFRMVENDA_FARMA.CREATE(SELF);
        FRMVENDA_FARMA.SHOWMODAL;
      end
      else
      begin
        APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
      end;
    end
    else
    begin
      APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
    end;
  end
  else
  begin
    if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
    begin
      if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
      begin
        frmvenda_inicio := tfrmvenda_inicio.create(self);
        frmvenda_inicio.showmodal;
        TAdvGlowButton(sender).setfocus;
      end
      else
      begin
        APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
      end;
    end
    else
    begin
      APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
    end;
  end;


end;

procedure TfrmPrincipal.AdvGlowButton2Click(Sender: TObject);
begin
  frmlista_servicos_periodicos := Tfrmlista_servicos_periodicos.CREATE(SELF);
  frmlista_servicos_periodicos.ShowModal;
  TAdvGlowButton(sender).setfocus;
end;

procedure TfrmPrincipal.FormasdePagamento1Click(Sender: TObject);
begin
 { if frmprincipal.acesso(codigo_usuario, '01.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMFORMAPGTO := TFRMFORMAPGTO.CREATE(SELF);
  FRMFORMAPGTO.SHOWMODAL;}

end;

procedure TfrmPrincipal.CondiesdePagamento1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMCONDPGTO := TFRMCONDPGTO.CREATE(SELF);
  FRMCONDPGTO.SHOWMODAL;
end;

procedure TfrmPrincipal.batualClick(Sender: TObject);
begin
  qrcx.close;
  qrcx.sql.clear;
  qrcx.sql.add('select * from c000045 where codigo = ''000099''');
  qrcx.open;
  if qrcx.RecordCount > 0 then
  begin
    lcaixa.Caption := qrcx.fieldbyname('data').asstring;
    if qrcx.fieldbyname('situacao').asinteger = 1 then
      lsit_caixa.caption := 'ABERTO' else
      lsit_caixa.caption := 'FECHADO';
  end
  else
  begin
    Lcaixa.caption := '---';
    lsit_caixa.Caption := '---'
  end;

  qrniver.close;
  qrniver.sql.clear;
  qrniver.sql.add('select codigo, nome, nascimento, telefone1, telefone2, celular from c000007 where situacao < 3 and  nascimento like ''' + copy(datetostr(date), 1, 5) + '/%'' order by nome');
  qrniver.open;

  qrpagar.close;
  qrpagar.sql.clear;
  qrpagar.sql.add('select pg.*, forn.nome from c000046 pg, c000009 forn');
  qrpagar.sql.add('where pg.codfornecedor = forn.codigo and situacao = 1 and');
  qrpagar.sql.add('data_vencimento = :datax order by data_vencimento ');
  qrpagar.params.ParamByName('datax').asdatetime := date;
  qrpagar.open;

  query.close;
  query.sql.clear;
  query.sql.add('select sum(entrada) total_entrada, sum(saida) total_saida,');
  query.sql.add('(select sum(valor)       valor   from c000046 where situacao = 1 and data_vencimento = :datav), ');
  query.sql.add('(select sum(valor_atual) valor_1 from c000049 where situacao = 1 and data_vencimento = :datav), ');
  query.sql.add('(select sum(total)       valor_2 from c000048 where data = :datax),');
  query.sql.add('(select sum(total)       valor_3 from c000051 where conclusao_data = :datax and situacao = ''FECHADA'')');
  query.sql.add('from c000044 where data = :datax');
  query.params.ParamByName('datax').asdatetime := qrcx.fieldbyname('data').asdatetime;
  query.params.ParamByName('datav').asdatetime := date;
  query.open;

  ltcaixa.caption := formatfloat('###,###,##0.00', query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat);
  ltpagar.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor').asfloat);
  ltreceber.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_1').asfloat);
  ltvenda.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_2').asfloat);
  ltos.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_3').asfloat);
  ltfinal.caption := formatfloat('###,###,##0.00', (query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat) + query.fieldbyname('valor_1').asfloat - query.fieldbyname('valor').asfloat);


end;

procedure TfrmPrincipal.Timer1Timer(Sender: TObject);
begin
//  if ( TimeToStr(time) < '05:00:00' ) or ( TimeToStr(time) > '24:00:00' ) then Application.Terminate;


  if (TimeToStr(time) >= '23:50:00') and (TimeToStr(time) <= '24:00:00') then
  begin
    Timer1.Enabled := False;
    if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
    begin
      application.messagebox(pchar('Já são ' + TimeToStr(time) + ' e o Caixa do dia ' +
        DateToStr(frmmodulo.qrcaixa_operador.FieldByName('data').asdatetime) + #13 +
        'Ainda não foi fechado! Verifique!'), 'Atenção', mb_ok + MB_ICONWARNING);
    end;
    Timer1.Enabled := True;
  end;


  if batual.down then
  begin
    qrpagar.close;
    qrpagar.sql.clear;
    qrpagar.sql.add('select pg.*, forn.nome from c000046 pg, c000009 forn');
    qrpagar.sql.add('where pg.codfornecedor = forn.codigo and situacao = 1 and');
    qrpagar.sql.add('data_vencimento = :datax order by data_vencimento ');
    qrpagar.params.ParamByName('datax').asdatetime := date;
    qrpagar.open;

    query.close;
    query.sql.clear;
    query.sql.add('select sum(entrada) total_entrada, sum(saida) total_saida,');
    query.sql.add('(select sum(valor)       valor from c000046 where situacao = 1 and data_vencimento = :datav), ');
    query.sql.add('(select sum(valor_atual) valor_1 from c000049 where situacao = 1 and data_vencimento = :datav), ');
    query.sql.add('(select sum(total)       valor_2 from c000048 where data = :datax),');
    query.sql.add('(select sum(total)       valor_3 from c000051 where conclusao_data = :datax and situacao = ''FECHADA'')');
    query.sql.add('from c000044 where data = :datax');
    query.params.ParamByName('datax').asdatetime := qrcx.fieldbyname('data').asdatetime;
    query.params.ParamByName('datav').asdatetime := date;
    query.open;

    ltcaixa.caption := formatfloat('###,###,##0.00', query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat);
    ltpagar.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor').asfloat);
    ltreceber.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_1').asfloat);
    ltvenda.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_2').asfloat);
    ltos.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_3').asfloat);
    ltfinal.caption := formatfloat('###,###,##0.00', (query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat) + query.fieldbyname('valor_1').asfloat - query.fieldbyname('valor').asfloat);
  end;
end;

function TfrmPrincipal.RemoveAcentos(Str: string): string;
const ComAcento = 'àâêôûãõáéíóúçüÀÂÊÔÛÃÕÁÉÍÓÚÇÜ';
  SemAcento = 'aaeouaoaeioucuAAEOUAOAEIOUCU';
var
  x: Integer;
begin
  for x := 1 to Length(Str) do
  begin
    if Pos(Str[x], ComAcento) <> 0 then
    begin
      Str[x] := SemAcento[Pos(Str[x], ComAcento)];
    end;
  end;
  Result := Str;
end;


procedure TfrmPrincipal.AdvGlowButton3Click(Sender: TObject);
begin
  if frmprincipal.autentica('Exportação', 3) then
  begin
    FRMPRODUTO_PDV2 := TFRMPRODUTO_PDV2.CREATE(SELF);
    FRMPRODUTO_PDV2.SHOWMODAL;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;

procedure TfrmPrincipal.AdvGlowButton3KeyPress(Sender: TObject;
  var Key: Char);
begin
 // if KEY = #27 then BMOVIMENTO.SETFOCUS;
end;

procedure TfrmPrincipal.AdvGlowButton4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmentrega := tfrmentrega.create(self);
  frmentrega.showmodal;
end;

procedure TfrmPrincipal.ArquivoLOG1Click(Sender: TObject);
begin
  if frmprincipal.autentica('Log de Usuários', nivel_exclusao) then
  begin
    frmusuario_log := tfrmusuario_log.create(self);
    frmusuario_log.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;



procedure TfrmPrincipal.Cidades1Click(Sender: TObject);
begin
  frmcidade := tfrmcidade.create(self);
  frmcidade.showmodal;
end;

procedure TfrmPrincipal.AdvGlowButton6Click(Sender: TObject);
begin
  frmTef := tfrmtef.create(self);
  frmTef.showmodal;
end;

procedure TfrmPrincipal.AdvGlowButton7Click(Sender: TObject);
begin
  frmproduto_pedido := tfrmproduto_pedido.create(self);
  frmproduto_pedido.showmodal;
end;

procedure TfrmPrincipal.AdvGlowButton10Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmcartao := tfrmcartao.create(self);
  frmcartao.showmodal;

  TAdvGlowButton(sender).setfocus;
end;

function tfrmprincipal.nao_arredonda(valor: real): real;
var txt_desconto: string;
  i: integer;
begin
  txt_desconto := formatfloat('#############0.00000000000', valor);
  i := pos(',', txt_desconto);
  if i > 0 then
  begin
    txt_desconto :=
      copy(txt_desconto, 1, i - 1) + ',' +
      copy(txt_desconto, i + 1, 2);

    result := strtofloat(txt_desconto);

  end
  else
    result := valor;


end;

function tfrmprincipal.FormataCEP(const CEP: string): string;
var
  I: integer;
begin
  Result := '';
  for I := 1 to Length(CEP) do
    if CEP[I] in ['0'..'9'] then
      Result := Result + CEP[I];

  //if Length(Result) <> 8 then
  //raise Exception.Create('CEP inválido.')
  //else
  if Copy(Result, 1, 5) = '' then
    Result := ''
  else
    Result := Copy(Result, 1, 5) + '-' + Copy(Result, 6, 3);
end;

procedure TfrmPrincipal.CNAE1Click(Sender: TObject);
begin
  frmcnae := tfrmcnae.create(self);
  frmcnae.showmodal;
end;

procedure TfrmPrincipal.amanho1Click(Sender: TObject);
begin
  frmtamanho := tfrmtamanho.create(self);
  frmtamanho.showmodal;
end;

procedure TfrmPrincipal.Cores1Click(Sender: TObject);
begin
  frmcor := tfrmcor.create(self);
  frmcor.showmodal;
end;

procedure TfrmPrincipal.AdvGlowButton8Click(Sender: TObject);
begin
  frmlista_abc_marca_grupo := Tfrmlista_abc_marca_grupo.CREATE(SELF);
  frmlista_abc_marca_grupo.ShowModal;
  TAdvGlowButton(sender).setfocus;
end;

procedure TfrmPrincipal.AdvGlowButton9Click(Sender: TObject);
begin
  frmlista_frete := tfrmlista_frete.create(self);
  frmlista_frete.showmodal;
end;

procedure TfrmPrincipal.AdvGlowButton11Click(Sender: TObject);
begin
  frmfluxo_caixa := tfrmfluxo_caixa.create(self);
  frmfluxo_caixa.showmodal;
end;

procedure TfrmPrincipal.DREClick(Sender: TObject);
begin
  FRMDRE := TFRMDRE.CREATE(SELF);
  FRMDRE.SHOWMODAL;
end;

function TfrmPrincipal.Arredondar(Value: Extended; Decimals: integer): Extended;
var
  Factor, Fraction: Extended;
begin
  Factor := IntPower(10, Decimals);
  { A conversão para string e depois para float evita
    erros de arredondamentos indesejáveis. }
  Value := StrToFloat(FloatToStr(Value * Factor));
  Result := Int(Value);
  Fraction := Frac(Value);
  if Fraction >= 0.5 then
    Result := Result + 1
  else if Fraction <= -0.5 then
    Result := Result - 1;
  Result := Result / Factor;
end;

procedure TfrmPrincipal.Label12Click(Sender: TObject);
begin
//  alerta_copia.CloseDelay := 1;
  //if efetua_Backup = false then
//  begin
//    if application.MessageBox('Erro ao efetuar backup! Deseja prosseguir a usar o Sistema iCloud?', 'Aviso', mb_yesno + mb_iconwarning) = idno then exit;
//  end;
end;

procedure TfrmPrincipal.NCMNomenclaturaMercosul1Click(Sender: TObject);
begin
  frmNcm := tfrmNcm.create(self);
  frmNcm.showmodal;
end;

procedure TfrmPrincipal.CSOSNCdigodaOperaodeSituaodoSimplesNacional1Click(
  Sender: TObject);
begin
  frmxloc_csosn := tfrmxloc_csosn.create(self);
  frmxloc_csosn.showmodal;
end;


procedure TfrmPrincipal.Image1Click(Sender: TObject);
var
  XY: TPoint;
begin
  XY := Point(0, 0);
  XY := Image1.ClientToScreen(XY);
  popmenuarq.Popup(XY.X, XY.Y + Image1.Height + 15);

end;


procedure TfrmPrincipal.Image8Click(Sender: TObject);
begin
  if application.messagebox('Confirma o encerramento do Sistema?', 'Aviso', mb_yesno + MB_ICONWARNING) = idyes then
  begin
    frmprincipal.FechePrograma('eBackup');
    frmprincipal.FechePrograma('s7servidor');
    frmmodulo.Conexao.Connected := false;
    Application.Terminate;
  end
end;

procedure TfrmPrincipal.imgClientesClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente := tfrmcliente.create(self);
  frmcliente.showmodal;
end;

procedure TfrmPrincipal.Image9Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmEMPRESA := tfrmEMPRESA.create(self);
  frmEMPRESA.showmodal;

end;

procedure TfrmPrincipal.Clientes3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente := tfrmcliente.create(self);
  frmcliente.showmodal;
end;

procedure TfrmPrincipal.imgFornecedoresClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMFORNECEDOR := TFRMFORNECEDOR.CREATE(SELF);
  FRMFORNECEDOR.SHOWMODAL;
end;

procedure TfrmPrincipal.imgtransportadoresClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmtransportador := tfrmtransportador.create(self);
  frmtransportador.showmodal;
end;

procedure TfrmPrincipal.imgFuncionariosClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMFUNCIONARIO := TFRMFUNCIONARIO.CREATE(SELF);
  FRMFUNCIONARIO.SHOWMODAL;
end;

procedure TfrmPrincipal.imgBancosClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.06') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmbanco := tfrmbanco.create(self);
  frmbanco.showmodal;
end;

procedure TfrmPrincipal.vbosContasClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMPLANO := TFRMPLANO.CREATE(SELF);
  FRMPLANO.SHOWMODAL;
end;

procedure TfrmPrincipal.imgOperadoresCaixaClick(Sender: TObject);
begin
  if autentica('Operador de Caixa', 4) then
  begin
    FRMCAIXA_OPERADOR := TFRMCAIXA_OPERADOR.CREATE(SELF);
    FRMCAIXA_OPERADOR.SHOWMODAL;
  end;
end;

procedure TfrmPrincipal.imgConveniosClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.14') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMCONVENIO := TFRMCONVENIO.CREATE(SELF);
  FRMCONVENIO.SHOWMODAL;
end;

procedure TfrmPrincipal.imgServicosClick(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.13') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmservico := tfrmservico.create(self);
  frmservico.showmodal;
end;

procedure TfrmPrincipal.EmpresasFiliais1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  if frmEMPRESA = nil then
  begin
    frmEMPRESA := tfrmEMPRESA.create(self);
    frmEMPRESA.showmodal;
  end;
end;

procedure TfrmPrincipal.Clientes2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente := tfrmcliente.create(self);
  frmcliente.showmodal;
end;

procedure TfrmPrincipal.Fornecedores1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMFORNECEDOR := TFRMFORNECEDOR.CREATE(SELF);
  FRMFORNECEDOR.SHOWMODAL;
end;

procedure TfrmPrincipal.ransportadores1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmtransportador := tfrmtransportador.create(self);
  frmtransportador.showmodal;
end;

procedure TfrmPrincipal.bancosFinanceiras1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.06') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmbanco := tfrmbanco.create(self);
  frmbanco.showmodal;
end;

procedure TfrmPrincipal.rocardeUsurio2Click(Sender: TObject);
begin
  with FRMPRINCIPAL do
  begin

    if autentica('Trocar de Usuário', 1) then
    begin
      nivel_usuario := frmmodulo.qrusuario.fieldbyname('nivel').asinteger;
      codigo_usuario := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
//      frmprincipal.pstatus.Panels[2].text := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
  //    frmprincipal.pstatus.Panels[3].text := frmmodulo.qrusuario.fieldbyname('usuario').asstring;
      if nivel_usuario = 4 then
      begin
        pnormal.visible := false;
        psuper.visible := false; //true;

        qrcx.close;
        qrcx.sql.clear;
        qrcx.sql.add('select * from c000045 where codigo = ''000099''');
        qrcx.open;
        if qrcx.RecordCount > 0 then
        begin
          lcaixa.Caption := qrcx.fieldbyname('data').asstring;
          if qrcx.fieldbyname('situacao').asinteger = 1 then
            lsit_caixa.caption := 'ABERTO' else
            lsit_caixa.caption := 'FECHADO';
        end
        else
        begin
          Lcaixa.caption := '---';
          lsit_caixa.Caption := '---'
        end;

        qrniver.close;
        qrniver.sql.clear;
        qrniver.sql.add('select codigo, nome, nascimento, telefone1, telefone2, celular from c000007 where situacao < 3 and  nascimento like ''' + copy(datetostr(date), 1, 5) + '/%'' order by nome');
        qrniver.open;

        qrpagar.close;
        qrpagar.sql.clear;
        qrpagar.sql.add('select pg.*, forn.nome from c000046 pg, c000009 forn');
        qrpagar.sql.add('where pg.codfornecedor = forn.codigo and situacao = 1 and');
        qrpagar.sql.add('data_vencimento = :datax order by data_vencimento ');
        qrpagar.params.ParamByName('datax').asdatetime := date;
        qrpagar.open;

        query.close;
        query.sql.clear;
        query.sql.add('select sum(entrada) total_entrada, sum(saida) total_saida,');
        query.sql.add('(select sum(valor)       valor   from c000046 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(valor_atual) valor_1 from c000049 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(total)       valor_2 from c000048 where data = :datax),');
        query.sql.add('(select sum(total)       valor_3 from c000051 where conclusao_data = :datax and situacao = ''FECHADA'')');
        query.sql.add('from c000044 where data = :datax');
        query.params.ParamByName('datax').asdatetime := qrcx.fieldbyname('data').asdatetime;
        query.params.ParamByName('datav').asdatetime := date;
        query.open;

        ltcaixa.caption := formatfloat('###,###,##0.00', query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat);
        ltpagar.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor').asfloat);
        ltreceber.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_1').asfloat);
        ltvenda.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_2').asfloat);
        ltos.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_3').asfloat);
        ltfinal.caption := formatfloat('###,###,##0.00', (query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat) + query.fieldbyname('valor_1').asfloat - query.fieldbyname('valor').asfloat);

      end
      else
      begin
        pnormal.visible := false; //true;
        psuper.visible := false;
      end;
    end;
  end;
end;

procedure TfrmPrincipal.GerenciamentodeUsurio1Click(Sender: TObject);
begin
  if frmprincipal.autentica('Config. Usuários', nivel_exclusao) then
  begin
    frmusuario := tfrmusuario.create(self);
    frmusuario.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;

procedure TfrmPrincipal.ArquivodeLOG1Click(Sender: TObject);
begin
  if frmprincipal.autentica('Log de Usuários', nivel_exclusao) then
  begin
    frmusuario_log := tfrmusuario_log.create(self);
    frmusuario_log.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;

procedure TfrmPrincipal.OperadoresdeCaixa1Click(Sender: TObject);
begin
  if autentica('Operador de Caixa', 4) then
  begin
    FRMCAIXA_OPERADOR := TFRMCAIXA_OPERADOR.CREATE(SELF);
    FRMCAIXA_OPERADOR.SHOWMODAL;
  end;
end;

procedure TfrmPrincipal.Setor1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.10') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmsetor := tfrmsetor.create(self);
  frmsetor.showmodal;
end;

procedure TfrmPrincipal.Veculos2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.11') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMVEICULO := TFRMVEICULO.CREATE(SELF);
  FRMVEICULO.SHOWMODAL;
end;

procedure TfrmPrincipal.VeculosdeTerceiros1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.12') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMCLIENTE_VEICULO := TFRMCLIENTE_VEICULO.CREATE(SELF);
  FRMCLIENTE_VEICULO.SHOWMODAL;
end;

procedure TfrmPrincipal.CondiesdePagamento2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  //mizael bug
  FRMCONDPGTO := TFRMCONDPGTO.CREATE(SELF);
  FRMCONDPGTO.SHOWMODAL;
end;

procedure TfrmPrincipal.Cidades2Click(Sender: TObject);
begin
  frmcidade := tfrmcidade.create(self);
  frmcidade.showmodal;
end;

procedure TfrmPrincipal.CNAE2Click(Sender: TObject);
begin
  frmcnae := tfrmcnae.create(self);
  frmcnae.showmodal;
end;

procedure TfrmPrincipal.Cores2Click(Sender: TObject);
begin
  frmcor := tfrmcor.create(self);
  frmcor.showmodal;
end;

procedure TfrmPrincipal.amanho2Click(Sender: TObject);
begin
  frmtamanho := tfrmtamanho.create(self);
  frmtamanho.showmodal;
end;

procedure TfrmPrincipal.CFOPNaturezadeOperao1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  FRMCFOP := TFRMCFOP.CREATE(SELF);
  FRMCFOP.SHOWMODAL;
end;

procedure TfrmPrincipal.CSTCdigodaSituaoTributria2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  frmcst := tfrmcst.create(self);
  frmcst.showmodal;
end;

procedure TfrmPrincipal.ModelosdeDocumentosFiscais2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMmodelo_fiscal := TFRMmodelo_fiscal.CREATE(SELF);
  FRMmodelo_fiscal.SHOWMODAL;
end;

procedure TfrmPrincipal.ECFCadastrodeEquipamentos2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMECF := TFRMECF.CREATE(SELF);
  FRMECF.SHOWMODAL;
end;

procedure TfrmPrincipal.NCMNomeclaturaComumaoMercosul1Click(
  Sender: TObject);
begin
  frmNcm := tfrmNcm.create(self);
  frmNcm.showmodal;
end;

procedure TfrmPrincipal.CSOSNCdigodeSituaodaOperaonoSimplesNacional1Click(
  Sender: TObject);
begin
  frmxloc_csosn := tfrmxloc_csosn.create(self);
  frmxloc_csosn.showmodal;
end;

procedure TfrmPrincipal.Servios1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.13') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmservico := tfrmservico.create(self);
  frmservico.showmodal;
end;

procedure TfrmPrincipal.Convnios1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.14') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONVENIO := TFRMCONVENIO.CREATE(SELF);
  FRMCONVENIO.SHOWMODAL;
end;

procedure TfrmPrincipal.planodeContas1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMPLANO := TFRMPLANO.CREATE(SELF);
  FRMPLANO.SHOWMODAL;
end;

procedure TfrmPrincipal.Produtos2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;



  FRMMODULO.QRCONFIG.OPEN;
  if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'NORMAL' then
  begin
    frmproduto := tfrmproduto.create(self);
    frmproduto.showmodal;
  end
  else
  begin
    if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'LIGHT' then
    begin
      frmproduto_LIGTH := tfrmproduto_LIGTH.create(self);
      frmproduto_LIGTH.showmodal;
    end
    else
    begin
      if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'FARMA' then
      begin
        frmproduto_FARMA := tfrmproduto_FARMA.create(self);
        frmproduto_FARMA.showmodal;
      end
      else
      begin
        if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'PECAS' then
        begin
          frmproduto_AUTO := tfrmproduto_AUTO.create(self);
          frmproduto_AUTO.showmodal;
        end;
      end;
    end;
  end;
end;

procedure TfrmPrincipal.GruposeSubgrupos1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmgrupo := tfrmgrupo.create(self);
  frmgrupo.showmodal;
end;

procedure TfrmPrincipal.Marcasfabricantes1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMMARCA := TFRMMARCA.CREATE(SELF);
  FRMMARCA.SHOWMODAL;
end;

procedure TfrmPrincipal.notaFiscaldeEntrada1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcompra_menu := tfrmcompra_menu.create(self);
  frmcompra_menu.showmodal;
end;

procedure TfrmPrincipal.ConsultadePreo1Click(Sender: TObject);
begin

  if frmprincipal.acesso(codigo_usuario, '02.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMMODULO.QRCONFIG.OPEN;
  if (FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'NORMAL') or (FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'FARMA') then
  begin
    frmproduto_consultapreco := tfrmproduto_consultapreco.create(self);
    frmproduto_consultapreco.showmodal;
  end
  else
  begin
    if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'LIGHT' then
    begin
      frmproduto_consultapreco := tfrmproduto_consultapreco.create(self);
      frmproduto_consultapreco.showmodal;
    end
    else
    begin
      if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'PECAS' then
      begin
        frmloc_produto_AUTO := tfrmloc_produto_AUTO.create(self);
        frmloc_produto_AUTO.showmodal;
      end
    end;
  end;
end;

procedure TfrmPrincipal.ConsultaSerial1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmproduto_consultaserial := tfrmproduto_consultaserial.create(self);
  frmproduto_consultaserial.showmodal;
end;

procedure TfrmPrincipal.ProdutosVendasFaltas1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMPRODUTO_FALTA := TFRMPRODUTO_FALTA.CREATE(SELF);
  FRMPRODUTO_FALTA.SHOWMODAL;
end;

procedure TfrmPrincipal.PedidodeCompra1Click(Sender: TObject);
begin
  frmproduto_pedido := tfrmproduto_pedido.create(self);
  frmproduto_pedido.showmodal;
end;

procedure TfrmPrincipal.BalanaExportao1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMBALANCA := TFRMBALANCA.CREATE(SELF);
  FRMBALANCA.SHOWMODAL;
end;

procedure TfrmPrincipal.img2Click(Sender: TObject);
var
  XY: TPoint;
begin
  XY := Point(0, 0);
  XY := Img2.ClientToScreen(XY);
  popestoque.Popup(XY.X, XY.Y + Image1.Height + 15);


end;

procedure TfrmPrincipal.Venda2Click(Sender: TObject);
var F: TEXTFILE;
  slinha: string;
begin
  if frmprincipal.acesso(codigo_usuario, '03.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  if USA_TEF then
  begin
    if FileExists(sTEFKoneKPath + 'gp.tmp') then
    begin
      begin
        assignfile(f, sTEFKoneKPath + 'gp.tmp');
        reset(f);
        readln(f, slinha);
        closefile(f);
      end;
    end;

    if slinha = 'TECBAN' then
    begin
      itefTecban := 1;
      sTEFPath := 'C:\TEF_DISC\'
    end
    else
    begin
      sTEFPath := 'C:\TEF_DIAL\';
      itefTecban := 0;
    end;

    TEFVerificaGerenciadorAtivo;
    TEFVerificaArquivosPendentes;
    TEFVerificaOperacaoPendente;
  end;

  FRMMODULO.qrconfig.OPEN;
  if frmmodulo.qrconfig.FieldByName('ramo_atividade').asinteger = 4 then
  begin
    if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
    begin
      if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
      begin
        FRMVENDA_FARMA := TFRMVENDA_FARMA.CREATE(SELF);
        FRMVENDA_FARMA.SHOWMODAL;
      end
      else
      begin
        APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
      end;
    end
    else
    begin
      APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
    end;
  end
  else
  begin
    if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
    begin
      if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
      begin
        frmvenda_inicio := tfrmvenda_inicio.create(self);
        frmvenda_inicio.showmodal;
      end
      else
      begin
        APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
      end;
    end
    else
    begin
      APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
    end;
  end;

end;

procedure TfrmPrincipal.AtendimentodePrVenda1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
  begin
    if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
    begin
      frmprevenda := tfrmprevenda.create(self);
      frmprevenda.lcodcaixa.caption := frmmodulo.qrcaixa_operador.fieldByname('codigo').asstring;
      frmprevenda.lcaixa.caption := frmmodulo.qrcaixa_operador.fieldByname('nome').asstring;
      frmprevenda.showmodal;

    end
    else
    begin
      APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
    end;
  end
  else
  begin
    APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
  end;

end;

procedure TfrmPrincipal.NotasdeVendas1Click(Sender: TObject);
var i: integer;
begin
  if frmprincipal.acesso(codigo_usuario, '03.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMNOTAS_VENDA := TFRMNOTAS_VENDA.CREATE(SELF);
  try {
    for i := 0 to frmnotas_venda.ComponentCount - 1 do
    begin
    if frmnotas_venda.Components[i] is tzquery then
       begin
       tzquery(frmnotas_venda.Components[i]).Connection := frmmodulo.Conexao;
       end;
    end;}
    frmnotas_venda.showmodal;
  finally
    frmnotas_venda.Release;
    frmnotas_venda := nil;
  end;

end;

procedure TfrmPrincipal.Oramento2Click(Sender: TObject);

begin
  if frmprincipal.acesso(codigo_usuario, '03.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  try
    frmorcamento := tfrmorcamento.create(self);
    frmorcamento.showmodal;
  finally
    freeandnil(frmorcamento);
  end;
end;

procedure TfrmPrincipal.ECFmovimentoDirio1Click(Sender: TObject);
begin
  exit;
  if frmprincipal.acesso(codigo_usuario, '03.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMECF_REDUCAO_menu := TFRMECF_REDUCAO_menu.CREATE(SELF);
  FRMECF_REDUCAO_menu.SHOWMODAL;
end;

procedure TfrmPrincipal.SINTEGRARegistroFiscal1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.06') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMSINTEGRA_gerar := TFRMSINTEGRA_gerar.CREATE(SELF);
  FRMSINTEGRA_gerar.SHOWMODAL;
end;

procedure TfrmPrincipal.EFDSpedFiscal1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmprincipal.ExecutePrograma('\iCloud\server\sped.exe', '');
end;

procedure TfrmPrincipal.ControledeEntrega1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmentrega := tfrmentrega.create(self);
  frmentrega.showmodal;
end;

procedure TfrmPrincipal.OrdemdesERVIO2Click(Sender: TObject);
begin
  if frmmodulo.oslibera <> '1' then
  begin
    application.messagebox('Módulo Não Liberado!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  if frmprincipal.acesso(codigo_usuario, '03.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  frmos_menu := tfrmos_menu.create(self);
  frmos_menu.showmodal;

end;

procedure TfrmPrincipal.Industrializao1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmindustrializacao := tfrmindustrializacao.create(self);
  frmindustrializacao.showmodal;
end;

procedure TfrmPrincipal.NotaFiscalEmisso1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmnotafiscal_menu := tfrmnotafiscal_menu.create(self);
  frmnotafiscal_menu.showmodal;
end;

procedure TfrmPrincipal.ConhecimentodeTransporte1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmconhecimento := tfrmconhecimento.create(self);
  frmconhecimento.showmodal;
end;

procedure TfrmPrincipal.MemorandodeExportao2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmmemorando_menu := Tfrmmemorando_menu.CREATE(SELF);
  frmmemorando_menu.SHOWMODAL;
end;

procedure TfrmPrincipal.Image2Click(Sender: TObject);
var
  XY: TPoint;
begin
  XY := Point(0, 0);
  XY := Image2.ClientToScreen(XY);
  popmovimento.Popup(XY.X, XY.Y + Image1.Height + 15);

end;

procedure TfrmPrincipal.Caixa2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  if frmPrincipal.autentica_caixa('Acesso ao Caixa', 0) then
  begin
    frmcaixa := tfrmcaixa.create(self);
    frmcaixa.showmodal;
  end
  else
  begin
    APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
  end;
end;

procedure TfrmPrincipal.ContasaPagar2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONTASPAGAR := TFRMCONTASPAGAR.CREATE(SELF);
  FRMCONTASPAGAR.SHOWMODAL;
end;

procedure TfrmPrincipal.ContasaReceber2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmcontasreceber := tfrmcontasreceber.create(self);
  frmcontasreceber.showmodal;
end;

procedure TfrmPrincipal.Financeira1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmFinanceira := tfrmFinanceira.create(self);
  frmFinanceira.showmodal;
end;

procedure TfrmPrincipal.Cheques1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FrmCHEQUE_MENU := tfrmCHEQUE_MENU.create(self);
  frmCHEQUE_MENU.showmodal;
end;

procedure TfrmPrincipal.ContaCorrente1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  frmcontacorrente := tfrmcontacorrente.create(self);
  frmcontacorrente.showmodal;
end;

procedure TfrmPrincipal.Clientes4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente_financeiro := tfrmcliente_financeiro.create(self);
  frmcliente_financeiro.showmodal;
end;

procedure TfrmPrincipal.BoletoBancrio1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.06') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMBOLETO := TFRMBOLETO.CREATE(SELF);
  FRMBOLETO.SHOWMODAL;
end;

procedure TfrmPrincipal.CartodeCrdito1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmcartao := tfrmcartao.create(self);
  frmcartao.showmodal;
end;

procedure TfrmPrincipal.Convnio1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONVENIO_receber := TFRMCONVENIO_receber.CREATE(SELF);
  FRMCONVENIO_receber.SHOWMODAL;
end;

procedure TfrmPrincipal.Image3Click(Sender: TObject);
var
  XY: TPoint;
begin
  XY := Point(0, 0);
  XY := Image3.ClientToScreen(XY);
  popfinanceiro.Popup(XY.X, XY.Y + Image1.Height + 15);

end;

procedure TfrmPrincipal.Image5Click(Sender: TObject);
var
  XY: TPoint;
begin
  XY := Point(0, 0);
  XY := Image5.ClientToScreen(XY);
  poprelatorios.Popup(XY.X, XY.Y + Image1.Height + 15);

end;

procedure TfrmPrincipal.Clientes5Click(Sender: TObject);
begin
  FRMLISTA_CLIENTE2 := TFRMLISTA_CLIENTE2.CREATE(SELF);
  FRMLISTA_CLIENTE2.SHOWMODAL;
end;

procedure TfrmPrincipal.Fornecedores3Click(Sender: TObject);
begin
  FRMLISTA_FORNECEDOR2 := TFRMLISTA_FORNECEDOR2.CREATE(SELF);
  FRMLISTA_FORNECEDOR2.SHOWMODAL;
end;

procedure TfrmPrincipal.Produtos3Click(Sender: TObject);
begin
  FRMLISTA_PRODUTO2 := TFRMLISTA_PRODUTO2.CREATE(SELF);
  FRMLISTA_PRODUTO2.SHOWMODAL;
end;

procedure TfrmPrincipal.Vendas1Click(Sender: TObject);
begin
  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end
  else
  begin
  //41 : result := '06.02 - RELATÓRIO CONTAS A PAG';
 // 43 : result := '06.04 - RELATÓRIO DE CAIXA';
    if frmprincipal.acesso(codigo_usuario, '06.01') = 'NAO' then
    begin
      application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
      exit;
    end;

  end;

  FRMLISTA_VENDA2 := TFRMLISTA_VENDA2.CREATE(SELF);
  FRMLISTA_VENDA2.SHOWMODAL;
end;

procedure TfrmPrincipal.ContasaReceber3Click(Sender: TObject);
begin
  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end
  else
  begin
  //41 : result := '06.02 - RELATÓRIO CONTAS A PAG';
 // 43 : result := '06.04 - RELATÓRIO DE CAIXA';
    if frmprincipal.acesso(codigo_usuario, '06.03') = 'NAO' then
    begin
      application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
      exit;
    end;

  end;

  FRMLISTA_RECEBER2 := TFRMLISTA_RECEBER2.CREATE(SELF);
  FRMLISTA_RECEBER2.SHOWMODAL;
end;

procedure TfrmPrincipal.ContasaPagar3Click(Sender: TObject);
begin
  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end
  else
  begin
  //41 : result := '06.02 - RELATÓRIO CONTAS A PAG';
 // 43 : result := '06.04 - RELATÓRIO DE CAIXA';
    if frmprincipal.acesso(codigo_usuario, '06.02') = 'NAO' then
    begin
      application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
      exit;
    end;

  end;

  FRMLISTA_PAGAR2 := TFRMLISTA_PAGAR2.CREATE(SELF);
  FRMLISTA_PAGAR2.SHOWMODAL;
end;

procedure TfrmPrincipal.Caixa3Click(Sender: TObject);
begin
  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end
  else
  begin
    //41 : result := '06.02 - RELATÓRIO CONTAS A PAG';
    // 43 : result := '06.04 - RELATÓRIO DE CAIXA';
    if frmprincipal.acesso(codigo_usuario, '06.04') = 'NAO' then
    begin
      application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
      exit;
    end;

  end;

  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end;

  FRMLISTA_CAIXA2 := TFRMLISTA_CAIXA2.CREATE(SELF);
  FRMLISTA_CAIXA2.SHOWMODAL;
end;

procedure TfrmPrincipal.EtiquetasdeProdutos1Click(Sender: TObject);
begin
  frmetiquetador := tfrmetiquetador.create(self);
  frmetiquetador.showmodal;
end;

procedure TfrmPrincipal.OrdemdeServio3Click(Sender: TObject);
begin
  FRMLISTA_OS := TFRMLISTA_OS.CREATE(SELF);
  FRMLISTA_OS.SHOWMODAL;
end;

procedure TfrmPrincipal.ServiosPeridicos1Click(Sender: TObject);
begin
  frmlista_servicos_periodicos := Tfrmlista_servicos_periodicos.CREATE(SELF);
  frmlista_servicos_periodicos.ShowModal;
end;

procedure TfrmPrincipal.PercentualVendasGrupoMarca1Click(Sender: TObject);
begin
  frmlista_abc_marca_grupo := Tfrmlista_abc_marca_grupo.CREATE(SELF);
  frmlista_abc_marca_grupo.ShowModal;
end;

procedure TfrmPrincipal.Fretes1Click(Sender: TObject);
begin
  frmlista_frete := tfrmlista_frete.create(self);
  frmlista_frete.showmodal;
end;

procedure TfrmPrincipal.FluxodeCaixa1Click(Sender: TObject);
begin
  frmfluxo_caixa := tfrmfluxo_caixa.create(self);
  frmfluxo_caixa.showmodal;
end;

procedure TfrmPrincipal.DRE1Click(Sender: TObject);
begin
  FRMDRE := TFRMDRE.CREATE(SELF);
  FRMDRE.SHOWMODAL;
end;

procedure TfrmPrincipal.CpiadeSegurna1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '05.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmbackup := tfrmbackup.create(self);
  frmbackup.showmodal;
end;

procedure TfrmPrincipal.RestaurarCpiadeSegurana1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '05.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmrestore := tfrmrestore.create(self);
  frmrestore.showmodal;

end;

procedure TfrmPrincipal.AgendaTelefnica1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '05.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmagenda := tfrmagenda.create(self);
  frmagenda.showmodal;
end;

procedure TfrmPrincipal.Calculadora1Click(Sender: TObject);
begin
  frmcalc := tfrmcalc.create(self);
  frmcalc.showmodal;
end;

procedure TfrmPrincipal.Calendrio1Click(Sender: TObject);
begin
  frmcalendario := tfrmcalendario.create(self);
  frmcalendario.showmodal;
end;

procedure TfrmPrincipal.Configuraes1Click(Sender: TObject);
begin
  if frmprincipal.autentica('Configurações', 4) then
  begin
    frmconfig := tfrmconfig.create(self);
    frmconfig.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;

procedure TfrmPrincipal.ExportaodeDados1Click(Sender: TObject);
begin
  if frmprincipal.autentica('Configurações', 4) then
  begin
    frmexporta := tfrmexporta.create(self);
    frmexporta.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;

procedure TfrmPrincipal.ControledeRotas1Click(Sender: TObject);
begin
 { mapas_rotas := Tmapas_rotas.create(self);
  mapas_rotas.showmodal;}
end;

procedure TfrmPrincipal.Image7Click(Sender: TObject);
var
  XY: TPoint;
begin
  XY := Point(0, 0);
  XY := Image7.ClientToScreen(XY);
  poputilitarios.Popup(XY.X, XY.Y + Image1.Height + 15);

end;

procedure TfrmPrincipal.Funcionrios1Click(Sender: TObject);
begin
  frmfuncionario := Tfrmfuncionario.create(self);
  frmfuncionario.ShowModal;
end;

procedure TfrmPrincipal.ConsultaLote1Click(Sender: TObject);
begin
  frmConsultaLote := TfrmConsultaLote.create(self);
  frmConsultaLote.ShowModal;
end;

procedure TfrmPrincipal.ConsultaLote2Click(Sender: TObject);
begin
  frmConsultaLote := TfrmConsultaLote.create(self);
  frmConsultaLote.ShowModal;
end;

procedure TfrmPrincipal.AtualizarSistema1Click(Sender: TObject);
var Hand: THandle;
begin
  application.messagebox(pchar('Prezado Cliente.O Atualizador será inciado,' + #13 +
    'Após a sua execução, se for feito o download de uma nova versão,' + #13 +
    'você deve reiniciar o sistema, para que a atualização tenha efeito!!'), 'Atenção - Leia [**Muito importante**]', mb_ok + MB_ICONEXCLAMATION);


  Hand := FindWindow('TApplication', 'Atualizador');
  if Hand = 0 then
    frmprincipal.ExecutePrograma('\iCloud\server\Atualizacao\iCloud_Atualizador.exe', '');


end;

procedure TfrmPrincipal.ImportarNfe1Click(Sender: TObject);
begin
  frmimporta_nfe := tfrmimporta_nfe.create(self);
  frmimporta_nfe.showmodal;
end;
 //novo menu SIGE


procedure TfrmPrincipal.bveiculocClick(Sender: TObject);
begin
  frmcliente_veiculo := tfrmcliente_veiculo.create(self);
  frmcliente_veiculo.showmodal;
end;

procedure TfrmPrincipal.Sair1Click(Sender: TObject);
begin
  close;
end;

procedure TfrmPrincipal.tlPhotosClick(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '01.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente := tfrmcliente.create(self);
  frmcliente.showmodal;
end;

procedure TfrmPrincipal.tlUserManagementClick(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '01.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMFORNECEDOR := TFRMFORNECEDOR.CREATE(SELF);
  FRMFORNECEDOR.SHOWMODAL;

end;

procedure TfrmPrincipal.Empresa2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  if frmEMPRESA = nil then
  begin
    frmEMPRESA := tfrmEMPRESA.create(self);
    frmEMPRESA.showmodal;
  end;
end;

procedure TfrmPrincipal.Clientes9Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente := tfrmcliente.create(self);
  frmcliente.showmodal;
end;

procedure TfrmPrincipal.Fornecedores6Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMFORNECEDOR := TFRMFORNECEDOR.CREATE(SELF);
  FRMFORNECEDOR.SHOWMODAL;
end;

procedure TfrmPrincipal.ransportadoras2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmtransportador := tfrmtransportador.create(self);
  frmtransportador.showmodal;
end;

procedure TfrmPrincipal.Funcionrios3Click(Sender: TObject);
begin
  frmfuncionario := Tfrmfuncionario.create(self);
  frmfuncionario.ShowModal;
end;

procedure TfrmPrincipal.BancosFinanceira2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.06') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmbanco := tfrmbanco.create(self);
  frmbanco.showmodal;
end;

procedure TfrmPrincipal.PlanodeContas3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMPLANO := TFRMPLANO.CREATE(SELF);
  FRMPLANO.SHOWMODAL;
end;

procedure TfrmPrincipal.Convnios3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONVENIO_receber := TFRMCONVENIO_receber.CREATE(SELF);
  FRMCONVENIO_receber.SHOWMODAL;

end;

procedure TfrmPrincipal.Servios3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.13') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmservico := tfrmservico.create(self);
  frmservico.showmodal;

end;

procedure TfrmPrincipal.Setor4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.10') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmsetor := tfrmsetor.create(self);
  frmsetor.showmodal;

end;

procedure TfrmPrincipal.VeculosdeTerceiros3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.11') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMVEICULO := TFRMVEICULO.CREATE(SELF);
  FRMVEICULO.SHOWMODAL;
end;

procedure TfrmPrincipal.CondiesdePagamento4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '01.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMCONDPGTO := TFRMCONDPGTO.CREATE(SELF);
  FRMCONDPGTO.SHOWMODAL;
end;

procedure TfrmPrincipal.Cidades4Click(Sender: TObject);
begin
  frmcidade := tfrmcidade.create(self);
  frmcidade.showmodal;
end;

procedure TfrmPrincipal.CNAE4Click(Sender: TObject);
begin
  frmcnae := tfrmcnae.create(self);
  frmcnae.showmodal;
end;

procedure TfrmPrincipal.Cores4Click(Sender: TObject);
begin
  frmcor := tfrmcor.create(self);
  frmcor.showmodal;
end;

procedure TfrmPrincipal.amanhos2Click(Sender: TObject);
begin
  frmtamanho := tfrmtamanho.create(self);
  frmtamanho.showmodal;
end;

procedure TfrmPrincipal.CFOPNaturezadeOperao3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  FRMCFOP := TFRMCFOP.CREATE(SELF);
  FRMCFOP.SHOWMODAL;
end;

procedure TfrmPrincipal.CSTCdigodaSituaoTributria4Click(Sender: TObject);
begin

  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  frmcst := tfrmcst.create(self);
  frmcst.showmodal;

end;

procedure TfrmPrincipal.ModelosdeDocumentosFiscais4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMmodelo_fiscal := TFRMmodelo_fiscal.CREATE(SELF);
  FRMmodelo_fiscal.SHOWMODAL;
end;

procedure TfrmPrincipal.ECFCadastrodeEquipamentos4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMECF := TFRMECF.CREATE(SELF);
  FRMECF.SHOWMODAL;
end;

procedure TfrmPrincipal.NCMNomeclaturaComumaoMercosul3Click(
  Sender: TObject);
begin
  frmNcm := tfrmNcm.create(self);
  frmNcm.showmodal;
end;

procedure TfrmPrincipal.CSOSNCdigodeSituaodaOperaonoSimplesNacional2Click(
  Sender: TObject);
begin
  frmxloc_csosn := tfrmxloc_csosn.create(self);
  frmxloc_csosn.showmodal;
end;

procedure TfrmPrincipal.Produtos6Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;



  FRMMODULO.QRCONFIG.OPEN;
  if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'NORMAL' then
  begin
    frmproduto := tfrmproduto.create(self);
    frmproduto.showmodal;
  end
  else
  begin
    if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'LIGHT' then
    begin
      frmproduto_LIGTH := tfrmproduto_LIGTH.create(self);
      frmproduto_LIGTH.showmodal;
    end
    else
    begin
      if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'FARMA' then
      begin
        frmproduto_FARMA := tfrmproduto_FARMA.create(self);
        frmproduto_FARMA.showmodal;
      end
      else
      begin
        if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'PECAS' then
        begin
          frmproduto_AUTO := tfrmproduto_AUTO.create(self);
          frmproduto_AUTO.showmodal;
        end;
      end;
    end;
  end;

end;

procedure TfrmPrincipal.GruposeSubgrupos3Click(Sender: TObject);
begin

  if frmprincipal.acesso(codigo_usuario, '02.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmgrupo := tfrmgrupo.create(self);
  frmgrupo.showmodal;
end;

procedure TfrmPrincipal.NotaFiscaldeEntrada3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcompra_menu := tfrmcompra_menu.create(self);
  frmcompra_menu.showmodal;
end;

procedure TfrmPrincipal.ConsultadePreo3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMMODULO.QRCONFIG.OPEN;
  if (FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'NORMAL') or (FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'FARMA') then
  begin
    frmproduto_consultapreco := tfrmproduto_consultapreco.create(self);
    frmproduto_consultapreco.showmodal;
  end
  else
  begin
    if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'LIGHT' then
    begin
      frmproduto_consultapreco := tfrmproduto_consultapreco.create(self);
      frmproduto_consultapreco.showmodal;
    end
    else
    begin
      if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'PECAS' then
      begin
        frmloc_produto_AUTO := tfrmloc_produto_AUTO.create(self);
        frmloc_produto_AUTO.showmodal;
      end
    end;
  end;
end;

procedure TfrmPrincipal.ConsultaSerial3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmproduto_consultaserial := tfrmproduto_consultaserial.create(self);
  frmproduto_consultaserial.showmodal;
end;

procedure TfrmPrincipal.ProdutosVendasFaltas3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMPRODUTO_FALTA := TFRMPRODUTO_FALTA.CREATE(SELF);
  FRMPRODUTO_FALTA.SHOWMODAL;
end;

procedure TfrmPrincipal.BaixadeEstoque2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmbaixa_estoque := tfrmbaixa_estoque.create(self);
  frmbaixa_estoque.showmodal;
end;

procedure TfrmPrincipal.PedidodeCompra3Click(Sender: TObject);
begin
  frmproduto_pedido := tfrmproduto_pedido.create(self);
  frmproduto_pedido.showmodal;
end;

procedure TfrmPrincipal.ControledeEntrega3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmentrega := tfrmentrega.create(self);
  frmentrega.showmodal;
end;

procedure TfrmPrincipal.Industrializao3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmindustrializacao := tfrmindustrializacao.create(self);
  frmindustrializacao.showmodal;
end;

procedure TfrmPrincipal.NotasdeVendas4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMNOTAS_VENDA := TFRMNOTAS_VENDA.CREATE(SELF);
  try {
    for i := 0 to frmnotas_venda.ComponentCount - 1 do
    begin
    if frmnotas_venda.Components[i] is tzquery then
       begin
       tzquery(frmnotas_venda.Components[i]).Connection := frmmodulo.Conexao;
       end;
    end;}
    frmnotas_venda.showmodal;
  finally
    frmnotas_venda.Release;
    frmnotas_venda := nil;
  end;
end;

procedure TfrmPrincipal.NotaFiscal4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  //frmnotafiscal := tfrmnotafiscal.create(self);
  //frmnotafiscal.showmodal;

  frmnotafiscal_menu := tfrmnotafiscal_menu.create(self);
  frmnotafiscal_menu.showmodal;
end;

procedure TfrmPrincipal.MemorandodeExportao4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmmemorando_menu := Tfrmmemorando_menu.CREATE(SELF);
  frmmemorando_menu.SHOWMODAL;
end;

procedure TfrmPrincipal.SintegraregistroFiscal3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.06') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMSINTEGRA_gerar := TFRMSINTEGRA_gerar.CREATE(SELF);
  FRMSINTEGRA_gerar.SHOWMODAL;
end;

procedure TfrmPrincipal.ECFSpedFiscal2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmprincipal.ExecutePrograma('\iCloud\server\sped.exe', '');
end;

procedure TfrmPrincipal.ECFMovimentoDirio3Click(Sender: TObject);
begin
  exit;
  if frmprincipal.acesso(codigo_usuario, '03.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMECF_REDUCAO_menu := TFRMECF_REDUCAO_menu.CREATE(SELF);
  FRMECF_REDUCAO_menu.SHOWMODAL;
end;

procedure TfrmPrincipal.Venda4Click(Sender: TObject);
var F: TEXTFILE;
  slinha: string;
begin
  if frmprincipal.acesso(codigo_usuario, '03.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  if USA_TEF then
  begin
    if FileExists(sTEFKoneKPath + 'gp.tmp') then
    begin
      begin
        assignfile(f, sTEFKoneKPath + 'gp.tmp');
        reset(f);
        readln(f, slinha);
        closefile(f);
      end;
    end;

    if slinha = 'TECBAN' then
    begin
      itefTecban := 1;
      sTEFPath := 'C:\TEF_DISC\'
    end
    else
    begin
      sTEFPath := 'C:\TEF_DIAL\';
      itefTecban := 0;
    end;

    TEFVerificaGerenciadorAtivo;
    TEFVerificaArquivosPendentes;
    TEFVerificaOperacaoPendente;
  end;

  FRMMODULO.qrconfig.OPEN;
  if frmmodulo.qrconfig.FieldByName('ramo_atividade').asinteger = 4 then
  begin
    if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
    begin
      if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
      begin
        FRMVENDA_FARMA := TFRMVENDA_FARMA.CREATE(SELF);
        FRMVENDA_FARMA.SHOWMODAL;
      end
      else
      begin
        APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
      end;
    end
    else
    begin
      APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
    end;
  end
  else
  begin
    if frmPrincipal.autentica_caixa('Pedido de Venda', 0) then
    begin
      if frmmodulo.qrcaixa_operador.FieldByName('situacao').asinteger = 1 then
      begin
        frmvenda_inicio := tfrmvenda_inicio.create(self);
        frmvenda_inicio.showmodal;
      end
      else
      begin
        APPLICATION.MESSAGEBOX('Este caixa está fechado! Favor verificar...', 'Atenção', mb_ok + MB_ICONWARNING);
      end;
    end
    else
    begin
      APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
    end;
  end;

end;

procedure TfrmPrincipal.Oramento4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmorcamento := tfrmorcamento.create(self);
  frmorcamento.showmodal;

end;

procedure TfrmPrincipal.OrdemdeServio4Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '03.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmos_menu := tfrmos_menu.create(self);
  frmos_menu.showmodal;
end;

procedure TfrmPrincipal.rocardeUsurio4Click(Sender: TObject);
begin
  with FRMPRINCIPAL do
  begin

    if autentica('Trocar de Usuário', 1) then
    begin
      nivel_usuario := frmmodulo.qrusuario.fieldbyname('nivel').asinteger;
      codigo_usuario := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
//      frmprincipal.pstatus.Panels[2].text := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
  //    frmprincipal.pstatus.Panels[3].text := frmmodulo.qrusuario.fieldbyname('usuario').asstring;
      if nivel_usuario = 4 then
      begin
        pnormal.visible := false;
        psuper.visible := false; //true;

        qrcx.close;
        qrcx.sql.clear;
        qrcx.sql.add('select * from c000045 where codigo = ''000099''');
        qrcx.open;
        if qrcx.RecordCount > 0 then
        begin
          lcaixa.Caption := qrcx.fieldbyname('data').asstring;
          if qrcx.fieldbyname('situacao').asinteger = 1 then
            lsit_caixa.caption := 'ABERTO' else
            lsit_caixa.caption := 'FECHADO';
        end
        else
        begin
          Lcaixa.caption := '---';
          lsit_caixa.Caption := '---'
        end;

        qrniver.close;
        qrniver.sql.clear;
        qrniver.sql.add('select codigo, nome, nascimento, telefone1, telefone2, celular from c000007 where situacao < 3 and  nascimento like ''' + copy(datetostr(date), 1, 5) + '/%'' order by nome');
        qrniver.open;

        qrpagar.close;
        qrpagar.sql.clear;
        qrpagar.sql.add('select pg.*, forn.nome from c000046 pg, c000009 forn');
        qrpagar.sql.add('where pg.codfornecedor = forn.codigo and situacao = 1 and');
        qrpagar.sql.add('data_vencimento = :datax order by data_vencimento ');
        qrpagar.params.ParamByName('datax').asdatetime := date;
        qrpagar.open;

        query.close;
        query.sql.clear;
        query.sql.add('select sum(entrada) total_entrada, sum(saida) total_saida,');
        query.sql.add('(select sum(valor)       valor   from c000046 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(valor_atual) valor_1 from c000049 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(total)       valor_2 from c000048 where data = :datax),');
        query.sql.add('(select sum(total)       valor_3 from c000051 where conclusao_data = :datax and situacao = ''FECHADA'')');
        query.sql.add('from c000044 where data = :datax');
        query.params.ParamByName('datax').asdatetime := qrcx.fieldbyname('data').asdatetime;
        query.params.ParamByName('datav').asdatetime := date;
        query.open;

        ltcaixa.caption := formatfloat('###,###,##0.00', query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat);
        ltpagar.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor').asfloat);
        ltreceber.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_1').asfloat);
        ltvenda.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_2').asfloat);
        ltos.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_3').asfloat);
        ltfinal.caption := formatfloat('###,###,##0.00', (query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat) + query.fieldbyname('valor_1').asfloat - query.fieldbyname('valor').asfloat);

      end
      else
      begin
        pnormal.visible := false; //true;
        psuper.visible := false;
      end;
    end;
  end;
end;

procedure TfrmPrincipal.GerenciamentodeUsurio3Click(Sender: TObject);
begin
  if frmprincipal.autentica('Config. Usuários', nivel_exclusao) then
  begin
    frmusuario := tfrmusuario.create(self);
    frmusuario.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;

end;

procedure TfrmPrincipal.OperadoresdeCaixa3Click(Sender: TObject);
begin
  if autentica('Operador de Caixa', 4) then
  begin
    FRMCAIXA_OPERADOR := TFRMCAIXA_OPERADOR.CREATE(SELF);
    FRMCAIXA_OPERADOR.SHOWMODAL;
  end;

end;

procedure TfrmPrincipal.ArquivodeLog3Click(Sender: TObject);
begin

  if frmprincipal.autentica('Log de Usuários', nivel_exclusao) then
  begin
    frmusuario_log := tfrmusuario_log.create(self);
    frmusuario_log.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;

end;

procedure TfrmPrincipal.DRE3Click(Sender: TObject);
begin
  FRMDRE := TFRMDRE.CREATE(SELF);
  FRMDRE.SHOWMODAL;
end;

procedure TfrmPrincipal.Fretes3Click(Sender: TObject);
begin
  frmlista_frete := tfrmlista_frete.create(self);
  frmlista_frete.showmodal;
end;

procedure TfrmPrincipal.ServiosPeridicos3Click(Sender: TObject);
begin

  frmlista_servicos_periodicos := Tfrmlista_servicos_periodicos.CREATE(SELF);
  frmlista_servicos_periodicos.ShowModal;
end;

procedure TfrmPrincipal.OrdensdeServio2Click(Sender: TObject);
begin
  FRMLISTA_OS := TFRMLISTA_OS.CREATE(SELF);
  FRMLISTA_OS.SHOWMODAL;

end;

procedure TfrmPrincipal.FluxodeCaixa3Click(Sender: TObject);
begin
  frmfluxo_caixa := tfrmfluxo_caixa.create(self);
  frmfluxo_caixa.showmodal;
end;

procedure TfrmPrincipal.Caixa7Click(Sender: TObject);
begin
  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end
  else
  begin
    //41 : result := '06.02 - RELATÓRIO CONTAS A PAG';
    // 43 : result := '06.04 - RELATÓRIO DE CAIXA';
    if frmprincipal.acesso(codigo_usuario, '06.04') = 'NAO' then
    begin
      application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
      exit;
    end;

  end;

  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end;

  FRMLISTA_CAIXA2 := TFRMLISTA_CAIXA2.CREATE(SELF);
  FRMLISTA_CAIXA2.SHOWMODAL;
end;

procedure TfrmPrincipal.ContasaReceber5Click(Sender: TObject);
begin
  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end
  else
  begin
  //41 : result := '06.02 - RELATÓRIO CONTAS A PAG';
 // 43 : result := '06.04 - RELATÓRIO DE CAIXA';
    if frmprincipal.acesso(codigo_usuario, '06.03') = 'NAO' then
    begin
      application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
      exit;
    end;

  end;

  FRMLISTA_RECEBER2 := TFRMLISTA_RECEBER2.CREATE(SELF);
  FRMLISTA_RECEBER2.SHOWMODAL;
end;

procedure TfrmPrincipal.ContasaPagar7Click(Sender: TObject);
begin
  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end
  else
  begin
  //41 : result := '06.02 - RELATÓRIO CONTAS A PAG';
 // 43 : result := '06.04 - RELATÓRIO DE CAIXA';
    if frmprincipal.acesso(codigo_usuario, '06.02') = 'NAO' then
    begin
      application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
      exit;
    end;

  end;

  FRMLISTA_PAGAR2 := TFRMLISTA_PAGAR2.CREATE(SELF);
  FRMLISTA_PAGAR2.SHOWMODAL;

end;

procedure TfrmPrincipal.PercentualVendasGrupoMarca3Click(Sender: TObject);
begin
  frmlista_abc_marca_grupo := Tfrmlista_abc_marca_grupo.CREATE(SELF);
  frmlista_abc_marca_grupo.ShowModal;
end;

procedure TfrmPrincipal.Vendas4Click(Sender: TObject);
begin
  if nivel_usuario < 3 then
  begin
    Application.MessageBox('Seu nível não permite este acesso!', 'Atenção', mb_ok + mb_iconwarning);
    exit;
  end
  else
  begin
  //41 : result := '06.02 - RELATÓRIO CONTAS A PAG';
 // 43 : result := '06.04 - RELATÓRIO DE CAIXA';
    if frmprincipal.acesso(codigo_usuario, '06.01') = 'NAO' then
    begin
      application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
      exit;
    end;

  end;

  FRMLISTA_VENDA2 := TFRMLISTA_VENDA2.CREATE(SELF);
  FRMLISTA_VENDA2.SHOWMODAL;

end;

procedure TfrmPrincipal.EtiquetasdeProdutos3Click(Sender: TObject);
begin
  frmetiquetador := tfrmetiquetador.create(self);
  frmetiquetador.showmodal;
end;

procedure TfrmPrincipal.Produtos7Click(Sender: TObject);
begin

  FRMLISTA_PRODUTO2 := TFRMLISTA_PRODUTO2.CREATE(SELF);
  FRMLISTA_PRODUTO2.SHOWMODAL;
end;

procedure TfrmPrincipal.Fornecedores7Click(Sender: TObject);
begin
  FRMLISTA_FORNECEDOR2 := TFRMLISTA_FORNECEDOR2.CREATE(SELF);
  FRMLISTA_FORNECEDOR2.SHOWMODAL;
end;

procedure TfrmPrincipal.Clientes11Click(Sender: TObject);
begin
  FRMLISTA_CLIENTE2 := TFRMLISTA_CLIENTE2.CREATE(SELF);
  FRMLISTA_CLIENTE2.SHOWMODAL;
end;

procedure TfrmPrincipal.Configuraes3Click(Sender: TObject);
begin
  if frmprincipal.autentica('Configurações', 4) then
  begin
    frmconfig := tfrmconfig.create(self);
    frmconfig.showmodal;
  end
  else
  begin
    Application.messagebox('Acesso não permitido!', 'Erro!', mb_ok + mb_iconerror);
  end;
end;

procedure TfrmPrincipal.A1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '05.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmagenda := tfrmagenda.create(self);
  frmagenda.showmodal;

end;

procedure TfrmPrincipal.Caixa6Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  if frmPrincipal.autentica_caixa('Acesso ao Caixa', 0) then
  begin
    frmcaixa := tfrmcaixa.create(self);
    frmcaixa.showmodal;
  end
  else
  begin
    APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
  end;

end;

procedure TfrmPrincipal.ContasaPagar6Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONTASPAGAR := TFRMCONTASPAGAR.CREATE(SELF);
  FRMCONTASPAGAR.SHOWMODAL;
end;

procedure TfrmPrincipal.ContsasaReceber2Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmcontasreceber := tfrmcontasreceber.create(self);
  frmcontasreceber.showmodal;

end;

procedure TfrmPrincipal.Financeira3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmFinanceira := tfrmFinanceira.create(self);
  frmFinanceira.showmodal;
end;

procedure TfrmPrincipal.Cheques3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FrmCHEQUE_MENU := tfrmCHEQUE_MENU.create(self);
  frmCHEQUE_MENU.showmodal;
end;

procedure TfrmPrincipal.ContaCorrente3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;


  frmcontacorrente := tfrmcontacorrente.create(self);
  frmcontacorrente.showmodal;
end;

procedure TfrmPrincipal.Clientes10Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcliente_financeiro := tfrmcliente_financeiro.create(self);
  frmcliente_financeiro.showmodal;
end;

procedure TfrmPrincipal.BoletoBancrio3Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '04.06') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  FRMBOLETO := TFRMBOLETO.CREATE(SELF);
  FRMBOLETO.SHOWMODAL;

end;

procedure TfrmPrincipal.CartodeCrdito3Click(Sender: TObject);
begin

  if frmprincipal.acesso(codigo_usuario, '04.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmcartao := tfrmcartao.create(self);
  frmcartao.showmodal;
end;

procedure TfrmPrincipal.Convnio3Click(Sender: TObject);
begin

  if frmprincipal.acesso(codigo_usuario, '04.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONVENIO_receber := TFRMCONVENIO_receber.CREATE(SELF);
  FRMCONVENIO_receber.SHOWMODAL;
end;

procedure TfrmPrincipal.tlSystemInformationClick(
  Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '01.04') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmtransportador := tfrmtransportador.create(self);
  frmtransportador.showmodal;

end;

procedure TfrmPrincipal.tlAgentsClick(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '04.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  if frmPrincipal.autentica_caixa('Acesso ao Caixa', 0) then
  begin
    frmcaixa := tfrmcaixa.create(self);
    frmcaixa.showmodal;
  end
  else
  begin
    APPLICATION.MESSAGEBOX('Não autorizado!', 'Aviso', mb_ok + MB_ICONERROR);
  end;


end;

procedure TfrmPrincipal.tlResearchClick(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '02.01') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;



  FRMMODULO.QRCONFIG.OPEN;
  if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'NORMAL' then
  begin
    frmproduto := tfrmproduto.create(self);
    frmproduto.showmodal;
  end
  else
  begin
    if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'LIGHT' then
    begin
      frmproduto_LIGTH := tfrmproduto_LIGTH.create(self);
      frmproduto_LIGTH.showmodal;
    end
    else
    begin
      if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'FARMA' then
      begin
        frmproduto_FARMA := tfrmproduto_FARMA.create(self);
        frmproduto_FARMA.showmodal;
      end
      else
      begin
        if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'PECAS' then
        begin
          frmproduto_AUTO := tfrmproduto_AUTO.create(self);
          frmproduto_AUTO.showmodal;
        end;
      end;
    end;
  end;

end;

procedure TfrmPrincipal.tlStatisticsClick(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '04.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMCONTASPAGAR := TFRMCONTASPAGAR.CREATE(SELF);
  FRMCONTASPAGAR.SHOWMODAL;

end;

procedure TfrmPrincipal.tlZillowClick(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '02.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmcompra_menu := tfrmcompra_menu.create(self);
  frmcompra_menu.showmodal;

end;

procedure TfrmPrincipal.dxTileItem2Click(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '04.07') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmcontasreceber := tfrmcontasreceber.create(self);
  frmcontasreceber.showmodal;


end;

procedure TfrmPrincipal.dxTileItem1Click(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '03.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  //frmnotafiscal := tfrmnotafiscal.create(self);
  //frmnotafiscal.showmodal;

  frmnotafiscal_menu := tfrmnotafiscal_menu.create(self);
  frmnotafiscal_menu.showmodal;

end;

procedure TfrmPrincipal.tlMortgageRatesClick(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '02.08') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMMODULO.QRCONFIG.OPEN;
  if (FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'NORMAL') or (FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'FARMA') then
  begin
    frmproduto_consultapreco := tfrmproduto_consultapreco.create(self);
    frmproduto_consultapreco.showmodal;
  end
  else
  begin
    if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'LIGHT' then
    begin
      frmproduto_consultapreco := tfrmproduto_consultapreco.create(self);
      frmproduto_consultapreco.showmodal;
    end
    else
    begin
      if FRMMODULO.QRCONFIG.FieldByName('CADASTRO_PRODUTO').asstring = 'PECAS' then
      begin
        frmloc_produto_AUTO := tfrmloc_produto_AUTO.create(self);
        frmloc_produto_AUTO.showmodal;
      end
    end;
  end;

end;

procedure TfrmPrincipal.tlLoanCalculatorClick(Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '02.05') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmbaixa_estoque := tfrmbaixa_estoque.create(self);
  frmbaixa_estoque.showmodal;
end;

procedure TfrmPrincipal.SobreoSistemaiCloud1Click(Sender: TObject);
begin
  form_sobre := tform_sobre.create(self);
  form_sobre.showmodal;

end;

procedure TfrmPrincipal.dxtlcntrltmTileItem5Click(
  Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '03.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmorcamento := tfrmorcamento.create(self);
  frmorcamento.showmodal;

end;

procedure TfrmPrincipal.dxtlcntrltmTileItem7Click(
  Sender: TdxTileControlItem);
begin
  if frmprincipal.acesso(codigo_usuario, '05.03') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  frmagenda := tfrmagenda.create(self);
  frmagenda.showmodal;


end;

procedure TfrmPrincipal.dxtlcntrltmTileItem3Click(
  Sender: TdxTileControlItem);
begin
  with FRMPRINCIPAL do
  begin

    if autentica('Trocar de Usuário', 1) then
    begin
      nivel_usuario := frmmodulo.qrusuario.fieldbyname('nivel').asinteger;
      codigo_usuario := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
//      frmprincipal.pstatus.Panels[2].text := frmmodulo.qrusuario.fieldbyname('codigo').asstring;
  //    frmprincipal.pstatus.Panels[3].text := frmmodulo.qrusuario.fieldbyname('usuario').asstring;
      if nivel_usuario = 4 then
      begin
        pnormal.visible := false;
        psuper.visible := false; //true;

        qrcx.close;
        qrcx.sql.clear;
        qrcx.sql.add('select * from c000045 where codigo = ''000099''');
        qrcx.open;
        if qrcx.RecordCount > 0 then
        begin
          lcaixa.Caption := qrcx.fieldbyname('data').asstring;
          if qrcx.fieldbyname('situacao').asinteger = 1 then
            lsit_caixa.caption := 'ABERTO' else
            lsit_caixa.caption := 'FECHADO';
        end
        else
        begin
          Lcaixa.caption := '---';
          lsit_caixa.Caption := '---'
        end;

        qrniver.close;
        qrniver.sql.clear;
        qrniver.sql.add('select codigo, nome, nascimento, telefone1, telefone2, celular from c000007 where situacao < 3 and  nascimento like ''' + copy(datetostr(date), 1, 5) + '/%'' order by nome');
        qrniver.open;

        qrpagar.close;
        qrpagar.sql.clear;
        qrpagar.sql.add('select pg.*, forn.nome from c000046 pg, c000009 forn');
        qrpagar.sql.add('where pg.codfornecedor = forn.codigo and situacao = 1 and');
        qrpagar.sql.add('data_vencimento = :datax order by data_vencimento ');
        qrpagar.params.ParamByName('datax').asdatetime := date;
        qrpagar.open;

        query.close;
        query.sql.clear;
        query.sql.add('select sum(entrada) total_entrada, sum(saida) total_saida,');
        query.sql.add('(select sum(valor)       valor   from c000046 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(valor_atual) valor_1 from c000049 where situacao = 1 and data_vencimento = :datav), ');
        query.sql.add('(select sum(total)       valor_2 from c000048 where data = :datax),');
        query.sql.add('(select sum(total)       valor_3 from c000051 where conclusao_data = :datax and situacao = ''FECHADA'')');
        query.sql.add('from c000044 where data = :datax');
        query.params.ParamByName('datax').asdatetime := qrcx.fieldbyname('data').asdatetime;
        query.params.ParamByName('datav').asdatetime := date;
        query.open;

        ltcaixa.caption := formatfloat('###,###,##0.00', query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat);
        ltpagar.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor').asfloat);
        ltreceber.caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_1').asfloat);
        ltvenda.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_2').asfloat);
        ltos.Caption := formatfloat('###,###,##0.00', query.fieldbyname('valor_3').asfloat);
        ltfinal.caption := formatfloat('###,###,##0.00', (query.fieldbyname('total_entrada').asfloat - query.fieldbyname('total_saida').asfloat) + query.fieldbyname('valor_1').asfloat - query.fieldbyname('valor').asfloat);

      end
      else
      begin
        pnormal.visible := false; //true;
        psuper.visible := false;
      end;
    end;
  end;

end;

procedure TfrmPrincipal.dxtlcntrltmTileItem4Click(
  Sender: TdxTileControlItem);
begin
  close;
end;

procedure TfrmPrincipal.dxtlcntrltmTileItem6Click(
  Sender: TdxTileControlItem);
begin

  if frmprincipal.acesso(codigo_usuario, '02.02') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;
  frmgrupo := tfrmgrupo.create(self);
  frmgrupo.showmodal;

end;

procedure TfrmPrincipal.E1Click(Sender: TObject);
begin
  if frmprincipal.acesso(codigo_usuario, '02.09') = 'NAO' then
  begin
    application.messagebox('Acesso não permitido!', 'Atenção', mb_ok + MB_ICONERROR);
    exit;
  end;

  FRMBALANCA := TFRMBALANCA.CREATE(SELF);
  FRMBALANCA.SHOWMODAL;
end;

procedure TfrmPrincipal.A2Click(Sender: TObject);
begin
  Form_ativacao.showmodal;
end;

function TfrmPrincipal.CalculaDigitoEAN(CodigoEAN: string): Integer;
//Esta rotina recebe os 12 digitos iniciais do codigo ean13 e
//calcula o DV

var
  Erro: Boolean;
  Peso: array[1..12] of Integer;
  posicao, numero, soma: Integer;
  final: integer;
begin
  Erro := False;
  Result := 0;
  //se passou diferente de 12 digitos tá errado
  if Length(CodigoEAN) <> 12 then begin
    ShowMessage('Erro:Informe os 12 Dígitos do Código!');
    Erro := True;
  end;

  if not Erro then begin
  //Pesos para cada posição de acordo com o manual da Ean do Brasil para Código de 13 nros. 12 + 1 DV
    Peso[01] := 1;
    Peso[02] := 3;
    Peso[03] := 1;
    Peso[04] := 3;
    Peso[05] := 1;
    Peso[06] := 3;
    Peso[07] := 1;
    Peso[08] := 3;
    Peso[09] := 1;
    Peso[10] := 3;
    Peso[11] := 1;
    Peso[12] := 3;

    Soma := 0;
    for posicao := 1 to 12 do begin
      numero := StrToInt(Copy(CodigoEAN, posicao, 1));
      Soma := Soma + (Numero * Peso[posicao]);
    end;

  //verifica o final da soma
  //se for 0 o dv = 0
  //caso contrario o dv = 10 - final
    Final := StrToInt(Copy(IntToStr(Soma), Length(IntToStr(Soma)), 1));
    if Final = 0 then
      Result := 0
    else
      Result := 10 - Final
        ;
  end;
end;

end.

